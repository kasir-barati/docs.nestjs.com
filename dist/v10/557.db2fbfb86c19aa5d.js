"use strict";(self.webpackChunkdocs_nestjs_com=self.webpackChunkdocs_nestjs_com||[]).push([[557],{4557:(R,b,d)=>{d.r(b),d.d(b,{MicroservicesModule:()=>T});var w=d(177),k=d(2647),x=d(3887),p=d(8050),e=d(4438),l=d(5119),E=d(4819),v=d(8149),C=d(7077),u=d(5663);const A=[{path:"basics",component:(()=>{class t extends p.y{static \u0275fac=(()=>{let n;return function(a){return(n||(n=e.xGo(t)))(a||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-basics"]],features:[e.Vt3],decls:709,vars:46,consts:[["contentReference",""],["appd92382bf1162cb7597540336c8682a93b456f8f0",""],["app8751c3b11bc4956dfc52691739bc5de9ae5945f8",""],["app8ecc69849a10fb365cc134f2119407437904f01d",""],["appbc54b5d628b2b01426d620e7c3aedffa1f9837fb",""],["appdc49b11b16d90ace362283ecd7a47d1eed6fc341",""],["app2024963c7509ac1168c5e0aa8d61b693d1d43fd6",""],["app332047e2b28b6a8d20ca59fcffd14faa92d566c9",""],["app4fa5e98d36c60015c77ffd7d902d05383b237835",""],["appe2b5712f4566feafa6e0022eecdeac669d87c4d4",""],["app1f1641ebdbd17a599981b24a4c97a7be44882aac",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/microservices/basics.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","overview"],["src","/assets/Microservices_1.png",1,"illustrative-image"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","getting-started"],[1,"filename"],[1,"language-typescript"],[1,"info"],["href","https://github.com/nestjs/nest/blob/master/packages/microservices/interfaces/serializer.interface.ts","target","_blank"],["href","https://github.com/nestjs/nest/blob/master/packages/microservices/interfaces/deserializer.interface.ts","target","_blank"],["appAnchor","","id","patterns"],["appAnchor","","id","request-response"],["rel","nofollow","target","_blank","href","https://docs.confluent.io/3.0.0/streams/"],["rel","nofollow","target","_blank","href","https://github.com/nats-io/node-nats-streaming"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/microservices/basics#event-based"],["rel","nofollow","target","_blank","href","https://nats.io/"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/controllers"],["appAnchor","","id","asynchronous-responses"],["appAnchor","","id","event-based"],["appAnchor","","id","decorators"],["appAnchor","","id","client"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/fundamentals/custom-providers#non-class-based-provider-tokens"],["routerLink","/fundamentals/custom-providers"],["appAnchor","","id","sending-messages"],["appAnchor","","id","publishing-events"],["appAnchor","","id","scopes"],["routerLink","/fundamentals/injection-scopes"],["appAnchor","","id","handling-timeouts"],["rel","nofollow","target","_blank","href","https://rxjs.dev"],["rel","nofollow","target","_blank","href","https://github.com/ReactiveX/rxjs"]],template:function(s,a){if(1&s&&(e.j41(0,"div",11,0)(2,"div",12)(3,"a",13),e.nrm(4,"i",14),e.k0s()(),e.j41(5,"h3",15),e.EFF(6,"Overview"),e.k0s(),e.j41(7,"p"),e.EFF(8,"In addition to traditional (sometimes called monolithic) application architectures, Nest natively supports the microservice architectural style of development. Most of the concepts discussed elsewhere in this documentation, such as dependency injection, decorators, exception filters, pipes, guards and interceptors, apply equally to microservices. Wherever possible, Nest abstracts implementation details so that the same components can run across HTTP-based platforms, WebSockets, and Microservices. This section covers the aspects of Nest that are specific to microservices."),e.k0s(),e.j41(9,"p"),e.EFF(10,"In Nest, a microservice is fundamentally an application that uses a different "),e.j41(11,"strong"),e.EFF(12,"transport"),e.k0s(),e.EFF(13," layer than HTTP."),e.k0s(),e.j41(14,"figure"),e.nrm(15,"img",16),e.k0s(),e.j41(16,"p"),e.EFF(17,"Nest supports several built-in transport layer implementations, called "),e.j41(18,"strong"),e.EFF(19,"transporters"),e.k0s(),e.EFF(20,", which are responsible for transmitting messages between different microservice instances. Most transporters natively support both "),e.j41(21,"strong"),e.EFF(22,"request-response"),e.k0s(),e.EFF(23," and "),e.j41(24,"strong"),e.EFF(25,"event-based"),e.k0s(),e.EFF(26," message styles. Nest abstracts the implementation details of each transporter behind a canonical interface for both request-response and event-based messaging. This makes it easy to switch from one transport layer to another -- for example to leverage the specific reliability or performance features of a particular transport layer -- without impacting your application code."),e.k0s(),e.j41(27,"h4",17)(28,"span"),e.EFF(29,"Installation"),e.k0s()(),e.j41(30,"p"),e.EFF(31,"To start building microservices, first install the required package:"),e.k0s(),e.j41(32,"pre")(33,"code",18),e.EFF(34,"\n$ npm i --save @nestjs/microservices\n"),e.k0s()(),e.j41(35,"h4",19)(36,"span"),e.EFF(37,"Getting started"),e.k0s()(),e.j41(38,"p"),e.EFF(39,"To instantiate a microservice, use the "),e.j41(40,"code"),e.EFF(41,"createMicroservice()"),e.k0s(),e.EFF(42," method of the "),e.j41(43,"code"),e.EFF(44,"NestFactory"),e.k0s(),e.EFF(45," class:"),e.k0s(),e.j41(46,"span",20),e.EFF(47),e.nI1(48,"extension"),e.nrm(49,"app-tabs",null,1),e.k0s(),e.j41(51,"pre")(52,"code",21),e.EFF(53,"\nimport { NestFactory } from '@nestjs/core';\nimport { Transport, MicroserviceOptions } from '@nestjs/microservices';\nimport { AppModule } from './app.module';\n\nasync function bootstrap() {\n  const app = await NestFactory.createMicroservice<MicroserviceOptions>(\n    AppModule,\n    {\n      transport: Transport.TCP,\n    },\n  );\n  await app.listen();\n}\nbootstrap();\n"),e.k0s()(),e.j41(54,"pre")(55,"code",21),e.EFF(56,"\nimport { NestFactory } from '@nestjs/core';\nimport { Transport } from '@nestjs/microservices';\nimport { AppModule } from './app.module';\n\nasync function bootstrap() {\n  const app = await NestFactory.createMicroservice(AppModule, {\n    transport: Transport.TCP,\n  });\n  await app.listen();\n}\nbootstrap();\n"),e.k0s()(),e.j41(57,"blockquote",22)(58,"strong"),e.EFF(59,"Hint"),e.k0s(),e.EFF(60," Microservices use the "),e.j41(61,"strong"),e.EFF(62,"TCP"),e.k0s(),e.EFF(63," transport layer by default.\n"),e.k0s(),e.j41(64,"p"),e.EFF(65,"The second argument of the "),e.j41(66,"code"),e.EFF(67,"createMicroservice()"),e.k0s(),e.EFF(68," method is an "),e.j41(69,"code"),e.EFF(70,"options"),e.k0s(),e.EFF(71," object. This object may consist of two members:"),e.k0s(),e.j41(72,"table")(73,"tr")(74,"td")(75,"code"),e.EFF(76,"transport"),e.k0s()(),e.j41(77,"td"),e.EFF(78,"Specifies the transporter (for example, "),e.j41(79,"code"),e.EFF(80,"Transport.NATS"),e.k0s(),e.EFF(81,")"),e.k0s()(),e.j41(82,"tr")(83,"td")(84,"code"),e.EFF(85,"options"),e.k0s()(),e.j41(86,"td"),e.EFF(87,"A transporter-specific options object that determines transporter behavior"),e.k0s()()(),e.j41(88,"p"),e.EFF(89," The "),e.j41(90,"code"),e.EFF(91,"options"),e.k0s(),e.EFF(92," object is specific to the chosen transporter. The "),e.j41(93,"strong"),e.EFF(94,"TCP"),e.k0s(),e.EFF(95," transporter exposes the properties described below. For other transporters (e.g, Redis, MQTT, etc.), see the relevant chapter for a description of the available options.\n"),e.k0s(),e.j41(96,"table")(97,"tr")(98,"td")(99,"code"),e.EFF(100,"host"),e.k0s()(),e.j41(101,"td"),e.EFF(102,"Connection hostname"),e.k0s()(),e.j41(103,"tr")(104,"td")(105,"code"),e.EFF(106,"port"),e.k0s()(),e.j41(107,"td"),e.EFF(108,"Connection port"),e.k0s()(),e.j41(109,"tr")(110,"td")(111,"code"),e.EFF(112,"retryAttempts"),e.k0s()(),e.j41(113,"td"),e.EFF(114,"Number of times to retry message (default: "),e.j41(115,"code"),e.EFF(116,"0"),e.k0s(),e.EFF(117,")"),e.k0s()(),e.j41(118,"tr")(119,"td")(120,"code"),e.EFF(121,"retryDelay"),e.k0s()(),e.j41(122,"td"),e.EFF(123,"Delay between message retry attempts (ms) (default: "),e.j41(124,"code"),e.EFF(125,"0"),e.k0s(),e.EFF(126,")"),e.k0s()(),e.j41(127,"tr")(128,"td")(129,"code"),e.EFF(130,"serializer"),e.k0s()(),e.j41(131,"td"),e.EFF(132,"Custom "),e.j41(133,"a",23),e.EFF(134,"serializer"),e.k0s(),e.EFF(135," for outcoming messages"),e.k0s()(),e.j41(136,"tr")(137,"td")(138,"code"),e.EFF(139,"deserializer"),e.k0s()(),e.j41(140,"td"),e.EFF(141,"Custom "),e.j41(142,"a",24),e.EFF(143,"deserializer"),e.k0s(),e.EFF(144," for incoming messages"),e.k0s()(),e.j41(145,"tr")(146,"td")(147,"code"),e.EFF(148,"socketClass"),e.k0s()(),e.j41(149,"td"),e.EFF(150,"A custom Socket that extends "),e.j41(151,"code"),e.EFF(152,"TcpSocket"),e.k0s(),e.EFF(153," (default: "),e.j41(154,"code"),e.EFF(155,"JsonSocket"),e.k0s(),e.EFF(156,")"),e.k0s()(),e.j41(157,"tr")(158,"td")(159,"code"),e.EFF(160,"tlsOptions"),e.k0s()(),e.j41(161,"td"),e.EFF(162,"Options to configure the tls protocol"),e.k0s()()(),e.j41(163,"h4",25)(164,"span"),e.EFF(165,"Patterns"),e.k0s()(),e.j41(166,"p"),e.EFF(167,"Microservices recognize both messages and events by "),e.j41(168,"strong"),e.EFF(169,"patterns"),e.k0s(),e.EFF(170,". A pattern is a plain value, for example, a literal object or a string. Patterns are automatically serialized and sent over the network along with the data portion of a message. In this way, message senders and consumers can coordinate which requests are consumed by which handlers."),e.k0s(),e.j41(171,"h4",26)(172,"span"),e.EFF(173,"Request-response"),e.k0s()(),e.j41(174,"p"),e.EFF(175,"The request-response message style is useful when you need to "),e.j41(176,"strong"),e.EFF(177,"exchange"),e.k0s(),e.EFF(178," messages between various external services. With this paradigm, you can be certain that the service has actually received the message (without the need to manually implement a message ACK protocol). However, the request-response paradigm is not always the best choice. For example, streaming transporters that use log-based persistence, such as "),e.j41(179,"a",27),e.EFF(180,"Kafka"),e.k0s(),e.EFF(181," or "),e.j41(182,"a",28),e.EFF(183,"NATS streaming"),e.k0s(),e.EFF(184,", are optimized for solving a different range of issues, more aligned with an event messaging paradigm (see "),e.j41(185,"a",29),e.EFF(186,"event-based messaging"),e.k0s(),e.EFF(187," below for more details)."),e.k0s(),e.j41(188,"p"),e.EFF(189,"To enable the request-response message type, Nest creates two logical channels - one is responsible for transferring the data while the other waits for incoming responses. For some underlying transports, such as "),e.j41(190,"a",30),e.EFF(191,"NATS"),e.k0s(),e.EFF(192,", this dual-channel support is provided out-of-the-box. For others, Nest compensates by manually creating separate channels. There can be overhead for this, so if you do not require a request-response message style, you should consider using the event-based method."),e.k0s(),e.j41(193,"p"),e.EFF(194,"To create a message handler based on the request-response paradigm use the "),e.j41(195,"code"),e.EFF(196,"@MessagePattern()"),e.k0s(),e.EFF(197," decorator, which is imported from the "),e.j41(198,"code"),e.EFF(199,"@nestjs/microservices"),e.k0s(),e.EFF(200," package. This decorator should be used only within the "),e.j41(201,"a",31),e.EFF(202,"controller"),e.k0s(),e.EFF(203," classes since they are the entry points for your application. Using them inside providers won't have any effect as they are simply ignored by Nest runtime."),e.k0s(),e.j41(204,"span",20),e.EFF(205),e.nI1(206,"extension"),e.nrm(207,"app-tabs",null,2),e.k0s(),e.j41(209,"pre")(210,"code",21),e.EFF(211,"\nimport { Controller } from '@nestjs/common';\nimport { MessagePattern } from '@nestjs/microservices';\n\n@Controller()\nexport class MathController {\n  @MessagePattern({ cmd: 'sum' })\n  accumulate(data: number[]): number {\n    return (data || []).reduce((a, b) => a + b);\n  }\n}\n"),e.k0s()(),e.j41(212,"pre")(213,"code",21),e.EFF(214,"\nimport { Controller } from '@nestjs/common';\nimport { MessagePattern } from '@nestjs/microservices';\n\n@Controller()\nexport class MathController {\n  @MessagePattern({ cmd: 'sum' })\n  accumulate(data) {\n    return (data || []).reduce((a, b) => a + b);\n  }\n}\n"),e.k0s()(),e.j41(215,"p"),e.EFF(216,"In the above code, the "),e.j41(217,"code"),e.EFF(218,"accumulate()"),e.k0s(),e.j41(219,"strong"),e.EFF(220,"message handler"),e.k0s(),e.EFF(221," listens for messages that fulfill the "),e.j41(222,"code"),e.EFF(223),e.k0s(),e.EFF(224," message pattern. The message handler takes a single argument, the "),e.j41(225,"code"),e.EFF(226,"data"),e.k0s(),e.EFF(227," passed from the client. In this case, the data is an array of numbers which are to be accumulated."),e.k0s(),e.j41(228,"h4",32)(229,"span"),e.EFF(230,"Asynchronous responses"),e.k0s()(),e.j41(231,"p"),e.EFF(232,"Message handlers are able to respond either synchronously or "),e.j41(233,"strong"),e.EFF(234,"asynchronously"),e.k0s(),e.EFF(235,". Hence, "),e.j41(236,"code"),e.EFF(237,"async"),e.k0s(),e.EFF(238," methods are supported."),e.k0s(),e.j41(239,"span",20),e.nrm(240,"app-tabs",null,3),e.k0s(),e.j41(242,"pre")(243,"code",21),e.EFF(244,"\n@MessagePattern({ cmd: 'sum' })\nasync accumulate(data: number[]): Promise<number> {\n  return (data || []).reduce((a, b) => a + b);\n}\n"),e.k0s()(),e.j41(245,"pre")(246,"code",21),e.EFF(247,"\n@MessagePattern({ cmd: 'sum' })\nasync accumulate(data) {\n  return (data || []).reduce((a, b) => a + b);\n}\n"),e.k0s()(),e.j41(248,"p"),e.EFF(249,"A message handler is also able to return an\xa0"),e.j41(250,"code"),e.EFF(251,"Observable"),e.k0s(),e.EFF(252,", in which case the result values will be emitted until the stream is completed."),e.k0s(),e.j41(253,"span",20),e.nrm(254,"app-tabs",null,4),e.k0s(),e.j41(256,"pre")(257,"code",21),e.EFF(258,"\n@MessagePattern({ cmd: 'sum' })\naccumulate(data: number[]): Observable<number> {\n  return from([1, 2, 3]);\n}\n"),e.k0s()(),e.j41(259,"pre")(260,"code",21),e.EFF(261,"\n@MessagePattern({ cmd: 'sum' })\naccumulate(data: number[]): Observable<number> {\n  return from([1, 2, 3]);\n}\n"),e.k0s()(),e.j41(262,"p"),e.EFF(263,"In the example above, the message handler will respond "),e.j41(264,"strong"),e.EFF(265,"3 times"),e.k0s(),e.EFF(266," (with each item from the array)."),e.k0s(),e.j41(267,"h4",33)(268,"span"),e.EFF(269,"Event-based"),e.k0s()(),e.j41(270,"p"),e.EFF(271,"While the request-response method is ideal for exchanging messages between services, it is less suitable when your message style is event-based - when you just want to publish "),e.j41(272,"strong"),e.EFF(273,"events"),e.k0s(),e.EFF(274," without waiting for a response. In that case, you do not want the overhead required by request-response for maintaining two channels."),e.k0s(),e.j41(275,"p"),e.EFF(276,"Suppose you would like to simply notify another service that a certain condition has occurred in this part of the system. This is the ideal use case for the event-based message style."),e.k0s(),e.j41(277,"p"),e.EFF(278,"To create an event handler, we use the "),e.j41(279,"code"),e.EFF(280,"@EventPattern()"),e.k0s(),e.EFF(281," decorator, which is imported from the "),e.j41(282,"code"),e.EFF(283,"@nestjs/microservices"),e.k0s(),e.EFF(284," package."),e.k0s(),e.j41(285,"span",20),e.nrm(286,"app-tabs",null,5),e.k0s(),e.j41(288,"pre")(289,"code",21),e.EFF(290,"\n@EventPattern('user_created')\nasync handleUserCreated(data: Record<string, unknown>) {\n  // business logic\n}\n"),e.k0s()(),e.j41(291,"pre")(292,"code",21),e.EFF(293,"\n@EventPattern('user_created')\nasync handleUserCreated(data) {\n  // business logic\n}\n"),e.k0s()(),e.j41(294,"blockquote",22)(295,"strong"),e.EFF(296,"Hint"),e.k0s(),e.EFF(297," You can register multiple event handlers for a "),e.j41(298,"strong"),e.EFF(299,"single"),e.k0s(),e.EFF(300," event pattern and all of them will be automatically triggered in parallel.\n"),e.k0s(),e.j41(301,"p"),e.EFF(302,"The "),e.j41(303,"code"),e.EFF(304,"handleUserCreated()"),e.k0s(),e.j41(305,"strong"),e.EFF(306,"event handler"),e.k0s(),e.EFF(307," listens for the "),e.j41(308,"code"),e.EFF(309,"'user_created'"),e.k0s(),e.EFF(310," event. The event handler takes a single argument, the "),e.j41(311,"code"),e.EFF(312,"data"),e.k0s(),e.EFF(313," passed from the client (in this case, an event payload which has been sent over the network)."),e.k0s(),e.j41(314,"p"),e.nrm(315,"app-banner-enterprise"),e.k0s(),e.j41(316,"h4",34)(317,"span"),e.EFF(318,"Decorators"),e.k0s()(),e.j41(319,"p"),e.EFF(320,"In more sophisticated scenarios, you may want to access more information about the incoming request. For example, in the case of NATS with wildcard subscriptions, you may want to get the original subject that the producer has sent the message to. Likewise, in Kafka you may want to access the message headers. In order to accomplish that, you can use built-in decorators as follows:"),e.k0s(),e.j41(321,"span",20),e.nrm(322,"app-tabs",null,6),e.k0s(),e.j41(324,"pre")(325,"code",21),e.EFF(326,"\n@MessagePattern('time.us.*')\ngetDate(@Payload() data: number[], @Ctx() context: NatsContext) {\n  console.log(`Subject: ${context.getSubject()}`); // e.g. \"time.us.east\"\n  return new Date().toLocaleTimeString(...);\n}\n"),e.k0s()(),e.j41(327,"pre")(328,"code",21),e.EFF(329,"\n@Bind(Payload(), Ctx())\n@MessagePattern('time.us.*')\ngetDate(data, context) {\n  console.log(`Subject: ${context.getSubject()}`); // e.g. \"time.us.east\"\n  return new Date().toLocaleTimeString(...);\n}\n"),e.k0s()(),e.j41(330,"blockquote",22)(331,"strong"),e.EFF(332,"Hint"),e.k0s(),e.j41(333,"code"),e.EFF(334,"@Payload()"),e.k0s(),e.EFF(335,", "),e.j41(336,"code"),e.EFF(337,"@Ctx()"),e.k0s(),e.EFF(338," and "),e.j41(339,"code"),e.EFF(340,"NatsContext"),e.k0s(),e.EFF(341," are imported from "),e.j41(342,"code"),e.EFF(343,"@nestjs/microservices"),e.k0s(),e.EFF(344,".\n"),e.k0s(),e.j41(345,"blockquote",22)(346,"strong"),e.EFF(347,"Hint"),e.k0s(),e.EFF(348," You can also pass in a property key to the "),e.j41(349,"code"),e.EFF(350,"@Payload()"),e.k0s(),e.EFF(351," decorator to extract a specific property from the incoming payload object, for example, "),e.j41(352,"code"),e.EFF(353,"@Payload('id')"),e.k0s(),e.EFF(354,".\n"),e.k0s(),e.j41(355,"h4",35)(356,"span"),e.EFF(357,"Client"),e.k0s()(),e.j41(358,"p"),e.EFF(359,"A client Nest application can exchange messages or publish events to a Nest microservice using the "),e.j41(360,"code"),e.EFF(361,"ClientProxy"),e.k0s(),e.EFF(362," class. This class defines several methods, such as "),e.j41(363,"code"),e.EFF(364,"send()"),e.k0s(),e.EFF(365," (for request-response messaging) and "),e.j41(366,"code"),e.EFF(367,"emit()"),e.k0s(),e.EFF(368," (for event-driven messaging) that let you communicate with a remote microservice. Obtain an instance of this class in one of the following ways."),e.k0s(),e.j41(369,"p"),e.EFF(370,"One technique is to import the "),e.j41(371,"code"),e.EFF(372,"ClientsModule"),e.k0s(),e.EFF(373,", which exposes the static "),e.j41(374,"code"),e.EFF(375,"register()"),e.k0s(),e.EFF(376," method. This method takes an argument which is an array of objects representing microservice transporters. Each such object has a "),e.j41(377,"code"),e.EFF(378,"name"),e.k0s(),e.EFF(379," property, an optional "),e.j41(380,"code"),e.EFF(381,"transport"),e.k0s(),e.EFF(382," property (default is "),e.j41(383,"code"),e.EFF(384,"Transport.TCP"),e.k0s(),e.EFF(385,"), and an optional transporter-specific "),e.j41(386,"code"),e.EFF(387,"options"),e.k0s(),e.EFF(388," property."),e.k0s(),e.j41(389,"p"),e.EFF(390,"The "),e.j41(391,"code"),e.EFF(392,"name"),e.k0s(),e.EFF(393," property serves as an "),e.j41(394,"strong"),e.EFF(395,"injection token"),e.k0s(),e.EFF(396," that can be used to inject an instance of a "),e.j41(397,"code"),e.EFF(398,"ClientProxy"),e.k0s(),e.EFF(399," where needed. The value of the "),e.j41(400,"code"),e.EFF(401,"name"),e.k0s(),e.EFF(402," property, as an injection token, can be an arbitrary string or JavaScript symbol, as described "),e.j41(403,"a",36),e.EFF(404,"here"),e.k0s(),e.EFF(405,"."),e.k0s(),e.j41(406,"p"),e.EFF(407,"The "),e.j41(408,"code"),e.EFF(409,"options"),e.k0s(),e.EFF(410," property is an object with the same properties we saw in the "),e.j41(411,"code"),e.EFF(412,"createMicroservice()"),e.k0s(),e.EFF(413," method earlier."),e.k0s(),e.j41(414,"pre")(415,"code",21),e.EFF(416,"\n@Module({\n  imports: [\n    ClientsModule.register([\n      { name: 'MATH_SERVICE', transport: Transport.TCP },\n    ]),\n  ]\n  ...\n})\n"),e.k0s()(),e.j41(417,"p"),e.EFF(418,"Once the module has been imported, we can inject an instance of the "),e.j41(419,"code"),e.EFF(420,"ClientProxy"),e.k0s(),e.EFF(421," configured as specified via the "),e.j41(422,"code"),e.EFF(423,"'MATH_SERVICE'"),e.k0s(),e.EFF(424," transporter options shown above, using the "),e.j41(425,"code"),e.EFF(426,"@Inject()"),e.k0s(),e.EFF(427," decorator."),e.k0s(),e.j41(428,"pre")(429,"code",21),e.EFF(430,"\nconstructor(\n  @Inject('MATH_SERVICE') private client: ClientProxy,\n) {}\n"),e.k0s()(),e.j41(431,"blockquote",22)(432,"strong"),e.EFF(433,"Hint"),e.k0s(),e.EFF(434," The "),e.j41(435,"code"),e.EFF(436,"ClientsModule"),e.k0s(),e.EFF(437," and "),e.j41(438,"code"),e.EFF(439,"ClientProxy"),e.k0s(),e.EFF(440," classes are imported from the "),e.j41(441,"code"),e.EFF(442,"@nestjs/microservices"),e.k0s(),e.EFF(443," package.\n"),e.k0s(),e.j41(444,"p"),e.EFF(445,"At times we may need to fetch the transporter configuration from another service (say a "),e.j41(446,"code"),e.EFF(447,"ConfigService"),e.k0s(),e.EFF(448,"), rather than hard-coding it in our client application. To do this, we can register a "),e.j41(449,"a",37),e.EFF(450,"custom provider"),e.k0s(),e.EFF(451," using the "),e.j41(452,"code"),e.EFF(453,"ClientProxyFactory"),e.k0s(),e.EFF(454," class. This class has a static "),e.j41(455,"code"),e.EFF(456,"create()"),e.k0s(),e.EFF(457," method, which accepts a transporter options object, and returns a customized "),e.j41(458,"code"),e.EFF(459,"ClientProxy"),e.k0s(),e.EFF(460," instance."),e.k0s(),e.j41(461,"pre")(462,"code",21),e.EFF(463,"\n@Module({\n  providers: [\n    {\n      provide: 'MATH_SERVICE',\n      useFactory: (configService: ConfigService) => {\n        const mathSvcOptions = configService.getMathSvcOptions();\n        return ClientProxyFactory.create(mathSvcOptions);\n      },\n      inject: [ConfigService],\n    }\n  ]\n  ...\n})\n"),e.k0s()(),e.j41(464,"blockquote",22)(465,"strong"),e.EFF(466,"Hint"),e.k0s(),e.EFF(467," The "),e.j41(468,"code"),e.EFF(469,"ClientProxyFactory"),e.k0s(),e.EFF(470," is imported from the "),e.j41(471,"code"),e.EFF(472,"@nestjs/microservices"),e.k0s(),e.EFF(473," package.\n"),e.k0s(),e.j41(474,"p"),e.EFF(475,"Another option is to use the "),e.j41(476,"code"),e.EFF(477,"@Client()"),e.k0s(),e.EFF(478," property decorator."),e.k0s(),e.j41(479,"pre")(480,"code",21),e.EFF(481,"\n@Client({ transport: Transport.TCP })\nclient: ClientProxy;\n"),e.k0s()(),e.j41(482,"blockquote",22)(483,"strong"),e.EFF(484,"Hint"),e.k0s(),e.EFF(485," The "),e.j41(486,"code"),e.EFF(487,"@Client()"),e.k0s(),e.EFF(488," decorator is imported from the "),e.j41(489,"code"),e.EFF(490,"@nestjs/microservices"),e.k0s(),e.EFF(491," package.\n"),e.k0s(),e.j41(492,"p"),e.EFF(493,"Using the "),e.j41(494,"code"),e.EFF(495,"@Client()"),e.k0s(),e.EFF(496," decorator is not the preferred technique, as it is harder to test and harder to share a client instance."),e.k0s(),e.j41(497,"p"),e.EFF(498,"The "),e.j41(499,"code"),e.EFF(500,"ClientProxy"),e.k0s(),e.EFF(501," is "),e.j41(502,"strong"),e.EFF(503,"lazy"),e.k0s(),e.EFF(504,". It doesn't initiate a connection immediately. Instead, it will be established before the first microservice call, and then reused across each subsequent call. However, if you want to delay the application bootstrapping process until a connection is established, you can manually initiate a connection using the "),e.j41(505,"code"),e.EFF(506,"ClientProxy"),e.k0s(),e.EFF(507," object's "),e.j41(508,"code"),e.EFF(509,"connect()"),e.k0s(),e.EFF(510," method inside the "),e.j41(511,"code"),e.EFF(512,"OnApplicationBootstrap"),e.k0s(),e.EFF(513," lifecycle hook."),e.k0s(),e.j41(514,"span",20),e.nrm(515,"app-tabs",null,7),e.k0s(),e.j41(517,"pre")(518,"code",21),e.EFF(519,"\nasync onApplicationBootstrap() {\n  await this.client.connect();\n}\n"),e.k0s()(),e.j41(520,"p"),e.EFF(521,"If the connection cannot be created, the "),e.j41(522,"code"),e.EFF(523,"connect()"),e.k0s(),e.EFF(524," method will reject with the corresponding error object."),e.k0s(),e.j41(525,"h4",38)(526,"span"),e.EFF(527,"Sending messages"),e.k0s()(),e.j41(528,"p"),e.EFF(529,"The "),e.j41(530,"code"),e.EFF(531,"ClientProxy"),e.k0s(),e.EFF(532," exposes a "),e.j41(533,"code"),e.EFF(534,"send()"),e.k0s(),e.EFF(535," method. This method is intended to call the microservice and returns an "),e.j41(536,"code"),e.EFF(537,"Observable"),e.k0s(),e.EFF(538," with its response. Thus, we can subscribe to the emitted values easily."),e.k0s(),e.j41(539,"span",20),e.nrm(540,"app-tabs",null,8),e.k0s(),e.j41(542,"pre")(543,"code",21),e.EFF(544,"\naccumulate(): Observable<number> {\n  const pattern = { cmd: 'sum' };\n  const payload = [1, 2, 3];\n  return this.client.send<number>(pattern, payload);\n}\n"),e.k0s()(),e.j41(545,"pre")(546,"code",21),e.EFF(547,"\naccumulate() {\n  const pattern = { cmd: 'sum' };\n  const payload = [1, 2, 3];\n  return this.client.send(pattern, payload);\n}\n"),e.k0s()(),e.j41(548,"p"),e.EFF(549,"The "),e.j41(550,"code"),e.EFF(551,"send()"),e.k0s(),e.EFF(552," method takes two arguments, "),e.j41(553,"code"),e.EFF(554,"pattern"),e.k0s(),e.EFF(555," and "),e.j41(556,"code"),e.EFF(557,"payload"),e.k0s(),e.EFF(558,". The "),e.j41(559,"code"),e.EFF(560,"pattern"),e.k0s(),e.EFF(561," should match one defined in a "),e.j41(562,"code"),e.EFF(563,"@MessagePattern()"),e.k0s(),e.EFF(564," decorator. The "),e.j41(565,"code"),e.EFF(566,"payload"),e.k0s(),e.EFF(567," is a message that we want to transmit to the remote microservice. This method returns a "),e.j41(568,"strong"),e.EFF(569,"cold "),e.j41(570,"code"),e.EFF(571,"Observable"),e.k0s()(),e.EFF(572,", which means that you have to explicitly subscribe to it before the message will be sent."),e.k0s(),e.j41(573,"h4",39)(574,"span"),e.EFF(575,"Publishing events"),e.k0s()(),e.j41(576,"p"),e.EFF(577,"To send an event, use the "),e.j41(578,"code"),e.EFF(579,"ClientProxy"),e.k0s(),e.EFF(580," object's "),e.j41(581,"code"),e.EFF(582,"emit()"),e.k0s(),e.EFF(583," method. This method publishes an event to the message broker."),e.k0s(),e.j41(584,"span",20),e.nrm(585,"app-tabs",null,9),e.k0s(),e.j41(587,"pre")(588,"code",21),e.EFF(589,"\nasync publish() {\n  this.client.emit<number>('user_created', new UserCreatedEvent());\n}\n"),e.k0s()(),e.j41(590,"pre")(591,"code",21),e.EFF(592,"\nasync publish() {\n  this.client.emit('user_created', new UserCreatedEvent());\n}\n"),e.k0s()(),e.j41(593,"p"),e.EFF(594,"The "),e.j41(595,"code"),e.EFF(596,"emit()"),e.k0s(),e.EFF(597," method takes two arguments, "),e.j41(598,"code"),e.EFF(599,"pattern"),e.k0s(),e.EFF(600," and "),e.j41(601,"code"),e.EFF(602,"payload"),e.k0s(),e.EFF(603,". The "),e.j41(604,"code"),e.EFF(605,"pattern"),e.k0s(),e.EFF(606,"should match one defined in an "),e.j41(607,"code"),e.EFF(608,"@EventPattern()"),e.k0s(),e.EFF(609," decorator. The "),e.j41(610,"code"),e.EFF(611,"payload"),e.k0s(),e.EFF(612," is an event payload that we want to transmit to the remote microservice. This method returns a "),e.j41(613,"strong"),e.EFF(614,"hot "),e.j41(615,"code"),e.EFF(616,"Observable"),e.k0s()(),e.EFF(617," (unlike the cold "),e.j41(618,"code"),e.EFF(619,"Observable"),e.k0s(),e.EFF(620," returned by "),e.j41(621,"code"),e.EFF(622,"send()"),e.k0s(),e.EFF(623,"), which means that whether or not you explicitly subscribe to the observable, the proxy will immediately try to deliver the event."),e.k0s(),e.j41(624,"p"),e.nrm(625,"app-banner-devtools"),e.k0s(),e.j41(626,"h4",40)(627,"span"),e.EFF(628,"Scopes"),e.k0s()(),e.j41(629,"p"),e.EFF(630,"For people coming from different programming language backgrounds, it might be unexpected to learn that in Nest, almost everything is shared across incoming requests. We have a connection pool to the database, singleton services with global state, etc. Remember that Node.js doesn't follow the request/response Multi-Threaded Stateless Model in which every request is processed by a separate thread. Hence, using singleton instances is fully "),e.j41(631,"strong"),e.EFF(632,"safe"),e.k0s(),e.EFF(633," for our applications."),e.k0s(),e.j41(634,"p"),e.EFF(635,"However, there are edge-cases when request-based lifetime of the handler may be the desired behavior, for instance per-request caching in GraphQL applications, request tracking or multi-tenancy. Learn how to control scopes "),e.j41(636,"a",41),e.EFF(637,"here"),e.k0s(),e.EFF(638,"."),e.k0s(),e.j41(639,"p"),e.EFF(640,"Request-scoped handlers and providers can inject "),e.j41(641,"code"),e.EFF(642,"RequestContext"),e.k0s(),e.EFF(643," using the "),e.j41(644,"code"),e.EFF(645,"@Inject()"),e.k0s(),e.EFF(646," decorator in combination with "),e.j41(647,"code"),e.EFF(648,"CONTEXT"),e.k0s(),e.EFF(649," token:"),e.k0s(),e.j41(650,"pre")(651,"code",21),e.EFF(652,"\nimport { Injectable, Scope, Inject } from '@nestjs/common';\nimport { CONTEXT, RequestContext } from '@nestjs/microservices';\n\n@Injectable({ scope: Scope.REQUEST })\nexport class CatsService {\n  constructor(@Inject(CONTEXT) private ctx: RequestContext) {}\n}\n"),e.k0s()(),e.j41(653,"p"),e.EFF(654,"This provides access to the "),e.j41(655,"code"),e.EFF(656,"RequestContext"),e.k0s(),e.EFF(657," object, which has two properties:"),e.k0s(),e.j41(658,"pre")(659,"code",21),e.EFF(660,"\nexport interface RequestContext<T = any> {\n  pattern: string | Record<string, any>;\n  data: T;\n}\n"),e.k0s()(),e.j41(661,"p"),e.EFF(662,"The "),e.j41(663,"code"),e.EFF(664,"data"),e.k0s(),e.EFF(665," property is the message payload sent by the message producer. The "),e.j41(666,"code"),e.EFF(667,"pattern"),e.k0s(),e.EFF(668," property is the pattern used to identify an appropriate handler to handle the incoming message."),e.k0s(),e.j41(669,"h4",42)(670,"span"),e.EFF(671,"Handling timeouts"),e.k0s()(),e.j41(672,"p"),e.EFF(673,"In distributed systems, sometimes microservices might be down or not available. To avoid infinitely long waiting, you can use Timeouts. A timeout is an incredibly useful pattern when communicating with other services. To apply timeouts to your microservice calls, you can use the "),e.j41(674,"a",43),e.EFF(675,"RxJS"),e.k0s(),e.j41(676,"code"),e.EFF(677,"timeout"),e.k0s(),e.EFF(678," operator. If the microservice does not respond to the request within a certain time, an exception is thrown, which can be caught and handled appropriately."),e.k0s(),e.j41(679,"p"),e.EFF(680,"To solve this problem you have to use "),e.j41(681,"a",44)(682,"code"),e.EFF(683,"rxjs"),e.k0s()(),e.EFF(684," package. Just use the "),e.j41(685,"code"),e.EFF(686,"timeout"),e.k0s(),e.EFF(687," operator in the pipe:"),e.k0s(),e.j41(688,"span",20),e.nrm(689,"app-tabs",null,10),e.k0s(),e.j41(691,"pre")(692,"code",21),e.EFF(693,"\nthis.client\n      .send<TResult, TInput>(pattern, data)\n      .pipe(timeout(5000));\n"),e.k0s()(),e.j41(694,"pre")(695,"code",21),e.EFF(696,"\nthis.client\n      .send(pattern, data)\n      .pipe(timeout(5000));\n"),e.k0s()(),e.j41(697,"blockquote",22)(698,"strong"),e.EFF(699,"Hint"),e.k0s(),e.EFF(700," The "),e.j41(701,"code"),e.EFF(702,"timeout"),e.k0s(),e.EFF(703," operator is imported from the "),e.j41(704,"code"),e.EFF(705,"rxjs/operators"),e.k0s(),e.EFF(706," package.\n"),e.k0s(),e.j41(707,"p"),e.EFF(708,"After 5 seconds, if the microservice isn't responding, it will throw an error."),e.k0s()()),2&s){const o=e.sdS(50),r=e.sdS(208),i=e.sdS(241),F=e.sdS(255),c=e.sdS(287),h=e.sdS(323),m=e.sdS(541),j=e.sdS(586),g=e.sdS(690);e.R7$(47),e.SpI(" ",e.i5U(48,40,"main",o.isJsActive),"\n"),e.R7$(4),e.AVh("hide",o.isJsActive),e.R7$(3),e.AVh("hide",!o.isJsActive),e.R7$(151),e.SpI(" ",e.i5U(206,43,"math.controller",r.isJsActive),"\n"),e.R7$(4),e.AVh("hide",r.isJsActive),e.R7$(3),e.AVh("hide",!r.isJsActive),e.R7$(11),e.Lme("","{"," cmd: 'sum' ","}",""),e.R7$(19),e.AVh("hide",i.isJsActive),e.R7$(3),e.AVh("hide",!i.isJsActive),e.R7$(11),e.AVh("hide",F.isJsActive),e.R7$(3),e.AVh("hide",!F.isJsActive),e.R7$(29),e.AVh("hide",c.isJsActive),e.R7$(3),e.AVh("hide",!c.isJsActive),e.R7$(33),e.AVh("hide",h.isJsActive),e.R7$(3),e.AVh("hide",!h.isJsActive),e.R7$(215),e.AVh("hide",m.isJsActive),e.R7$(3),e.AVh("hide",!m.isJsActive),e.R7$(42),e.AVh("hide",j.isJsActive),e.R7$(3),e.AVh("hide",!j.isJsActive),e.R7$(101),e.AVh("hide",g.isJsActive),e.R7$(3),e.AVh("hide",!g.isJsActive)}},dependencies:[l.O,E.a,v.d,C._,k.Wk,u.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Microservices"}},{path:"redis",component:(()=>{class t extends p.y{static \u0275fac=(()=>{let n;return function(a){return(n||(n=e.xGo(t)))(a||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-redis"]],features:[e.Vt3],decls:198,vars:12,consts:[["contentReference",""],["app2b31cb1229fab1f245311afd007e03f0e648f083",""],["app5474a4497c0619d1f7d2ab106ca59b9617cc9bf1",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/microservices/redis.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","redis"],["rel","nofollow","target","_blank","href","https://redis.io/"],["rel","nofollow","target","_blank","href","https://redis.io/topics/pubsub"],["src","/assets/Redis_1.png",1,"illustrative-image"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","overview"],[1,"filename"],[1,"language-typescript"],[1,"info"],["appAnchor","","id","options"],["rel","nofollow","target","_blank","href","https://redis.github.io/ioredis/index.html#RedisOptions"],["appAnchor","","id","client"],["href","https://docs.nestjs.com/microservices/basics#client"],["appAnchor","","id","context"]],template:function(s,a){if(1&s&&(e.j41(0,"div",3,0)(2,"div",4)(3,"a",5),e.nrm(4,"i",6),e.k0s()(),e.j41(5,"h3",7),e.EFF(6,"Redis"),e.k0s(),e.j41(7,"p"),e.EFF(8,"The "),e.j41(9,"a",8),e.EFF(10,"Redis"),e.k0s(),e.EFF(11," transporter implements the publish/subscribe messaging paradigm and leverages the "),e.j41(12,"a",9),e.EFF(13,"Pub/Sub"),e.k0s(),e.EFF(14," feature of Redis. Published messages are categorized in channels, without knowing what subscribers (if any) will eventually receive the message. Each microservice can subscribe to any number of channels. In addition, more than one channel can be subscribed to at a time. Messages exchanged through channels are "),e.j41(15,"strong"),e.EFF(16,"fire-and-forget"),e.k0s(),e.EFF(17,", which means that if a message is published and there are no subscribers interested in it, the message is removed and cannot be recovered. Thus, you don't have a guarantee that either messages or events will be handled by at least one service. A single message can be subscribed to (and received) by multiple subscribers."),e.k0s(),e.j41(18,"figure"),e.nrm(19,"img",10),e.k0s(),e.j41(20,"h4",11)(21,"span"),e.EFF(22,"Installation"),e.k0s()(),e.j41(23,"p"),e.EFF(24,"To start building Redis-based microservices, first install the required package:"),e.k0s(),e.j41(25,"pre")(26,"code",12),e.EFF(27,"\n$ npm i --save ioredis\n"),e.k0s()(),e.j41(28,"h4",13)(29,"span"),e.EFF(30,"Overview"),e.k0s()(),e.j41(31,"p"),e.EFF(32,"To use the Redis transporter, pass the following options object to the "),e.j41(33,"code"),e.EFF(34,"createMicroservice()"),e.k0s(),e.EFF(35," method:"),e.k0s(),e.j41(36,"span",14),e.EFF(37),e.nI1(38,"extension"),e.nrm(39,"app-tabs",null,1),e.k0s(),e.j41(41,"pre")(42,"code",15),e.EFF(43,"\nconst app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {\n  transport: Transport.REDIS,\n  options: {\n    host: 'localhost',\n    port: 6379,\n  },\n});\n"),e.k0s()(),e.j41(44,"pre")(45,"code",15),e.EFF(46,"\nconst app = await NestFactory.createMicroservice(AppModule, {\n  transport: Transport.REDIS,\n  options: {\n    host: 'localhost',\n    port: 6379,\n  },\n});\n"),e.k0s()(),e.j41(47,"blockquote",16)(48,"strong"),e.EFF(49,"Hint"),e.k0s(),e.EFF(50," The "),e.j41(51,"code"),e.EFF(52,"Transport"),e.k0s(),e.EFF(53," enum is imported from the "),e.j41(54,"code"),e.EFF(55,"@nestjs/microservices"),e.k0s(),e.EFF(56," package.\n"),e.k0s(),e.j41(57,"h4",17)(58,"span"),e.EFF(59,"Options"),e.k0s()(),e.j41(60,"p"),e.EFF(61,"The "),e.j41(62,"code"),e.EFF(63,"options"),e.k0s(),e.EFF(64," property is specific to the chosen transporter. The "),e.j41(65,"strong"),e.EFF(66,"Redis"),e.k0s(),e.EFF(67," transporter exposes the properties described below."),e.k0s(),e.j41(68,"table")(69,"tr")(70,"td")(71,"code"),e.EFF(72,"host"),e.k0s()(),e.j41(73,"td"),e.EFF(74,"Connection url"),e.k0s()(),e.j41(75,"tr")(76,"td")(77,"code"),e.EFF(78,"port"),e.k0s()(),e.j41(79,"td"),e.EFF(80,"Connection port"),e.k0s()(),e.j41(81,"tr")(82,"td")(83,"code"),e.EFF(84,"retryAttempts"),e.k0s()(),e.j41(85,"td"),e.EFF(86,"Number of times to retry message (default: "),e.j41(87,"code"),e.EFF(88,"0"),e.k0s(),e.EFF(89,")"),e.k0s()(),e.j41(90,"tr")(91,"td")(92,"code"),e.EFF(93,"retryDelay"),e.k0s()(),e.j41(94,"td"),e.EFF(95,"Delay between message retry attempts (ms) (default: "),e.j41(96,"code"),e.EFF(97,"0"),e.k0s(),e.EFF(98,")"),e.k0s()(),e.j41(99,"tr")(100,"td")(101,"code"),e.EFF(102,"wildcards"),e.k0s()(),e.j41(103,"td"),e.EFF(104,"Enables Redis wildcard subscriptions, instructing transporter to use "),e.j41(105,"code"),e.EFF(106,"psubscribe"),e.k0s(),e.EFF(107,"/"),e.j41(108,"code"),e.EFF(109,"pmessage"),e.k0s(),e.EFF(110," under the hood. (default: "),e.j41(111,"code"),e.EFF(112,"false"),e.k0s(),e.EFF(113,")"),e.k0s()()(),e.j41(114,"p"),e.EFF(115,"All the properties supported by the official "),e.j41(116,"a",18),e.EFF(117,"ioredis"),e.k0s(),e.EFF(118," client are also supported by this transporter."),e.k0s(),e.j41(119,"h4",19)(120,"span"),e.EFF(121,"Client"),e.k0s()(),e.j41(122,"p"),e.EFF(123,"Like other microservice transporters, you have "),e.j41(124,"a",20),e.EFF(125,"several options"),e.k0s(),e.EFF(126," for creating a Redis "),e.j41(127,"code"),e.EFF(128,"ClientProxy"),e.k0s(),e.EFF(129," instance."),e.k0s(),e.j41(130,"p"),e.EFF(131,"One method for creating an instance is to use the "),e.j41(132,"code"),e.EFF(133,"ClientsModule"),e.k0s(),e.EFF(134,". To create a client instance with the "),e.j41(135,"code"),e.EFF(136,"ClientsModule"),e.k0s(),e.EFF(137,", import it and use the "),e.j41(138,"code"),e.EFF(139,"register()"),e.k0s(),e.EFF(140," method to pass an options object with the same properties shown above in the "),e.j41(141,"code"),e.EFF(142,"createMicroservice()"),e.k0s(),e.EFF(143," method, as well as a "),e.j41(144,"code"),e.EFF(145,"name"),e.k0s(),e.EFF(146," property to be used as the injection token. Read more about "),e.j41(147,"code"),e.EFF(148,"ClientsModule"),e.k0s(),e.j41(149,"a",20),e.EFF(150,"here"),e.k0s(),e.EFF(151,"."),e.k0s(),e.j41(152,"pre")(153,"code",15),e.EFF(154,"\n@Module({\n  imports: [\n    ClientsModule.register([\n      {\n        name: 'MATH_SERVICE',\n        transport: Transport.REDIS,\n        options: {\n          host: 'localhost',\n          port: 6379,\n        }\n      },\n    ]),\n  ]\n  ...\n})\n"),e.k0s()(),e.j41(155,"p"),e.EFF(156,"Other options to create a client (either "),e.j41(157,"code"),e.EFF(158,"ClientProxyFactory"),e.k0s(),e.EFF(159," or "),e.j41(160,"code"),e.EFF(161,"@Client()"),e.k0s(),e.EFF(162,") can be used as well. You can read about them "),e.j41(163,"a",20),e.EFF(164,"here"),e.k0s(),e.EFF(165,"."),e.k0s(),e.j41(166,"h4",21)(167,"span"),e.EFF(168,"Context"),e.k0s()(),e.j41(169,"p"),e.EFF(170,"In more sophisticated scenarios, you may want to access more information about the incoming request. When using the Redis transporter, you can access the "),e.j41(171,"code"),e.EFF(172,"RedisContext"),e.k0s(),e.EFF(173," object."),e.k0s(),e.j41(174,"span",14),e.nrm(175,"app-tabs",null,2),e.k0s(),e.j41(177,"pre")(178,"code",15),e.EFF(179,"\n@MessagePattern('notifications')\ngetNotifications(@Payload() data: number[], @Ctx() context: RedisContext) {\n  console.log(`Channel: ${context.getChannel()}`);\n}\n"),e.k0s()(),e.j41(180,"pre")(181,"code",15),e.EFF(182,"\n@Bind(Payload(), Ctx())\n@MessagePattern('notifications')\ngetNotifications(data, context) {\n  console.log(`Channel: ${context.getChannel()}`);\n}\n"),e.k0s()(),e.j41(183,"blockquote",16)(184,"strong"),e.EFF(185,"Hint"),e.k0s(),e.j41(186,"code"),e.EFF(187,"@Payload()"),e.k0s(),e.EFF(188,", "),e.j41(189,"code"),e.EFF(190,"@Ctx()"),e.k0s(),e.EFF(191," and "),e.j41(192,"code"),e.EFF(193,"RedisContext"),e.k0s(),e.EFF(194," are imported from the "),e.j41(195,"code"),e.EFF(196,"@nestjs/microservices"),e.k0s(),e.EFF(197," package.\n"),e.k0s()()),2&s){const o=e.sdS(40),r=e.sdS(176);e.R7$(37),e.SpI(" ",e.i5U(38,9,"main",o.isJsActive),"\n"),e.R7$(4),e.AVh("hide",o.isJsActive),e.R7$(3),e.AVh("hide",!o.isJsActive),e.R7$(133),e.AVh("hide",r.isJsActive),e.R7$(3),e.AVh("hide",!r.isJsActive)}},dependencies:[l.O,E.a,u.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Redis - Microservices"}},{path:"mqtt",component:(()=>{class t extends p.y{static \u0275fac=(()=>{let n;return function(a){return(n||(n=e.xGo(t)))(a||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-mqtt"]],features:[e.Vt3],decls:271,vars:32,consts:[["contentReference",""],["app77cb60ad8d4c6ce23f6305305c9739af172d3809",""],["app6c2491f90ebf08ee748a123dc5a11998459586b7",""],["appbbf5524549ba89ac3ce60c1d9bb3ed95c2245578",""],["appe58d4aad4cb0d6fcb7d9984a58f01f03e655e224",""],["app698bb9aba77ab0219487e0ddbe83e20cd927b2aa",""],["app08cc22f170cd75d1fa6b9e546b4a0e37ea8c20a0",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/microservices/mqtt.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","mqtt"],["rel","nofollow","target","_blank","href","https://mqtt.org/"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","overview"],[1,"filename"],[1,"language-typescript"],[1,"info"],["appAnchor","","id","options"],["rel","nofollow","target","_blank","href","https://github.com/mqttjs/MQTT.js/#mqttclientstreambuilder-options"],["appAnchor","","id","client"],["href","https://docs.nestjs.com/microservices/basics#client"],["appAnchor","","id","context"],["rel","nofollow","target","_blank","href","https://github.com/mqttjs/mqtt-packet"],["appAnchor","","id","wildcards"],["appAnchor","","id","quality-of-service-qos"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/microservices/custom-transport"],["appAnchor","","id","record-builders"]],template:function(s,a){if(1&s&&(e.j41(0,"div",7,0)(2,"div",8)(3,"a",9),e.nrm(4,"i",10),e.k0s()(),e.j41(5,"h3",11),e.EFF(6,"MQTT"),e.k0s(),e.j41(7,"p")(8,"a",12),e.EFF(9,"MQTT"),e.k0s(),e.EFF(10," (Message Queuing Telemetry Transport) is an open source, lightweight messaging protocol, optimized for low latency. This protocol provides a scalable and cost-efficient way to connect devices using a "),e.j41(11,"strong"),e.EFF(12,"publish/subscribe"),e.k0s(),e.EFF(13," model. A communication system built on MQTT consists of the publishing server, a broker and one or more clients. It is designed for constrained devices and low-bandwidth, high-latency or unreliable networks."),e.k0s(),e.j41(14,"h4",13)(15,"span"),e.EFF(16,"Installation"),e.k0s()(),e.j41(17,"p"),e.EFF(18,"To start building MQTT-based microservices, first install the required package:"),e.k0s(),e.j41(19,"pre")(20,"code",14),e.EFF(21,"\n$ npm i --save mqtt\n"),e.k0s()(),e.j41(22,"h4",15)(23,"span"),e.EFF(24,"Overview"),e.k0s()(),e.j41(25,"p"),e.EFF(26,"To use the MQTT transporter, pass the following options object to the "),e.j41(27,"code"),e.EFF(28,"createMicroservice()"),e.k0s(),e.EFF(29," method:"),e.k0s(),e.j41(30,"span",16),e.EFF(31),e.nI1(32,"extension"),e.nrm(33,"app-tabs",null,1),e.k0s(),e.j41(35,"pre")(36,"code",17),e.EFF(37,"\nconst app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {\n  transport: Transport.MQTT,\n  options: {\n    url: 'mqtt://localhost:1883',\n  },\n});\n"),e.k0s()(),e.j41(38,"pre")(39,"code",17),e.EFF(40,"\nconst app = await NestFactory.createMicroservice(AppModule, {\n  transport: Transport.MQTT,\n  options: {\n    url: 'mqtt://localhost:1883',\n  },\n});\n"),e.k0s()(),e.j41(41,"blockquote",18)(42,"strong"),e.EFF(43,"Hint"),e.k0s(),e.EFF(44," The "),e.j41(45,"code"),e.EFF(46,"Transport"),e.k0s(),e.EFF(47," enum is imported from the "),e.j41(48,"code"),e.EFF(49,"@nestjs/microservices"),e.k0s(),e.EFF(50," package.\n"),e.k0s(),e.j41(51,"h4",19)(52,"span"),e.EFF(53,"Options"),e.k0s()(),e.j41(54,"p"),e.EFF(55,"The "),e.j41(56,"code"),e.EFF(57,"options"),e.k0s(),e.EFF(58," object is specific to the chosen transporter. The "),e.j41(59,"strong"),e.EFF(60,"MQTT"),e.k0s(),e.EFF(61," transporter exposes the properties described "),e.j41(62,"a",20),e.EFF(63,"here"),e.k0s(),e.EFF(64,"."),e.k0s(),e.j41(65,"h4",21)(66,"span"),e.EFF(67,"Client"),e.k0s()(),e.j41(68,"p"),e.EFF(69,"Like other microservice transporters, you have "),e.j41(70,"a",22),e.EFF(71,"several options"),e.k0s(),e.EFF(72," for creating a MQTT "),e.j41(73,"code"),e.EFF(74,"ClientProxy"),e.k0s(),e.EFF(75," instance."),e.k0s(),e.j41(76,"p"),e.EFF(77,"One method for creating an instance is to use use the "),e.j41(78,"code"),e.EFF(79,"ClientsModule"),e.k0s(),e.EFF(80,". To create a client instance with the "),e.j41(81,"code"),e.EFF(82,"ClientsModule"),e.k0s(),e.EFF(83,", import it and use the "),e.j41(84,"code"),e.EFF(85,"register()"),e.k0s(),e.EFF(86," method to pass an options object with the same properties shown above in the "),e.j41(87,"code"),e.EFF(88,"createMicroservice()"),e.k0s(),e.EFF(89," method, as well as a "),e.j41(90,"code"),e.EFF(91,"name"),e.k0s(),e.EFF(92," property to be used as the injection token. Read more about "),e.j41(93,"code"),e.EFF(94,"ClientsModule"),e.k0s(),e.j41(95,"a",22),e.EFF(96,"here"),e.k0s(),e.EFF(97,"."),e.k0s(),e.j41(98,"pre")(99,"code",17),e.EFF(100,"\n@Module({\n  imports: [\n    ClientsModule.register([\n      {\n        name: 'MATH_SERVICE',\n        transport: Transport.MQTT,\n        options: {\n          url: 'mqtt://localhost:1883',\n        }\n      },\n    ]),\n  ]\n  ...\n})\n"),e.k0s()(),e.j41(101,"p"),e.EFF(102,"Other options to create a client (either "),e.j41(103,"code"),e.EFF(104,"ClientProxyFactory"),e.k0s(),e.EFF(105," or "),e.j41(106,"code"),e.EFF(107,"@Client()"),e.k0s(),e.EFF(108,") can be used as well. You can read about them "),e.j41(109,"a",22),e.EFF(110,"here"),e.k0s(),e.EFF(111,"."),e.k0s(),e.j41(112,"h4",23)(113,"span"),e.EFF(114,"Context"),e.k0s()(),e.j41(115,"p"),e.EFF(116,"In more sophisticated scenarios, you may want to access more information about the incoming request. When using the MQTT transporter, you can access the "),e.j41(117,"code"),e.EFF(118,"MqttContext"),e.k0s(),e.EFF(119," object."),e.k0s(),e.j41(120,"span",16),e.nrm(121,"app-tabs",null,2),e.k0s(),e.j41(123,"pre")(124,"code",17),e.EFF(125,"\n@MessagePattern('notifications')\ngetNotifications(@Payload() data: number[], @Ctx() context: MqttContext) {\n  console.log(`Topic: ${context.getTopic()}`);\n}\n"),e.k0s()(),e.j41(126,"pre")(127,"code",17),e.EFF(128,"\n@Bind(Payload(), Ctx())\n@MessagePattern('notifications')\ngetNotifications(data, context) {\n  console.log(`Topic: ${context.getTopic()}`);\n}\n"),e.k0s()(),e.j41(129,"blockquote",18)(130,"strong"),e.EFF(131,"Hint"),e.k0s(),e.j41(132,"code"),e.EFF(133,"@Payload()"),e.k0s(),e.EFF(134,", "),e.j41(135,"code"),e.EFF(136,"@Ctx()"),e.k0s(),e.EFF(137," and "),e.j41(138,"code"),e.EFF(139,"MqttContext"),e.k0s(),e.EFF(140," are imported from the "),e.j41(141,"code"),e.EFF(142,"@nestjs/microservices"),e.k0s(),e.EFF(143," package.\n"),e.k0s(),e.j41(144,"p"),e.EFF(145,"To access the original mqtt "),e.j41(146,"a",24),e.EFF(147,"packet"),e.k0s(),e.EFF(148,", use the "),e.j41(149,"code"),e.EFF(150,"getPacket()"),e.k0s(),e.EFF(151," method of the "),e.j41(152,"code"),e.EFF(153,"MqttContext"),e.k0s(),e.EFF(154," object, as follows:"),e.k0s(),e.j41(155,"span",16),e.nrm(156,"app-tabs",null,3),e.k0s(),e.j41(158,"pre")(159,"code",17),e.EFF(160,"\n@MessagePattern('notifications')\ngetNotifications(@Payload() data: number[], @Ctx() context: MqttContext) {\n  console.log(context.getPacket());\n}\n"),e.k0s()(),e.j41(161,"pre")(162,"code",17),e.EFF(163,"\n@Bind(Payload(), Ctx())\n@MessagePattern('notifications')\ngetNotifications(data, context) {\n  console.log(context.getPacket());\n}\n"),e.k0s()(),e.j41(164,"h4",25)(165,"span"),e.EFF(166,"Wildcards"),e.k0s()(),e.j41(167,"p"),e.EFF(168,"A subscription may be to an explicit topic, or it may include wildcards. Two wildcards are available, "),e.j41(169,"code"),e.EFF(170,"+"),e.k0s(),e.EFF(171," and "),e.j41(172,"code"),e.EFF(173,"#"),e.k0s(),e.EFF(174,". "),e.j41(175,"code"),e.EFF(176,"+"),e.k0s(),e.EFF(177," is a single-level wildcard, while "),e.j41(178,"code"),e.EFF(179,"#"),e.k0s(),e.EFF(180," is a multi-level wildcard which covers many topic levels."),e.k0s(),e.j41(181,"span",16),e.nrm(182,"app-tabs",null,4),e.k0s(),e.j41(184,"pre")(185,"code",17),e.EFF(186,"\n@MessagePattern('sensors/+/temperature/+')\ngetTemperature(@Ctx() context: MqttContext) {\n  console.log(`Topic: ${context.getTopic()}`);\n}\n"),e.k0s()(),e.j41(187,"pre")(188,"code",17),e.EFF(189,"\n@Bind(Ctx())\n@MessagePattern('sensors/+/temperature/+')\ngetTemperature(context) {\n  console.log(`Topic: ${context.getTopic()}`);\n}\n"),e.k0s()(),e.j41(190,"h4",26)(191,"span"),e.EFF(192,"Quality of Service (QoS)"),e.k0s()(),e.j41(193,"p"),e.EFF(194,"Any subscription created with "),e.j41(195,"code"),e.EFF(196,"@MessagePattern"),e.k0s(),e.EFF(197," or "),e.j41(198,"code"),e.EFF(199,"@EventPattern"),e.k0s(),e.EFF(200," decorators will subscribe with QoS 0. If a higher QoS is required, it can be set globally using the "),e.j41(201,"code"),e.EFF(202,"subscribeOptions"),e.k0s(),e.EFF(203," block when establishing the connection as follows:"),e.k0s(),e.j41(204,"span",16),e.EFF(205),e.nI1(206,"extension"),e.nrm(207,"app-tabs",null,5),e.k0s(),e.j41(209,"pre")(210,"code",17),e.EFF(211,"\nconst app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {\n  transport: Transport.MQTT,\n  options: {\n    url: 'mqtt://localhost:1883',\n    subscribeOptions: {\n      qos: 2\n    },\n  },\n});\n"),e.k0s()(),e.j41(212,"pre")(213,"code",17),e.EFF(214,"\nconst app = await NestFactory.createMicroservice(AppModule, {\n  transport: Transport.MQTT,\n  options: {\n    url: 'mqtt://localhost:1883',\n    subscribeOptions: {\n      qos: 2\n    },\n  },\n});\n"),e.k0s()(),e.j41(215,"p"),e.EFF(216,"If a topic specific QoS is required, consider creating a "),e.j41(217,"a",27),e.EFF(218,"Custom transporter"),e.k0s(),e.EFF(219,"."),e.k0s(),e.j41(220,"h4",28)(221,"span"),e.EFF(222,"Record builders"),e.k0s()(),e.j41(223,"p"),e.EFF(224,"To configure message options (adjust the QoS level, set the Retain or DUP flags, or add additional properties to the payload), you can use the "),e.j41(225,"code"),e.EFF(226,"MqttRecordBuilder"),e.k0s(),e.EFF(227," class. For example, to set "),e.j41(228,"code"),e.EFF(229,"QoS"),e.k0s(),e.EFF(230," to "),e.j41(231,"code"),e.EFF(232,"2"),e.k0s(),e.EFF(233," use the "),e.j41(234,"code"),e.EFF(235,"setQoS"),e.k0s(),e.EFF(236," method, as follows:"),e.k0s(),e.j41(237,"pre")(238,"code",17),e.EFF(239,"\nconst userProperties = { 'x-version': '1.0.0' };\nconst record = new MqttRecordBuilder(':cat:')\n  .setProperties({ userProperties })\n  .setQoS(1)\n  .build();\nclient.send('replace-emoji', record).subscribe(...);\n"),e.k0s()(),e.j41(240,"blockquote",18)(241,"strong"),e.EFF(242,"Hint"),e.k0s(),e.j41(243,"code"),e.EFF(244,"MqttRecordBuilder"),e.k0s(),e.EFF(245," class is exported from the "),e.j41(246,"code"),e.EFF(247,"@nestjs/microservices"),e.k0s(),e.EFF(248," package.\n"),e.k0s(),e.j41(249,"p"),e.EFF(250,"And you can read these options on the server-side as well, by accessing the "),e.j41(251,"code"),e.EFF(252,"MqttContext"),e.k0s(),e.EFF(253,"."),e.k0s(),e.j41(254,"span",16),e.nrm(255,"app-tabs",null,6),e.k0s(),e.j41(257,"pre")(258,"code",17),e.EFF(259,"\n@MessagePattern('replace-emoji')\nreplaceEmoji(@Payload() data: string, @Ctx() context: MqttContext): string {\n  const { properties: { userProperties } } = context.getPacket();\n  return userProperties['x-version'] === '1.0.0' ? '\u{1f431}' : '\u{1f408}';\n}\n"),e.k0s()(),e.j41(260,"pre")(261,"code",17),e.EFF(262,"\n@Bind(Payload(), Ctx())\n@MessagePattern('replace-emoji')\nreplaceEmoji(data, context) {\n  const { properties: { userProperties } } = context.getPacket();\n  return userProperties['x-version'] === '1.0.0' ? '\u{1f431}' : '\u{1f408}';\n}\n"),e.k0s()(),e.j41(263,"p"),e.EFF(264,"In some cases you might want to configure user properties for multiple requests, you can pass these options to the "),e.j41(265,"code"),e.EFF(266,"ClientProxyFactory"),e.k0s(),e.EFF(267,"."),e.k0s(),e.j41(268,"pre")(269,"code",17),e.EFF(270,"\nimport { Module } from '@nestjs/common';\nimport { ClientProxyFactory, Transport } from '@nestjs/microservices';\n\n@Module({\n  providers: [\n    {\n      provide: 'API_v1',\n      useFactory: () =>\n        ClientProxyFactory.create({\n          transport: Transport.MQTT,\n          options: {\n            url: 'mqtt://localhost:1833',\n            userProperties: { 'x-version': '1.0.0' },\n          },\n        }),\n    },\n  ],\n})\nexport class ApiModule {}\n"),e.k0s()()()),2&s){const o=e.sdS(34),r=e.sdS(122),i=e.sdS(157),F=e.sdS(183),c=e.sdS(208),h=e.sdS(256);e.R7$(31),e.SpI(" ",e.i5U(32,26,"main",o.isJsActive),"\n"),e.R7$(4),e.AVh("hide",o.isJsActive),e.R7$(3),e.AVh("hide",!o.isJsActive),e.R7$(85),e.AVh("hide",r.isJsActive),e.R7$(3),e.AVh("hide",!r.isJsActive),e.R7$(32),e.AVh("hide",i.isJsActive),e.R7$(3),e.AVh("hide",!i.isJsActive),e.R7$(23),e.AVh("hide",F.isJsActive),e.R7$(3),e.AVh("hide",!F.isJsActive),e.R7$(18),e.SpI(" ",e.i5U(206,29,"main",c.isJsActive),"\n"),e.R7$(4),e.AVh("hide",c.isJsActive),e.R7$(3),e.AVh("hide",!c.isJsActive),e.R7$(45),e.AVh("hide",h.isJsActive),e.R7$(3),e.AVh("hide",!h.isJsActive)}},dependencies:[l.O,E.a,u.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"MQTT - Microservices"}},{path:"nats",component:(()=>{class t extends p.y{static \u0275fac=(()=>{let n;return function(a){return(n||(n=e.xGo(t)))(a||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-nats"]],features:[e.Vt3],decls:268,vars:24,consts:[["contentReference",""],["app6d96a5b77b2c5c3741bfb7338978259ee086d817",""],["app47b52d6019d7a5e8c74c13fac8852454762600c5",""],["appcf20077a6ccaa21869c7c4b28f124d5f184a11b3",""],["app561fd469a72037e59be6aabbae295e8b31d09756",""],["appaf72c8a0565e3ee6c2925dd1522984ba1c085b45",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/microservices/nats.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","nats"],["rel","nofollow","target","_blank","href","https://nats.io"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","overview"],[1,"filename"],[1,"language-typescript"],[1,"info"],["appAnchor","","id","options"],["rel","nofollow","target","_blank","href","https://github.com/nats-io/node-nats#connection-options"],["href","https://docs.nestjs.com/microservices/nats#queue-groups"],["appAnchor","","id","client"],["href","https://docs.nestjs.com/microservices/basics#client"],["appAnchor","","id","request-response"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/microservices/basics#request-response"],["rel","nofollow","target","_blank","href","https://docs.nats.io/nats-concepts/reqreply"],["appAnchor","","id","event-based"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/microservices/basics#event-based"],["rel","nofollow","target","_blank","href","https://docs.nats.io/nats-concepts/pubsub"],["appAnchor","","id","queue-groups"],["rel","nofollow","target","_blank","href","https://docs.nats.io/nats-concepts/queue"],["appAnchor","","id","context"],["appAnchor","","id","wildcards"],["appAnchor","","id","record-builders"]],template:function(s,a){if(1&s&&(e.j41(0,"div",6,0)(2,"div",7)(3,"a",8),e.nrm(4,"i",9),e.k0s()(),e.j41(5,"h3",10),e.EFF(6,"NATS"),e.k0s(),e.j41(7,"p")(8,"a",11),e.EFF(9,"NATS"),e.k0s(),e.EFF(10," is a simple, secure and high performance open source messaging system for cloud native applications, IoT messaging, and microservices architectures. The NATS server is written in the Go programming language, but client libraries to interact with the server are available for dozens of major programming languages. NATS supports both "),e.j41(11,"strong"),e.EFF(12,"At Most Once"),e.k0s(),e.EFF(13," and "),e.j41(14,"strong"),e.EFF(15,"At Least Once"),e.k0s(),e.EFF(16," delivery. It can run anywhere, from large servers and cloud instances, through edge gateways and even Internet of Things devices."),e.k0s(),e.j41(17,"h4",12)(18,"span"),e.EFF(19,"Installation"),e.k0s()(),e.j41(20,"p"),e.EFF(21,"To start building NATS-based microservices, first install the required package:"),e.k0s(),e.j41(22,"pre")(23,"code",13),e.EFF(24,"\n$ npm i --save nats\n"),e.k0s()(),e.j41(25,"h4",14)(26,"span"),e.EFF(27,"Overview"),e.k0s()(),e.j41(28,"p"),e.EFF(29,"To use the NATS transporter, pass the following options object to the "),e.j41(30,"code"),e.EFF(31,"createMicroservice()"),e.k0s(),e.EFF(32," method:"),e.k0s(),e.j41(33,"span",15),e.EFF(34),e.nI1(35,"extension"),e.nrm(36,"app-tabs",null,1),e.k0s(),e.j41(38,"pre")(39,"code",16),e.EFF(40,"\nconst app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {\n  transport: Transport.NATS,\n  options: {\n    servers: ['nats://localhost:4222'],\n  },\n});\n"),e.k0s()(),e.j41(41,"pre")(42,"code",16),e.EFF(43,"\nconst app = await NestFactory.createMicroservice(AppModule, {\n  transport: Transport.NATS,\n  options: {\n    servers: ['nats://localhost:4222'],\n  },\n});\n"),e.k0s()(),e.j41(44,"blockquote",17)(45,"strong"),e.EFF(46,"Hint"),e.k0s(),e.EFF(47," The "),e.j41(48,"code"),e.EFF(49,"Transport"),e.k0s(),e.EFF(50," enum is imported from the "),e.j41(51,"code"),e.EFF(52,"@nestjs/microservices"),e.k0s(),e.EFF(53," package.\n"),e.k0s(),e.j41(54,"h4",18)(55,"span"),e.EFF(56,"Options"),e.k0s()(),e.j41(57,"p"),e.EFF(58,"The "),e.j41(59,"code"),e.EFF(60,"options"),e.k0s(),e.EFF(61," object is specific to the chosen transporter. The "),e.j41(62,"strong"),e.EFF(63,"NATS"),e.k0s(),e.EFF(64," transporter exposes the properties described "),e.j41(65,"a",19),e.EFF(66,"here"),e.k0s(),e.EFF(67,".\nAdditionally, there is a "),e.j41(68,"code"),e.EFF(69,"queue"),e.k0s(),e.EFF(70," property which allows you to specify the name of the queue that your server should subscribe to (leave "),e.j41(71,"code"),e.EFF(72,"undefined"),e.k0s(),e.EFF(73," to ignore this setting). Read more about NATS queue groups "),e.j41(74,"a",20),e.EFF(75,"below"),e.k0s(),e.EFF(76,"."),e.k0s(),e.j41(77,"h4",21)(78,"span"),e.EFF(79,"Client"),e.k0s()(),e.j41(80,"p"),e.EFF(81,"Like other microservice transporters, you have "),e.j41(82,"a",22),e.EFF(83,"several options"),e.k0s(),e.EFF(84," for creating a NATS "),e.j41(85,"code"),e.EFF(86,"ClientProxy"),e.k0s(),e.EFF(87," instance."),e.k0s(),e.j41(88,"p"),e.EFF(89,"One method for creating an instance is to use the "),e.j41(90,"code"),e.EFF(91,"ClientsModule"),e.k0s(),e.EFF(92,". To create a client instance with the "),e.j41(93,"code"),e.EFF(94,"ClientsModule"),e.k0s(),e.EFF(95,", import it and use the "),e.j41(96,"code"),e.EFF(97,"register()"),e.k0s(),e.EFF(98," method to pass an options object with the same properties shown above in the "),e.j41(99,"code"),e.EFF(100,"createMicroservice()"),e.k0s(),e.EFF(101," method, as well as a "),e.j41(102,"code"),e.EFF(103,"name"),e.k0s(),e.EFF(104," property to be used as the injection token. Read more about "),e.j41(105,"code"),e.EFF(106,"ClientsModule"),e.k0s(),e.j41(107,"a",22),e.EFF(108,"here"),e.k0s(),e.EFF(109,"."),e.k0s(),e.j41(110,"pre")(111,"code",16),e.EFF(112,"\n@Module({\n  imports: [\n    ClientsModule.register([\n      {\n        name: 'MATH_SERVICE',\n        transport: Transport.NATS,\n        options: {\n          servers: ['nats://localhost:4222'],\n        }\n      },\n    ]),\n  ]\n  ...\n})\n"),e.k0s()(),e.j41(113,"p"),e.EFF(114,"Other options to create a client (either "),e.j41(115,"code"),e.EFF(116,"ClientProxyFactory"),e.k0s(),e.EFF(117," or "),e.j41(118,"code"),e.EFF(119,"@Client()"),e.k0s(),e.EFF(120,") can be used as well. You can read about them "),e.j41(121,"a",22),e.EFF(122,"here"),e.k0s(),e.EFF(123,"."),e.k0s(),e.j41(124,"h4",23)(125,"span"),e.EFF(126,"Request-response"),e.k0s()(),e.j41(127,"p"),e.EFF(128,"For the "),e.j41(129,"strong"),e.EFF(130,"request-response"),e.k0s(),e.EFF(131," message style ("),e.j41(132,"a",24),e.EFF(133,"read more"),e.k0s(),e.EFF(134,"), the NATS transporter does not use the NATS built-in "),e.j41(135,"a",25),e.EFF(136,"Request-Reply"),e.k0s(),e.EFF(137,' mechanism. Instead, a "request" is published on a given subject using the '),e.j41(138,"code"),e.EFF(139,"publish()"),e.k0s(),e.EFF(140," method with a unique reply subject name, and responders listen on that subject and send responses to the reply subject. Reply subjects are directed back to the requestor dynamically, regardless of location of either party."),e.k0s(),e.j41(141,"h4",26)(142,"span"),e.EFF(143,"Event-based"),e.k0s()(),e.j41(144,"p"),e.EFF(145,"For the "),e.j41(146,"strong"),e.EFF(147,"event-based"),e.k0s(),e.EFF(148," message style ("),e.j41(149,"a",27),e.EFF(150,"read more"),e.k0s(),e.EFF(151,"), the NATS transporter uses NATS built-in "),e.j41(152,"a",28),e.EFF(153,"Publish-Subscribe"),e.k0s(),e.EFF(154," mechanism. A publisher sends a message on a subject and any active subscriber listening on that subject receives the message. Subscribers can also register interest in wildcard subjects that work a bit like a regular expression. This one-to-many pattern is sometimes called fan-out."),e.k0s(),e.j41(155,"h4",29)(156,"span"),e.EFF(157,"Queue groups"),e.k0s()(),e.j41(158,"p"),e.EFF(159,"NATS provides a built-in load balancing feature called "),e.j41(160,"a",30),e.EFF(161,"distributed queues"),e.k0s(),e.EFF(162,". To create a queue subscription, use the "),e.j41(163,"code"),e.EFF(164,"queue"),e.k0s(),e.EFF(165," property as follows:"),e.k0s(),e.j41(166,"span",15),e.EFF(167),e.nI1(168,"extension"),e.nrm(169,"app-tabs",null,2),e.k0s(),e.j41(171,"pre")(172,"code",16),e.EFF(173,"\nconst app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {\n  transport: Transport.NATS,\n  options: {\n    servers: ['nats://localhost:4222'],\n    queue: 'cats_queue',\n  },\n});\n"),e.k0s()(),e.j41(174,"h4",31)(175,"span"),e.EFF(176,"Context"),e.k0s()(),e.j41(177,"p"),e.EFF(178,"In more sophisticated scenarios, you may want to access more information about the incoming request. When using the NATS transporter, you can access the "),e.j41(179,"code"),e.EFF(180,"NatsContext"),e.k0s(),e.EFF(181," object."),e.k0s(),e.j41(182,"span",15),e.nrm(183,"app-tabs",null,3),e.k0s(),e.j41(185,"pre")(186,"code",16),e.EFF(187,"\n@MessagePattern('notifications')\ngetNotifications(@Payload() data: number[], @Ctx() context: NatsContext) {\n  console.log(`Subject: ${context.getSubject()}`);\n}\n"),e.k0s()(),e.j41(188,"pre")(189,"code",16),e.EFF(190,"\n@Bind(Payload(), Ctx())\n@MessagePattern('notifications')\ngetNotifications(data, context) {\n  console.log(`Subject: ${context.getSubject()}`);\n}\n"),e.k0s()(),e.j41(191,"blockquote",17)(192,"strong"),e.EFF(193,"Hint"),e.k0s(),e.j41(194,"code"),e.EFF(195,"@Payload()"),e.k0s(),e.EFF(196,", "),e.j41(197,"code"),e.EFF(198,"@Ctx()"),e.k0s(),e.EFF(199," and "),e.j41(200,"code"),e.EFF(201,"NatsContext"),e.k0s(),e.EFF(202," are imported from the "),e.j41(203,"code"),e.EFF(204,"@nestjs/microservices"),e.k0s(),e.EFF(205," package.\n"),e.k0s(),e.j41(206,"h4",32)(207,"span"),e.EFF(208,"Wildcards"),e.k0s()(),e.j41(209,"p"),e.EFF(210,"A subscription may be to an explicit subject, or it may include wildcards."),e.k0s(),e.j41(211,"span",15),e.nrm(212,"app-tabs",null,4),e.k0s(),e.j41(214,"pre")(215,"code",16),e.EFF(216,"\n@MessagePattern('time.us.*')\ngetDate(@Payload() data: number[], @Ctx() context: NatsContext) {\n  console.log(`Subject: ${context.getSubject()}`); // e.g. \"time.us.east\"\n  return new Date().toLocaleTimeString(...);\n}\n"),e.k0s()(),e.j41(217,"pre")(218,"code",16),e.EFF(219,"\n@Bind(Payload(), Ctx())\n@MessagePattern('time.us.*')\ngetDate(data, context) {\n  console.log(`Subject: ${context.getSubject()}`); // e.g. \"time.us.east\"\n  return new Date().toLocaleTimeString(...);\n}\n"),e.k0s()(),e.j41(220,"h4",33)(221,"span"),e.EFF(222,"Record builders"),e.k0s()(),e.j41(223,"p"),e.EFF(224,"To configure message options, you can use the "),e.j41(225,"code"),e.EFF(226,"NatsRecordBuilder"),e.k0s(),e.EFF(227," class (note: this is doable for event-based flows as well). For example, to add "),e.j41(228,"code"),e.EFF(229,"x-version"),e.k0s(),e.EFF(230," header, use the "),e.j41(231,"code"),e.EFF(232,"setHeaders"),e.k0s(),e.EFF(233," method, as follows:"),e.k0s(),e.j41(234,"pre")(235,"code",16),e.EFF(236,"\nimport * as nats from 'nats';\n\n// somewhere in your code\nconst headers = nats.headers();\nheaders.set('x-version', '1.0.0');\n\nconst record = new NatsRecordBuilder(':cat:').setHeaders(headers).build();\nthis.client.send('replace-emoji', record).subscribe(...);\n"),e.k0s()(),e.j41(237,"blockquote",17)(238,"strong"),e.EFF(239,"Hint"),e.k0s(),e.j41(240,"code"),e.EFF(241,"NatsRecordBuilder"),e.k0s(),e.EFF(242," class is exported from the "),e.j41(243,"code"),e.EFF(244,"@nestjs/microservices"),e.k0s(),e.EFF(245," package.\n"),e.k0s(),e.j41(246,"p"),e.EFF(247,"And you can read these headers on the server-side as well, by accessing the "),e.j41(248,"code"),e.EFF(249,"NatsContext"),e.k0s(),e.EFF(250,", as follows:"),e.k0s(),e.j41(251,"span",15),e.nrm(252,"app-tabs",null,5),e.k0s(),e.j41(254,"pre")(255,"code",16),e.EFF(256,"\n@MessagePattern('replace-emoji')\nreplaceEmoji(@Payload() data: string, @Ctx() context: NatsContext): string {\n  const headers = context.getHeaders();\n  return headers['x-version'] === '1.0.0' ? '\u{1f431}' : '\u{1f408}';\n}\n"),e.k0s()(),e.j41(257,"pre")(258,"code",16),e.EFF(259,"\n@Bind(Payload(), Ctx())\n@MessagePattern('replace-emoji')\nreplaceEmoji(data, context) {\n  const headers = context.getHeaders();\n  return headers['x-version'] === '1.0.0' ? '\u{1f431}' : '\u{1f408}';\n}\n"),e.k0s()(),e.j41(260,"p"),e.EFF(261,"In some cases you might want to configure headers for multiple requests, you can pass these as options to the "),e.j41(262,"code"),e.EFF(263,"ClientProxyFactory"),e.k0s(),e.EFF(264,":"),e.k0s(),e.j41(265,"pre")(266,"code",16),e.EFF(267,"\nimport { Module } from '@nestjs/common';\nimport { ClientProxyFactory, Transport } from '@nestjs/microservices';\n\n@Module({\n  providers: [\n    {\n      provide: 'API_v1',\n      useFactory: () =>\n        ClientProxyFactory.create({\n          transport: Transport.NATS,\n          options: {\n            servers: ['nats://localhost:4222'],\n            headers: { 'x-version': '1.0.0' },\n          },\n        }),\n    },\n  ],\n})\nexport class ApiModule {}\n"),e.k0s()()()),2&s){const o=e.sdS(37),r=e.sdS(170),i=e.sdS(184),F=e.sdS(213),c=e.sdS(253);e.R7$(34),e.SpI(" ",e.i5U(35,18,"main",o.isJsActive),"\n"),e.R7$(4),e.AVh("hide",o.isJsActive),e.R7$(3),e.AVh("hide",!o.isJsActive),e.R7$(126),e.SpI(" ",e.i5U(168,21,"main",r.isJsActive),"\n"),e.R7$(18),e.AVh("hide",i.isJsActive),e.R7$(3),e.AVh("hide",!i.isJsActive),e.R7$(26),e.AVh("hide",F.isJsActive),e.R7$(3),e.AVh("hide",!F.isJsActive),e.R7$(37),e.AVh("hide",c.isJsActive),e.R7$(3),e.AVh("hide",!c.isJsActive)}},dependencies:[l.O,E.a,u.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"NATS - Microservices"}},{path:"grpc",component:(()=>{class t extends p.y{static \u0275fac=(()=>{let n;return function(a){return(n||(n=e.xGo(t)))(a||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-grpc"]],features:[e.Vt3],decls:880,vars:52,consts:[["contentReference",""],["app1a2bb267106b27894229ceedc0fc50e5eab6f89a",""],["app2b0cf146ba861a8c5ce2a0c047a6fb06021dac94",""],["appb4ca308b17ff8bb3fdf3c0b0435e5009d8bdebfb",""],["app1f38fb5ddab1b132d69ecd80093dc2c41e4fed0f",""],["app264c46169b40cd88bccb1f916d9ca068d8c0f31b",""],["app4243ab426aa0c9b9ef374aa9b49f9e538bf663e4",""],["appafaaf76c6e50daa3bcc843781c1ab6e608e179f1",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/microservices/grpc.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","grpc"],["rel","nofollow","target","_blank","href","https://github.com/grpc/grpc-node"],["href","https://protobuf.dev"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","overview"],["href","microservices/grpc#options"],[1,"filename"],[1,"language-typescript"],[1,"info"],[1,"language-json"],["appAnchor","","id","options"],["href","https://github.com/grpc/grpc-node/blob/master/packages/proto-loader/README.md","rel","nofollow","target","_blank"],["href","https://grpc.io/grpc/node/grpc.ServerCredentials.html","rel","nofollow","target","_blank"],["appAnchor","","id","sample-grpc-service"],["href","https://developers.google.com/protocol-buffers"],["href","microservices/basics#request-response"],["appAnchor","","id","client"],[1,"error"],["href","/microservices/basics#client"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/04-grpc"],["appAnchor","","id","grpc-reflection"],["rel","nofollow","target","_blank","href","https://grpc.io/docs/guides/reflection/#overview"],["appAnchor","","id","grpc-streaming"],["rel","nofollow","target","_blank","href","https://grpc.io/docs/guides/concepts/"],["appAnchor","","id","streaming-sample"],["rel","nofollow","target","_blank","href","https://github.com/stephenh/ts-proto"],["rel","nofollow","target","_blank","href","https://github.com/stephenh/ts-proto/blob/main/NESTJS.markdown"],["appAnchor","","id","subject-strategy"],[1,"warning"],["appAnchor","","id","call-stream-handler"],["rel","nofollow","target","_blank","href","https://grpc.github.io/grpc/node/grpc-ClientDuplexStream.html"],["rel","nofollow","target","_blank","href","https://grpc.github.io/grpc/node/grpc-ServerReadableStream.html"],["appAnchor","","id","grpc-metadata"],["href","microservices/grpc#subject-strategy"],["href","microservices/grpc#call-stream-handler"]],template:function(s,a){if(1&s&&(e.j41(0,"div",8,0)(2,"div",9)(3,"a",10),e.nrm(4,"i",11),e.k0s()(),e.j41(5,"h3",12),e.EFF(6,"gRPC"),e.k0s(),e.j41(7,"p")(8,"a",13),e.EFF(9,"gRPC"),e.k0s(),e.EFF(10," is a modern, open source, high performance RPC framework that can run in any environment. It can efficiently connect services in and across data centers with pluggable support for load balancing, tracing, health checking and authentication."),e.k0s(),e.j41(11,"p"),e.EFF(12,"Like many RPC systems, gRPC is based on the concept of defining a service in terms of functions (methods) that can be called remotely. For each method, you define the parameters and return types. Services, parameters, and return types are defined in "),e.j41(13,"code"),e.EFF(14,".proto"),e.k0s(),e.EFF(15," files using Google's open source language-neutral "),e.j41(16,"a",14),e.EFF(17,"protocol buffers"),e.k0s(),e.EFF(18," mechanism."),e.k0s(),e.j41(19,"p"),e.EFF(20,"With the gRPC transporter, Nest uses "),e.j41(21,"code"),e.EFF(22,".proto"),e.k0s(),e.EFF(23," files to dynamically bind clients and servers to make it easy to implement remote procedure calls, automatically serializing and deserializing structured data."),e.k0s(),e.j41(24,"h4",15)(25,"span"),e.EFF(26,"Installation"),e.k0s()(),e.j41(27,"p"),e.EFF(28,"To start building gRPC-based microservices, first install the required packages:"),e.k0s(),e.j41(29,"pre")(30,"code",16),e.EFF(31,"\n$ npm i --save @grpc/grpc-js @grpc/proto-loader\n"),e.k0s()(),e.j41(32,"h4",17)(33,"span"),e.EFF(34,"Overview"),e.k0s()(),e.j41(35,"p"),e.EFF(36,"Like other Nest microservices transport layer implementations, you select the gRPC transporter mechanism using the "),e.j41(37,"code"),e.EFF(38,"transport"),e.k0s(),e.EFF(39," property of the options object passed to the "),e.j41(40,"code"),e.EFF(41,"createMicroservice()"),e.k0s(),e.EFF(42," method. In the following example, we'll set up a hero service. The "),e.j41(43,"code"),e.EFF(44,"options"),e.k0s(),e.EFF(45," property provides metadata about that service; its properties are described "),e.j41(46,"a",18),e.EFF(47,"below"),e.k0s(),e.EFF(48,"."),e.k0s(),e.j41(49,"span",19),e.EFF(50),e.nI1(51,"extension"),e.nrm(52,"app-tabs",null,1),e.k0s(),e.j41(54,"pre")(55,"code",20),e.EFF(56,"\nconst app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {\n  transport: Transport.GRPC,\n  options: {\n    package: 'hero',\n    protoPath: join(__dirname, 'hero/hero.proto'),\n  },\n});\n"),e.k0s()(),e.j41(57,"pre")(58,"code",20),e.EFF(59,"\nconst app = await NestFactory.createMicroservice(AppModule, {\n  transport: Transport.GRPC,\n  options: {\n    package: 'hero',\n    protoPath: join(__dirname, 'hero/hero.proto'),\n  },\n});\n"),e.k0s()(),e.j41(60,"blockquote",21)(61,"strong"),e.EFF(62,"Hint"),e.k0s(),e.EFF(63," The "),e.j41(64,"code"),e.EFF(65,"join()"),e.k0s(),e.EFF(66," function is imported from the "),e.j41(67,"code"),e.EFF(68,"path"),e.k0s(),e.EFF(69," package; the "),e.j41(70,"code"),e.EFF(71,"Transport"),e.k0s(),e.EFF(72," enum is imported from the "),e.j41(73,"code"),e.EFF(74,"@nestjs/microservices"),e.k0s(),e.EFF(75," package.\n"),e.k0s(),e.j41(76,"p"),e.EFF(77,"In the "),e.j41(78,"code"),e.EFF(79,"nest-cli.json"),e.k0s(),e.EFF(80," file, we add the "),e.j41(81,"code"),e.EFF(82,"assets"),e.k0s(),e.EFF(83," property that allows us to distribute non-TypeScript files, and "),e.j41(84,"code"),e.EFF(85,"watchAssets"),e.k0s(),e.EFF(86," - to turn on watching all non-TypeScript assets. In our case, we want "),e.j41(87,"code"),e.EFF(88,".proto"),e.k0s(),e.EFF(89," files to be automatically copied to the "),e.j41(90,"code"),e.EFF(91,"dist"),e.k0s(),e.EFF(92," folder."),e.k0s(),e.j41(93,"pre")(94,"code",22),e.EFF(95,'\n{\n  "compilerOptions": {\n    "assets": ["**/*.proto"],\n    "watchAssets": true\n  }\n}\n'),e.k0s()(),e.j41(96,"h4",23)(97,"span"),e.EFF(98,"Options"),e.k0s()(),e.j41(99,"p"),e.EFF(100,"The "),e.j41(101,"strong"),e.EFF(102,"gRPC"),e.k0s(),e.EFF(103," transporter options object exposes the properties described below."),e.k0s(),e.j41(104,"table")(105,"tr")(106,"td")(107,"code"),e.EFF(108,"package"),e.k0s()(),e.j41(109,"td"),e.EFF(110,"Protobuf package name (matches "),e.j41(111,"code"),e.EFF(112,"package"),e.k0s(),e.EFF(113," setting from "),e.j41(114,"code"),e.EFF(115,".proto"),e.k0s(),e.EFF(116," file). Required"),e.k0s()(),e.j41(117,"tr")(118,"td")(119,"code"),e.EFF(120,"protoPath"),e.k0s()(),e.j41(121,"td"),e.EFF(122," Absolute (or relative to the root dir) path to the "),e.j41(123,"code"),e.EFF(124,".proto"),e.k0s(),e.EFF(125," file. Required "),e.k0s()(),e.j41(126,"tr")(127,"td")(128,"code"),e.EFF(129,"url"),e.k0s()(),e.j41(130,"td"),e.EFF(131,"Connection url. String in the format "),e.j41(132,"code"),e.EFF(133,"ip address/dns name:port"),e.k0s(),e.EFF(134," (for example, "),e.j41(135,"code"),e.EFF(136,"'0.0.0.0:50051'"),e.k0s(),e.EFF(137," for a Docker server) defining the address/port on which the transporter establishes a connection. Optional. Defaults to "),e.j41(138,"code"),e.EFF(139,"'localhost:5000'"),e.k0s()()(),e.j41(140,"tr")(141,"td")(142,"code"),e.EFF(143,"protoLoader"),e.k0s()(),e.j41(144,"td"),e.EFF(145,"NPM package name for the utility to load "),e.j41(146,"code"),e.EFF(147,".proto"),e.k0s(),e.EFF(148," files. Optional. Defaults to "),e.j41(149,"code"),e.EFF(150,"'@grpc/proto-loader'"),e.k0s()()(),e.j41(151,"tr")(152,"td")(153,"code"),e.EFF(154,"loader"),e.k0s()(),e.j41(155,"td")(156,"code"),e.EFF(157,"@grpc/proto-loader"),e.k0s(),e.EFF(158," options. These provide detailed control over the behavior of "),e.j41(159,"code"),e.EFF(160,".proto"),e.k0s(),e.EFF(161," files. Optional. See "),e.j41(162,"a",24),e.EFF(163,"here"),e.k0s(),e.EFF(164," for more details "),e.k0s()(),e.j41(165,"tr")(166,"td")(167,"code"),e.EFF(168,"credentials"),e.k0s()(),e.j41(169,"td"),e.EFF(170," Server credentials. Optional. "),e.j41(171,"a",25),e.EFF(172,"Read more here"),e.k0s()()()(),e.j41(173,"h4",26)(174,"span"),e.EFF(175,"Sample gRPC service"),e.k0s()(),e.j41(176,"p"),e.EFF(177,"Let's define our sample gRPC service called "),e.j41(178,"code"),e.EFF(179,"HeroesService"),e.k0s(),e.EFF(180,". In the above "),e.j41(181,"code"),e.EFF(182,"options"),e.k0s(),e.EFF(183," object, the"),e.j41(184,"code"),e.EFF(185,"protoPath"),e.k0s(),e.EFF(186," property sets a path to the "),e.j41(187,"code"),e.EFF(188,".proto"),e.k0s(),e.EFF(189," definitions file "),e.j41(190,"code"),e.EFF(191,"hero.proto"),e.k0s(),e.EFF(192,". The "),e.j41(193,"code"),e.EFF(194,"hero.proto"),e.k0s(),e.EFF(195," file is structured using "),e.j41(196,"a",27),e.EFF(197,"protocol buffers"),e.k0s(),e.EFF(198,". Here's what it looks like:"),e.k0s(),e.j41(199,"pre")(200,"code",20),e.EFF(201,'\n// hero/hero.proto\nsyntax = "proto3";\n\npackage hero;\n\nservice HeroesService {\n  rpc FindOne (HeroById) returns (Hero) {}\n}\n\nmessage HeroById {\n  int32 id = 1;\n}\n\nmessage Hero {\n  int32 id = 1;\n  string name = 2;\n}\n'),e.k0s()(),e.j41(202,"p"),e.EFF(203,"Our "),e.j41(204,"code"),e.EFF(205,"HeroesService"),e.k0s(),e.EFF(206," exposes a "),e.j41(207,"code"),e.EFF(208,"FindOne()"),e.k0s(),e.EFF(209," method. This method expects an input argument of type "),e.j41(210,"code"),e.EFF(211,"HeroById"),e.k0s(),e.EFF(212," and returns a "),e.j41(213,"code"),e.EFF(214,"Hero"),e.k0s(),e.EFF(215," message (protocol buffers use "),e.j41(216,"code"),e.EFF(217,"message"),e.k0s(),e.EFF(218," elements to define both parameter types and return types)."),e.k0s(),e.j41(219,"p"),e.EFF(220,"Next, we need to implement the service. To define a handler that fulfills this definition, we use the "),e.j41(221,"code"),e.EFF(222,"@GrpcMethod()"),e.k0s(),e.EFF(223," decorator in a controller, as shown below. This decorator provides the metadata needed to declare a method as a gRPC service method."),e.k0s(),e.j41(224,"blockquote",21)(225,"strong"),e.EFF(226,"Hint"),e.k0s(),e.EFF(227," The "),e.j41(228,"code"),e.EFF(229,"@MessagePattern()"),e.k0s(),e.EFF(230," decorator ("),e.j41(231,"a",28),e.EFF(232,"read more"),e.k0s(),e.EFF(233,") introduced in previous microservices chapters is not used with gRPC-based microservices. The "),e.j41(234,"code"),e.EFF(235,"@GrpcMethod()"),e.k0s(),e.EFF(236," decorator effectively takes its place for gRPC-based microservices.\n"),e.k0s(),e.j41(237,"span",19),e.EFF(238),e.nI1(239,"extension"),e.nrm(240,"app-tabs",null,2),e.k0s(),e.j41(242,"pre")(243,"code",20),e.EFF(244,"\n@Controller()\nexport class HeroesController {\n  @GrpcMethod('HeroesService', 'FindOne')\n  findOne(data: HeroById, metadata: Metadata, call: ServerUnaryCall<any, any>): Hero {\n    const items = [\n      { id: 1, name: 'John' },\n      { id: 2, name: 'Doe' },\n    ];\n    return items.find(({ id }) => id === data.id);\n  }\n}\n"),e.k0s()(),e.j41(245,"pre")(246,"code",20),e.EFF(247,"\n@Controller()\nexport class HeroesController {\n  @GrpcMethod('HeroesService', 'FindOne')\n  findOne(data, metadata, call) {\n    const items = [\n      { id: 1, name: 'John' },\n      { id: 2, name: 'Doe' },\n    ];\n    return items.find(({ id }) => id === data.id);\n  }\n}\n"),e.k0s()(),e.j41(248,"blockquote",21)(249,"strong"),e.EFF(250,"Hint"),e.k0s(),e.EFF(251," The "),e.j41(252,"code"),e.EFF(253,"@GrpcMethod()"),e.k0s(),e.EFF(254," decorator is imported from the "),e.j41(255,"code"),e.EFF(256,"@nestjs/microservices"),e.k0s(),e.EFF(257," package, while "),e.j41(258,"code"),e.EFF(259,"Metadata"),e.k0s(),e.EFF(260," and "),e.j41(261,"code"),e.EFF(262,"ServerUnaryCall"),e.k0s(),e.EFF(263," from the "),e.j41(264,"code"),e.EFF(265,"grpc"),e.k0s(),e.EFF(266," package.\n"),e.k0s(),e.j41(267,"p"),e.EFF(268,"The decorator shown above takes two arguments. The first is the service name (e.g., "),e.j41(269,"code"),e.EFF(270,"'HeroesService'"),e.k0s(),e.EFF(271,"), corresponding to the "),e.j41(272,"code"),e.EFF(273,"HeroesService"),e.k0s(),e.EFF(274," service definition in "),e.j41(275,"code"),e.EFF(276,"hero.proto"),e.k0s(),e.EFF(277,". The second (the string "),e.j41(278,"code"),e.EFF(279,"'FindOne'"),e.k0s(),e.EFF(280,") corresponds to the "),e.j41(281,"code"),e.EFF(282,"FindOne()"),e.k0s(),e.EFF(283," rpc method defined within "),e.j41(284,"code"),e.EFF(285,"HeroesService"),e.k0s(),e.EFF(286," in the "),e.j41(287,"code"),e.EFF(288,"hero.proto"),e.k0s(),e.EFF(289," file."),e.k0s(),e.j41(290,"p"),e.EFF(291,"The "),e.j41(292,"code"),e.EFF(293,"findOne()"),e.k0s(),e.EFF(294," handler method takes three arguments, the "),e.j41(295,"code"),e.EFF(296,"data"),e.k0s(),e.EFF(297," passed from the caller, "),e.j41(298,"code"),e.EFF(299,"metadata"),e.k0s(),e.EFF(300," that stores gRPC\nrequest metadata and "),e.j41(301,"code"),e.EFF(302,"call"),e.k0s(),e.EFF(303," to obtain the "),e.j41(304,"code"),e.EFF(305,"GrpcCall"),e.k0s(),e.EFF(306," object properties such as "),e.j41(307,"code"),e.EFF(308,"sendMetadata"),e.k0s(),e.EFF(309," for send metadata to client."),e.k0s(),e.j41(310,"p"),e.EFF(311,"Both "),e.j41(312,"code"),e.EFF(313,"@GrpcMethod()"),e.k0s(),e.EFF(314," decorator arguments are optional. If called without the second argument (e.g., "),e.j41(315,"code"),e.EFF(316,"'FindOne'"),e.k0s(),e.EFF(317,"), Nest will automatically associate the "),e.j41(318,"code"),e.EFF(319,".proto"),e.k0s(),e.EFF(320," file rpc method with the handler based on converting the handler name to upper camel case (e.g., the "),e.j41(321,"code"),e.EFF(322,"findOne"),e.k0s(),e.EFF(323," handler is associated with the "),e.j41(324,"code"),e.EFF(325,"FindOne"),e.k0s(),e.EFF(326," rpc call definition). This is shown below."),e.k0s(),e.j41(327,"span",19),e.EFF(328),e.nI1(329,"extension"),e.nrm(330,"app-tabs",null,3),e.k0s(),e.j41(332,"pre")(333,"code",20),e.EFF(334,"\n@Controller()\nexport class HeroesController {\n  @GrpcMethod('HeroesService')\n  findOne(data: HeroById, metadata: Metadata, call: ServerUnaryCall<any, any>): Hero {\n    const items = [\n      { id: 1, name: 'John' },\n      { id: 2, name: 'Doe' },\n    ];\n    return items.find(({ id }) => id === data.id);\n  }\n}\n"),e.k0s()(),e.j41(335,"pre")(336,"code",20),e.EFF(337,"\n@Controller()\nexport class HeroesController {\n  @GrpcMethod('HeroesService')\n  findOne(data, metadata, call) {\n    const items = [\n      { id: 1, name: 'John' },\n      { id: 2, name: 'Doe' },\n    ];\n    return items.find(({ id }) => id === data.id);\n  }\n}\n"),e.k0s()(),e.j41(338,"p"),e.EFF(339,"You can also omit the first "),e.j41(340,"code"),e.EFF(341,"@GrpcMethod()"),e.k0s(),e.EFF(342," argument. In this case, Nest automatically associates the handler with the service definition from the proto definitions file based on the "),e.j41(343,"strong"),e.EFF(344,"class"),e.k0s(),e.EFF(345," name where the handler is defined. For example, in the following code, class "),e.j41(346,"code"),e.EFF(347,"HeroesService"),e.k0s(),e.EFF(348," associates its handler methods with the "),e.j41(349,"code"),e.EFF(350,"HeroesService"),e.k0s(),e.EFF(351," service definition in the "),e.j41(352,"code"),e.EFF(353,"hero.proto"),e.k0s(),e.EFF(354," file based on the matching of the name "),e.j41(355,"code"),e.EFF(356,"'HeroesService'"),e.k0s(),e.EFF(357,"."),e.k0s(),e.j41(358,"span",19),e.EFF(359),e.nI1(360,"extension"),e.nrm(361,"app-tabs",null,4),e.k0s(),e.j41(363,"pre")(364,"code",20),e.EFF(365,"\n@Controller()\nexport class HeroesService {\n  @GrpcMethod()\n  findOne(data: HeroById, metadata: Metadata, call: ServerUnaryCall<any, any>): Hero {\n    const items = [\n      { id: 1, name: 'John' },\n      { id: 2, name: 'Doe' },\n    ];\n    return items.find(({ id }) => id === data.id);\n  }\n}\n"),e.k0s()(),e.j41(366,"pre")(367,"code",20),e.EFF(368,"\n@Controller()\nexport class HeroesService {\n  @GrpcMethod()\n  findOne(data, metadata, call) {\n    const items = [\n      { id: 1, name: 'John' },\n      { id: 2, name: 'Doe' },\n    ];\n    return items.find(({ id }) => id === data.id);\n  }\n}\n"),e.k0s()(),e.j41(369,"h4",29)(370,"span"),e.EFF(371,"Client"),e.k0s()(),e.j41(372,"p"),e.EFF(373,"Nest applications can act as gRPC clients, consuming services defined in "),e.j41(374,"code"),e.EFF(375,".proto"),e.k0s(),e.EFF(376," files. You access remote services through a "),e.j41(377,"code"),e.EFF(378,"ClientGrpc"),e.k0s(),e.EFF(379," object. You can obtain a "),e.j41(380,"code"),e.EFF(381,"ClientGrpc"),e.k0s(),e.EFF(382," object in several ways."),e.k0s(),e.j41(383,"p"),e.EFF(384,"The preferred technique is to import the "),e.j41(385,"code"),e.EFF(386,"ClientsModule"),e.k0s(),e.EFF(387,". Use the "),e.j41(388,"code"),e.EFF(389,"register()"),e.k0s(),e.EFF(390," method to bind a package of services defined in a "),e.j41(391,"code"),e.EFF(392,".proto"),e.k0s(),e.EFF(393," file to an injection token, and to configure the service. The "),e.j41(394,"code"),e.EFF(395,"name"),e.k0s(),e.EFF(396," property is the injection token. For gRPC services, use "),e.j41(397,"code"),e.EFF(398,"transport: Transport.GRPC"),e.k0s(),e.EFF(399,". The "),e.j41(400,"code"),e.EFF(401,"options"),e.k0s(),e.EFF(402," property is an object with the same properties described "),e.j41(403,"a",18),e.EFF(404,"above"),e.k0s(),e.EFF(405,"."),e.k0s(),e.j41(406,"pre")(407,"code",20),e.EFF(408,"\nimports: [\n  ClientsModule.register([\n    {\n      name: 'HERO_PACKAGE',\n      transport: Transport.GRPC,\n      options: {\n        package: 'hero',\n        protoPath: join(__dirname, 'hero/hero.proto'),\n      },\n    },\n  ]),\n];\n"),e.k0s()(),e.j41(409,"blockquote",21)(410,"strong"),e.EFF(411,"Hint"),e.k0s(),e.EFF(412," The "),e.j41(413,"code"),e.EFF(414,"register()"),e.k0s(),e.EFF(415," method takes an array of objects. Register multiple packages by providing a comma separated list of registration objects.\n"),e.k0s(),e.j41(416,"p"),e.EFF(417,"Once registered, we can inject the configured "),e.j41(418,"code"),e.EFF(419,"ClientGrpc"),e.k0s(),e.EFF(420," object with "),e.j41(421,"code"),e.EFF(422,"@Inject()"),e.k0s(),e.EFF(423,". Then we use the "),e.j41(424,"code"),e.EFF(425,"ClientGrpc"),e.k0s(),e.EFF(426," object's "),e.j41(427,"code"),e.EFF(428,"getService()"),e.k0s(),e.EFF(429," method to retrieve the service instance, as shown below."),e.k0s(),e.j41(430,"pre")(431,"code",20),e.EFF(432,"\n@Injectable()\nexport class AppService implements OnModuleInit {\n  private heroesService: HeroesService;\n\n  constructor(@Inject('HERO_PACKAGE') private client: ClientGrpc) {}\n\n  onModuleInit() {\n    this.heroesService = this.client.getService<HeroesService>('HeroesService');\n  }\n\n  getHero(): Observable<string> {\n    return this.heroesService.findOne({ id: 1 });\n  }\n}\n"),e.k0s()(),e.j41(433,"blockquote",30)(434,"strong"),e.EFF(435,"Warning"),e.k0s(),e.EFF(436," gRPC Client will not send fields that contain underscore "),e.j41(437,"code"),e.EFF(438,"_"),e.k0s(),e.EFF(439," in their names unless the "),e.j41(440,"code"),e.EFF(441,"keepCase"),e.k0s(),e.EFF(442," options is set to "),e.j41(443,"code"),e.EFF(444,"true"),e.k0s(),e.EFF(445," in the proto loader configuration ("),e.j41(446,"code"),e.EFF(447,"options.loader.keepcase"),e.k0s(),e.EFF(448," in the microservice transporter configuration).\n"),e.k0s(),e.j41(449,"p"),e.EFF(450,"Notice that there is a small difference compared to the technique used in other microservice transport methods. Instead of the "),e.j41(451,"code"),e.EFF(452,"ClientProxy"),e.k0s(),e.EFF(453," class, we use the "),e.j41(454,"code"),e.EFF(455,"ClientGrpc"),e.k0s(),e.EFF(456," class, which provides the "),e.j41(457,"code"),e.EFF(458,"getService()"),e.k0s(),e.EFF(459," method. The "),e.j41(460,"code"),e.EFF(461,"getService()"),e.k0s(),e.EFF(462," generic method takes a service name as an argument and returns its instance (if available)."),e.k0s(),e.j41(463,"p"),e.EFF(464,"Alternatively, you can use the "),e.j41(465,"code"),e.EFF(466,"@Client()"),e.k0s(),e.EFF(467," decorator to instantiate a "),e.j41(468,"code"),e.EFF(469,"ClientGrpc"),e.k0s(),e.EFF(470," object, as follows:"),e.k0s(),e.j41(471,"pre")(472,"code",20),e.EFF(473,"\n@Injectable()\nexport class AppService implements OnModuleInit {\n  @Client({\n    transport: Transport.GRPC,\n    options: {\n      package: 'hero',\n      protoPath: join(__dirname, 'hero/hero.proto'),\n    },\n  })\n  client: ClientGrpc;\n\n  private heroesService: HeroesService;\n\n  onModuleInit() {\n    this.heroesService = this.client.getService<HeroesService>('HeroesService');\n  }\n\n  getHero(): Observable<string> {\n    return this.heroesService.findOne({ id: 1 });\n  }\n}\n"),e.k0s()(),e.j41(474,"p"),e.EFF(475,"Finally, for more complex scenarios, we can inject a dynamically configured client using the "),e.j41(476,"code"),e.EFF(477,"ClientProxyFactory"),e.k0s(),e.EFF(478," class as described "),e.j41(479,"a",31),e.EFF(480,"here"),e.k0s(),e.EFF(481,"."),e.k0s(),e.j41(482,"p"),e.EFF(483,"In either case, we end up with a reference to our "),e.j41(484,"code"),e.EFF(485,"HeroesService"),e.k0s(),e.EFF(486," proxy object, which exposes the same set of methods that are defined inside the "),e.j41(487,"code"),e.EFF(488,".proto"),e.k0s(),e.EFF(489," file. Now, when we access this proxy object (i.e., "),e.j41(490,"code"),e.EFF(491,"heroesService"),e.k0s(),e.EFF(492,"), the gRPC system automatically serializes requests, forwards them to the remote system, returns a response, and deserializes the response. Because gRPC shields us from these network communication details, "),e.j41(493,"code"),e.EFF(494,"heroesService"),e.k0s(),e.EFF(495," looks and acts like a local provider."),e.k0s(),e.j41(496,"p"),e.EFF(497,"Note, all service methods are "),e.j41(498,"strong"),e.EFF(499,"lower camel cased"),e.k0s(),e.EFF(500," (in order to follow the natural convention of the language). So, for example, while our "),e.j41(501,"code"),e.EFF(502,".proto"),e.k0s(),e.EFF(503," file "),e.j41(504,"code"),e.EFF(505,"HeroesService"),e.k0s(),e.EFF(506," definition contains the "),e.j41(507,"code"),e.EFF(508,"FindOne()"),e.k0s(),e.EFF(509," function, the "),e.j41(510,"code"),e.EFF(511,"heroesService"),e.k0s(),e.EFF(512," instance will provide the "),e.j41(513,"code"),e.EFF(514,"findOne()"),e.k0s(),e.EFF(515," method."),e.k0s(),e.j41(516,"pre")(517,"code",20),e.EFF(518,"\ninterface HeroesService {\n  findOne(data: { id: number }): Observable<any>;\n}\n"),e.k0s()(),e.j41(519,"p"),e.EFF(520,"A message handler is also able to return an\xa0"),e.j41(521,"code"),e.EFF(522,"Observable"),e.k0s(),e.EFF(523,", in which case the result values will be emitted until the stream is completed."),e.k0s(),e.j41(524,"span",19),e.EFF(525),e.nI1(526,"extension"),e.nrm(527,"app-tabs",null,5),e.k0s(),e.j41(529,"pre")(530,"code",20),e.EFF(531,"\n@Get()\ncall(): Observable<any> {\n  return this.heroesService.findOne({ id: 1 });\n}\n"),e.k0s()(),e.j41(532,"pre")(533,"code",20),e.EFF(534,"\n@Get()\ncall() {\n  return this.heroesService.findOne({ id: 1 });\n}\n"),e.k0s()(),e.j41(535,"p"),e.EFF(536,"To send gRPC metadata (along with the request), you can pass a second argument, as follows:"),e.k0s(),e.j41(537,"pre")(538,"code",20),e.EFF(539,"\ncall(): Observable<any> {\n  const metadata = new Metadata();\n  metadata.add('Set-Cookie', 'yummy_cookie=choco');\n\n  return this.heroesService.findOne({ id: 1 }, metadata);\n}\n"),e.k0s()(),e.j41(540,"blockquote",21)(541,"strong"),e.EFF(542,"Hint"),e.k0s(),e.EFF(543," The "),e.j41(544,"code"),e.EFF(545,"Metadata"),e.k0s(),e.EFF(546," class is imported from the "),e.j41(547,"code"),e.EFF(548,"grpc"),e.k0s(),e.EFF(549," package.\n"),e.k0s(),e.j41(550,"p"),e.EFF(551,"Please note that this would require updating the "),e.j41(552,"code"),e.EFF(553,"HeroesService"),e.k0s(),e.EFF(554," interface that we've defined a few steps earlier."),e.k0s(),e.j41(555,"h4",32)(556,"span"),e.EFF(557,"Example"),e.k0s()(),e.j41(558,"p"),e.EFF(559,"A working example is available "),e.j41(560,"a",33),e.EFF(561,"here"),e.k0s(),e.EFF(562,"."),e.k0s(),e.j41(563,"h4",34)(564,"span"),e.EFF(565,"gRPC Reflection"),e.k0s()(),e.j41(566,"p"),e.EFF(567,"The "),e.j41(568,"a",35),e.EFF(569,"gRPC Server Reflection Specification"),e.k0s(),e.EFF(570," is a standard which allows gRPC clients to request details about the API that the server exposes, akin to exposing an OpenAPI document for a REST API. This can make working with developer debugging tools such as grpc-ui or postman significantly easier."),e.k0s(),e.j41(571,"p"),e.EFF(572,"To add gRPC reflection support to your server, first install the required implementation package:"),e.k0s(),e.j41(573,"pre")(574,"code",16),e.EFF(575,"\n$ npm i --save @grpc/reflection\n"),e.k0s()(),e.j41(576,"p"),e.EFF(577,"Then it can be hooked into the gRPC server using the "),e.j41(578,"code"),e.EFF(579,"onLoadPackageDefinition"),e.k0s(),e.EFF(580," hook in your gRPC server options, as follows:"),e.k0s(),e.j41(581,"span",19),e.EFF(582),e.nI1(583,"extension"),e.nrm(584,"app-tabs",null,6),e.k0s(),e.j41(586,"pre")(587,"code",20),e.EFF(588,"\nimport { ReflectionService } from '@grpc/reflection';\n\nconst app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {\n  options: {\n    onLoadPackageDefinition: (pkg, server) => {\n      new ReflectionService(pkg).addToServer(server);\n    },\n  },\n});\n"),e.k0s()(),e.j41(589,"p"),e.EFF(590,"Now your server will respond to messages requesting API details using the reflection specification."),e.k0s(),e.j41(591,"h4",36)(592,"span"),e.EFF(593,"gRPC Streaming"),e.k0s()(),e.j41(594,"p"),e.EFF(595,"gRPC on its own supports long-term live connections, conventionally known as "),e.j41(596,"code"),e.EFF(597,"streams"),e.k0s(),e.EFF(598,". Streams are useful for cases such as Chatting, Observations or Chunk-data transfers. Find more details in the official documentation "),e.j41(599,"a",37),e.EFF(600,"here"),e.k0s(),e.EFF(601,"."),e.k0s(),e.j41(602,"p"),e.EFF(603,"Nest supports GRPC stream handlers in two possible ways:"),e.k0s(),e.j41(604,"ul")(605,"li"),e.EFF(606,"RxJS "),e.j41(607,"code"),e.EFF(608,"Subject"),e.k0s(),e.EFF(609," + "),e.j41(610,"code"),e.EFF(611,"Observable"),e.k0s(),e.EFF(612," handler: can be useful to write responses right inside of a Controller method or to be passed down to "),e.j41(613,"code"),e.EFF(614,"Subject"),e.k0s(),e.EFF(615,"/"),e.j41(616,"code"),e.EFF(617,"Observable"),e.k0s(),e.EFF(618," consumer"),e.k0s(),e.j41(619,"li"),e.EFF(620,"Pure GRPC call stream handler: can be useful to be passed to some executor which will handle the rest of dispatch for the Node standard "),e.j41(621,"code"),e.EFF(622,"Duplex"),e.k0s(),e.EFF(623," stream handler."),e.k0s()(),e.j41(624,"p"),e.nrm(625,"app-banner-enterprise"),e.k0s(),e.j41(626,"h4",38)(627,"span"),e.EFF(628,"Streaming sample"),e.k0s()(),e.j41(629,"p"),e.EFF(630,"Let's define a new sample gRPC service called "),e.j41(631,"code"),e.EFF(632,"HelloService"),e.k0s(),e.EFF(633,". The "),e.j41(634,"code"),e.EFF(635,"hello.proto"),e.k0s(),e.EFF(636," file is structured using "),e.j41(637,"a",27),e.EFF(638,"protocol buffers"),e.k0s(),e.EFF(639,". Here's what it looks like:"),e.k0s(),e.j41(640,"pre")(641,"code",20),e.EFF(642,'\n// hello/hello.proto\nsyntax = "proto3";\n\npackage hello;\n\nservice HelloService {\n  rpc BidiHello(stream HelloRequest) returns (stream HelloResponse);\n  rpc LotsOfGreetings(stream HelloRequest) returns (HelloResponse);\n}\n\nmessage HelloRequest {\n  string greeting = 1;\n}\n\nmessage HelloResponse {\n  string reply = 1;\n}\n'),e.k0s()(),e.j41(643,"blockquote",21)(644,"strong"),e.EFF(645,"Hint"),e.k0s(),e.EFF(646," The "),e.j41(647,"code"),e.EFF(648,"LotsOfGreetings"),e.k0s(),e.EFF(649," method can be simply implemented with the "),e.j41(650,"code"),e.EFF(651,"@GrpcMethod"),e.k0s(),e.EFF(652," decorator (as in the examples above) since the returned stream can emit multiple values.\n"),e.k0s(),e.j41(653,"p"),e.EFF(654,"Based on this "),e.j41(655,"code"),e.EFF(656,".proto"),e.k0s(),e.EFF(657," file, let's define the "),e.j41(658,"code"),e.EFF(659,"HelloService"),e.k0s(),e.EFF(660," interface:"),e.k0s(),e.j41(661,"pre")(662,"code",20),e.EFF(663,"\ninterface HelloService {\n  bidiHello(upstream: Observable<HelloRequest>): Observable<HelloResponse>;\n  lotsOfGreetings(\n    upstream: Observable<HelloRequest>,\n  ): Observable<HelloResponse>;\n}\n\ninterface HelloRequest {\n  greeting: string;\n}\n\ninterface HelloResponse {\n  reply: string;\n}\n"),e.k0s()(),e.j41(664,"blockquote",21)(665,"strong"),e.EFF(666,"Hint"),e.k0s(),e.EFF(667," The proto interface can be automatically generated by the "),e.j41(668,"a",39),e.EFF(669,"ts-proto"),e.k0s(),e.EFF(670," package, learn more "),e.j41(671,"a",40),e.EFF(672,"here"),e.k0s(),e.EFF(673,".\n"),e.k0s(),e.j41(674,"h4",41)(675,"span"),e.EFF(676,"Subject strategy"),e.k0s()(),e.j41(677,"p"),e.EFF(678,"The "),e.j41(679,"code"),e.EFF(680,"@GrpcStreamMethod()"),e.k0s(),e.EFF(681," decorator provides the function parameter as an RxJS "),e.j41(682,"code"),e.EFF(683,"Observable"),e.k0s(),e.EFF(684,". Thus, we can receive and process multiple messages."),e.k0s(),e.j41(685,"pre")(686,"code",20),e.EFF(687,"\n@GrpcStreamMethod()\nbidiHello(messages: Observable<any>, metadata: Metadata, call: ServerDuplexStream<any, any>): Observable<any> {\n  const subject = new Subject();\n\n  const onNext = message => {\n    console.log(message);\n    subject.next({\n      reply: 'Hello, world!'\n    });\n  };\n  const onComplete = () => subject.complete();\n  messages.subscribe({\n    next: onNext,\n    complete: onComplete,\n  });\n\n\n  return subject.asObservable();\n}\n"),e.k0s()(),e.j41(688,"blockquote",42)(689,"strong"),e.EFF(690,"Warning"),e.k0s(),e.EFF(691," For supporting full-duplex interaction with the "),e.j41(692,"code"),e.EFF(693,"@GrpcStreamMethod()"),e.k0s(),e.EFF(694," decorator, the controller method must return an RxJS "),e.j41(695,"code"),e.EFF(696,"Observable"),e.k0s(),e.EFF(697,".\n"),e.k0s(),e.j41(698,"blockquote",21)(699,"strong"),e.EFF(700,"Hint"),e.k0s(),e.EFF(701," The "),e.j41(702,"code"),e.EFF(703,"Metadata"),e.k0s(),e.EFF(704," and "),e.j41(705,"code"),e.EFF(706,"ServerUnaryCall"),e.k0s(),e.EFF(707," classes/interfaces are imported from the "),e.j41(708,"code"),e.EFF(709,"grpc"),e.k0s(),e.EFF(710," package.\n"),e.k0s(),e.j41(711,"p"),e.EFF(712,"According to the service definition (in the "),e.j41(713,"code"),e.EFF(714,".proto"),e.k0s(),e.EFF(715," file), the "),e.j41(716,"code"),e.EFF(717,"BidiHello"),e.k0s(),e.EFF(718," method should stream requests to the service. To send multiple asynchronous messages to the stream from a client, we leverage an RxJS "),e.j41(719,"code"),e.EFF(720,"ReplaySubject"),e.k0s(),e.EFF(721," class."),e.k0s(),e.j41(722,"pre")(723,"code",20),e.EFF(724,"\nconst helloService = this.client.getService<HelloService>('HelloService');\nconst helloRequest$ = new ReplaySubject<HelloRequest>();\n\nhelloRequest$.next({ greeting: 'Hello (1)!' });\nhelloRequest$.next({ greeting: 'Hello (2)!' });\nhelloRequest$.complete();\n\nreturn helloService.bidiHello(helloRequest$);\n"),e.k0s()(),e.j41(725,"p"),e.EFF(726,"In the example above, we wrote two messages to the stream ("),e.j41(727,"code"),e.EFF(728,"next()"),e.k0s(),e.EFF(729," calls) and notified the service that we've completed sending the data ("),e.j41(730,"code"),e.EFF(731,"complete()"),e.k0s(),e.EFF(732," call)."),e.k0s(),e.j41(733,"h4",43)(734,"span"),e.EFF(735,"Call stream handler"),e.k0s()(),e.j41(736,"p"),e.EFF(737,"When the method return value is defined as "),e.j41(738,"code"),e.EFF(739,"stream"),e.k0s(),e.EFF(740,", the "),e.j41(741,"code"),e.EFF(742,"@GrpcStreamCall()"),e.k0s(),e.EFF(743," decorator provides the function parameter as "),e.j41(744,"code"),e.EFF(745,"grpc.ServerDuplexStream"),e.k0s(),e.EFF(746,", which supports standard methods like "),e.j41(747,"code"),e.EFF(748,".on('data', callback)"),e.k0s(),e.EFF(749,", "),e.j41(750,"code"),e.EFF(751,".write(message)"),e.k0s(),e.EFF(752," or "),e.j41(753,"code"),e.EFF(754,".cancel()"),e.k0s(),e.EFF(755,". Full documentation on available methods can be found "),e.j41(756,"a",44),e.EFF(757,"here"),e.k0s(),e.EFF(758,"."),e.k0s(),e.j41(759,"p"),e.EFF(760,"Alternatively, when the method return value is not a "),e.j41(761,"code"),e.EFF(762,"stream"),e.k0s(),e.EFF(763,", the "),e.j41(764,"code"),e.EFF(765,"@GrpcStreamCall()"),e.k0s(),e.EFF(766," decorator provides two function parameters, respectively "),e.j41(767,"code"),e.EFF(768,"grpc.ServerReadableStream"),e.k0s(),e.EFF(769," (read more "),e.j41(770,"a",45),e.EFF(771,"here"),e.k0s(),e.EFF(772,") and "),e.j41(773,"code"),e.EFF(774,"callback"),e.k0s(),e.EFF(775,"."),e.k0s(),e.j41(776,"p"),e.EFF(777,"Let's start with implementing the "),e.j41(778,"code"),e.EFF(779,"BidiHello"),e.k0s(),e.EFF(780," which should support a full-duplex interaction."),e.k0s(),e.j41(781,"pre")(782,"code",20),e.EFF(783,"\n@GrpcStreamCall()\nbidiHello(requestStream: any) {\n  requestStream.on('data', message => {\n    console.log(message);\n    requestStream.write({\n      reply: 'Hello, world!'\n    });\n  });\n}\n"),e.k0s()(),e.j41(784,"blockquote",21)(785,"strong"),e.EFF(786,"Hint"),e.k0s(),e.EFF(787," This decorator does not require any specific return parameter to be provided. It is expected that the stream will be handled similar to any other standard stream type.\n"),e.k0s(),e.j41(788,"p"),e.EFF(789,"In the example above, we used the "),e.j41(790,"code"),e.EFF(791,"write()"),e.k0s(),e.EFF(792," method to write objects to the response stream. The callback passed into the "),e.j41(793,"code"),e.EFF(794,".on()"),e.k0s(),e.EFF(795," method as a second parameter will be called every time our service receives a new chunk of data."),e.k0s(),e.j41(796,"p"),e.EFF(797,"Let's implement the "),e.j41(798,"code"),e.EFF(799,"LotsOfGreetings"),e.k0s(),e.EFF(800," method."),e.k0s(),e.j41(801,"pre")(802,"code",20),e.EFF(803,"\n@GrpcStreamCall()\nlotsOfGreetings(requestStream: any, callback: (err: unknown, value: HelloResponse) => void) {\n  requestStream.on('data', message => {\n    console.log(message);\n  });\n  requestStream.on('end', () => callback(null, { reply: 'Hello, world!' }));\n}\n"),e.k0s()(),e.j41(804,"p"),e.EFF(805,"Here we used the "),e.j41(806,"code"),e.EFF(807,"callback"),e.k0s(),e.EFF(808," function to send the response once processing of the "),e.j41(809,"code"),e.EFF(810,"requestStream"),e.k0s(),e.EFF(811," has been completed."),e.k0s(),e.j41(812,"h4",46)(813,"span"),e.EFF(814,"gRPC Metadata"),e.k0s()(),e.j41(815,"p"),e.EFF(816,"Metadata is information about a particular RPC call in the form of a list of key-value pairs, where the keys are strings and the values are typically strings but can be binary data. Metadata is opaque to gRPC itself - it lets the client provide information associated with the call to the server and vice versa. Metadata may include authentication tokens, request identifiers and tags for monitoring purposes, and data information such as the number of records in a data set."),e.k0s(),e.j41(817,"p"),e.EFF(818,"To read the metadata in "),e.j41(819,"code"),e.EFF(820,"@GrpcMethod()"),e.k0s(),e.EFF(821," handler, use the second argument (metadata), which is of type "),e.j41(822,"code"),e.EFF(823,"Metadata"),e.k0s(),e.EFF(824," (imported from the "),e.j41(825,"code"),e.EFF(826,"grpc"),e.k0s(),e.EFF(827," package)."),e.k0s(),e.j41(828,"p"),e.EFF(829,"To send back metadata from the handler, use the "),e.j41(830,"code"),e.EFF(831,"ServerUnaryCall#sendMetadata()"),e.k0s(),e.EFF(832," method (third handler argument)."),e.k0s(),e.j41(833,"span",19),e.EFF(834),e.nI1(835,"extension"),e.nrm(836,"app-tabs",null,7),e.k0s(),e.j41(838,"pre")(839,"code",20),e.EFF(840,"\n@Controller()\nexport class HeroesService {\n  @GrpcMethod()\n  findOne(data: HeroById, metadata: Metadata, call: ServerUnaryCall<any, any>): Hero {\n    const serverMetadata = new Metadata();\n    const items = [\n      { id: 1, name: 'John' },\n      { id: 2, name: 'Doe' },\n    ];\n\n    serverMetadata.add('Set-Cookie', 'yummy_cookie=choco');\n    call.sendMetadata(serverMetadata);\n\n    return items.find(({ id }) => id === data.id);\n  }\n}\n"),e.k0s()(),e.j41(841,"pre")(842,"code",20),e.EFF(843,"\n@Controller()\nexport class HeroesService {\n  @GrpcMethod()\n  findOne(data, metadata, call) {\n    const serverMetadata = new Metadata();\n    const items = [\n      { id: 1, name: 'John' },\n      { id: 2, name: 'Doe' },\n    ];\n\n    serverMetadata.add('Set-Cookie', 'yummy_cookie=choco');\n    call.sendMetadata(serverMetadata);\n\n    return items.find(({ id }) => id === data.id);\n  }\n}\n"),e.k0s()(),e.j41(844,"p"),e.EFF(845,"Likewise, to read the metadata in handlers annotated with the "),e.j41(846,"code"),e.EFF(847,"@GrpcStreamMethod()"),e.k0s(),e.EFF(848," handler ("),e.j41(849,"a",47),e.EFF(850,"subject strategy"),e.k0s(),e.EFF(851,"), use the second argument (metadata), which is of type "),e.j41(852,"code"),e.EFF(853,"Metadata"),e.k0s(),e.EFF(854," (imported from the "),e.j41(855,"code"),e.EFF(856,"grpc"),e.k0s(),e.EFF(857," package)."),e.k0s(),e.j41(858,"p"),e.EFF(859,"To send back metadata from the handler, use the "),e.j41(860,"code"),e.EFF(861,"ServerDuplexStream#sendMetadata()"),e.k0s(),e.EFF(862," method (third handler argument)."),e.k0s(),e.j41(863,"p"),e.EFF(864,"To read metadata from within the "),e.j41(865,"a",48),e.EFF(866,"call stream handlers"),e.k0s(),e.EFF(867," (handlers annotated with "),e.j41(868,"code"),e.EFF(869,"@GrpcStreamCall()"),e.k0s(),e.EFF(870," decorator), listen to the "),e.j41(871,"code"),e.EFF(872,"metadata"),e.k0s(),e.EFF(873," event on the "),e.j41(874,"code"),e.EFF(875,"requestStream"),e.k0s(),e.EFF(876," reference, as follows:"),e.k0s(),e.j41(877,"pre")(878,"code",20),e.EFF(879,"\nrequestStream.on('metadata', (metadata: Metadata) => {\n  const meta = metadata.get('X-Meta');\n});\n"),e.k0s()()()),2&s){const o=e.sdS(53),r=e.sdS(241),i=e.sdS(331),F=e.sdS(362),c=e.sdS(528),h=e.sdS(585),m=e.sdS(837);e.R7$(50),e.SpI(" ",e.i5U(51,31,"main",o.isJsActive),"\n"),e.R7$(4),e.AVh("hide",o.isJsActive),e.R7$(3),e.AVh("hide",!o.isJsActive),e.R7$(181),e.SpI(" ",e.i5U(239,34,"heroes.controller",r.isJsActive),"\n"),e.R7$(4),e.AVh("hide",r.isJsActive),e.R7$(3),e.AVh("hide",!r.isJsActive),e.R7$(83),e.SpI(" ",e.i5U(329,37,"heroes.controller",i.isJsActive),"\n"),e.R7$(4),e.AVh("hide",i.isJsActive),e.R7$(3),e.AVh("hide",!i.isJsActive),e.R7$(24),e.SpI(" ",e.i5U(360,40,"heroes.controller",F.isJsActive),"\n"),e.R7$(4),e.AVh("hide",F.isJsActive),e.R7$(3),e.AVh("hide",!F.isJsActive),e.R7$(159),e.SpI(" ",e.i5U(526,43,"heroes.controller",c.isJsActive),"\n"),e.R7$(4),e.AVh("hide",c.isJsActive),e.R7$(3),e.AVh("hide",!c.isJsActive),e.R7$(50),e.SpI(" ",e.i5U(583,46,"main",h.isJsActive),"\n"),e.R7$(252),e.SpI(" ",e.i5U(835,49,"heroes.controller",m.isJsActive),"\n"),e.R7$(4),e.AVh("hide",m.isJsActive),e.R7$(3),e.AVh("hide",!m.isJsActive)}},dependencies:[l.O,E.a,v.d,u.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"gRPC - Microservices"}},{path:"rabbitmq",component:(()=>{class t extends p.y{static \u0275fac=(()=>{let n;return function(a){return(n||(n=e.xGo(t)))(a||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-rabbitmq"]],features:[e.Vt3],decls:324,vars:28,consts:[["contentReference",""],["appab39adb1cec7828db83682a63f728fb2f893c0b6",""],["app1231888659c9f42d4df25a11b8f4cc7a6a9109fc",""],["app6c827a9ae40834734c652cc827311decf43996a4",""],["app244ca6dda0d89a5c36ae2766261c5b78757db0cd",""],["app505702a745d3abbbb796e1d0739bd5479b040349",""],["app0d0ff09167b5a670a3081097b894d4e432e7ff11",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/microservices/rabbitmq.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","rabbitmq"],["rel","nofollow","target","_blank","href","https://www.rabbitmq.com/"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","overview"],[1,"filename"],[1,"language-typescript"],[1,"info"],["appAnchor","","id","options"],["href","https://amqp-node.github.io/amqplib/channel_api.html#channel_consume","rel","nofollow","target","_blank"],["href","https://amqp-node.github.io/amqplib/channel_api.html#channel_assertQueue","rel","nofollow","target","_blank"],["href","https://amqp-node.github.io/amqplib/channel_api.html#connect","rel","nofollow","target","_blank"],["appAnchor","","id","client"],["href","https://docs.nestjs.com/microservices/basics#client"],["appAnchor","","id","context"],["rel","nofollow","target","_blank","href","https://www.rabbitmq.com/channels.html"],["appAnchor","","id","message-acknowledgement"],["rel","nofollow","target","_blank","href","https://www.rabbitmq.com/confirms.html"],["appAnchor","","id","record-builders"]],template:function(s,a){if(1&s&&(e.j41(0,"div",7,0)(2,"div",8)(3,"a",9),e.nrm(4,"i",10),e.k0s()(),e.j41(5,"h3",11),e.EFF(6,"RabbitMQ"),e.k0s(),e.j41(7,"p")(8,"a",12),e.EFF(9,"RabbitMQ"),e.k0s(),e.EFF(10," is an open-source and lightweight message broker which supports multiple messaging protocols. It can be deployed in distributed and federated configurations to meet high-scale, high-availability requirements. In addition, it's the most widely deployed message broker, used worldwide at small startups and large enterprises."),e.k0s(),e.j41(11,"h4",13)(12,"span"),e.EFF(13,"Installation"),e.k0s()(),e.j41(14,"p"),e.EFF(15,"To start building RabbitMQ-based microservices, first install the required packages:"),e.k0s(),e.j41(16,"pre")(17,"code",14),e.EFF(18,"\n$ npm i --save amqplib amqp-connection-manager\n"),e.k0s()(),e.j41(19,"h4",15)(20,"span"),e.EFF(21,"Overview"),e.k0s()(),e.j41(22,"p"),e.EFF(23,"To use the RabbitMQ transporter, pass the following options object to the "),e.j41(24,"code"),e.EFF(25,"createMicroservice()"),e.k0s(),e.EFF(26," method:"),e.k0s(),e.j41(27,"span",16),e.EFF(28),e.nI1(29,"extension"),e.nrm(30,"app-tabs",null,1),e.k0s(),e.j41(32,"pre")(33,"code",17),e.EFF(34,"\nconst app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {\n  transport: Transport.RMQ,\n  options: {\n    urls: ['amqp://localhost:5672'],\n    queue: 'cats_queue',\n    queueOptions: {\n      durable: false\n    },\n  },\n});\n"),e.k0s()(),e.j41(35,"pre")(36,"code",17),e.EFF(37,"\nconst app = await NestFactory.createMicroservice(AppModule, {\n  transport: Transport.RMQ,\n  options: {\n    urls: ['amqp://localhost:5672'],\n    queue: 'cats_queue',\n    queueOptions: {\n      durable: false\n    },\n  },\n});\n"),e.k0s()(),e.j41(38,"blockquote",18)(39,"strong"),e.EFF(40,"Hint"),e.k0s(),e.EFF(41," The "),e.j41(42,"code"),e.EFF(43,"Transport"),e.k0s(),e.EFF(44," enum is imported from the "),e.j41(45,"code"),e.EFF(46,"@nestjs/microservices"),e.k0s(),e.EFF(47," package.\n"),e.k0s(),e.j41(48,"h4",19)(49,"span"),e.EFF(50,"Options"),e.k0s()(),e.j41(51,"p"),e.EFF(52,"The "),e.j41(53,"code"),e.EFF(54,"options"),e.k0s(),e.EFF(55," property is specific to the chosen transporter. The "),e.j41(56,"strong"),e.EFF(57,"RabbitMQ"),e.k0s(),e.EFF(58," transporter exposes the properties described below."),e.k0s(),e.j41(59,"table")(60,"tr")(61,"td")(62,"code"),e.EFF(63,"urls"),e.k0s()(),e.j41(64,"td"),e.EFF(65,"Connection urls"),e.k0s()(),e.j41(66,"tr")(67,"td")(68,"code"),e.EFF(69,"queue"),e.k0s()(),e.j41(70,"td"),e.EFF(71,"Queue name which your server will listen to"),e.k0s()(),e.j41(72,"tr")(73,"td")(74,"code"),e.EFF(75,"prefetchCount"),e.k0s()(),e.j41(76,"td"),e.EFF(77,"Sets the prefetch count for the channel"),e.k0s()(),e.j41(78,"tr")(79,"td")(80,"code"),e.EFF(81,"isGlobalPrefetchCount"),e.k0s()(),e.j41(82,"td"),e.EFF(83,"Enables per channel prefetching"),e.k0s()(),e.j41(84,"tr")(85,"td")(86,"code"),e.EFF(87,"noAck"),e.k0s()(),e.j41(88,"td"),e.EFF(89,"If "),e.j41(90,"code"),e.EFF(91,"false"),e.k0s(),e.EFF(92,", manual acknowledgment mode enabled"),e.k0s()(),e.j41(93,"tr")(94,"td")(95,"code"),e.EFF(96,"consumerTag"),e.k0s()(),e.j41(97,"td"),e.EFF(98,"Consumer Tag Identifier (read more "),e.j41(99,"a",20),e.EFF(100,"here"),e.k0s(),e.EFF(101,")"),e.k0s()(),e.j41(102,"tr")(103,"td")(104,"code"),e.EFF(105,"queueOptions"),e.k0s()(),e.j41(106,"td"),e.EFF(107,"Additional queue options (read more "),e.j41(108,"a",21),e.EFF(109,"here"),e.k0s(),e.EFF(110,")"),e.k0s()(),e.j41(111,"tr")(112,"td")(113,"code"),e.EFF(114,"socketOptions"),e.k0s()(),e.j41(115,"td"),e.EFF(116,"Additional socket options (read more "),e.j41(117,"a",22),e.EFF(118,"here"),e.k0s(),e.EFF(119,")"),e.k0s()(),e.j41(120,"tr")(121,"td")(122,"code"),e.EFF(123,"headers"),e.k0s()(),e.j41(124,"td"),e.EFF(125,"Headers to be sent along with every message"),e.k0s()()(),e.j41(126,"h4",23)(127,"span"),e.EFF(128,"Client"),e.k0s()(),e.j41(129,"p"),e.EFF(130,"Like other microservice transporters, you have "),e.j41(131,"a",24),e.EFF(132,"several options"),e.k0s(),e.EFF(133," for creating a RabbitMQ "),e.j41(134,"code"),e.EFF(135,"ClientProxy"),e.k0s(),e.EFF(136," instance."),e.k0s(),e.j41(137,"p"),e.EFF(138,"One method for creating an instance is to use the "),e.j41(139,"code"),e.EFF(140,"ClientsModule"),e.k0s(),e.EFF(141,". To create a client instance with the "),e.j41(142,"code"),e.EFF(143,"ClientsModule"),e.k0s(),e.EFF(144,", import it and use the "),e.j41(145,"code"),e.EFF(146,"register()"),e.k0s(),e.EFF(147," method to pass an options object with the same properties shown above in the "),e.j41(148,"code"),e.EFF(149,"createMicroservice()"),e.k0s(),e.EFF(150," method, as well as a "),e.j41(151,"code"),e.EFF(152,"name"),e.k0s(),e.EFF(153," property to be used as the injection token. Read more about "),e.j41(154,"code"),e.EFF(155,"ClientsModule"),e.k0s(),e.j41(156,"a",24),e.EFF(157,"here"),e.k0s(),e.EFF(158,"."),e.k0s(),e.j41(159,"pre")(160,"code",17),e.EFF(161,"\n@Module({\n  imports: [\n    ClientsModule.register([\n      {\n        name: 'MATH_SERVICE',\n        transport: Transport.RMQ,\n        options: {\n          urls: ['amqp://localhost:5672'],\n          queue: 'cats_queue',\n          queueOptions: {\n            durable: false\n          },\n        },\n      },\n    ]),\n  ]\n  ...\n})\n"),e.k0s()(),e.j41(162,"p"),e.EFF(163,"Other options to create a client (either "),e.j41(164,"code"),e.EFF(165,"ClientProxyFactory"),e.k0s(),e.EFF(166," or "),e.j41(167,"code"),e.EFF(168,"@Client()"),e.k0s(),e.EFF(169,") can be used as well. You can read about them "),e.j41(170,"a",24),e.EFF(171,"here"),e.k0s(),e.EFF(172,"."),e.k0s(),e.j41(173,"h4",25)(174,"span"),e.EFF(175,"Context"),e.k0s()(),e.j41(176,"p"),e.EFF(177,"In more sophisticated scenarios, you may want to access more information about the incoming request. When using the RabbitMQ transporter, you can access the "),e.j41(178,"code"),e.EFF(179,"RmqContext"),e.k0s(),e.EFF(180," object."),e.k0s(),e.j41(181,"span",16),e.nrm(182,"app-tabs",null,2),e.k0s(),e.j41(184,"pre")(185,"code",17),e.EFF(186,"\n@MessagePattern('notifications')\ngetNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {\n  console.log(`Pattern: ${context.getPattern()}`);\n}\n"),e.k0s()(),e.j41(187,"pre")(188,"code",17),e.EFF(189,"\n@Bind(Payload(), Ctx())\n@MessagePattern('notifications')\ngetNotifications(data, context) {\n  console.log(`Pattern: ${context.getPattern()}`);\n}\n"),e.k0s()(),e.j41(190,"blockquote",18)(191,"strong"),e.EFF(192,"Hint"),e.k0s(),e.j41(193,"code"),e.EFF(194,"@Payload()"),e.k0s(),e.EFF(195,", "),e.j41(196,"code"),e.EFF(197,"@Ctx()"),e.k0s(),e.EFF(198," and "),e.j41(199,"code"),e.EFF(200,"RmqContext"),e.k0s(),e.EFF(201," are imported from the "),e.j41(202,"code"),e.EFF(203,"@nestjs/microservices"),e.k0s(),e.EFF(204," package.\n"),e.k0s(),e.j41(205,"p"),e.EFF(206,"To access the original RabbitMQ message (with the "),e.j41(207,"code"),e.EFF(208,"properties"),e.k0s(),e.EFF(209,", "),e.j41(210,"code"),e.EFF(211,"fields"),e.k0s(),e.EFF(212,", and "),e.j41(213,"code"),e.EFF(214,"content"),e.k0s(),e.EFF(215,"), use the "),e.j41(216,"code"),e.EFF(217,"getMessage()"),e.k0s(),e.EFF(218," method of the "),e.j41(219,"code"),e.EFF(220,"RmqContext"),e.k0s(),e.EFF(221," object, as follows:"),e.k0s(),e.j41(222,"span",16),e.nrm(223,"app-tabs",null,3),e.k0s(),e.j41(225,"pre")(226,"code",17),e.EFF(227,"\n@MessagePattern('notifications')\ngetNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {\n  console.log(context.getMessage());\n}\n"),e.k0s()(),e.j41(228,"pre")(229,"code",17),e.EFF(230,"\n@Bind(Payload(), Ctx())\n@MessagePattern('notifications')\ngetNotifications(data, context) {\n  console.log(context.getMessage());\n}\n"),e.k0s()(),e.j41(231,"p"),e.EFF(232,"To retrieve a reference to the RabbitMQ "),e.j41(233,"a",26),e.EFF(234,"channel"),e.k0s(),e.EFF(235,", use the "),e.j41(236,"code"),e.EFF(237,"getChannelRef"),e.k0s(),e.EFF(238," method of the "),e.j41(239,"code"),e.EFF(240,"RmqContext"),e.k0s(),e.EFF(241," object, as follows:"),e.k0s(),e.j41(242,"span",16),e.nrm(243,"app-tabs",null,4),e.k0s(),e.j41(245,"pre")(246,"code",17),e.EFF(247,"\n@MessagePattern('notifications')\ngetNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {\n  console.log(context.getChannelRef());\n}\n"),e.k0s()(),e.j41(248,"pre")(249,"code",17),e.EFF(250,"\n@Bind(Payload(), Ctx())\n@MessagePattern('notifications')\ngetNotifications(data, context) {\n  console.log(context.getChannelRef());\n}\n"),e.k0s()(),e.j41(251,"h4",27)(252,"span"),e.EFF(253,"Message acknowledgement"),e.k0s()(),e.j41(254,"p"),e.EFF(255,"To make sure a message is never lost, RabbitMQ supports "),e.j41(256,"a",28),e.EFF(257,"message acknowledgements"),e.k0s(),e.EFF(258,". An acknowledgement is sent back by the consumer to tell RabbitMQ that a particular message has been received, processed and that RabbitMQ is free to delete it. If a consumer dies (its channel is closed, connection is closed, or TCP connection is lost) without sending an ack, RabbitMQ will understand that a message wasn't processed fully and will re-queue it."),e.k0s(),e.j41(259,"p"),e.EFF(260,"To enable manual acknowledgment mode, set the "),e.j41(261,"code"),e.EFF(262,"noAck"),e.k0s(),e.EFF(263," property to "),e.j41(264,"code"),e.EFF(265,"false"),e.k0s(),e.EFF(266,":"),e.k0s(),e.j41(267,"pre")(268,"code",17),e.EFF(269,"\noptions: {\n  urls: ['amqp://localhost:5672'],\n  queue: 'cats_queue',\n  noAck: false,\n  queueOptions: {\n    durable: false\n  },\n},\n"),e.k0s()(),e.j41(270,"p"),e.EFF(271,"When manual consumer acknowledgements are turned on, we must send a proper acknowledgement from the worker to signal that we are done with a task."),e.k0s(),e.j41(272,"span",16),e.nrm(273,"app-tabs",null,5),e.k0s(),e.j41(275,"pre")(276,"code",17),e.EFF(277,"\n@MessagePattern('notifications')\ngetNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {\n  const channel = context.getChannelRef();\n  const originalMsg = context.getMessage();\n\n  channel.ack(originalMsg);\n}\n"),e.k0s()(),e.j41(278,"pre")(279,"code",17),e.EFF(280,"\n@Bind(Payload(), Ctx())\n@MessagePattern('notifications')\ngetNotifications(data, context) {\n  const channel = context.getChannelRef();\n  const originalMsg = context.getMessage();\n\n  channel.ack(originalMsg);\n}\n"),e.k0s()(),e.j41(281,"h4",29)(282,"span"),e.EFF(283,"Record builders"),e.k0s()(),e.j41(284,"p"),e.EFF(285,"To configure message options, you can use the "),e.j41(286,"code"),e.EFF(287,"RmqRecordBuilder"),e.k0s(),e.EFF(288," class (note: this is doable for event-based flows as well). For example, to set "),e.j41(289,"code"),e.EFF(290,"headers"),e.k0s(),e.EFF(291," and "),e.j41(292,"code"),e.EFF(293,"priority"),e.k0s(),e.EFF(294," properties, use the "),e.j41(295,"code"),e.EFF(296,"setOptions"),e.k0s(),e.EFF(297," method, as follows:"),e.k0s(),e.j41(298,"pre")(299,"code",17),e.EFF(300,"\nconst message = ':cat:';\nconst record = new RmqRecordBuilder(message)\n  .setOptions({\n    headers: {\n      ['x-version']: '1.0.0',\n    },\n    priority: 3,\n  })\n  .build();\n\nthis.client.send('replace-emoji', record).subscribe(...);\n"),e.k0s()(),e.j41(301,"blockquote",18)(302,"strong"),e.EFF(303,"Hint"),e.k0s(),e.j41(304,"code"),e.EFF(305,"RmqRecordBuilder"),e.k0s(),e.EFF(306," class is exported from the "),e.j41(307,"code"),e.EFF(308,"@nestjs/microservices"),e.k0s(),e.EFF(309," package.\n"),e.k0s(),e.j41(310,"p"),e.EFF(311,"And you can read these values on the server-side as well, by accessing the "),e.j41(312,"code"),e.EFF(313,"RmqContext"),e.k0s(),e.EFF(314,", as follows:"),e.k0s(),e.j41(315,"span",16),e.nrm(316,"app-tabs",null,6),e.k0s(),e.j41(318,"pre")(319,"code",17),e.EFF(320,"\n@MessagePattern('replace-emoji')\nreplaceEmoji(@Payload() data: string, @Ctx() context: RmqContext): string {\n  const { properties: { headers } } = context.getMessage();\n  return headers['x-version'] === '1.0.0' ? '\u{1f431}' : '\u{1f408}';\n}\n"),e.k0s()(),e.j41(321,"pre")(322,"code",17),e.EFF(323,"\n@Bind(Payload(), Ctx())\n@MessagePattern('replace-emoji')\nreplaceEmoji(data, context) {\n  const { properties: { headers } } = context.getMessage();\n  return headers['x-version'] === '1.0.0' ? '\u{1f431}' : '\u{1f408}';\n}\n"),e.k0s()()()),2&s){const o=e.sdS(31),r=e.sdS(183),i=e.sdS(224),F=e.sdS(244),c=e.sdS(274),h=e.sdS(317);e.R7$(28),e.SpI(" ",e.i5U(29,25,"main",o.isJsActive),"\n"),e.R7$(4),e.AVh("hide",o.isJsActive),e.R7$(3),e.AVh("hide",!o.isJsActive),e.R7$(149),e.AVh("hide",r.isJsActive),e.R7$(3),e.AVh("hide",!r.isJsActive),e.R7$(38),e.AVh("hide",i.isJsActive),e.R7$(3),e.AVh("hide",!i.isJsActive),e.R7$(17),e.AVh("hide",F.isJsActive),e.R7$(3),e.AVh("hide",!F.isJsActive),e.R7$(27),e.AVh("hide",c.isJsActive),e.R7$(3),e.AVh("hide",!c.isJsActive),e.R7$(40),e.AVh("hide",h.isJsActive),e.R7$(3),e.AVh("hide",!h.isJsActive)}},dependencies:[l.O,E.a,u.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"RabbitMQ - Microservices"}},{path:"kafka",component:(()=>{class t extends p.y{static \u0275fac=(()=>{let n;return function(a){return(n||(n=e.xGo(t)))(a||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-kafka"]],features:[e.Vt3],decls:660,vars:60,consts:[["contentReference",""],["app404cbfa5a6cbe2fb0ff7735ed98ee2839e04f457",""],["appf96cac04459f50b97d8e62f8dfe30fdf24f00047",""],["appb4ef1f907996e3c39d2461c302a42c6c7be006fe",""],["app84f12b478c2e7d93279bbb40a24917a94cfae3c4",""],["app392072ceb7b80e0ed2ec001d0304029f5e621890",""],["app760b40324d33790fb4e6f28611e6055a9a7b10dd",""],["app697af06017724e546e1824db9c89428a99658400",""],["app656aed852e0caceb93404e53eeb1afefeb81f56a",""],["appaf9642334b1ba9cee14ea51f8fe058cf6e6d1aa6",""],["appd433d8b5fb9e595e36b611841c2d57408cb76cb2",""],["app25cebede405190a3ec8d9287b32e1f3214438a79",""],["appec3502a2e32d4ea529d40b4760667645c7c85fad",""],["appb54f68633fa6129aa0cdd852a94b3c7df2409579",""],["app39cd189f1ffaf1df7e9d0a3ba2664b3dee623672",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/microservices/kafka.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","kafka"],["rel","nofollow","target","_blank","href","https://kafka.apache.org/"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","overview"],[1,"filename"],[1,"language-typescript"],[1,"info"],["appAnchor","","id","options"],["href","https://kafka.js.org/docs/configuration","rel","nofollow","target","blank"],["href","https://kafka.js.org/docs/consuming#a-name-options-a-options","rel","nofollow","target","blank"],["href","https://kafka.js.org/docs/consuming","rel","nofollow","target","blank"],["href","https://kafka.js.org/docs/consuming#frombeginning","rel","nofollow","target","blank"],["href","https://kafka.js.org/docs/producing#options","rel","nofollow","target","blank"],["appAnchor","","id","client"],["href","https://docs.nestjs.com/microservices/basics#client"],["appAnchor","","id","message-pattern"],["rel","nofollow","target","_blank","href","https://www.enterpriseintegrationpatterns.com/patterns/messaging/ReturnAddress.html"],["rel","nofollow","target","_blank","href","https://www.enterpriseintegrationpatterns.com/patterns/messaging/CorrelationIdentifier.html"],["appAnchor","","id","message-response-subscription"],[1,"warning"],["href","/microservices/basics#request-response"],["href","/microservices/basics#event-based"],["appAnchor","","id","incoming"],["appAnchor","","id","outgoing"],["rel","nofollow","target","_blank","href","https://docs.confluent.io/current/ksql/docs/developer-guide/partition-data.html#co-partitioning-requirements"],["appAnchor","","id","event-based"],["href","/microservices/basics#publishing-events"],["appAnchor","","id","context"],["appAnchor","","id","naming-conventions"],["appAnchor","","id","retriable-exceptions"],["appAnchor","","id","commit-offsets"],["rel","nofollow","target","_blank","href","https://kafka.js.org/docs/consuming#autocommit"],["rel","nofollow","target","_blank","href","https://kafka.js.org/docs/consuming#manual-committing"]],template:function(s,a){if(1&s&&(e.j41(0,"div",15,0)(2,"div",16)(3,"a",17),e.nrm(4,"i",18),e.k0s()(),e.j41(5,"h3",19),e.EFF(6,"Kafka"),e.k0s(),e.j41(7,"p")(8,"a",20),e.EFF(9,"Kafka"),e.k0s(),e.EFF(10," is an open source, distributed streaming platform which has three key capabilities:"),e.k0s(),e.j41(11,"ul")(12,"li"),e.EFF(13,"Publish and subscribe to streams of records, similar to a message queue or enterprise messaging system."),e.k0s(),e.j41(14,"li"),e.EFF(15,"Store streams of records in a fault-tolerant durable way."),e.k0s(),e.j41(16,"li"),e.EFF(17,"Process streams of records as they occur."),e.k0s()(),e.j41(18,"p"),e.EFF(19,"The Kafka project aims to provide a unified, high-throughput, low-latency platform for handling real-time data feeds. It integrates very well with Apache Storm and Spark for real-time streaming data analysis."),e.k0s(),e.j41(20,"h4",21)(21,"span"),e.EFF(22,"Installation"),e.k0s()(),e.j41(23,"p"),e.EFF(24,"To start building Kafka-based microservices, first install the required package:"),e.k0s(),e.j41(25,"pre")(26,"code",22),e.EFF(27,"\n$ npm i --save kafkajs\n"),e.k0s()(),e.j41(28,"h4",23)(29,"span"),e.EFF(30,"Overview"),e.k0s()(),e.j41(31,"p"),e.EFF(32,"Like other Nest microservice transport layer implementations, you select the Kafka transporter mechanism using the "),e.j41(33,"code"),e.EFF(34,"transport"),e.k0s(),e.EFF(35," property of the options object passed to the "),e.j41(36,"code"),e.EFF(37,"createMicroservice()"),e.k0s(),e.EFF(38," method, along with an optional "),e.j41(39,"code"),e.EFF(40,"options"),e.k0s(),e.EFF(41," property, as shown below:"),e.k0s(),e.j41(42,"span",24),e.EFF(43),e.nI1(44,"extension"),e.nrm(45,"app-tabs",null,1),e.k0s(),e.j41(47,"pre")(48,"code",25),e.EFF(49,"\nconst app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {\n  transport: Transport.KAFKA,\n  options: {\n    client: {\n      brokers: ['localhost:9092'],\n    }\n  }\n});\n"),e.k0s()(),e.j41(50,"pre")(51,"code",25),e.EFF(52,"\nconst app = await NestFactory.createMicroservice(AppModule, {\n  transport: Transport.KAFKA,\n  options: {\n    client: {\n      brokers: ['localhost:9092'],\n    }\n  }\n});\n"),e.k0s()(),e.j41(53,"blockquote",26)(54,"strong"),e.EFF(55,"Hint"),e.k0s(),e.EFF(56," The "),e.j41(57,"code"),e.EFF(58,"Transport"),e.k0s(),e.EFF(59," enum is imported from the "),e.j41(60,"code"),e.EFF(61,"@nestjs/microservices"),e.k0s(),e.EFF(62," package.\n"),e.k0s(),e.j41(63,"h4",27)(64,"span"),e.EFF(65,"Options"),e.k0s()(),e.j41(66,"p"),e.EFF(67,"The "),e.j41(68,"code"),e.EFF(69,"options"),e.k0s(),e.EFF(70," property is specific to the chosen transporter. The "),e.j41(71,"strong"),e.EFF(72,"Kafka"),e.k0s(),e.EFF(73," transporter exposes the properties described below."),e.k0s(),e.j41(74,"table")(75,"tr")(76,"td")(77,"code"),e.EFF(78,"client"),e.k0s()(),e.j41(79,"td"),e.EFF(80,"Client configuration options (read more "),e.j41(81,"a",28),e.EFF(82,"here"),e.k0s(),e.EFF(83,")"),e.k0s()(),e.j41(84,"tr")(85,"td")(86,"code"),e.EFF(87,"consumer"),e.k0s()(),e.j41(88,"td"),e.EFF(89,"Consumer configuration options (read more "),e.j41(90,"a",29),e.EFF(91,"here"),e.k0s(),e.EFF(92,")"),e.k0s()(),e.j41(93,"tr")(94,"td")(95,"code"),e.EFF(96,"run"),e.k0s()(),e.j41(97,"td"),e.EFF(98,"Run configuration options (read more "),e.j41(99,"a",30),e.EFF(100,"here"),e.k0s(),e.EFF(101,")"),e.k0s()(),e.j41(102,"tr")(103,"td")(104,"code"),e.EFF(105,"subscribe"),e.k0s()(),e.j41(106,"td"),e.EFF(107,"Subscribe configuration options (read more "),e.j41(108,"a",31),e.EFF(109,"here"),e.k0s(),e.EFF(110,")"),e.k0s()(),e.j41(111,"tr")(112,"td")(113,"code"),e.EFF(114,"producer"),e.k0s()(),e.j41(115,"td"),e.EFF(116,"Producer configuration options (read more "),e.j41(117,"a",32),e.EFF(118,"here"),e.k0s(),e.EFF(119,")"),e.k0s()(),e.j41(120,"tr")(121,"td")(122,"code"),e.EFF(123,"send"),e.k0s()(),e.j41(124,"td"),e.EFF(125,"Send configuration options (read more "),e.j41(126,"a",32),e.EFF(127,"here"),e.k0s(),e.EFF(128,")"),e.k0s()(),e.j41(129,"tr")(130,"td")(131,"code"),e.EFF(132,"producerOnlyMode"),e.k0s()(),e.j41(133,"td"),e.EFF(134,"Feature flag to skip consumer group registration and only act as a producer ("),e.j41(135,"code"),e.EFF(136,"boolean"),e.k0s(),e.EFF(137,")"),e.k0s()(),e.j41(138,"tr")(139,"td")(140,"code"),e.EFF(141,"postfixId"),e.k0s()(),e.j41(142,"td"),e.EFF(143,"Change suffix of clientId value ("),e.j41(144,"code"),e.EFF(145,"string"),e.k0s(),e.EFF(146,")"),e.k0s()()(),e.j41(147,"h4",33)(148,"span"),e.EFF(149,"Client"),e.k0s()(),e.j41(150,"p"),e.EFF(151,"There is a small difference in Kafka compared to other microservice transporters. Instead of the "),e.j41(152,"code"),e.EFF(153,"ClientProxy"),e.k0s(),e.EFF(154," class, we use the "),e.j41(155,"code"),e.EFF(156,"ClientKafka"),e.k0s(),e.EFF(157," class."),e.k0s(),e.j41(158,"p"),e.EFF(159,"Like other microservice transporters, you have "),e.j41(160,"a",34),e.EFF(161,"several options"),e.k0s(),e.EFF(162," for creating a "),e.j41(163,"code"),e.EFF(164,"ClientKafka"),e.k0s(),e.EFF(165," instance."),e.k0s(),e.j41(166,"p"),e.EFF(167,"One method for creating an instance is to use the "),e.j41(168,"code"),e.EFF(169,"ClientsModule"),e.k0s(),e.EFF(170,". To create a client instance with the "),e.j41(171,"code"),e.EFF(172,"ClientsModule"),e.k0s(),e.EFF(173,", import it and use the "),e.j41(174,"code"),e.EFF(175,"register()"),e.k0s(),e.EFF(176," method to pass an options object with the same properties shown above in the "),e.j41(177,"code"),e.EFF(178,"createMicroservice()"),e.k0s(),e.EFF(179," method, as well as a "),e.j41(180,"code"),e.EFF(181,"name"),e.k0s(),e.EFF(182," property to be used as the injection token. Read more about "),e.j41(183,"code"),e.EFF(184,"ClientsModule"),e.k0s(),e.j41(185,"a",34),e.EFF(186,"here"),e.k0s(),e.EFF(187,"."),e.k0s(),e.j41(188,"pre")(189,"code",25),e.EFF(190,"\n@Module({\n  imports: [\n    ClientsModule.register([\n      {\n        name: 'HERO_SERVICE',\n        transport: Transport.KAFKA,\n        options: {\n          client: {\n            clientId: 'hero',\n            brokers: ['localhost:9092'],\n          },\n          consumer: {\n            groupId: 'hero-consumer'\n          }\n        }\n      },\n    ]),\n  ]\n  ...\n})\n"),e.k0s()(),e.j41(191,"p"),e.EFF(192,"Other options to create a client (either "),e.j41(193,"code"),e.EFF(194,"ClientProxyFactory"),e.k0s(),e.EFF(195," or "),e.j41(196,"code"),e.EFF(197,"@Client()"),e.k0s(),e.EFF(198,") can be used as well. You can read about them "),e.j41(199,"a",34),e.EFF(200,"here"),e.k0s(),e.EFF(201,"."),e.k0s(),e.j41(202,"p"),e.EFF(203,"Use the "),e.j41(204,"code"),e.EFF(205,"@Client()"),e.k0s(),e.EFF(206," decorator as follows:"),e.k0s(),e.j41(207,"pre")(208,"code",25),e.EFF(209,"\n@Client({\n  transport: Transport.KAFKA,\n  options: {\n    client: {\n      clientId: 'hero',\n      brokers: ['localhost:9092'],\n    },\n    consumer: {\n      groupId: 'hero-consumer'\n    }\n  }\n})\nclient: ClientKafka;\n"),e.k0s()(),e.j41(210,"h4",35)(211,"span"),e.EFF(212,"Message pattern"),e.k0s()(),e.j41(213,"p"),e.EFF(214,"The Kafka microservice message pattern utilizes two topics for the request and reply channels. The "),e.j41(215,"code"),e.EFF(216,"ClientKafka#send()"),e.k0s(),e.EFF(217," method sends messages with a "),e.j41(218,"a",36),e.EFF(219,"return address"),e.k0s(),e.EFF(220," by associating a "),e.j41(221,"a",37),e.EFF(222,"correlation id"),e.k0s(),e.EFF(223,", reply topic, and reply partition with the request message. This requires the "),e.j41(224,"code"),e.EFF(225,"ClientKafka"),e.k0s(),e.EFF(226," instance to be subscribed to the reply topic and assigned to at least one partition before sending a message."),e.k0s(),e.j41(227,"p"),e.EFF(228,"Subsequently, you need to have at least one reply topic partition for every Nest application running. For example, if you are running 4 Nest applications but the reply topic only has 3 partitions, then 1 of the Nest applications will error out when trying to send a message."),e.k0s(),e.j41(229,"p"),e.EFF(230,"When new "),e.j41(231,"code"),e.EFF(232,"ClientKafka"),e.k0s(),e.EFF(233," instances are launched they join the consumer group and subscribe to their respective topics. This process triggers a rebalance of topic partitions assigned to consumers of the consumer group."),e.k0s(),e.j41(234,"p"),e.EFF(235,"Normally, topic partitions are assigned using the round robin partitioner, which assigns topic partitions to a collection of consumers sorted by consumer names which are randomly set on application launch. However, when a new consumer joins the consumer group, the new consumer can be positioned anywhere within the collection of consumers. This creates a condition where pre-existing consumers can be assigned different partitions when the pre-existing consumer is positioned after the new consumer. As a result, the consumers that are assigned different partitions will lose response messages of requests sent before the rebalance."),e.k0s(),e.j41(236,"p"),e.EFF(237,"To prevent the "),e.j41(238,"code"),e.EFF(239,"ClientKafka"),e.k0s(),e.EFF(240," consumers from losing response messages, a Nest-specific built-in custom partitioner is utilized. This custom partitioner assigns partitions to a collection of consumers sorted by high-resolution timestamps ("),e.j41(241,"code"),e.EFF(242,"process.hrtime()"),e.k0s(),e.EFF(243,") that are set on application launch."),e.k0s(),e.j41(244,"h4",38)(245,"span"),e.EFF(246,"Message response subscription"),e.k0s()(),e.j41(247,"blockquote",39)(248,"strong"),e.EFF(249,"Note"),e.k0s(),e.EFF(250," This section is only relevant if you use "),e.j41(251,"a",40),e.EFF(252,"request-response"),e.k0s(),e.EFF(253," message style (with the "),e.j41(254,"code"),e.EFF(255,"@MessagePattern"),e.k0s(),e.EFF(256," decorator and the "),e.j41(257,"code"),e.EFF(258,"ClientKafka#send"),e.k0s(),e.EFF(259," method). Subscribing to the response topic is not necessary for the "),e.j41(260,"a",41),e.EFF(261,"event-based"),e.k0s(),e.EFF(262," communication ("),e.j41(263,"code"),e.EFF(264,"@EventPattern"),e.k0s(),e.EFF(265," decorator and "),e.j41(266,"code"),e.EFF(267,"ClientKafka#emit"),e.k0s(),e.EFF(268," method).\n"),e.k0s(),e.j41(269,"p"),e.EFF(270,"The "),e.j41(271,"code"),e.EFF(272,"ClientKafka"),e.k0s(),e.EFF(273," class provides the "),e.j41(274,"code"),e.EFF(275,"subscribeToResponseOf()"),e.k0s(),e.EFF(276," method. The "),e.j41(277,"code"),e.EFF(278,"subscribeToResponseOf()"),e.k0s(),e.EFF(279," method takes a request's topic name as an argument and adds the derived reply topic name to a collection of reply topics. This method is required when implementing the message pattern."),e.k0s(),e.j41(280,"span",24),e.EFF(281),e.nI1(282,"extension"),e.nrm(283,"app-tabs",null,2),e.k0s(),e.j41(285,"pre")(286,"code",25),e.EFF(287,"\nonModuleInit() {\n  this.client.subscribeToResponseOf('hero.kill.dragon');\n}\n"),e.k0s()(),e.j41(288,"p"),e.EFF(289,"If the "),e.j41(290,"code"),e.EFF(291,"ClientKafka"),e.k0s(),e.EFF(292," instance is created asynchronously, the "),e.j41(293,"code"),e.EFF(294,"subscribeToResponseOf()"),e.k0s(),e.EFF(295," method must be called before calling the "),e.j41(296,"code"),e.EFF(297,"connect()"),e.k0s(),e.EFF(298," method."),e.k0s(),e.j41(299,"span",24),e.EFF(300),e.nI1(301,"extension"),e.nrm(302,"app-tabs",null,3),e.k0s(),e.j41(304,"pre")(305,"code",25),e.EFF(306,"\nasync onModuleInit() {\n  this.client.subscribeToResponseOf('hero.kill.dragon');\n  await this.client.connect();\n}\n"),e.k0s()(),e.j41(307,"h4",42)(308,"span"),e.EFF(309,"Incoming"),e.k0s()(),e.j41(310,"p"),e.EFF(311,"Nest receives incoming Kafka messages as an object with "),e.j41(312,"code"),e.EFF(313,"key"),e.k0s(),e.EFF(314,", "),e.j41(315,"code"),e.EFF(316,"value"),e.k0s(),e.EFF(317,", and "),e.j41(318,"code"),e.EFF(319,"headers"),e.k0s(),e.EFF(320," properties that have values of type "),e.j41(321,"code"),e.EFF(322,"Buffer"),e.k0s(),e.EFF(323,'. Nest then parses these values by transforming the buffers into strings. If the string is "object like", Nest attempts to parse the string as '),e.j41(324,"code"),e.EFF(325,"JSON"),e.k0s(),e.EFF(326,". The "),e.j41(327,"code"),e.EFF(328,"value"),e.k0s(),e.EFF(329," is then passed to its associated handler."),e.k0s(),e.j41(330,"h4",43)(331,"span"),e.EFF(332,"Outgoing"),e.k0s()(),e.j41(333,"p"),e.EFF(334,"Nest sends outgoing Kafka messages after a serialization process when publishing events or sending messages. This occurs on arguments passed to the "),e.j41(335,"code"),e.EFF(336,"ClientKafka"),e.k0s(),e.j41(337,"code"),e.EFF(338,"emit()"),e.k0s(),e.EFF(339," and "),e.j41(340,"code"),e.EFF(341,"send()"),e.k0s(),e.EFF(342," methods or on values returned from a "),e.j41(343,"code"),e.EFF(344,"@MessagePattern"),e.k0s(),e.EFF(345,' method. This serialization "stringifies" objects that are not strings or buffers by using '),e.j41(346,"code"),e.EFF(347,"JSON.stringify()"),e.k0s(),e.EFF(348," or the "),e.j41(349,"code"),e.EFF(350,"toString()"),e.k0s(),e.EFF(351," prototype method."),e.k0s(),e.j41(352,"span",24),e.EFF(353),e.nI1(354,"extension"),e.nrm(355,"app-tabs",null,4),e.k0s(),e.j41(357,"pre")(358,"code",25),e.EFF(359,"\n@Controller()\nexport class HeroesController {\n  @MessagePattern('hero.kill.dragon')\n  killDragon(@Payload() message: KillDragonMessage): any {\n    const dragonId = message.dragonId;\n    const items = [\n      { id: 1, name: 'Mythical Sword' },\n      { id: 2, name: 'Key to Dungeon' },\n    ];\n    return items;\n  }\n}\n"),e.k0s()(),e.j41(360,"blockquote",26)(361,"strong"),e.EFF(362,"Hint"),e.k0s(),e.j41(363,"code"),e.EFF(364,"@Payload()"),e.k0s(),e.EFF(365," is imported from the "),e.j41(366,"code"),e.EFF(367,"@nestjs/microservices"),e.k0s(),e.EFF(368," package.\n"),e.k0s(),e.j41(369,"p"),e.EFF(370,"Outgoing messages can also be keyed by passing an object with the "),e.j41(371,"code"),e.EFF(372,"key"),e.k0s(),e.EFF(373," and "),e.j41(374,"code"),e.EFF(375,"value"),e.k0s(),e.EFF(376," properties. Keying messages is important for meeting the "),e.j41(377,"a",44),e.EFF(378,"co-partitioning requirement"),e.k0s(),e.EFF(379,"."),e.k0s(),e.j41(380,"span",24),e.EFF(381),e.nI1(382,"extension"),e.nrm(383,"app-tabs",null,5),e.k0s(),e.j41(385,"pre")(386,"code",25),e.EFF(387,"\n@Controller()\nexport class HeroesController {\n  @MessagePattern('hero.kill.dragon')\n  killDragon(@Payload() message: KillDragonMessage): any {\n    const realm = 'Nest';\n    const heroId = message.heroId;\n    const dragonId = message.dragonId;\n\n    const items = [\n      { id: 1, name: 'Mythical Sword' },\n      { id: 2, name: 'Key to Dungeon' },\n    ];\n\n    return {\n      headers: {\n        realm\n      },\n      key: heroId,\n      value: items\n    }\n  }\n}\n"),e.k0s()(),e.j41(388,"p"),e.EFF(389,"Additionally, messages passed in this format can also contain custom headers set in the "),e.j41(390,"code"),e.EFF(391,"headers"),e.k0s(),e.EFF(392," hash property. Header hash property values must be either of type "),e.j41(393,"code"),e.EFF(394,"string"),e.k0s(),e.EFF(395," or type "),e.j41(396,"code"),e.EFF(397,"Buffer"),e.k0s(),e.EFF(398,"."),e.k0s(),e.j41(399,"span",24),e.EFF(400),e.nI1(401,"extension"),e.nrm(402,"app-tabs",null,6),e.k0s(),e.j41(404,"pre")(405,"code",25),e.EFF(406,"\n@Controller()\nexport class HeroesController {\n  @MessagePattern('hero.kill.dragon')\n  killDragon(@Payload() message: KillDragonMessage): any {\n    const realm = 'Nest';\n    const heroId = message.heroId;\n    const dragonId = message.dragonId;\n\n    const items = [\n      { id: 1, name: 'Mythical Sword' },\n      { id: 2, name: 'Key to Dungeon' },\n    ];\n\n    return {\n      headers: {\n        kafka_nestRealm: realm\n      },\n      key: heroId,\n      value: items\n    }\n  }\n}\n"),e.k0s()(),e.j41(407,"h4",45)(408,"span"),e.EFF(409,"Event-based"),e.k0s()(),e.j41(410,"p"),e.EFF(411,"While the request-response method is ideal for exchanging messages between services, it is less suitable when your message style is event-based (which in turn is ideal for Kafka) - when you just want to publish events "),e.j41(412,"strong"),e.EFF(413,"without waiting for a response"),e.k0s(),e.EFF(414,". In that case, you do not want the overhead required by request-response for maintaining two topics."),e.k0s(),e.j41(415,"p"),e.EFF(416,"Check out these two sections to learn more about this: "),e.j41(417,"a",41),e.EFF(418,"Overview: Event-based"),e.k0s(),e.EFF(419," and "),e.j41(420,"a",46),e.EFF(421,"Overview: Publishing events"),e.k0s(),e.EFF(422,"."),e.k0s(),e.j41(423,"h4",47)(424,"span"),e.EFF(425,"Context"),e.k0s()(),e.j41(426,"p"),e.EFF(427,"In more sophisticated scenarios, you may want to access more information about the incoming request. When using the Kafka transporter, you can access the "),e.j41(428,"code"),e.EFF(429,"KafkaContext"),e.k0s(),e.EFF(430," object."),e.k0s(),e.j41(431,"span",24),e.nrm(432,"app-tabs",null,7),e.k0s(),e.j41(434,"pre")(435,"code",25),e.EFF(436,"\n@MessagePattern('hero.kill.dragon')\nkillDragon(@Payload() message: KillDragonMessage, @Ctx() context: KafkaContext) {\n  console.log(`Topic: ${context.getTopic()}`);\n}\n"),e.k0s()(),e.j41(437,"pre")(438,"code",25),e.EFF(439,"\n@Bind(Payload(), Ctx())\n@MessagePattern('hero.kill.dragon')\nkillDragon(message, context) {\n  console.log(`Topic: ${context.getTopic()}`);\n}\n"),e.k0s()(),e.j41(440,"blockquote",26)(441,"strong"),e.EFF(442,"Hint"),e.k0s(),e.j41(443,"code"),e.EFF(444,"@Payload()"),e.k0s(),e.EFF(445,", "),e.j41(446,"code"),e.EFF(447,"@Ctx()"),e.k0s(),e.EFF(448," and "),e.j41(449,"code"),e.EFF(450,"KafkaContext"),e.k0s(),e.EFF(451," are imported from the "),e.j41(452,"code"),e.EFF(453,"@nestjs/microservices"),e.k0s(),e.EFF(454," package.\n"),e.k0s(),e.j41(455,"p"),e.EFF(456,"To access the original Kafka "),e.j41(457,"code"),e.EFF(458,"IncomingMessage"),e.k0s(),e.EFF(459," object, use the "),e.j41(460,"code"),e.EFF(461,"getMessage()"),e.k0s(),e.EFF(462," method of the "),e.j41(463,"code"),e.EFF(464,"KafkaContext"),e.k0s(),e.EFF(465," object, as follows:"),e.k0s(),e.j41(466,"span",24),e.nrm(467,"app-tabs",null,8),e.k0s(),e.j41(469,"pre")(470,"code",25),e.EFF(471,"\n@MessagePattern('hero.kill.dragon')\nkillDragon(@Payload() message: KillDragonMessage, @Ctx() context: KafkaContext) {\n  const originalMessage = context.getMessage();\n  const partition = context.getPartition();\n  const { headers, timestamp } = originalMessage;\n}\n"),e.k0s()(),e.j41(472,"pre")(473,"code",25),e.EFF(474,"\n@Bind(Payload(), Ctx())\n@MessagePattern('hero.kill.dragon')\nkillDragon(message, context) {\n  const originalMessage = context.getMessage();\n  const partition = context.getPartition();\n  const { headers, timestamp } = originalMessage;\n}\n"),e.k0s()(),e.j41(475,"p"),e.EFF(476,"Where the "),e.j41(477,"code"),e.EFF(478,"IncomingMessage"),e.k0s(),e.EFF(479," fulfills the following interface:"),e.k0s(),e.j41(480,"pre")(481,"code",25),e.EFF(482,"\ninterface IncomingMessage {\n  topic: string;\n  partition: number;\n  timestamp: string;\n  size: number;\n  attributes: number;\n  offset: string;\n  key: any;\n  value: any;\n  headers: Record<string, any>;\n}\n"),e.k0s()(),e.j41(483,"p"),e.EFF(484,"If your handler involves a slow processing time for each received message you should consider using the "),e.j41(485,"code"),e.EFF(486,"heartbeat"),e.k0s(),e.EFF(487," callback. To retrieve the "),e.j41(488,"code"),e.EFF(489,"heartbeat"),e.k0s(),e.EFF(490," function, use the "),e.j41(491,"code"),e.EFF(492,"getHeartbeat()"),e.k0s(),e.EFF(493," method of the "),e.j41(494,"code"),e.EFF(495,"KafkaContext"),e.k0s(),e.EFF(496,", as follows:"),e.k0s(),e.j41(497,"span",24),e.nrm(498,"app-tabs",null,9),e.k0s(),e.j41(500,"pre")(501,"code",25),e.EFF(502,"\n@MessagePattern('hero.kill.dragon')\nasync killDragon(@Payload() message: KillDragonMessage, @Ctx() context: KafkaContext) {\n  const heartbeat = context.getHeartbeat();\n\n  // Do some slow processing\n  await doWorkPart1();\n\n  // Send heartbeat to not exceed the sessionTimeout\n  await heartbeat();\n\n  // Do some slow processing again\n  await doWorkPart2();\n}\n"),e.k0s()(),e.j41(503,"h4",48)(504,"span"),e.EFF(505,"Naming conventions"),e.k0s()(),e.j41(506,"p"),e.EFF(507,"The Kafka microservice components append a description of their respective role onto the "),e.j41(508,"code"),e.EFF(509,"client.clientId"),e.k0s(),e.EFF(510," and "),e.j41(511,"code"),e.EFF(512,"consumer.groupId"),e.k0s(),e.EFF(513," options to prevent collisions between Nest microservice client and server components. By default the "),e.j41(514,"code"),e.EFF(515,"ClientKafka"),e.k0s(),e.EFF(516," components append "),e.j41(517,"code"),e.EFF(518,"-client"),e.k0s(),e.EFF(519," and the "),e.j41(520,"code"),e.EFF(521,"ServerKafka"),e.k0s(),e.EFF(522," components append "),e.j41(523,"code"),e.EFF(524,"-server"),e.k0s(),e.EFF(525," to both of these options. Note how the provided values below are transformed in that way (as shown in the comments)."),e.k0s(),e.j41(526,"span",24),e.EFF(527),e.nI1(528,"extension"),e.nrm(529,"app-tabs",null,10),e.k0s(),e.j41(531,"pre")(532,"code",25),e.EFF(533,"\nconst app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {\n  transport: Transport.KAFKA,\n  options: {\n    client: {\n      clientId: 'hero', // hero-server\n      brokers: ['localhost:9092'],\n    },\n    consumer: {\n      groupId: 'hero-consumer' // hero-consumer-server\n    },\n  }\n});\n"),e.k0s()(),e.j41(534,"p"),e.EFF(535,"And for the client:"),e.k0s(),e.j41(536,"span",24),e.EFF(537),e.nI1(538,"extension"),e.nrm(539,"app-tabs",null,11),e.k0s(),e.j41(541,"pre")(542,"code",25),e.EFF(543,"\n@Client({\n  transport: Transport.KAFKA,\n  options: {\n    client: {\n      clientId: 'hero', // hero-client\n      brokers: ['localhost:9092'],\n    },\n    consumer: {\n      groupId: 'hero-consumer' // hero-consumer-client\n    }\n  }\n})\nclient: ClientKafka;\n"),e.k0s()(),e.j41(544,"blockquote",26)(545,"strong"),e.EFF(546,"Hint"),e.k0s(),e.EFF(547," Kafka client and consumer naming conventions can be customized by extending "),e.j41(548,"code"),e.EFF(549,"ClientKafka"),e.k0s(),e.EFF(550," and "),e.j41(551,"code"),e.EFF(552,"KafkaServer"),e.k0s(),e.EFF(553," in your own custom provider and overriding the constructor.\n"),e.k0s(),e.j41(554,"p"),e.EFF(555,"Since the Kafka microservice message pattern utilizes two topics for the request and reply channels, a reply pattern should be derived from the request topic. By default, the name of the reply topic is the composite of the request topic name with "),e.j41(556,"code"),e.EFF(557,".reply"),e.k0s(),e.EFF(558," appended."),e.k0s(),e.j41(559,"span",24),e.EFF(560),e.nI1(561,"extension"),e.nrm(562,"app-tabs",null,12),e.k0s(),e.j41(564,"pre")(565,"code",25),e.EFF(566,"\nonModuleInit() {\n  this.client.subscribeToResponseOf('hero.get'); // hero.get.reply\n}\n"),e.k0s()(),e.j41(567,"blockquote",26)(568,"strong"),e.EFF(569,"Hint"),e.k0s(),e.EFF(570," Kafka reply topic naming conventions can be customized by extending "),e.j41(571,"code"),e.EFF(572,"ClientKafka"),e.k0s(),e.EFF(573," in your own custom provider and overriding the "),e.j41(574,"code"),e.EFF(575,"getResponsePatternName"),e.k0s(),e.EFF(576," method.\n"),e.k0s(),e.j41(577,"h4",49)(578,"span"),e.EFF(579,"Retriable exceptions"),e.k0s()(),e.j41(580,"p"),e.EFF(581,"Similar to other transporters, all unhandled exceptions are automatically wrapped into an "),e.j41(582,"code"),e.EFF(583,"RpcException"),e.k0s(),e.EFF(584,' and converted to a "user-friendly" format. However, there are edge-cases when you might want to bypass this mechanism and let exceptions be consumed by the '),e.j41(585,"code"),e.EFF(586,"kafkajs"),e.k0s(),e.EFF(587," driver instead. Throwing an exception when processing a message instructs "),e.j41(588,"code"),e.EFF(589,"kafkajs"),e.k0s(),e.EFF(590," to "),e.j41(591,"strong"),e.EFF(592,"retry"),e.k0s(),e.EFF(593," it (redeliver it) which means that even though the message (or event) handler was triggered, the offset won't be committed to Kafka."),e.k0s(),e.j41(594,"blockquote",39)(595,"strong"),e.EFF(596,"Warning"),e.k0s(),e.EFF(597," For event handlers (event-based communication), all unhandled exceptions are considered "),e.j41(598,"strong"),e.EFF(599,"retriable exceptions"),e.k0s(),e.EFF(600," by default.\n"),e.k0s(),e.j41(601,"p"),e.EFF(602,"For this, you can use a dedicated class called "),e.j41(603,"code"),e.EFF(604,"KafkaRetriableException"),e.k0s(),e.EFF(605,", as follows:"),e.k0s(),e.j41(606,"pre")(607,"code",25),e.EFF(608,"\nthrow new KafkaRetriableException('...');\n"),e.k0s()(),e.j41(609,"blockquote",26)(610,"strong"),e.EFF(611,"Hint"),e.k0s(),e.j41(612,"code"),e.EFF(613,"KafkaRetriableException"),e.k0s(),e.EFF(614," class is exported from the "),e.j41(615,"code"),e.EFF(616,"@nestjs/microservices"),e.k0s(),e.EFF(617," package.\n"),e.k0s(),e.j41(618,"h4",50)(619,"span"),e.EFF(620,"Commit offsets"),e.k0s()(),e.j41(621,"p"),e.EFF(622,"Committing offsets is essential when working with Kafka. Per default, messages will be automatically committed after a specific time. For more information visit "),e.j41(623,"a",51),e.EFF(624,"KafkaJS docs"),e.k0s(),e.EFF(625,". "),e.j41(626,"code"),e.EFF(627,"KafkaContext"),e.k0s(),e.EFF(628," offers a way to access the active consumer for manually committing offsets. The consumer is the KafkaJS consumer and works as the "),e.j41(629,"a",52),e.EFF(630,"native KafkaJS implementation"),e.k0s(),e.EFF(631,"."),e.k0s(),e.j41(632,"span",24),e.nrm(633,"app-tabs",null,13),e.k0s(),e.j41(635,"pre")(636,"code",25),e.EFF(637,"\n@EventPattern('user.created')\nasync handleUserCreated(@Payload() data: IncomingMessage, @Ctx() context: KafkaContext) {\n  // business logic\n  \n  const { offset } = context.getMessage();\n  const partition = context.getPartition();\n  const topic = context.getTopic();\n  const consumer = context.getConsumer();\n  await consumer.commitOffsets([{ topic, partition, offset }])\n}\n"),e.k0s()(),e.j41(638,"pre")(639,"code",25),e.EFF(640,"\n@Bind(Payload(), Ctx())\n@EventPattern('user.created')\nasync handleUserCreated(data, context) {\n  // business logic\n\n  const { offset } = context.getMessage();\n  const partition = context.getPartition();\n  const topic = context.getTopic();\n  const consumer = context.getConsumer();\n  await consumer.commitOffsets([{ topic, partition, offset }])\n}\n"),e.k0s()(),e.j41(641,"p"),e.EFF(642,"To disable auto-committing of messages set "),e.j41(643,"code"),e.EFF(644,"autoCommit: false"),e.k0s(),e.EFF(645," in the "),e.j41(646,"code"),e.EFF(647,"run"),e.k0s(),e.EFF(648," configuration, as follows:"),e.k0s(),e.j41(649,"span",24),e.EFF(650),e.nI1(651,"extension"),e.nrm(652,"app-tabs",null,14),e.k0s(),e.j41(654,"pre")(655,"code",25),e.EFF(656,"\nconst app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {\n  transport: Transport.KAFKA,\n  options: {\n    client: {\n      brokers: ['localhost:9092'],\n    },\n    run: {\n      autoCommit: false\n    }\n  }\n});\n"),e.k0s()(),e.j41(657,"pre")(658,"code",25),e.EFF(659,"\nconst app = await NestFactory.createMicroservice(AppModule, {\n  transport: Transport.KAFKA,\n  options: {\n    client: {\n      brokers: ['localhost:9092'],\n    },\n    run: {\n      autoCommit: false\n    }\n  }\n});\n"),e.k0s()()()),2&s){const o=e.sdS(46),r=e.sdS(284),i=e.sdS(303),F=e.sdS(356),c=e.sdS(384),h=e.sdS(403),m=e.sdS(433),j=e.sdS(468),g=e.sdS(530),M=e.sdS(540),S=e.sdS(563),y=e.sdS(634),f=e.sdS(653);e.R7$(43),e.SpI(" ",e.i5U(44,30,"main",o.isJsActive),"\n"),e.R7$(4),e.AVh("hide",o.isJsActive),e.R7$(3),e.AVh("hide",!o.isJsActive),e.R7$(231),e.SpI(" ",e.i5U(282,33,"heroes.controller",r.isJsActive),"\n"),e.R7$(19),e.SpI(" ",e.i5U(301,36,"heroes.controller",i.isJsActive),"\n"),e.R7$(53),e.SpI(" ",e.i5U(354,39,"heroes.controller",F.isJsActive),"\n"),e.R7$(28),e.SpI(" ",e.i5U(382,42,"heroes.controller",c.isJsActive),"\n"),e.R7$(19),e.SpI(" ",e.i5U(401,45,"heroes.controller",h.isJsActive),"\n"),e.R7$(34),e.AVh("hide",m.isJsActive),e.R7$(3),e.AVh("hide",!m.isJsActive),e.R7$(32),e.AVh("hide",j.isJsActive),e.R7$(3),e.AVh("hide",!j.isJsActive),e.R7$(55),e.SpI(" ",e.i5U(528,48,"main",g.isJsActive),"\n"),e.R7$(10),e.SpI(" ",e.i5U(538,51,"heroes.controller",M.isJsActive),"\n"),e.R7$(23),e.SpI(" ",e.i5U(561,54,"heroes.controller",S.isJsActive),"\n"),e.R7$(75),e.AVh("hide",y.isJsActive),e.R7$(3),e.AVh("hide",!y.isJsActive),e.R7$(12),e.SpI(" ",e.i5U(651,57,"main",f.isJsActive),"\n"),e.R7$(4),e.AVh("hide",f.isJsActive),e.R7$(3),e.AVh("hide",!f.isJsActive)}},dependencies:[l.O,E.a,u.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Kafka - Microservices"}},{path:"pipes",component:(()=>{class t extends p.y{static \u0275fac=(()=>{let n;return function(a){return(n||(n=e.xGo(t)))(a||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-pipes"]],features:[e.Vt3],decls:45,vars:4,consts:[["contentReference",""],["app2fe861df9b9cfda5c1959ae6e1c9b12bc35cae57",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/microservices/pipes.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","pipes"],["routerLink","/pipes"],[1,"info"],["appAnchor","","id","binding-pipes"],[1,"filename"],[1,"language-typescript"]],template:function(s,a){if(1&s&&(e.j41(0,"div",2,0)(2,"div",3)(3,"a",4),e.nrm(4,"i",5),e.k0s()(),e.j41(5,"h3",6),e.EFF(6,"Pipes"),e.k0s(),e.j41(7,"p"),e.EFF(8,"There is no fundamental difference between "),e.j41(9,"a",7),e.EFF(10,"regular pipes"),e.k0s(),e.EFF(11," and microservices pipes. The only difference is that instead of throwing "),e.j41(12,"code"),e.EFF(13,"HttpException"),e.k0s(),e.EFF(14,", you should use "),e.j41(15,"code"),e.EFF(16,"RpcException"),e.k0s(),e.EFF(17,"."),e.k0s(),e.j41(18,"blockquote",8)(19,"strong"),e.EFF(20,"Hint"),e.k0s(),e.EFF(21," The "),e.j41(22,"code"),e.EFF(23,"RpcException"),e.k0s(),e.EFF(24," class is exposed from "),e.j41(25,"code"),e.EFF(26,"@nestjs/microservices"),e.k0s(),e.EFF(27," package.\n"),e.k0s(),e.j41(28,"h4",9)(29,"span"),e.EFF(30,"Binding pipes"),e.k0s()(),e.j41(31,"p"),e.EFF(32,"The following example uses a manually instantiated method-scoped pipe. Just as with HTTP based applications, you can also use controller-scoped pipes (i.e., prefix the controller class with a "),e.j41(33,"code"),e.EFF(34,"@UsePipes()"),e.k0s(),e.EFF(35," decorator)."),e.k0s(),e.j41(36,"span",10),e.nrm(37,"app-tabs",null,1),e.k0s(),e.j41(39,"pre")(40,"code",11),e.EFF(41,"\n@UsePipes(new ValidationPipe())\n@MessagePattern({ cmd: 'sum' })\naccumulate(data: number[]): number {\n  return (data || []).reduce((a, b) => a + b);\n}\n"),e.k0s()(),e.j41(42,"pre")(43,"code",11),e.EFF(44,"\n@UsePipes(new ValidationPipe())\n@MessagePattern({ cmd: 'sum' })\naccumulate(data) {\n  return (data || []).reduce((a, b) => a + b);\n}\n"),e.k0s()()()),2&s){const o=e.sdS(38);e.R7$(39),e.AVh("hide",o.isJsActive),e.R7$(3),e.AVh("hide",!o.isJsActive)}},dependencies:[l.O,E.a,k.Wk],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Pipes - Microservices"}},{path:"exception-filters",component:(()=>{class t extends p.y{static \u0275fac=(()=>{let n;return function(a){return(n||(n=e.xGo(t)))(a||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-exception-filters"]],features:[e.Vt3],decls:112,vars:16,consts:[["contentReference",""],["app708274c3cf480a973fd5675b1099d84f231ac987",""],["appde4b4832f82fabfa6f243ce91e351dd6d1707298",""],["appc0e79e8d4319bb0fe60d824717b2fb5beb2d42e5",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/microservices/exception-filters.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","exception-filters"],["routerLink","/exception-filters"],[1,"language-typescript"],[1,"info"],[1,"language-json"],["appAnchor","","id","filters"],[1,"filename"],[1,"warning"],["routerLink","/faq/hybrid-application"],["appAnchor","","id","inheritance"]],template:function(s,a){if(1&s&&(e.j41(0,"div",4,0)(2,"div",5)(3,"a",6),e.nrm(4,"i",7),e.k0s()(),e.j41(5,"h3",8),e.EFF(6,"Exception filters"),e.k0s(),e.j41(7,"p"),e.EFF(8,"The only difference between the HTTP "),e.j41(9,"a",9),e.EFF(10,"exception filter"),e.k0s(),e.EFF(11," layer and the corresponding microservices layer is that instead of throwing "),e.j41(12,"code"),e.EFF(13,"HttpException"),e.k0s(),e.EFF(14,", you should use "),e.j41(15,"code"),e.EFF(16,"RpcException"),e.k0s(),e.EFF(17,"."),e.k0s(),e.j41(18,"pre")(19,"code",10),e.EFF(20,"\nthrow new RpcException('Invalid credentials.');\n"),e.k0s()(),e.j41(21,"blockquote",11)(22,"strong"),e.EFF(23,"Hint"),e.k0s(),e.EFF(24," The "),e.j41(25,"code"),e.EFF(26,"RpcException"),e.k0s(),e.EFF(27," class is imported from the "),e.j41(28,"code"),e.EFF(29,"@nestjs/microservices"),e.k0s(),e.EFF(30," package.\n"),e.k0s(),e.j41(31,"p"),e.EFF(32,"With the sample above, Nest will handle the thrown exception and return the "),e.j41(33,"code"),e.EFF(34,"error"),e.k0s(),e.EFF(35," object with the following structure:"),e.k0s(),e.j41(36,"pre")(37,"code",12),e.EFF(38,'\n{\n  "status": "error",\n  "message": "Invalid credentials."\n}\n'),e.k0s()(),e.j41(39,"h4",13)(40,"span"),e.EFF(41,"Filters"),e.k0s()(),e.j41(42,"p"),e.EFF(43,"Microservice exception filters behave similarly to HTTP exception filters, with one small difference. The "),e.j41(44,"code"),e.EFF(45,"catch()"),e.k0s(),e.EFF(46," method must return an "),e.j41(47,"code"),e.EFF(48,"Observable"),e.k0s(),e.EFF(49,"."),e.k0s(),e.j41(50,"span",14),e.EFF(51),e.nI1(52,"extension"),e.nrm(53,"app-tabs",null,1),e.k0s(),e.j41(55,"pre")(56,"code",10),e.EFF(57,"\nimport { Catch, RpcExceptionFilter, ArgumentsHost } from '@nestjs/common';\nimport { Observable, throwError } from 'rxjs';\nimport { RpcException } from '@nestjs/microservices';\n\n@Catch(RpcException)\nexport class ExceptionFilter implements RpcExceptionFilter<RpcException> {\n  catch(exception: RpcException, host: ArgumentsHost): Observable<any> {\n    return throwError(() => exception.getError());\n  }\n}\n"),e.k0s()(),e.j41(58,"pre")(59,"code",10),e.EFF(60,"\nimport { Catch } from '@nestjs/common';\nimport { throwError } from 'rxjs';\n\n@Catch(RpcException)\nexport class ExceptionFilter {\n  catch(exception, host) {\n    return throwError(() => exception.getError());\n  }\n}\n"),e.k0s()(),e.j41(61,"blockquote",15)(62,"strong"),e.EFF(63,"Warning"),e.k0s(),e.EFF(64," Global microservice exception filters aren't enabled by default when using a "),e.j41(65,"a",16),e.EFF(66,"hybrid application"),e.k0s(),e.EFF(67,".\n"),e.k0s(),e.j41(68,"p"),e.EFF(69,"The following example uses a manually instantiated method-scoped filter. Just as with HTTP based applications, you can also use controller-scoped filters (i.e., prefix the controller class with a "),e.j41(70,"code"),e.EFF(71,"@UseFilters()"),e.k0s(),e.EFF(72," decorator)."),e.k0s(),e.j41(73,"span",14),e.nrm(74,"app-tabs",null,2),e.k0s(),e.j41(76,"pre")(77,"code",10),e.EFF(78,"\n@UseFilters(new ExceptionFilter())\n@MessagePattern({ cmd: 'sum' })\naccumulate(data: number[]): number {\n  return (data || []).reduce((a, b) => a + b);\n}\n"),e.k0s()(),e.j41(79,"pre")(80,"code",10),e.EFF(81,"\n@UseFilters(new ExceptionFilter())\n@MessagePattern({ cmd: 'sum' })\naccumulate(data) {\n  return (data || []).reduce((a, b) => a + b);\n}\n"),e.k0s()(),e.j41(82,"h4",17)(83,"span"),e.EFF(84,"Inheritance"),e.k0s()(),e.j41(85,"p"),e.EFF(86,"Typically, you'll create fully customized exception filters crafted to fulfill your application requirements. However, there might be use-cases when you would like to simply extend the "),e.j41(87,"strong"),e.EFF(88,"core exception filter"),e.k0s(),e.EFF(89,", and override the behavior based on certain factors."),e.k0s(),e.j41(90,"p"),e.EFF(91,"In order to delegate exception processing to the base filter, you need to extend "),e.j41(92,"code"),e.EFF(93,"BaseExceptionFilter"),e.k0s(),e.EFF(94," and call the inherited "),e.j41(95,"code"),e.EFF(96,"catch()"),e.k0s(),e.EFF(97," method."),e.k0s(),e.j41(98,"span",14),e.nrm(99,"app-tabs",null,3),e.k0s(),e.j41(101,"pre")(102,"code",10),e.EFF(103,"\nimport { Catch, ArgumentsHost } from '@nestjs/common';\nimport { BaseRpcExceptionFilter } from '@nestjs/microservices';\n\n@Catch()\nexport class AllExceptionsFilter extends BaseRpcExceptionFilter {\n  catch(exception: any, host: ArgumentsHost) {\n    return super.catch(exception, host);\n  }\n}\n"),e.k0s()(),e.j41(104,"pre")(105,"code",10),e.EFF(106,"\nimport { Catch } from '@nestjs/common';\nimport { BaseRpcExceptionFilter } from '@nestjs/microservices';\n\n@Catch()\nexport class AllExceptionsFilter extends BaseRpcExceptionFilter {\n  catch(exception, host) {\n    return super.catch(exception, host);\n  }\n}\n"),e.k0s()(),e.j41(107,"p"),e.EFF(108,"The above implementation is just a shell demonstrating the approach. Your implementation of the extended exception filter would include your tailored "),e.j41(109,"strong"),e.EFF(110,"business logic"),e.k0s(),e.EFF(111," (e.g., handling various conditions)."),e.k0s()()),2&s){const o=e.sdS(54),r=e.sdS(75),i=e.sdS(100);e.R7$(51),e.SpI(" ",e.i5U(52,13,"rpc-exception.filter",o.isJsActive),"\n"),e.R7$(4),e.AVh("hide",o.isJsActive),e.R7$(3),e.AVh("hide",!o.isJsActive),e.R7$(18),e.AVh("hide",r.isJsActive),e.R7$(3),e.AVh("hide",!r.isJsActive),e.R7$(22),e.AVh("hide",i.isJsActive),e.R7$(3),e.AVh("hide",!i.isJsActive)}},dependencies:[l.O,E.a,k.Wk,u.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Exception Filters - Microservices"}},{path:"guards",component:(()=>{class t extends p.y{static \u0275fac=(()=>{let n;return function(a){return(n||(n=e.xGo(t)))(a||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-guards"]],features:[e.Vt3],decls:45,vars:4,consts:[["contentReference",""],["appb072d7c3e928ce808a8b6295f3b44a96eea2f406",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/microservices/guards.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","guards"],["routerLink","/guards"],[1,"info"],["appAnchor","","id","binding-guards"],[1,"filename"],[1,"language-typescript"]],template:function(s,a){if(1&s&&(e.j41(0,"div",2,0)(2,"div",3)(3,"a",4),e.nrm(4,"i",5),e.k0s()(),e.j41(5,"h3",6),e.EFF(6,"Guards"),e.k0s(),e.j41(7,"p"),e.EFF(8,"There is no fundamental difference between microservices guards and "),e.j41(9,"a",7),e.EFF(10,"regular HTTP application guards"),e.k0s(),e.EFF(11,".\nThe only difference is that instead of throwing "),e.j41(12,"code"),e.EFF(13,"HttpException"),e.k0s(),e.EFF(14,", you should use "),e.j41(15,"code"),e.EFF(16,"RpcException"),e.k0s(),e.EFF(17,"."),e.k0s(),e.j41(18,"blockquote",8)(19,"strong"),e.EFF(20,"Hint"),e.k0s(),e.EFF(21," The "),e.j41(22,"code"),e.EFF(23,"RpcException"),e.k0s(),e.EFF(24," class is exposed from "),e.j41(25,"code"),e.EFF(26,"@nestjs/microservices"),e.k0s(),e.EFF(27," package.\n"),e.k0s(),e.j41(28,"h4",9)(29,"span"),e.EFF(30,"Binding guards"),e.k0s()(),e.j41(31,"p"),e.EFF(32,"The following example uses a method-scoped guard. Just as with HTTP based applications, you can also use controller-scoped guards (i.e., prefix the controller class with a "),e.j41(33,"code"),e.EFF(34,"@UseGuards()"),e.k0s(),e.EFF(35," decorator)."),e.k0s(),e.j41(36,"span",10),e.nrm(37,"app-tabs",null,1),e.k0s(),e.j41(39,"pre")(40,"code",11),e.EFF(41,"\n@UseGuards(AuthGuard)\n@MessagePattern({ cmd: 'sum' })\naccumulate(data: number[]): number {\n  return (data || []).reduce((a, b) => a + b);\n}\n"),e.k0s()(),e.j41(42,"pre")(43,"code",11),e.EFF(44,"\n@UseGuards(AuthGuard)\n@MessagePattern({ cmd: 'sum' })\naccumulate(data) {\n  return (data || []).reduce((a, b) => a + b);\n}\n"),e.k0s()()()),2&s){const o=e.sdS(38);e.R7$(39),e.AVh("hide",o.isJsActive),e.R7$(3),e.AVh("hide",!o.isJsActive)}},dependencies:[l.O,E.a,k.Wk],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Guards - Microservices"}},{path:"interceptors",component:(()=>{class t extends p.y{static \u0275fac=(()=>{let n;return function(a){return(n||(n=e.xGo(t)))(a||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-interceptors"]],features:[e.Vt3],decls:24,vars:4,consts:[["contentReference",""],["app131734522f19a4e74c557f3869e23fa589f3c1ee",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/microservices/interceptors.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","interceptors"],["routerLink","/interceptors"],[1,"filename"],[1,"language-typescript"]],template:function(s,a){if(1&s&&(e.j41(0,"div",2,0)(2,"div",3)(3,"a",4),e.nrm(4,"i",5),e.k0s()(),e.j41(5,"h3",6),e.EFF(6,"Interceptors"),e.k0s(),e.j41(7,"p"),e.EFF(8,"There is no difference between "),e.j41(9,"a",7),e.EFF(10,"regular interceptors"),e.k0s(),e.EFF(11," and microservices interceptors. The following example uses a manually instantiated method-scoped interceptor. Just as with HTTP based applications, you can also use controller-scoped interceptors (i.e., prefix the controller class with a "),e.j41(12,"code"),e.EFF(13,"@UseInterceptors()"),e.k0s(),e.EFF(14," decorator)."),e.k0s(),e.j41(15,"span",8),e.nrm(16,"app-tabs",null,1),e.k0s(),e.j41(18,"pre")(19,"code",9),e.EFF(20,"\n@UseInterceptors(new TransformInterceptor())\n@MessagePattern({ cmd: 'sum' })\naccumulate(data: number[]): number {\n  return (data || []).reduce((a, b) => a + b);\n}\n"),e.k0s()(),e.j41(21,"pre")(22,"code",9),e.EFF(23,"\n@UseInterceptors(new TransformInterceptor())\n@MessagePattern({ cmd: 'sum' })\naccumulate(data) {\n  return (data || []).reduce((a, b) => a + b);\n}\n"),e.k0s()()()),2&s){const o=e.sdS(17);e.R7$(18),e.AVh("hide",o.isJsActive),e.R7$(3),e.AVh("hide",!o.isJsActive)}},dependencies:[l.O,k.Wk],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Interceptors - Microservices"}},{path:"custom-transport",component:(()=>{class t extends p.y{static \u0275fac=(()=>{let n;return function(a){return(n||(n=e.xGo(t)))(a||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-custom-transport"]],features:[e.Vt3],decls:376,vars:8,consts:[["contentReference",""],["appd912219342a0ce3b28d14eb57d43b19367fe4970",""],["app4f8901b966cfc821133d9f2b4482df10ed465814",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/microservices/custom-transport.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","custom-transporters"],["rel","nofollow","target","_blank","href","https://dev.to/nestjs/integrate-nestjs-with-external-services-using-microservice-transporters-part-1-p3"],[1,"info"],["routerLink","/application-context"],["rel","nofollow","target","_blank","href","https://github.com/mqttjs/MQTT.js/blob/master/README.md#qos"],["rel","nofollow","target","_blank","href","https://dev.to/johnbiundo/series/4724"],["rel","nofollow","target","_blank","href","https://dev.to/nestjs/part-1-introduction-and-setup-1a2l"],["appAnchor","","id","creating-a-strategy"],[1,"language-typescript"],[1,"warning"],[1,"language-json"],["routerLink","/interceptors"],["appAnchor","","id","client-proxy"],["rel","nofollow","target","_blank","href","https://dev.to/nestjs/part-4-basic-client-component-16f9"],["appAnchor","","id","message-serialization"],[1,"filename"]],template:function(s,a){if(1&s&&(e.j41(0,"div",3,0)(2,"div",4)(3,"a",5),e.nrm(4,"i",6),e.k0s()(),e.j41(5,"h3",7),e.EFF(6,"Custom transporters"),e.k0s(),e.j41(7,"p"),e.EFF(8,"Nest provides a variety of "),e.j41(9,"strong"),e.EFF(10,"transporters"),e.k0s(),e.EFF(11," out-of-the-box, as well as an API allowing developers to build new custom transport strategies.\nTransporters enable you to connect components over a network using a pluggable communications layer and a very simple application-level message protocol (read full "),e.j41(12,"a",8),e.EFF(13,"article"),e.k0s(),e.EFF(14,")."),e.k0s(),e.j41(15,"blockquote",9)(16,"strong"),e.EFF(17,"Hint"),e.k0s(),e.EFF(18," Building a microservice with Nest does not necessarily mean you must use the "),e.j41(19,"code"),e.EFF(20,"@nestjs/microservices"),e.k0s(),e.EFF(21," package. For example, if you want to communicate with external services (let's say other microservices written in different languages), you may not need all the features provided by "),e.j41(22,"code"),e.EFF(23,"@nestjs/microservice"),e.k0s(),e.EFF(24," library.\nIn fact, if you don't need decorators ("),e.j41(25,"code"),e.EFF(26,"@EventPattern"),e.k0s(),e.EFF(27," or "),e.j41(28,"code"),e.EFF(29,"@MessagePattern"),e.k0s(),e.EFF(30,") that let you declaratively define subscribers, running a "),e.j41(31,"a",10),e.EFF(32,"Standalone Application"),e.k0s(),e.EFF(33," and manually maintaining connection/subscribing to channels should be enough for most use-cases and will provide you with more flexibility.\n"),e.k0s(),e.j41(34,"p"),e.EFF(35,"With a custom transporter, you can integrate any messaging system/protocol (including Google Cloud Pub/Sub, Amazon Kinesis, and others) or extend the existing one, adding extra features on top (for example, "),e.j41(36,"a",11),e.EFF(37,"QoS"),e.k0s(),e.EFF(38," for MQTT)."),e.k0s(),e.j41(39,"blockquote",9)(40,"strong"),e.EFF(41,"Hint"),e.k0s(),e.EFF(42," To better understand how Nest microservices work and how you can extend the capabilities of existing transporters, we recommend reading the "),e.j41(43,"a",12),e.EFF(44,"NestJS Microservices in Action"),e.k0s(),e.EFF(45," and "),e.j41(46,"a",13),e.EFF(47,"Advanced NestJS Microservices"),e.k0s(),e.EFF(48," article series.\n"),e.k0s(),e.j41(49,"h4",14)(50,"span"),e.EFF(51,"Creating a strategy"),e.k0s()(),e.j41(52,"p"),e.EFF(53,"First, let's define a class representing our custom transporter."),e.k0s(),e.j41(54,"pre")(55,"code",15),e.EFF(56,"\nimport { CustomTransportStrategy, Server } from '@nestjs/microservices';\n\nclass GoogleCloudPubSubServer\n  extends Server\n  implements CustomTransportStrategy {\n  /**\n   * This method is triggered when you run \"app.listen()\".\n   */\n  listen(callback: () => void) {\n    callback();\n  }\n\n  /**\n   * This method is triggered on application shutdown.\n   */\n  close() {}\n}\n"),e.k0s()(),e.j41(57,"blockquote",16)(58,"strong"),e.EFF(59,"Warning"),e.k0s(),e.EFF(60," Please, note we won't be implementing a fully-featured Google Cloud Pub/Sub server in this chapter as this would require diving into transporter specific technical details.\n"),e.k0s(),e.j41(61,"p"),e.EFF(62,"In our example above, we declared the "),e.j41(63,"code"),e.EFF(64,"GoogleCloudPubSubServer"),e.k0s(),e.EFF(65," class and provided "),e.j41(66,"code"),e.EFF(67,"listen()"),e.k0s(),e.EFF(68," and "),e.j41(69,"code"),e.EFF(70,"close()"),e.k0s(),e.EFF(71," methods enforced by the "),e.j41(72,"code"),e.EFF(73,"CustomTransportStrategy"),e.k0s(),e.EFF(74," interface.\nAlso, our class extends the "),e.j41(75,"code"),e.EFF(76,"Server"),e.k0s(),e.EFF(77," class imported from the "),e.j41(78,"code"),e.EFF(79,"@nestjs/microservices"),e.k0s(),e.EFF(80," package that provides a few useful methods, for example, methods used by Nest runtime to register message handlers. Alternatively, in case you want to extend the capabilities of an existing transport strategy, you could extend the corresponding server class, for example, "),e.j41(81,"code"),e.EFF(82,"ServerRedis"),e.k0s(),e.EFF(83,".\nConventionally, we added the "),e.j41(84,"code"),e.EFF(85,'"Server"'),e.k0s(),e.EFF(86," suffix to our class as it will be responsible for subscribing to messages/events (and responding to them, if necessary)."),e.k0s(),e.j41(87,"p"),e.EFF(88,"With this in place, we can now use our custom strategy instead of using a built-in transporter, as follows:"),e.k0s(),e.j41(89,"pre")(90,"code",15),e.EFF(91,"\nconst app = await NestFactory.createMicroservice<MicroserviceOptions>(\n  AppModule,\n  {\n    strategy: new GoogleCloudPubSubServer(),\n  },\n);\n"),e.k0s()(),e.j41(92,"p"),e.EFF(93,"Basically, instead of passing the normal transporter options object with "),e.j41(94,"code"),e.EFF(95,"transport"),e.k0s(),e.EFF(96," and "),e.j41(97,"code"),e.EFF(98,"options"),e.k0s(),e.EFF(99," properties, we pass a single property, "),e.j41(100,"code"),e.EFF(101,"strategy"),e.k0s(),e.EFF(102,", whose value is an instance of our custom transporter class."),e.k0s(),e.j41(103,"p"),e.EFF(104,"Back to our "),e.j41(105,"code"),e.EFF(106,"GoogleCloudPubSubServer"),e.k0s(),e.EFF(107," class, in a real-world application, we would be establishing a connection to our message broker/external service and registering subscribers/listening to specific channels in "),e.j41(108,"code"),e.EFF(109,"listen()"),e.k0s(),e.EFF(110," method (and then removing subscriptions & closing the connection in the "),e.j41(111,"code"),e.EFF(112,"close()"),e.k0s(),e.EFF(113," teardown method),\nbut since this requires a good understanding of how Nest microservices communicate with each other, we recommend reading this "),e.j41(114,"a",13),e.EFF(115,"article series"),e.k0s(),e.EFF(116,".\nIn this chapter instead, we'll focus on the capabilities the "),e.j41(117,"code"),e.EFF(118,"Server"),e.k0s(),e.EFF(119," class provides and how you can leverage them to build custom strategies."),e.k0s(),e.j41(120,"p"),e.EFF(121,"For example, let's say that somewhere in our application, the following message handler is defined:"),e.k0s(),e.j41(122,"pre")(123,"code",15),e.EFF(124,"\n@MessagePattern('echo')\necho(@Payload() data: object) {\n  return data;\n}\n"),e.k0s()(),e.j41(125,"p"),e.EFF(126,"This message handler will be automatically registered by Nest runtime. With "),e.j41(127,"code"),e.EFF(128,"Server"),e.k0s(),e.EFF(129," class, you can see what message patterns have been registered and also, access and execute the actual methods that were assigned to them.\nTo test this out, let's add a simple "),e.j41(130,"code"),e.EFF(131,"console.log"),e.k0s(),e.EFF(132," inside "),e.j41(133,"code"),e.EFF(134,"listen()"),e.k0s(),e.EFF(135," method before "),e.j41(136,"code"),e.EFF(137,"callback"),e.k0s(),e.EFF(138," function is called:"),e.k0s(),e.j41(139,"pre")(140,"code",15),e.EFF(141,"\nlisten(callback: () => void) {\n  console.log(this.messageHandlers);\n  callback();\n}\n"),e.k0s()(),e.j41(142,"p"),e.EFF(143,"After your application restarts, you'll see the following log in your terminal:"),e.k0s(),e.j41(144,"pre")(145,"code",15),e.EFF(146,"\nMap { 'echo' => [AsyncFunction] { isEventHandler: false } }\n"),e.k0s()(),e.j41(147,"blockquote",9)(148,"strong"),e.EFF(149,"Hint"),e.k0s(),e.EFF(150," If we used the "),e.j41(151,"code"),e.EFF(152,"@EventPattern"),e.k0s(),e.EFF(153," decorator, you would see the same output, but with the "),e.j41(154,"code"),e.EFF(155,"isEventHandler"),e.k0s(),e.EFF(156," property set to "),e.j41(157,"code"),e.EFF(158,"true"),e.k0s(),e.EFF(159,".\n"),e.k0s(),e.j41(160,"p"),e.EFF(161,"As you can see, the "),e.j41(162,"code"),e.EFF(163,"messageHandlers"),e.k0s(),e.EFF(164," property is a "),e.j41(165,"code"),e.EFF(166,"Map"),e.k0s(),e.EFF(167," collection of all message (and event) handlers, in which patterns are being used as keys.\nNow, you can use a key (for example, "),e.j41(168,"code"),e.EFF(169,'"echo"'),e.k0s(),e.EFF(170,") to receive a reference to the message handler:"),e.k0s(),e.j41(171,"pre")(172,"code",15),e.EFF(173,"\nasync listen(callback: () => void) {\n  const echoHandler = this.messageHandlers.get('echo');\n  console.log(await echoHandler('Hello world!'));\n  callback();\n}\n"),e.k0s()(),e.j41(174,"p"),e.EFF(175,"Once we execute the "),e.j41(176,"code"),e.EFF(177,"echoHandler"),e.k0s(),e.EFF(178," passing an arbitrary string as an argument ("),e.j41(179,"code"),e.EFF(180,'"Hello world!"'),e.k0s(),e.EFF(181," here), we should see it in the console:"),e.k0s(),e.j41(182,"pre")(183,"code",17),e.EFF(184,"\nHello world!\n"),e.k0s()(),e.j41(185,"p"),e.EFF(186,"Which means that our method handler was properly executed."),e.k0s(),e.j41(187,"p"),e.EFF(188,"When using a "),e.j41(189,"code"),e.EFF(190,"CustomTransportStrategy"),e.k0s(),e.EFF(191," with "),e.j41(192,"a",18),e.EFF(193,"Interceptors"),e.k0s(),e.EFF(194," the handlers are wrapped into RxJS streams. This means that you need to subscribe to them in order to execute the streams underlying logic (e.g. continue into the controller logic after an interceptor has been executed)."),e.k0s(),e.j41(195,"p"),e.EFF(196,"An example of this can be seen below:"),e.k0s(),e.j41(197,"pre")(198,"code",15),e.EFF(199,"\nasync listen(callback: () => void) {\n  const echoHandler = this.messageHandlers.get('echo');\n  const streamOrResult = await echoHandler('Hello World');\n  if (isObservable(streamOrResult)) {\n    streamOrResult.subscribe();\n  }\n  callback();\n}\n"),e.k0s()(),e.j41(200,"h4",19)(201,"span"),e.EFF(202,"Client proxy"),e.k0s()(),e.j41(203,"p"),e.EFF(204,"As we mentioned in the first section, you don't necessarily need to use the "),e.j41(205,"code"),e.EFF(206,"@nestjs/microservices"),e.k0s(),e.EFF(207,' package to create microservices, but if you decide to do so and you need to integrate a custom strategy, you will need to provide a "client" class too.'),e.k0s(),e.j41(208,"blockquote",9)(209,"strong"),e.EFF(210,"Hint"),e.k0s(),e.EFF(211," Again, implementing a fully-featured client class compatible with all "),e.j41(212,"code"),e.EFF(213,"@nestjs/microservices"),e.k0s(),e.EFF(214," features (e.g., streaming) requires a good understanding of communication techniques used by the framework. To learn more, check out this "),e.j41(215,"a",20),e.EFF(216,"article"),e.k0s(),e.EFF(217,".\n"),e.k0s(),e.j41(218,"p"),e.EFF(219,"To communicate with an external service/emit & publish messages (or events) you can either use a library-specific SDK package, or implement a custom client class that extends the "),e.j41(220,"code"),e.EFF(221,"ClientProxy"),e.k0s(),e.EFF(222,", as follows:"),e.k0s(),e.j41(223,"pre")(224,"code",15),e.EFF(225,"\nimport { ClientProxy, ReadPacket, WritePacket } from '@nestjs/microservices';\n\nclass GoogleCloudPubSubClient extends ClientProxy {\n  async connect(): Promise<any> {}\n  async close() {}\n  async dispatchEvent(packet: ReadPacket<any>): Promise<any> {}\n  publish(\n    packet: ReadPacket<any>,\n    callback: (packet: WritePacket<any>) => void,\n  ): Function {}\n}\n"),e.k0s()(),e.j41(226,"blockquote",16)(227,"strong"),e.EFF(228,"Warning"),e.k0s(),e.EFF(229," Please, note we won't be implementing a fully-featured Google Cloud Pub/Sub client in this chapter as this would require diving into transporter specific technical details.\n"),e.k0s(),e.j41(230,"p"),e.EFF(231,"As you can see, "),e.j41(232,"code"),e.EFF(233,"ClientProxy"),e.k0s(),e.EFF(234," class requires us to provide several methods for establishing & closing the connection and publishing messages ("),e.j41(235,"code"),e.EFF(236,"publish"),e.k0s(),e.EFF(237,") and events ("),e.j41(238,"code"),e.EFF(239,"dispatchEvent"),e.k0s(),e.EFF(240,").\nNote, if you don't need a request-response communication style support, you can leave the "),e.j41(241,"code"),e.EFF(242,"publish()"),e.k0s(),e.EFF(243," method empty. Likewise, if you don't need to support event-based communication, skip the "),e.j41(244,"code"),e.EFF(245,"dispatchEvent()"),e.k0s(),e.EFF(246," method."),e.k0s(),e.j41(247,"p"),e.EFF(248,"To observe what and when those methods are executed, let's add multiple "),e.j41(249,"code"),e.EFF(250,"console.log"),e.k0s(),e.EFF(251," calls, as follows:"),e.k0s(),e.j41(252,"pre")(253,"code",15),e.EFF(254,"\nclass GoogleCloudPubSubClient extends ClientProxy {\n  async connect(): Promise<any> {\n    console.log('connect');\n  }\n\n  async close() {\n    console.log('close');\n  }\n\n  async dispatchEvent(packet: ReadPacket<any>): Promise<any> {\n    return console.log('event to dispatch: ', packet);\n  }\n\n  publish(\n    packet: ReadPacket<any>,\n    callback: (packet: WritePacket<any>) => void,\n  ): Function {\n    console.log('message:', packet);\n\n    // In a real-world application, the \"callback\" function should be executed\n    // with payload sent back from the responder. Here, we'll simply simulate (5 seconds delay)\n    // that response came through by passing the same \"data\" as we've originally passed in.\n    setTimeout(() => callback({ response: packet.data }), 5000);\n\n    return () => console.log('teardown');\n  }\n}\n"),e.k0s()(),e.j41(255,"p"),e.EFF(256,"With this in place, let's create an instance of "),e.j41(257,"code"),e.EFF(258,"GoogleCloudPubSubClient"),e.k0s(),e.EFF(259," class and run the "),e.j41(260,"code"),e.EFF(261,"send()"),e.k0s(),e.EFF(262," method (which you might have seen in earlier chapters), subscribing to the returned observable stream."),e.k0s(),e.j41(263,"pre")(264,"code",15),e.EFF(265,"\nconst googlePubSubClient = new GoogleCloudPubSubClient();\ngooglePubSubClient\n  .send('pattern', 'Hello world!')\n  .subscribe((response) => console.log(response));\n"),e.k0s()(),e.j41(266,"p"),e.EFF(267,"Now, you should see the following output in your terminal:"),e.k0s(),e.j41(268,"pre")(269,"code",15),e.EFF(270,"\nconnect\nmessage: { pattern: 'pattern', data: 'Hello world!' }\nHello world! // <-- after 5 seconds\n"),e.k0s()(),e.j41(271,"p"),e.EFF(272,'To test if our "teardown" method (which our '),e.j41(273,"code"),e.EFF(274,"publish()"),e.k0s(),e.EFF(275," method returns) is properly executed, let's apply a timeout operator to our stream, setting it to 2 seconds to make sure it throws earlier then our "),e.j41(276,"code"),e.EFF(277,"setTimeout"),e.k0s(),e.EFF(278," calls the "),e.j41(279,"code"),e.EFF(280,"callback"),e.k0s(),e.EFF(281," function."),e.k0s(),e.j41(282,"pre")(283,"code",15),e.EFF(284,"\nconst googlePubSubClient = new GoogleCloudPubSubClient();\ngooglePubSubClient\n  .send('pattern', 'Hello world!')\n  .pipe(timeout(2000))\n  .subscribe(\n    (response) => console.log(response),\n    (error) => console.error(error.message),\n  );\n"),e.k0s()(),e.j41(285,"blockquote",9)(286,"strong"),e.EFF(287,"Hint"),e.k0s(),e.EFF(288," The "),e.j41(289,"code"),e.EFF(290,"timeout"),e.k0s(),e.EFF(291," operator is imported from the "),e.j41(292,"code"),e.EFF(293,"rxjs/operators"),e.k0s(),e.EFF(294," package.\n"),e.k0s(),e.j41(295,"p"),e.EFF(296,"With "),e.j41(297,"code"),e.EFF(298,"timeout"),e.k0s(),e.EFF(299," operator applied, your terminal output should look as follows:"),e.k0s(),e.j41(300,"pre")(301,"code",15),e.EFF(302,"\nconnect\nmessage: { pattern: 'pattern', data: 'Hello world!' }\nteardown // <-- teardown\nTimeout has occurred\n"),e.k0s()(),e.j41(303,"p"),e.EFF(304,"To dispatch an event (instead of sending a message), use the "),e.j41(305,"code"),e.EFF(306,"emit()"),e.k0s(),e.EFF(307," method:"),e.k0s(),e.j41(308,"pre")(309,"code",15),e.EFF(310,"\ngooglePubSubClient.emit('event', 'Hello world!');\n"),e.k0s()(),e.j41(311,"p"),e.EFF(312,"And that's what you should see in the console:"),e.k0s(),e.j41(313,"pre")(314,"code",15),e.EFF(315,"\nconnect\nevent to dispatch:  { pattern: 'event', data: 'Hello world!' }\n"),e.k0s()(),e.j41(316,"h4",21)(317,"span"),e.EFF(318,"Message serialization"),e.k0s()(),e.j41(319,"p"),e.EFF(320,"If you need to add some custom logic around the serialization of responses on the client side, you can use a custom class that extends the "),e.j41(321,"code"),e.EFF(322,"ClientProxy"),e.k0s(),e.EFF(323," class or one of its child classes. For modifying successful requests you can override the "),e.j41(324,"code"),e.EFF(325,"serializeResponse"),e.k0s(),e.EFF(326," method, and for modifying any errors that go through this client you can override the "),e.j41(327,"code"),e.EFF(328,"serializeError"),e.k0s(),e.EFF(329," method. To make use of this custom class, you can pass the class itself to the "),e.j41(330,"code"),e.EFF(331,"ClientsModule.register()"),e.k0s(),e.EFF(332," method using the "),e.j41(333,"code"),e.EFF(334,"customClass"),e.k0s(),e.EFF(335," property. Below is an example of a custom "),e.j41(336,"code"),e.EFF(337,"ClientProxy"),e.k0s(),e.EFF(338," that serializes each error into an "),e.j41(339,"code"),e.EFF(340,"RpcException"),e.k0s(),e.EFF(341,"."),e.k0s(),e.j41(342,"span",22),e.EFF(343),e.nI1(344,"extension"),e.nrm(345,"app-tabs",null,1),e.k0s(),e.j41(347,"pre")(348,"code",15),e.EFF(349,"\nimport { ClientTcp, RpcException } from '@nestjs/microservices';\n\nclass ErrorHandlingProxy extends ClientTCP {\n  serializeError(err: Error) {\n    return new RpcException(err);\n  }\n}\n"),e.k0s()(),e.j41(350,"p"),e.EFF(351,"and then use it in the "),e.j41(352,"code"),e.EFF(353,"ClientsModule"),e.k0s(),e.EFF(354," like so:"),e.k0s(),e.j41(355,"span",22),e.EFF(356),e.nI1(357,"extension"),e.nrm(358,"app-tabs",null,2),e.k0s(),e.j41(360,"pre")(361,"code",15),e.EFF(362,"\n@Module({\n  imports: [\n    ClientsModule.register([{\n      name: 'CustomProxy',\n      customClass: ErrorHandlingProxy,\n    }]),\n  ]\n})\nexport class AppModule\n"),e.k0s()(),e.j41(363,"blockquote",9)(364,"strong"),e.EFF(365,"hint"),e.k0s(),e.EFF(366," This is the class itself being passed to "),e.j41(367,"code"),e.EFF(368,"customClass"),e.k0s(),e.EFF(369,", not an instance of the class. Nest will create the instance under the hood for you, and will pass any options given to the "),e.j41(370,"code"),e.EFF(371,"options"),e.k0s(),e.EFF(372," property to the new "),e.j41(373,"code"),e.EFF(374,"ClientProxy"),e.k0s(),e.EFF(375,".\n"),e.k0s()()),2&s){const o=e.sdS(346),r=e.sdS(359);e.R7$(343),e.SpI(" ",e.i5U(344,2,"error-handling.proxy",o.isJsActive),"\n"),e.R7$(13),e.SpI(" ",e.i5U(357,5,"app.module",r.isJsActive),"\n")}},dependencies:[l.O,E.a,k.Wk,u.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Custom transporters - Microservices"}}];let T=(()=>{class t{static \u0275fac=function(s){return new(s||t)};static \u0275mod=e.$C({type:t});static \u0275inj=e.G2t({imports:[w.MD,x.G,k.iI.forChild(A)]})}return t})()}}]);