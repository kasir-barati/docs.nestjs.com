"use strict";(self.webpackChunkdocs_nestjs_com=self.webpackChunkdocs_nestjs_com||[]).push([[945],{6945:(Y,A,d)=>{d.r(A),d.d(A,{TechniquesModule:()=>B});var x=d(177),E=d(2647),M=d(3887),i=d(8050),e=d(4438),p=d(5119),F=d(4819);let C=(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-caching"]],features:[e.Vt3],decls:490,vars:8,consts:[["contentReference",""],["appb7327a9ec936bec7522162ed538be6471488066c",""],["appb1056da2d81be24e3316c16a225fd53e197006f7",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/caching.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","caching"],["appAnchor","","id","installation"],[1,"language-bash"],[1,"warning"],["appAnchor","","id","in-memory-cache"],[1,"language-typescript"],["appAnchor","","id","interacting-with-the-cache-store"],[1,"info"],["rel","nofollow","target","_blank","href","https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm#javascript_types"],["appAnchor","","id","auto-caching-responses"],["routerLink","/graphql/quick-start"],["href","https://docs.nestjs.com/interceptors#response-mapping"],["appAnchor","","id","customize-caching"],["rel","nofollow","target","_blank","href","https://en.wikipedia.org/wiki/Time_to_live"],["appAnchor","","id","use-module-globally"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/modules#global-modules"],["appAnchor","","id","global-cache-overrides"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/techniques/caching#different-stores"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/techniques/caching#customize-caching"],["appAnchor","","id","websockets-and-microservices"],[1,"filename"],["appAnchor","","id","adjust-tracking"],["appAnchor","","id","different-stores"],["rel","nofollow","target","_blank","href","https://github.com/node-cache-manager/node-cache-manager"],["rel","nofollow","target","_blank","href","https://github.com/dabroek/node-cache-manager-redis-store"],["rel","nofollow","target","_blank","href","https://github.com/node-cache-manager/node-cache-manager#store-engines"],["rel","nofollow","target","_blank","href","https://github.com/dabroek/node-cache-manager-redis-store/issues/40"],["appAnchor","","id","async-configuration"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/20-cache"]],template:function(s,n){if(1&s&&(e.j41(0,"div",3,0)(2,"div",4)(3,"a",5),e.nrm(4,"i",6),e.k0s()(),e.j41(5,"h3",7),e.EFF(6,"Caching"),e.k0s(),e.j41(7,"p"),e.EFF(8,"Caching is a great and simple "),e.j41(9,"strong"),e.EFF(10,"technique"),e.k0s(),e.EFF(11," that helps improve your app's performance. It acts as a temporary data store providing high performance data access."),e.k0s(),e.j41(12,"h4",8)(13,"span"),e.EFF(14,"Installation"),e.k0s()(),e.j41(15,"p"),e.EFF(16,"First install required packages:"),e.k0s(),e.j41(17,"pre")(18,"code",9),e.EFF(19,"\n$ npm install @nestjs/cache-manager cache-manager\n"),e.k0s()(),e.j41(20,"blockquote",10)(21,"strong"),e.EFF(22,"Warning"),e.k0s(),e.j41(23,"code"),e.EFF(24,"cache-manager"),e.k0s(),e.EFF(25," version 4 uses seconds for "),e.j41(26,"code"),e.EFF(27,"TTL (Time-To-Live)"),e.k0s(),e.EFF(28,". The current version of "),e.j41(29,"code"),e.EFF(30,"cache-manager"),e.k0s(),e.EFF(31," (v5) has switched to using milliseconds instead. NestJS doesn't convert the value, and simply forwards the ttl you provide to the library. In other words:\n"),e.j41(32,"ul")(33,"li"),e.EFF(34,"If using "),e.j41(35,"code"),e.EFF(36,"cache-manager"),e.k0s(),e.EFF(37," v4, provide ttl in seconds"),e.k0s(),e.j41(38,"li"),e.EFF(39,"If using "),e.j41(40,"code"),e.EFF(41,"cache-manager"),e.k0s(),e.EFF(42," v5, provide ttl in milliseconds"),e.k0s(),e.j41(43,"li"),e.EFF(44,"Documentation is referring to seconds, since NestJS was released targeting version 4 of cache-manager."),e.k0s()()(),e.j41(45,"h4",11)(46,"span"),e.EFF(47,"In-memory cache"),e.k0s()(),e.j41(48,"p"),e.EFF(49,"Nest provides a unified API for various cache storage providers. The built-in one is an in-memory data store. However, you can easily switch to a more comprehensive solution, like Redis."),e.k0s(),e.j41(50,"p"),e.EFF(51,"In order to enable caching, import the "),e.j41(52,"code"),e.EFF(53,"CacheModule"),e.k0s(),e.EFF(54," and call its "),e.j41(55,"code"),e.EFF(56,"register()"),e.k0s(),e.EFF(57," method."),e.k0s(),e.j41(58,"pre")(59,"code",12),e.EFF(60,"\nimport { Module } from '@nestjs/common';\nimport { CacheModule } from '@nestjs/cache-manager';\nimport { AppController } from './app.controller';\n\n@Module({\n  imports: [CacheModule.register()],\n  controllers: [AppController],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(61,"h4",13)(62,"span"),e.EFF(63,"Interacting with the Cache store"),e.k0s()(),e.j41(64,"p"),e.EFF(65,"To interact with the cache manager instance, inject it to your class using the "),e.j41(66,"code"),e.EFF(67,"CACHE_MANAGER"),e.k0s(),e.EFF(68," token, as follows:"),e.k0s(),e.j41(69,"pre")(70,"code",12),e.EFF(71,"\nconstructor(@Inject(CACHE_MANAGER) private cacheManager: Cache) {}\n"),e.k0s()(),e.j41(72,"blockquote",14)(73,"strong"),e.EFF(74,"Hint"),e.k0s(),e.EFF(75," The "),e.j41(76,"code"),e.EFF(77,"Cache"),e.k0s(),e.EFF(78," class is imported from the "),e.j41(79,"code"),e.EFF(80,"cache-manager"),e.k0s(),e.EFF(81,", while "),e.j41(82,"code"),e.EFF(83,"CACHE_MANAGER"),e.k0s(),e.EFF(84," token from the "),e.j41(85,"code"),e.EFF(86,"@nestjs/cache-manager"),e.k0s(),e.EFF(87," package.\n"),e.k0s(),e.j41(88,"p"),e.EFF(89,"The "),e.j41(90,"code"),e.EFF(91,"get"),e.k0s(),e.EFF(92," method on the "),e.j41(93,"code"),e.EFF(94,"Cache"),e.k0s(),e.EFF(95," instance (from the "),e.j41(96,"code"),e.EFF(97,"cache-manager"),e.k0s(),e.EFF(98," package) is used to retrieve items from the cache. If the item does not exist in the cache, "),e.j41(99,"code"),e.EFF(100,"null"),e.k0s(),e.EFF(101," will be returned."),e.k0s(),e.j41(102,"pre")(103,"code",12),e.EFF(104,"\nconst value = await this.cacheManager.get('key');\n"),e.k0s()(),e.j41(105,"p"),e.EFF(106,"To add an item to the cache, use the "),e.j41(107,"code"),e.EFF(108,"set"),e.k0s(),e.EFF(109," method:"),e.k0s(),e.j41(110,"pre")(111,"code",12),e.EFF(112,"\nawait this.cacheManager.set('key', 'value');\n"),e.k0s()(),e.j41(113,"blockquote",10)(114,"strong"),e.EFF(115,"Note"),e.k0s(),e.EFF(116," The in-memory cache storage can only store values of types that are supported by "),e.j41(117,"a",15),e.EFF(118,"the structured clone algorithm"),e.k0s(),e.EFF(119,".\n"),e.k0s(),e.j41(120,"p"),e.EFF(121,"The default expiration time of the cache is 5 seconds."),e.k0s(),e.j41(122,"p"),e.EFF(123,"You can manually specify a TTL (expiration time in seconds) for this specific key, as follows:"),e.k0s(),e.j41(124,"pre")(125,"code",12),e.EFF(126,"\nawait this.cacheManager.set('key', 'value', 1000);\n"),e.k0s()(),e.j41(127,"p"),e.EFF(128,"To disable expiration of the cache, set the "),e.j41(129,"code"),e.EFF(130,"ttl"),e.k0s(),e.EFF(131," configuration property to "),e.j41(132,"code"),e.EFF(133,"0"),e.k0s(),e.EFF(134,":"),e.k0s(),e.j41(135,"pre")(136,"code",12),e.EFF(137,"\nawait this.cacheManager.set('key', 'value', 0);\n"),e.k0s()(),e.j41(138,"p"),e.EFF(139,"To remove an item from the cache, use the "),e.j41(140,"code"),e.EFF(141,"del"),e.k0s(),e.EFF(142," method:"),e.k0s(),e.j41(143,"pre")(144,"code",12),e.EFF(145,"\nawait this.cacheManager.del('key');\n"),e.k0s()(),e.j41(146,"p"),e.EFF(147,"To clear the entire cache, use the "),e.j41(148,"code"),e.EFF(149,"reset"),e.k0s(),e.EFF(150," method:"),e.k0s(),e.j41(151,"pre")(152,"code",12),e.EFF(153,"\nawait this.cacheManager.reset();\n"),e.k0s()(),e.j41(154,"h4",16)(155,"span"),e.EFF(156,"Auto-caching responses"),e.k0s()(),e.j41(157,"blockquote",10)(158,"strong"),e.EFF(159,"Warning"),e.k0s(),e.EFF(160," In "),e.j41(161,"a",17),e.EFF(162,"GraphQL"),e.k0s(),e.EFF(163," applications, interceptors are executed separately for each field resolver. Thus, "),e.j41(164,"code"),e.EFF(165,"CacheModule"),e.k0s(),e.EFF(166," (which uses interceptors to cache responses) will not work properly.\n"),e.k0s(),e.j41(167,"p"),e.EFF(168,"To enable auto-caching responses, just tie the "),e.j41(169,"code"),e.EFF(170,"CacheInterceptor"),e.k0s(),e.EFF(171," where you want to cache data."),e.k0s(),e.j41(172,"pre")(173,"code",12),e.EFF(174,"\n@Controller()\n@UseInterceptors(CacheInterceptor)\nexport class AppController {\n  @Get()\n  findAll(): string[] {\n    return [];\n  }\n}\n"),e.k0s()(),e.j41(175,"blockquote",10)(176,"strong"),e.EFF(177,"Warning"),e.k0s(),e.EFF(178," Only "),e.j41(179,"code"),e.EFF(180,"GET"),e.k0s(),e.EFF(181," endpoints are cached. Also, HTTP server routes that inject the native response object ("),e.j41(182,"code"),e.EFF(183,"@Res()"),e.k0s(),e.EFF(184,") cannot use the Cache Interceptor. See\n"),e.j41(185,"a",18),e.EFF(186,"response mapping"),e.k0s(),e.EFF(187," for more details.\n"),e.k0s(),e.j41(188,"p"),e.EFF(189,"To reduce the amount of required boilerplate, you can bind "),e.j41(190,"code"),e.EFF(191,"CacheInterceptor"),e.k0s(),e.EFF(192," to all endpoints globally:"),e.k0s(),e.j41(193,"pre")(194,"code",12),e.EFF(195,"\nimport { Module } from '@nestjs/common';\nimport { CacheModule, CacheInterceptor } from '@nestjs/cache-manager';\nimport { AppController } from './app.controller';\nimport { APP_INTERCEPTOR } from '@nestjs/core';\n\n@Module({\n  imports: [CacheModule.register()],\n  controllers: [AppController],\n  providers: [\n    {\n      provide: APP_INTERCEPTOR,\n      useClass: CacheInterceptor,\n    },\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(196,"h4",19)(197,"span"),e.EFF(198,"Customize caching"),e.k0s()(),e.j41(199,"p"),e.EFF(200,"All cached data has its own expiration time ("),e.j41(201,"a",20),e.EFF(202,"TTL"),e.k0s(),e.EFF(203,"). To customize default values, pass the options object to the "),e.j41(204,"code"),e.EFF(205,"register()"),e.k0s(),e.EFF(206," method."),e.k0s(),e.j41(207,"pre")(208,"code",12),e.EFF(209,"\nCacheModule.register({\n  ttl: 5, // seconds\n  max: 10, // maximum number of items in cache\n});\n"),e.k0s()(),e.j41(210,"h4",21)(211,"span"),e.EFF(212,"Use module globally"),e.k0s()(),e.j41(213,"p"),e.EFF(214,"When you want to use "),e.j41(215,"code"),e.EFF(216,"CacheModule"),e.k0s(),e.EFF(217," in other modules, you'll need to import it (as is standard with any Nest module). Alternatively, declare it as a "),e.j41(218,"a",22),e.EFF(219,"global module"),e.k0s(),e.EFF(220," by setting the options object's "),e.j41(221,"code"),e.EFF(222,"isGlobal"),e.k0s(),e.EFF(223," property to "),e.j41(224,"code"),e.EFF(225,"true"),e.k0s(),e.EFF(226,", as shown below. In that case, you will not need to import "),e.j41(227,"code"),e.EFF(228,"CacheModule"),e.k0s(),e.EFF(229," in other modules once it's been loaded in the root module (e.g., "),e.j41(230,"code"),e.EFF(231,"AppModule"),e.k0s(),e.EFF(232,")."),e.k0s(),e.j41(233,"pre")(234,"code",12),e.EFF(235,"\nCacheModule.register({\n  isGlobal: true,\n});\n"),e.k0s()(),e.j41(236,"h4",23)(237,"span"),e.EFF(238,"Global cache overrides"),e.k0s()(),e.j41(239,"p"),e.EFF(240,"While global cache is enabled, cache entries are stored under a "),e.j41(241,"code"),e.EFF(242,"CacheKey"),e.k0s(),e.EFF(243," that is auto-generated based on the route path. You may override certain cache settings ("),e.j41(244,"code"),e.EFF(245,"@CacheKey()"),e.k0s(),e.EFF(246," and "),e.j41(247,"code"),e.EFF(248,"@CacheTTL()"),e.k0s(),e.EFF(249,") on a per-method basis, allowing customized caching strategies for individual controller methods. This may be most relevant while using "),e.j41(250,"a",24),e.EFF(251,"different cache stores."),e.k0s()(),e.j41(252,"p"),e.EFF(253,"You can apply the "),e.j41(254,"code"),e.EFF(255,"@CacheTTL()"),e.k0s(),e.EFF(256," decorator on a per-controller basis to set a caching TTL for the entire controller. In situations where both controller-level and method-level cache TTL settings are defined, the cache TTL settings specified at the method level will take priority over the ones set at the controller level."),e.k0s(),e.j41(257,"pre")(258,"code",12),e.EFF(259,"\n@Controller()\n@CacheTTL(50)\nexport class AppController {\n  @CacheKey('custom_key')\n  @CacheTTL(20)\n  findAll(): string[] {\n    return [];\n  }\n}\n"),e.k0s()(),e.j41(260,"blockquote",14)(261,"strong"),e.EFF(262,"Hint"),e.k0s(),e.EFF(263," The "),e.j41(264,"code"),e.EFF(265,"@CacheKey()"),e.k0s(),e.EFF(266," and "),e.j41(267,"code"),e.EFF(268,"@CacheTTL()"),e.k0s(),e.EFF(269," decorators are imported from the "),e.j41(270,"code"),e.EFF(271,"@nestjs/cache-manager"),e.k0s(),e.EFF(272," package.\n"),e.k0s(),e.j41(273,"p"),e.EFF(274,"The "),e.j41(275,"code"),e.EFF(276,"@CacheKey()"),e.k0s(),e.EFF(277," decorator may be used with or without a corresponding "),e.j41(278,"code"),e.EFF(279,"@CacheTTL()"),e.k0s(),e.EFF(280," decorator and vice versa. One may choose to override only the "),e.j41(281,"code"),e.EFF(282,"@CacheKey()"),e.k0s(),e.EFF(283," or only the "),e.j41(284,"code"),e.EFF(285,"@CacheTTL()"),e.k0s(),e.EFF(286,". Settings that are not overridden with a decorator will use the default values as registered globally (see "),e.j41(287,"a",25),e.EFF(288,"Customize caching"),e.k0s(),e.EFF(289,")."),e.k0s(),e.j41(290,"h4",26)(291,"span"),e.EFF(292,"WebSockets and Microservices"),e.k0s()(),e.j41(293,"p"),e.EFF(294,"You can also apply the "),e.j41(295,"code"),e.EFF(296,"CacheInterceptor"),e.k0s(),e.EFF(297," to WebSocket subscribers as well as Microservice's patterns (regardless of the transport method that is being used)."),e.k0s(),e.j41(298,"span",27),e.nrm(299,"app-tabs",null,1),e.k0s(),e.j41(301,"pre")(302,"code",12),e.EFF(303,"\n@CacheKey('events')\n@UseInterceptors(CacheInterceptor)\n@SubscribeMessage('events')\nhandleEvent(client: Client, data: string[]): Observable<string[]> {\n  return [];\n}\n"),e.k0s()(),e.j41(304,"pre")(305,"code",12),e.EFF(306,"\n@CacheKey('events')\n@UseInterceptors(CacheInterceptor)\n@SubscribeMessage('events')\nhandleEvent(client, data) {\n  return [];\n}\n"),e.k0s()(),e.j41(307,"p"),e.EFF(308,"However, the additional "),e.j41(309,"code"),e.EFF(310,"@CacheKey()"),e.k0s(),e.EFF(311," decorator is required in order to specify a key used to subsequently store and retrieve cached data. Also, please note that you "),e.j41(312,"strong"),e.EFF(313,"shouldn't cache everything"),e.k0s(),e.EFF(314,". Actions which perform some business operations rather than simply querying the data should never be cached."),e.k0s(),e.j41(315,"p"),e.EFF(316,"Additionally, you may specify a cache expiration time (TTL) by using the "),e.j41(317,"code"),e.EFF(318,"@CacheTTL()"),e.k0s(),e.EFF(319," decorator, which will override the global default TTL value."),e.k0s(),e.j41(320,"span",27),e.nrm(321,"app-tabs",null,2),e.k0s(),e.j41(323,"pre")(324,"code",12),e.EFF(325,"\n@CacheTTL(10)\n@UseInterceptors(CacheInterceptor)\n@SubscribeMessage('events')\nhandleEvent(client: Client, data: string[]): Observable<string[]> {\n  return [];\n}\n"),e.k0s()(),e.j41(326,"pre")(327,"code",12),e.EFF(328,"\n@CacheTTL(10)\n@UseInterceptors(CacheInterceptor)\n@SubscribeMessage('events')\nhandleEvent(client, data) {\n  return [];\n}\n"),e.k0s()(),e.j41(329,"blockquote",14)(330,"strong"),e.EFF(331,"Hint"),e.k0s(),e.EFF(332," The "),e.j41(333,"code"),e.EFF(334,"@CacheTTL()"),e.k0s(),e.EFF(335," decorator may be used with or without a corresponding "),e.j41(336,"code"),e.EFF(337,"@CacheKey()"),e.k0s(),e.EFF(338," decorator.\n"),e.k0s(),e.j41(339,"h4",28)(340,"span"),e.EFF(341,"Adjust tracking"),e.k0s()(),e.j41(342,"p"),e.EFF(343,"By default, Nest uses the request URL (in an HTTP app) or cache key (in websockets and microservices apps, set through the "),e.j41(344,"code"),e.EFF(345,"@CacheKey()"),e.k0s(),e.EFF(346," decorator) to associate cache records with your endpoints. Nevertheless, sometimes you might want to set up tracking based on different factors, for example, using HTTP headers (e.g. "),e.j41(347,"code"),e.EFF(348,"Authorization"),e.k0s(),e.EFF(349," to properly identify "),e.j41(350,"code"),e.EFF(351,"profile"),e.k0s(),e.EFF(352," endpoints)."),e.k0s(),e.j41(353,"p"),e.EFF(354,"In order to accomplish that, create a subclass of "),e.j41(355,"code"),e.EFF(356,"CacheInterceptor"),e.k0s(),e.EFF(357," and override the "),e.j41(358,"code"),e.EFF(359,"trackBy()"),e.k0s(),e.EFF(360," method."),e.k0s(),e.j41(361,"pre")(362,"code",12),e.EFF(363,"\n@Injectable()\nclass HttpCacheInterceptor extends CacheInterceptor {\n  trackBy(context: ExecutionContext): string | undefined {\n    return 'key';\n  }\n}\n"),e.k0s()(),e.j41(364,"h4",29)(365,"span"),e.EFF(366,"Different stores"),e.k0s()(),e.j41(367,"p"),e.EFF(368,"This service takes advantage of "),e.j41(369,"a",30),e.EFF(370,"cache-manager"),e.k0s(),e.EFF(371," under the hood. The "),e.j41(372,"code"),e.EFF(373,"cache-manager"),e.k0s(),e.EFF(374," package supports a wide-range of useful stores, for example, "),e.j41(375,"a",31),e.EFF(376,"Redis store"),e.k0s(),e.EFF(377,". A full list of supported stores is available "),e.j41(378,"a",32),e.EFF(379,"here"),e.k0s(),e.EFF(380,". To set up the Redis store, simply pass the package together with corresponding options to the "),e.j41(381,"code"),e.EFF(382,"register()"),e.k0s(),e.EFF(383," method."),e.k0s(),e.j41(384,"pre")(385,"code",12),e.EFF(386,"\nimport type { RedisClientOptions } from 'redis';\nimport * as redisStore from 'cache-manager-redis-store';\nimport { Module } from '@nestjs/common';\nimport { CacheModule } from '@nestjs/cache-manager';\nimport { AppController } from './app.controller';\n\n@Module({\n  imports: [\n    CacheModule.register<RedisClientOptions>({\n      store: redisStore,\n\n      // Store-specific configuration:\n      host: 'localhost',\n      port: 6379,\n    }),\n  ],\n  controllers: [AppController],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(387,"blockquote",10)(388,"strong"),e.EFF(389,"Warning"),e.k0s(),e.j41(390,"code"),e.EFF(391,"cache-manager-redis-store"),e.k0s(),e.EFF(392," does not support redis v4. In order for the "),e.j41(393,"code"),e.EFF(394,"ClientOpts"),e.k0s(),e.EFF(395," interface to exist and work correctly you need to install the\nlatest "),e.j41(396,"code"),e.EFF(397,"redis"),e.k0s(),e.EFF(398," 3.x.x major release. See this "),e.j41(399,"a",33),e.EFF(400,"issue"),e.k0s(),e.EFF(401," to track the progress of this upgrade.\n"),e.k0s(),e.j41(402,"h4",34)(403,"span"),e.EFF(404,"Async configuration"),e.k0s()(),e.j41(405,"p"),e.EFF(406,"You may want to asynchronously pass in module options instead of passing them statically at compile time. In this case, use the "),e.j41(407,"code"),e.EFF(408,"registerAsync()"),e.k0s(),e.EFF(409," method, which provides several ways to deal with async configuration."),e.k0s(),e.j41(410,"p"),e.EFF(411,"One approach is to use a factory function:"),e.k0s(),e.j41(412,"pre")(413,"code",12),e.EFF(414,"\nCacheModule.registerAsync({\n  useFactory: () => ({\n    ttl: 5,\n  }),\n});\n"),e.k0s()(),e.j41(415,"p"),e.EFF(416,"Our factory behaves like all other asynchronous module factories (it can be "),e.j41(417,"code"),e.EFF(418,"async"),e.k0s(),e.EFF(419," and is able to inject dependencies through "),e.j41(420,"code"),e.EFF(421,"inject"),e.k0s(),e.EFF(422,")."),e.k0s(),e.j41(423,"pre")(424,"code",12),e.EFF(425,"\nCacheModule.registerAsync({\n  imports: [ConfigModule],\n  useFactory: async (configService: ConfigService) => ({\n    ttl: configService.get('CACHE_TTL'),\n  }),\n  inject: [ConfigService],\n});\n"),e.k0s()(),e.j41(426,"p"),e.EFF(427,"Alternatively, you can use the "),e.j41(428,"code"),e.EFF(429,"useClass"),e.k0s(),e.EFF(430," method:"),e.k0s(),e.j41(431,"pre")(432,"code",12),e.EFF(433,"\nCacheModule.registerAsync({\n  useClass: CacheConfigService,\n});\n"),e.k0s()(),e.j41(434,"p"),e.EFF(435,"The above construction will instantiate "),e.j41(436,"code"),e.EFF(437,"CacheConfigService"),e.k0s(),e.EFF(438," inside "),e.j41(439,"code"),e.EFF(440,"CacheModule"),e.k0s(),e.EFF(441," and will use it to get the options object. The "),e.j41(442,"code"),e.EFF(443,"CacheConfigService"),e.k0s(),e.EFF(444," has to implement the "),e.j41(445,"code"),e.EFF(446,"CacheOptionsFactory"),e.k0s(),e.EFF(447," interface in order to provide the configuration options:"),e.k0s(),e.j41(448,"pre")(449,"code",12),e.EFF(450,"\n@Injectable()\nclass CacheConfigService implements CacheOptionsFactory {\n  createCacheOptions(): CacheModuleOptions {\n    return {\n      ttl: 5,\n    };\n  }\n}\n"),e.k0s()(),e.j41(451,"p"),e.EFF(452,"If you wish to use an existing configuration provider imported from a different module, use the "),e.j41(453,"code"),e.EFF(454,"useExisting"),e.k0s(),e.EFF(455," syntax:"),e.k0s(),e.j41(456,"pre")(457,"code",12),e.EFF(458,"\nCacheModule.registerAsync({\n  imports: [ConfigModule],\n  useExisting: ConfigService,\n});\n"),e.k0s()(),e.j41(459,"p"),e.EFF(460,"This works the same as "),e.j41(461,"code"),e.EFF(462,"useClass"),e.k0s(),e.EFF(463," with one critical difference - "),e.j41(464,"code"),e.EFF(465,"CacheModule"),e.k0s(),e.EFF(466," will lookup imported modules to reuse any already-created "),e.j41(467,"code"),e.EFF(468,"ConfigService"),e.k0s(),e.EFF(469,", instead of instantiating its own."),e.k0s(),e.j41(470,"blockquote",14)(471,"strong"),e.EFF(472,"Hint"),e.k0s(),e.j41(473,"code"),e.EFF(474,"CacheModule#register"),e.k0s(),e.EFF(475," and "),e.j41(476,"code"),e.EFF(477,"CacheModule#registerAsync"),e.k0s(),e.EFF(478," and "),e.j41(479,"code"),e.EFF(480,"CacheOptionsFactory"),e.k0s(),e.EFF(481," has an optional generic (type argument) to narrow down store-specific configuration options, making it type safe.\n"),e.k0s(),e.j41(482,"h4",35)(483,"span"),e.EFF(484,"Example"),e.k0s()(),e.j41(485,"p"),e.EFF(486,"A working example is available "),e.j41(487,"a",36),e.EFF(488,"here"),e.k0s(),e.EFF(489,"."),e.k0s()()),2&s){const a=e.sdS(300),r=e.sdS(322);e.R7$(301),e.AVh("hide",a.isJsActive),e.R7$(3),e.AVh("hide",!a.isJsActive),e.R7$(19),e.AVh("hide",r.isJsActive),e.R7$(3),e.AVh("hide",!r.isJsActive)}},dependencies:[p.O,F.a,E.Wk],encapsulation:2,changeDetection:0})}return t})(),q=(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-compression"]],features:[e.Vt3],decls:83,vars:0,consts:[["contentReference",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/compression.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","compression"],["appAnchor","","id","use-with-express-default"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/compression"],[1,"language-bash"],[1,"language-typescript"],["appAnchor","","id","use-with-fastify"],["rel","nofollow","target","_blank","href","https://github.com/fastify/fastify-compress"]],template:function(s,n){1&s&&(e.j41(0,"div",1,0)(2,"div",2)(3,"a",3),e.nrm(4,"i",4),e.k0s()(),e.j41(5,"h3",5),e.EFF(6,"Compression"),e.k0s(),e.j41(7,"p"),e.EFF(8,"Compression can greatly decrease the size of the response body, thereby increasing the speed of a web app."),e.k0s(),e.j41(9,"p"),e.EFF(10,"For "),e.j41(11,"strong"),e.EFF(12,"high-traffic"),e.k0s(),e.EFF(13," websites in production, it is strongly recommended to offload compression from the application server - typically in a reverse proxy (e.g., Nginx). In that case, you should not use compression middleware."),e.k0s(),e.j41(14,"h4",6)(15,"span"),e.EFF(16,"Use with Express (default)"),e.k0s()(),e.j41(17,"p"),e.EFF(18,"Use the "),e.j41(19,"a",7),e.EFF(20,"compression"),e.k0s(),e.EFF(21," middleware package to enable gzip compression."),e.k0s(),e.j41(22,"p"),e.EFF(23,"First install the required package:"),e.k0s(),e.j41(24,"pre")(25,"code",8),e.EFF(26,"\n$ npm i --save compression\n"),e.k0s()(),e.j41(27,"p"),e.EFF(28,"Once the installation is complete, apply the compression middleware as global middleware."),e.k0s(),e.j41(29,"pre")(30,"code",9),e.EFF(31,"\nimport * as compression from 'compression';\n// somewhere in your initialization file\napp.use(compression());\n"),e.k0s()(),e.j41(32,"h4",10)(33,"span"),e.EFF(34,"Use with Fastify"),e.k0s()(),e.j41(35,"p"),e.EFF(36,"If using the "),e.j41(37,"code"),e.EFF(38,"FastifyAdapter"),e.k0s(),e.EFF(39,", you'll want to use "),e.j41(40,"a",11),e.EFF(41,"fastify-compress"),e.k0s(),e.EFF(42,":"),e.k0s(),e.j41(43,"pre")(44,"code",8),e.EFF(45,"\n$ npm i --save @fastify/compress\n"),e.k0s()(),e.j41(46,"p"),e.EFF(47,"Once the installation is complete, apply the "),e.j41(48,"code"),e.EFF(49,"@fastify/compress"),e.k0s(),e.EFF(50," middleware as global middleware."),e.k0s(),e.j41(51,"pre")(52,"code",9),e.EFF(53,"\nimport compression from '@fastify/compress';\n// somewhere in your initialization file\nawait app.register(compression);\n"),e.k0s()(),e.j41(54,"p"),e.EFF(55,"By default, "),e.j41(56,"code"),e.EFF(57,"@fastify/compress"),e.k0s(),e.EFF(58," will use Brotli compression (on Node >= 11.7.0) when browsers indicate support for the encoding. While Brotli can be quite efficient in terms of compression ratio, it can also be quite slow. By default, Brotli sets a maximum compression quality of 11, although it can be adjusted to reduce compression time in lieu of compression quality by adjusting the "),e.j41(59,"code"),e.EFF(60,"BROTLI_PARAM_QUALITY"),e.k0s(),e.EFF(61," between 0 min and 11 max. This will require fine tuning to optimize space/time performance. An example with quality 4: "),e.k0s(),e.j41(62,"pre")(63,"code",9),e.EFF(64,"\nimport { constants } from 'zlib';\n// somewhere in your initialization file\nawait app.register(compression, { brotliOptions: { params: { [constants.BROTLI_PARAM_QUALITY]: 4 } } });\n"),e.k0s()(),e.j41(65,"p"),e.EFF(66,"To simplify, you may want to tell "),e.j41(67,"code"),e.EFF(68,"fastify-compress"),e.k0s(),e.EFF(69," to only use deflate and gzip to compress responses; you'll end up with potentially larger responses but they'll be delivered much more quickly."),e.k0s(),e.j41(70,"p"),e.EFF(71,"To specify encodings, provide a second argument to "),e.j41(72,"code"),e.EFF(73,"app.register"),e.k0s(),e.EFF(74,":"),e.k0s(),e.j41(75,"pre")(76,"code",9),e.EFF(77,"\nawait app.register(compression, { encodings: ['gzip', 'deflate'] });\n"),e.k0s()(),e.j41(78,"p"),e.EFF(79,"The above tells "),e.j41(80,"code"),e.EFF(81,"fastify-compress"),e.k0s(),e.EFF(82," to only use gzip and deflate encodings, preferring gzip if the client supports both."),e.k0s()())},dependencies:[F.a],encapsulation:2,changeDetection:0})}return t})();var T=d(7077),m=d(5663);let I=(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-configuration"]],features:[e.Vt3],decls:970,vars:56,consts:[["contentReference",""],["appacec76ac773074c02c841815555589fbeb1e5ae7",""],["app38fb5ba6645ea2db0f4dadbda7aea06813b6fb4d",""],["app53e242d50369ec01dc1d025f95011291cd0b1878",""],["app7dc01e85ca2ec8e9a7c4844786fc55ca7072cb0d",""],["app742f6c645b5560eba487950c5bb263bb07db8c35",""],["appe61d4d05cdbca9413efb54d09a1169513e2ec670",""],["appd3234e3a3ea27cc7e06bdab6eb58d42d7b22ea39",""],["app7c6eb9c6728e89c8d9cf9a5f06563429331b4df8",""],["app10a72e68dc568161d77e2f01449d5f5aa6081cb5",""],["app32f9090b19ae422c60ced12b84fa20353cc1f862",""],["appfc6a8be625b70ff5610bb7234fa71d9f4de6c012",""],["appecdfb9ad396440db7977fbe3ab583905e0f7e647",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/configuration.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","configuration"],["rel","nofollow","target","_blank","href","https://12factor.net/config"],["appAnchor","","id","installation"],[1,"language-bash"],[1,"info"],["rel","nofollow","target","_blank","href","https://github.com/motdotla/dotenv"],[1,"warning"],["appAnchor","","id","getting-started"],[1,"filename"],[1,"language-typescript"],[1,"language-json"],["appAnchor","","id","custom-env-file-path"],["appAnchor","","id","disable-env-variables-loading"],["appAnchor","","id","use-module-globally"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/modules#global-modules"],["appAnchor","","id","custom-configuration-files"],["href","techniques/configuration#getting-started"],[1,"language-yaml"],["href","/cli/monorepo#assets"],["appAnchor","","id","using-the-configservice"],["href","techniques/configuration#custom-configuration-files"],["appAnchor","","id","configuration-namespaces"],["appAnchor","","id","cache-environment-variables"],["appAnchor","","id","partial-registration"],["appAnchor","","id","schema-validation"],["rel","nofollow","target","_blank","href","https://github.com/sideway/joi"],["rel","nofollow","target","_blank","href","https://joi.dev/api/?v=17.3.0#example"],["rel","nofollow","target","_blank","href","https://joi.dev/api/?v=17.3.0#anyvalidatevalue-options"],["appAnchor","","id","custom-validate-function"],["appAnchor","","id","custom-getter-functions"],["appAnchor","","id","environment-variables-loaded-hook"],["appAnchor","","id","conditional-module-configuration"],["appAnchor","","id","expandable-variables"],["rel","nofollow","target","_blank","href","https://github.com/motdotla/dotenv-expand"],["appAnchor","","id","using-in-the-maints"]],template:function(s,n){if(1&s&&(e.j41(0,"div",13,0)(2,"div",14)(3,"a",15),e.nrm(4,"i",16),e.k0s()(),e.j41(5,"h3",17),e.EFF(6,"Configuration"),e.k0s(),e.j41(7,"p"),e.EFF(8,"Applications often run in different "),e.j41(9,"strong"),e.EFF(10,"environments"),e.k0s(),e.EFF(11,". Depending on the environment, different configuration settings should be used. For example, usually the local environment relies on specific database credentials, valid only for the local DB instance. The production environment would use a separate set of DB credentials. Since configuration variables change, best practice is to "),e.j41(12,"a",18),e.EFF(13,"store configuration variables"),e.k0s(),e.EFF(14," in the environment."),e.k0s(),e.j41(15,"p"),e.EFF(16,"Externally defined environment variables are visible inside Node.js through the "),e.j41(17,"code"),e.EFF(18,"process.env"),e.k0s(),e.EFF(19," global. We could try to solve the problem of multiple environments by setting the environment variables separately in each environment. This can quickly get unwieldy, especially in the development and testing environments where these values need to be easily mocked and/or changed."),e.k0s(),e.j41(20,"p"),e.EFF(21,"In Node.js applications, it's common to use "),e.j41(22,"code"),e.EFF(23,".env"),e.k0s(),e.EFF(24," files, holding key-value pairs where each key represents a particular value, to represent each environment. Running an app in different environments is then just a matter of swapping in the correct "),e.j41(25,"code"),e.EFF(26,".env"),e.k0s(),e.EFF(27," file."),e.k0s(),e.j41(28,"p"),e.EFF(29,"A good approach for using this technique in Nest is to create a "),e.j41(30,"code"),e.EFF(31,"ConfigModule"),e.k0s(),e.EFF(32," that exposes a "),e.j41(33,"code"),e.EFF(34,"ConfigService"),e.k0s(),e.EFF(35," which loads the appropriate "),e.j41(36,"code"),e.EFF(37,".env"),e.k0s(),e.EFF(38," file. While you may choose to write such a module yourself, for convenience Nest provides the "),e.j41(39,"code"),e.EFF(40,"@nestjs/config"),e.k0s(),e.EFF(41," package out-of-the box. We'll cover this package in the current chapter."),e.k0s(),e.j41(42,"h4",19)(43,"span"),e.EFF(44,"Installation"),e.k0s()(),e.j41(45,"p"),e.EFF(46,"To begin using it, we first install the required dependency."),e.k0s(),e.j41(47,"pre")(48,"code",20),e.EFF(49,"\n$ npm i --save @nestjs/config\n"),e.k0s()(),e.j41(50,"blockquote",21)(51,"strong"),e.EFF(52,"Hint"),e.k0s(),e.EFF(53," The "),e.j41(54,"code"),e.EFF(55,"@nestjs/config"),e.k0s(),e.EFF(56," package internally uses "),e.j41(57,"a",22),e.EFF(58,"dotenv"),e.k0s(),e.EFF(59,".\n"),e.k0s(),e.j41(60,"blockquote",23)(61,"strong"),e.EFF(62,"Note"),e.k0s(),e.j41(63,"code"),e.EFF(64,"@nestjs/config"),e.k0s(),e.EFF(65," requires TypeScript 4.1 or later.\n"),e.k0s(),e.j41(66,"h4",24)(67,"span"),e.EFF(68,"Getting started"),e.k0s()(),e.j41(69,"p"),e.EFF(70,"Once the installation process is complete, we can import the "),e.j41(71,"code"),e.EFF(72,"ConfigModule"),e.k0s(),e.EFF(73,". Typically, we'll import it into the root "),e.j41(74,"code"),e.EFF(75,"AppModule"),e.k0s(),e.EFF(76," and control its behavior using the "),e.j41(77,"code"),e.EFF(78,".forRoot()"),e.k0s(),e.EFF(79," static method. During this step, environment variable key/value pairs are parsed and resolved. Later, we'll see several options for accessing the "),e.j41(80,"code"),e.EFF(81,"ConfigService"),e.k0s(),e.EFF(82," class of the "),e.j41(83,"code"),e.EFF(84,"ConfigModule"),e.k0s(),e.EFF(85," in our other feature modules."),e.k0s(),e.j41(86,"span",25),e.EFF(87),e.nI1(88,"extension"),e.nrm(89,"app-tabs",null,1),e.k0s(),e.j41(91,"pre")(92,"code",26),e.EFF(93,"\nimport { Module } from '@nestjs/common';\nimport { ConfigModule } from '@nestjs/config';\n\n@Module({\n  imports: [ConfigModule.forRoot()],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(94,"p"),e.EFF(95,"The above code will load and parse a "),e.j41(96,"code"),e.EFF(97,".env"),e.k0s(),e.EFF(98," file from the default location (the project root directory), merge key/value pairs from the "),e.j41(99,"code"),e.EFF(100,".env"),e.k0s(),e.EFF(101," file with environment variables assigned to "),e.j41(102,"code"),e.EFF(103,"process.env"),e.k0s(),e.EFF(104,", and store the result in a private structure that you can access through the "),e.j41(105,"code"),e.EFF(106,"ConfigService"),e.k0s(),e.EFF(107,". The "),e.j41(108,"code"),e.EFF(109,"forRoot()"),e.k0s(),e.EFF(110," method registers the "),e.j41(111,"code"),e.EFF(112,"ConfigService"),e.k0s(),e.EFF(113," provider, which provides a "),e.j41(114,"code"),e.EFF(115,"get()"),e.k0s(),e.EFF(116," method for reading these parsed/merged configuration variables. Since "),e.j41(117,"code"),e.EFF(118,"@nestjs/config"),e.k0s(),e.EFF(119," relies on "),e.j41(120,"a",22),e.EFF(121,"dotenv"),e.k0s(),e.EFF(122,", it uses that package's rules for resolving conflicts in environment variable names. When a key exists both in the runtime environment as an environment variable (e.g., via OS shell exports like "),e.j41(123,"code"),e.EFF(124,"export DATABASE_USER=test"),e.k0s(),e.EFF(125,") and in a "),e.j41(126,"code"),e.EFF(127,".env"),e.k0s(),e.EFF(128," file, the runtime environment variable takes precedence."),e.k0s(),e.j41(129,"p"),e.EFF(130,"A sample "),e.j41(131,"code"),e.EFF(132,".env"),e.k0s(),e.EFF(133," file looks something like this:"),e.k0s(),e.j41(134,"pre")(135,"code",27),e.EFF(136,"\nDATABASE_USER=test\nDATABASE_PASSWORD=test\n"),e.k0s()(),e.j41(137,"h4",28)(138,"span"),e.EFF(139,"Custom env file path"),e.k0s()(),e.j41(140,"p"),e.EFF(141,"By default, the package looks for a "),e.j41(142,"code"),e.EFF(143,".env"),e.k0s(),e.EFF(144," file in the root directory of the application. To specify another path for the "),e.j41(145,"code"),e.EFF(146,".env"),e.k0s(),e.EFF(147," file, set the "),e.j41(148,"code"),e.EFF(149,"envFilePath"),e.k0s(),e.EFF(150," property of an (optional) options object you pass to "),e.j41(151,"code"),e.EFF(152,"forRoot()"),e.k0s(),e.EFF(153,", as follows:"),e.k0s(),e.j41(154,"pre")(155,"code",26),e.EFF(156,"\nConfigModule.forRoot({\n  envFilePath: '.development.env',\n});\n"),e.k0s()(),e.j41(157,"p"),e.EFF(158,"You can also specify multiple paths for "),e.j41(159,"code"),e.EFF(160,".env"),e.k0s(),e.EFF(161," files like this:"),e.k0s(),e.j41(162,"pre")(163,"code",26),e.EFF(164,"\nConfigModule.forRoot({\n  envFilePath: ['.env.development.local', '.env.development'],\n});\n"),e.k0s()(),e.j41(165,"p"),e.EFF(166,"If a variable is found in multiple files, the first one takes precedence."),e.k0s(),e.j41(167,"h4",29)(168,"span"),e.EFF(169,"Disable env variables loading"),e.k0s()(),e.j41(170,"p"),e.EFF(171,"If you don't want to load the "),e.j41(172,"code"),e.EFF(173,".env"),e.k0s(),e.EFF(174," file, but instead would like to simply access environment variables from the runtime environment (as with OS shell exports like "),e.j41(175,"code"),e.EFF(176,"export DATABASE_USER=test"),e.k0s(),e.EFF(177,"), set the options object's "),e.j41(178,"code"),e.EFF(179,"ignoreEnvFile"),e.k0s(),e.EFF(180," property to "),e.j41(181,"code"),e.EFF(182,"true"),e.k0s(),e.EFF(183,", as follows:"),e.k0s(),e.j41(184,"pre")(185,"code",26),e.EFF(186,"\nConfigModule.forRoot({\n  ignoreEnvFile: true,\n});\n"),e.k0s()(),e.j41(187,"h4",30)(188,"span"),e.EFF(189,"Use module globally"),e.k0s()(),e.j41(190,"p"),e.EFF(191,"When you want to use "),e.j41(192,"code"),e.EFF(193,"ConfigModule"),e.k0s(),e.EFF(194," in other modules, you'll need to import it (as is standard with any Nest module). Alternatively, declare it as a "),e.j41(195,"a",31),e.EFF(196,"global module"),e.k0s(),e.EFF(197," by setting the options object's "),e.j41(198,"code"),e.EFF(199,"isGlobal"),e.k0s(),e.EFF(200," property to "),e.j41(201,"code"),e.EFF(202,"true"),e.k0s(),e.EFF(203,", as shown below. In that case, you will not need to import "),e.j41(204,"code"),e.EFF(205,"ConfigModule"),e.k0s(),e.EFF(206," in other modules once it's been loaded in the root module (e.g., "),e.j41(207,"code"),e.EFF(208,"AppModule"),e.k0s(),e.EFF(209,")."),e.k0s(),e.j41(210,"pre")(211,"code",26),e.EFF(212,"\nConfigModule.forRoot({\n  isGlobal: true,\n});\n"),e.k0s()(),e.j41(213,"h4",32)(214,"span"),e.EFF(215,"Custom configuration files"),e.k0s()(),e.j41(216,"p"),e.EFF(217,"For more complex projects, you may utilize custom configuration files to return nested configuration objects. This allows you to group related configuration settings by function (e.g., database-related settings), and to store related settings in individual files to help manage them independently."),e.k0s(),e.j41(218,"p"),e.EFF(219,"A custom configuration file exports a factory function that returns a configuration object. The configuration object can be any arbitrarily nested plain JavaScript object. The "),e.j41(220,"code"),e.EFF(221,"process.env"),e.k0s(),e.EFF(222," object will contain the fully resolved environment variable key/value pairs (with "),e.j41(223,"code"),e.EFF(224,".env"),e.k0s(),e.EFF(225," file and externally defined variables resolved and merged as described "),e.j41(226,"a",33),e.EFF(227,"above"),e.k0s(),e.EFF(228,"). Since you control the returned configuration object, you can add any required logic to cast values to an appropriate type, set default values, etc. For example:"),e.k0s(),e.j41(229,"span",25),e.EFF(230),e.nI1(231,"extension"),e.nrm(232,"app-tabs",null,2),e.k0s(),e.j41(234,"pre")(235,"code",26),e.EFF(236,"\nexport default () => ({\n  port: parseInt(process.env.PORT, 10) || 3000,\n  database: {\n    host: process.env.DATABASE_HOST,\n    port: parseInt(process.env.DATABASE_PORT, 10) || 5432\n  }\n});\n"),e.k0s()(),e.j41(237,"p"),e.EFF(238,"We load this file using the "),e.j41(239,"code"),e.EFF(240,"load"),e.k0s(),e.EFF(241," property of the options object we pass to the "),e.j41(242,"code"),e.EFF(243,"ConfigModule.forRoot()"),e.k0s(),e.EFF(244," method:"),e.k0s(),e.j41(245,"pre")(246,"code",26),e.EFF(247,"\nimport configuration from './config/configuration';\n\n@Module({\n  imports: [\n    ConfigModule.forRoot({\n      load: [configuration],\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(248,"blockquote",21)(249,"strong"),e.EFF(250,"Notice"),e.k0s(),e.EFF(251," The value assigned to the "),e.j41(252,"code"),e.EFF(253,"load"),e.k0s(),e.EFF(254," property is an array, allowing you to load multiple configuration files (e.g. "),e.j41(255,"code"),e.EFF(256,"load: [databaseConfig, authConfig]"),e.k0s(),e.EFF(257,")\n"),e.k0s(),e.j41(258,"p"),e.EFF(259,"With custom configuration files, we can also manage custom files such as YAML files. Here is an example of a configuration using YAML format:"),e.k0s(),e.j41(260,"pre")(261,"code",34),e.EFF(262,"\nhttp:\n  host: 'localhost'\n  port: 8080\n\ndb:\n  postgres:\n    url: 'localhost'\n    port: 5432\n    database: 'yaml-db'\n\n  sqlite:\n    database: 'sqlite.db'\n"),e.k0s()(),e.j41(263,"p"),e.EFF(264,"To read and parse YAML files, we can leverage the "),e.j41(265,"code"),e.EFF(266,"js-yaml"),e.k0s(),e.EFF(267," package."),e.k0s(),e.j41(268,"pre")(269,"code",20),e.EFF(270,"\n$ npm i js-yaml\n$ npm i -D @types/js-yaml\n"),e.k0s()(),e.j41(271,"p"),e.EFF(272,"Once the package is installed, we use "),e.j41(273,"code"),e.EFF(274,"yaml#load"),e.k0s(),e.EFF(275," function to load YAML file we just created above."),e.k0s(),e.j41(276,"span",25),e.EFF(277),e.nI1(278,"extension"),e.nrm(279,"app-tabs",null,3),e.k0s(),e.j41(281,"pre")(282,"code",26),e.EFF(283,"\nimport { readFileSync } from 'fs';\nimport * as yaml from 'js-yaml';\nimport { join } from 'path';\n\nconst YAML_CONFIG_FILENAME = 'config.yaml';\n\nexport default () => {\n  return yaml.load(\n    readFileSync(join(__dirname, YAML_CONFIG_FILENAME), 'utf8'),\n  ) as Record<string, any>;\n};\n"),e.k0s()(),e.j41(284,"blockquote",23)(285,"strong"),e.EFF(286,"Note"),e.k0s(),e.EFF(287,' Nest CLI does not automatically move your "assets" (non-TS files) to the '),e.j41(288,"code"),e.EFF(289,"dist"),e.k0s(),e.EFF(290," folder during the build process. To make sure that your YAML files are copied, you have to specify this in the "),e.j41(291,"code"),e.EFF(292,"compilerOptions#assets"),e.k0s(),e.EFF(293," object in the "),e.j41(294,"code"),e.EFF(295,"nest-cli.json"),e.k0s(),e.EFF(296," file. As an example, if the "),e.j41(297,"code"),e.EFF(298,"config"),e.k0s(),e.EFF(299," folder is at the same level as the "),e.j41(300,"code"),e.EFF(301,"src"),e.k0s(),e.EFF(302," folder, add "),e.j41(303,"code"),e.EFF(304,"compilerOptions#assets"),e.k0s(),e.EFF(305," with the value "),e.j41(306,"code"),e.EFF(307),e.k0s(),e.EFF(308,". Read more "),e.j41(309,"a",35),e.EFF(310,"here"),e.k0s(),e.EFF(311,".\n"),e.k0s(),e.j41(312,"p"),e.nrm(313,"app-banner-devtools"),e.k0s(),e.j41(314,"h4",36)(315,"span"),e.EFF(316,"Using the "),e.j41(317,"code"),e.EFF(318,"ConfigService"),e.k0s()()(),e.j41(319,"p"),e.EFF(320,"To access configuration values from our "),e.j41(321,"code"),e.EFF(322,"ConfigService"),e.k0s(),e.EFF(323,", we first need to inject "),e.j41(324,"code"),e.EFF(325,"ConfigService"),e.k0s(),e.EFF(326,". As with any provider, we need to import its containing module - the "),e.j41(327,"code"),e.EFF(328,"ConfigModule"),e.k0s(),e.EFF(329," - into the module that will use it (unless you set the "),e.j41(330,"code"),e.EFF(331,"isGlobal"),e.k0s(),e.EFF(332," property in the options object passed to the "),e.j41(333,"code"),e.EFF(334,"ConfigModule.forRoot()"),e.k0s(),e.EFF(335," method to "),e.j41(336,"code"),e.EFF(337,"true"),e.k0s(),e.EFF(338,"). Import it into a feature module as shown below."),e.k0s(),e.j41(339,"span",25),e.EFF(340),e.nI1(341,"extension"),e.nrm(342,"app-tabs",null,4),e.k0s(),e.j41(344,"pre")(345,"code",26),e.EFF(346,"\n@Module({\n  imports: [ConfigModule],\n  // ...\n})\n"),e.k0s()(),e.j41(347,"p"),e.EFF(348,"Then we can inject it using standard constructor injection:"),e.k0s(),e.j41(349,"pre")(350,"code",26),e.EFF(351,"\nconstructor(private configService: ConfigService) {}\n"),e.k0s()(),e.j41(352,"blockquote",21)(353,"strong"),e.EFF(354,"Hint"),e.k0s(),e.EFF(355," The "),e.j41(356,"code"),e.EFF(357,"ConfigService"),e.k0s(),e.EFF(358," is imported from the "),e.j41(359,"code"),e.EFF(360,"@nestjs/config"),e.k0s(),e.EFF(361," package.\n"),e.k0s(),e.j41(362,"p"),e.EFF(363,"And use it in our class:"),e.k0s(),e.j41(364,"pre")(365,"code",26),e.EFF(366,"\n// get an environment variable\nconst dbUser = this.configService.get<string>('DATABASE_USER');\n\n// get a custom configuration value\nconst dbHost = this.configService.get<string>('database.host');\n"),e.k0s()(),e.j41(367,"p"),e.EFF(368,"As shown above, use the "),e.j41(369,"code"),e.EFF(370,"configService.get()"),e.k0s(),e.EFF(371," method to get a simple environment variable by passing the variable name. You can do TypeScript type hinting by passing the type, as shown above (e.g., "),e.j41(372,"code"),e.EFF(373,"get<string>(...)"),e.k0s(),e.EFF(374,"). The "),e.j41(375,"code"),e.EFF(376,"get()"),e.k0s(),e.EFF(377," method can also traverse a nested custom configuration object (created via a "),e.j41(378,"a",37),e.EFF(379,"Custom configuration file"),e.k0s(),e.EFF(380,"), as shown in the second example above."),e.k0s(),e.j41(381,"p"),e.EFF(382,"You can also get the whole nested custom configuration object using an interface as the type hint:"),e.k0s(),e.j41(383,"pre")(384,"code",26),e.EFF(385,"\ninterface DatabaseConfig {\n  host: string;\n  port: number;\n}\n\nconst dbConfig = this.configService.get<DatabaseConfig>('database');\n\n// you can now use `dbConfig.port` and `dbConfig.host`\nconst port = dbConfig.port;\n"),e.k0s()(),e.j41(386,"p"),e.EFF(387,"The "),e.j41(388,"code"),e.EFF(389,"get()"),e.k0s(),e.EFF(390," method also takes an optional second argument defining a default value, which will be returned when the key doesn't exist, as shown below:"),e.k0s(),e.j41(391,"pre")(392,"code",26),e.EFF(393,"\n// use \"localhost\" when \"database.host\" is not defined\nconst dbHost = this.configService.get<string>('database.host', 'localhost');\n"),e.k0s()(),e.j41(394,"p")(395,"code"),e.EFF(396,"ConfigService"),e.k0s(),e.EFF(397," has two optional generics (type arguments). The first one is to help prevent accessing a config property that does not exist. Use it as shown below:"),e.k0s(),e.j41(398,"pre")(399,"code",26),e.EFF(400,"\ninterface EnvironmentVariables {\n  PORT: number;\n  TIMEOUT: string;\n}\n\n// somewhere in the code\nconstructor(private configService: ConfigService<EnvironmentVariables>) {\n  const port = this.configService.get('PORT', { infer: true });\n\n  // TypeScript Error: this is invalid as the URL property is not defined in EnvironmentVariables\n  const url = this.configService.get('URL', { infer: true });\n}\n"),e.k0s()(),e.j41(401,"p"),e.EFF(402,"With the "),e.j41(403,"code"),e.EFF(404,"infer"),e.k0s(),e.EFF(405," property set to "),e.j41(406,"code"),e.EFF(407,"true"),e.k0s(),e.EFF(408,", the "),e.j41(409,"code"),e.EFF(410,"ConfigService#get"),e.k0s(),e.EFF(411," method will automatically infer the property type based on the interface, so for example, "),e.j41(412,"code"),e.EFF(413,'typeof port === "number"'),e.k0s(),e.EFF(414," (if you're not using "),e.j41(415,"code"),e.EFF(416,"strictNullChecks"),e.k0s(),e.EFF(417," flag from TypeScript) since "),e.j41(418,"code"),e.EFF(419,"PORT"),e.k0s(),e.EFF(420," has a "),e.j41(421,"code"),e.EFF(422,"number"),e.k0s(),e.EFF(423," type in the "),e.j41(424,"code"),e.EFF(425,"EnvironmentVariables"),e.k0s(),e.EFF(426," interface."),e.k0s(),e.j41(427,"p"),e.EFF(428,"Also, with the "),e.j41(429,"code"),e.EFF(430,"infer"),e.k0s(),e.EFF(431," feature, you can infer the type of a nested custom configuration object's property, even when using dot notation, as follows:"),e.k0s(),e.j41(432,"pre")(433,"code",26),e.EFF(434,"\nconstructor(private configService: ConfigService<{ database: { host: string } }>) {\n  const dbHost = this.configService.get('database.host', { infer: true })!;\n  // typeof dbHost === \"string\"                                          |\n  //                                                                     +--\x3e non-null assertion operator\n}\n"),e.k0s()(),e.j41(435,"p"),e.EFF(436,"The second generic relies on the first one, acting as a type assertion to get rid of all "),e.j41(437,"code"),e.EFF(438,"undefined"),e.k0s(),e.EFF(439," types that "),e.j41(440,"code"),e.EFF(441,"ConfigService"),e.k0s(),e.EFF(442,"'s methods can return when "),e.j41(443,"code"),e.EFF(444,"strictNullChecks"),e.k0s(),e.EFF(445," is on. For instance:"),e.k0s(),e.j41(446,"pre")(447,"code",26),e.EFF(448,"\n// ...\nconstructor(private configService: ConfigService<{ PORT: number }, true>) {\n  //                                                               ^^^^\n  const port = this.configService.get('PORT', { infer: true });\n  //    ^^^ The type of port will be 'number' thus you don't need TS type assertions anymore\n}\n"),e.k0s()(),e.j41(449,"h4",38)(450,"span"),e.EFF(451,"Configuration namespaces"),e.k0s()(),e.j41(452,"p"),e.EFF(453,"The "),e.j41(454,"code"),e.EFF(455,"ConfigModule"),e.k0s(),e.EFF(456," allows you to define and load multiple custom configuration files, as shown in "),e.j41(457,"a",37),e.EFF(458,"Custom configuration files"),e.k0s(),e.EFF(459,' above. You can manage complex configuration object hierarchies with nested configuration objects as shown in that section. Alternatively, you can return a "namespaced" configuration object with the '),e.j41(460,"code"),e.EFF(461,"registerAs()"),e.k0s(),e.EFF(462," function as follows:"),e.k0s(),e.j41(463,"span",25),e.EFF(464),e.nI1(465,"extension"),e.nrm(466,"app-tabs",null,5),e.k0s(),e.j41(468,"pre")(469,"code",26),e.EFF(470,"\nexport default registerAs('database', () => ({\n  host: process.env.DATABASE_HOST,\n  port: process.env.DATABASE_PORT || 5432\n}));\n"),e.k0s()(),e.j41(471,"p"),e.EFF(472,"As with custom configuration files, inside your "),e.j41(473,"code"),e.EFF(474,"registerAs()"),e.k0s(),e.EFF(475," factory function, the "),e.j41(476,"code"),e.EFF(477,"process.env"),e.k0s(),e.EFF(478," object will contain the fully resolved environment variable key/value pairs (with "),e.j41(479,"code"),e.EFF(480,".env"),e.k0s(),e.EFF(481," file and externally defined variables resolved and merged as described "),e.j41(482,"a",33),e.EFF(483,"above"),e.k0s(),e.EFF(484,")."),e.k0s(),e.j41(485,"blockquote",21)(486,"strong"),e.EFF(487,"Hint"),e.k0s(),e.EFF(488," The "),e.j41(489,"code"),e.EFF(490,"registerAs"),e.k0s(),e.EFF(491," function is exported from the "),e.j41(492,"code"),e.EFF(493,"@nestjs/config"),e.k0s(),e.EFF(494," package.\n"),e.k0s(),e.j41(495,"p"),e.EFF(496,"Load a namespaced configuration with the "),e.j41(497,"code"),e.EFF(498,"load"),e.k0s(),e.EFF(499," property of the "),e.j41(500,"code"),e.EFF(501,"forRoot()"),e.k0s(),e.EFF(502," method's options object, in the same way you load a custom configuration file:"),e.k0s(),e.j41(503,"pre")(504,"code",26),e.EFF(505,"\nimport databaseConfig from './config/database.config';\n\n@Module({\n  imports: [\n    ConfigModule.forRoot({\n      load: [databaseConfig],\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(506,"p"),e.EFF(507,"Now, to get the "),e.j41(508,"code"),e.EFF(509,"host"),e.k0s(),e.EFF(510," value from the "),e.j41(511,"code"),e.EFF(512,"database"),e.k0s(),e.EFF(513," namespace, use dot notation. Use "),e.j41(514,"code"),e.EFF(515,"'database'"),e.k0s(),e.EFF(516," as the prefix to the property name, corresponding to the name of the namespace (passed as the first argument to the "),e.j41(517,"code"),e.EFF(518,"registerAs()"),e.k0s(),e.EFF(519," function):"),e.k0s(),e.j41(520,"pre")(521,"code",26),e.EFF(522,"\nconst dbHost = this.configService.get<string>('database.host');\n"),e.k0s()(),e.j41(523,"p"),e.EFF(524,"A reasonable alternative is to inject the "),e.j41(525,"code"),e.EFF(526,"database"),e.k0s(),e.EFF(527," namespace directly. This allows us to benefit from strong typing:"),e.k0s(),e.j41(528,"pre")(529,"code",26),e.EFF(530,"\nconstructor(\n  @Inject(databaseConfig.KEY)\n  private dbConfig: ConfigType<typeof databaseConfig>,\n) {}\n"),e.k0s()(),e.j41(531,"blockquote",21)(532,"strong"),e.EFF(533,"Hint"),e.k0s(),e.EFF(534," The "),e.j41(535,"code"),e.EFF(536,"ConfigType"),e.k0s(),e.EFF(537," is exported from the "),e.j41(538,"code"),e.EFF(539,"@nestjs/config"),e.k0s(),e.EFF(540," package.\n"),e.k0s(),e.j41(541,"h4",39)(542,"span"),e.EFF(543,"Cache environment variables"),e.k0s()(),e.j41(544,"p"),e.EFF(545,"As accessing "),e.j41(546,"code"),e.EFF(547,"process.env"),e.k0s(),e.EFF(548," can be slow, you can set the "),e.j41(549,"code"),e.EFF(550,"cache"),e.k0s(),e.EFF(551," property of the options object passed to "),e.j41(552,"code"),e.EFF(553,"ConfigModule.forRoot()"),e.k0s(),e.EFF(554," to increase the performance of "),e.j41(555,"code"),e.EFF(556,"ConfigService#get"),e.k0s(),e.EFF(557," method when it comes to variables stored in "),e.j41(558,"code"),e.EFF(559,"process.env"),e.k0s(),e.EFF(560,"."),e.k0s(),e.j41(561,"pre")(562,"code",26),e.EFF(563,"\nConfigModule.forRoot({\n  cache: true,\n});\n"),e.k0s()(),e.j41(564,"h4",40)(565,"span"),e.EFF(566,"Partial registration"),e.k0s()(),e.j41(567,"p"),e.EFF(568,"Thus far, we've processed configuration files in our root module (e.g., "),e.j41(569,"code"),e.EFF(570,"AppModule"),e.k0s(),e.EFF(571,"), with the "),e.j41(572,"code"),e.EFF(573,"forRoot()"),e.k0s(),e.EFF(574," method. Perhaps you have a more complex project structure, with feature-specific configuration files located in multiple different directories. Rather than load all these files in the root module, the "),e.j41(575,"code"),e.EFF(576,"@nestjs/config"),e.k0s(),e.EFF(577," package provides a feature called "),e.j41(578,"strong"),e.EFF(579,"partial registration"),e.k0s(),e.EFF(580,", which references only the configuration files associated with each feature module. Use the "),e.j41(581,"code"),e.EFF(582,"forFeature()"),e.k0s(),e.EFF(583," static method within a feature module to perform this partial registration, as follows:"),e.k0s(),e.j41(584,"pre")(585,"code",26),e.EFF(586,"\nimport databaseConfig from './config/database.config';\n\n@Module({\n  imports: [ConfigModule.forFeature(databaseConfig)],\n})\nexport class DatabaseModule {}\n"),e.k0s()(),e.j41(587,"blockquote",21)(588,"strong"),e.EFF(589,"Warning"),e.k0s(),e.EFF(590," In some circumstances, you may need to access properties loaded via partial registration using the "),e.j41(591,"code"),e.EFF(592,"onModuleInit()"),e.k0s(),e.EFF(593," hook, rather than in a constructor. This is because the "),e.j41(594,"code"),e.EFF(595,"forFeature()"),e.k0s(),e.EFF(596," method is run during module initialization, and the order of module initialization is indeterminate. If you access values loaded this way by another module, in a constructor, the module that the configuration depends upon may not yet have initialized. The "),e.j41(597,"code"),e.EFF(598,"onModuleInit()"),e.k0s(),e.EFF(599," method runs only after all modules it depends upon have been initialized, so this technique is safe.\n"),e.k0s(),e.j41(600,"h4",41)(601,"span"),e.EFF(602,"Schema validation"),e.k0s()(),e.j41(603,"p"),e.EFF(604,"It is standard practice to throw an exception during application startup if required environment variables haven't been provided or if they don't meet certain validation rules. The "),e.j41(605,"code"),e.EFF(606,"@nestjs/config"),e.k0s(),e.EFF(607," package enables two different ways to do this:"),e.k0s(),e.j41(608,"ul")(609,"li")(610,"a",42),e.EFF(611,"Joi"),e.k0s(),e.EFF(612," built-in validator. With Joi, you define an object schema and validate JavaScript objects against it."),e.k0s(),e.j41(613,"li"),e.EFF(614,"A custom "),e.j41(615,"code"),e.EFF(616,"validate()"),e.k0s(),e.EFF(617," function which takes environment variables as an input."),e.k0s()(),e.j41(618,"p"),e.EFF(619,"To use Joi, we must install Joi package:"),e.k0s(),e.j41(620,"pre")(621,"code",20),e.EFF(622,"\n$ npm install --save joi\n"),e.k0s()(),e.j41(623,"p"),e.EFF(624,"Now we can define a Joi validation schema and pass it via the "),e.j41(625,"code"),e.EFF(626,"validationSchema"),e.k0s(),e.EFF(627," property of the "),e.j41(628,"code"),e.EFF(629,"forRoot()"),e.k0s(),e.EFF(630," method's options object, as shown below:"),e.k0s(),e.j41(631,"span",25),e.EFF(632),e.nI1(633,"extension"),e.nrm(634,"app-tabs",null,6),e.k0s(),e.j41(636,"pre")(637,"code",26),e.EFF(638,"\nimport * as Joi from 'joi';\n\n@Module({\n  imports: [\n    ConfigModule.forRoot({\n      validationSchema: Joi.object({\n        NODE_ENV: Joi.string()\n          .valid('development', 'production', 'test', 'provision')\n          .default('development'),\n        PORT: Joi.number().port().default(3000),\n      }),\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(639,"p"),e.EFF(640,"By default, all schema keys are considered optional. Here, we set default values for "),e.j41(641,"code"),e.EFF(642,"NODE_ENV"),e.k0s(),e.EFF(643," and "),e.j41(644,"code"),e.EFF(645,"PORT"),e.k0s(),e.EFF(646," which will be used if we don't provide these variables in the environment ("),e.j41(647,"code"),e.EFF(648,".env"),e.k0s(),e.EFF(649," file or process environment). Alternatively, we can use the "),e.j41(650,"code"),e.EFF(651,"required()"),e.k0s(),e.EFF(652," validation method to require that a value must be defined in the environment ("),e.j41(653,"code"),e.EFF(654,".env"),e.k0s(),e.EFF(655," file or process environment). In this case, the validation step will throw an exception if we don't provide the variable in the environment. See "),e.j41(656,"a",43),e.EFF(657,"Joi validation methods"),e.k0s(),e.EFF(658," for more on how to construct validation schemas."),e.k0s(),e.j41(659,"p"),e.EFF(660,"By default, unknown environment variables (environment variables whose keys are not present in the schema) are allowed and do not trigger a validation exception. By default, all validation errors are reported. You can alter these behaviors by passing an options object via the "),e.j41(661,"code"),e.EFF(662,"validationOptions"),e.k0s(),e.EFF(663," key of the "),e.j41(664,"code"),e.EFF(665,"forRoot()"),e.k0s(),e.EFF(666," options object. This options object can contain any of the standard validation options properties provided by "),e.j41(667,"a",44),e.EFF(668,"Joi validation options"),e.k0s(),e.EFF(669,". For example, to reverse the two settings above, pass options like this:"),e.k0s(),e.j41(670,"span",25),e.EFF(671),e.nI1(672,"extension"),e.nrm(673,"app-tabs",null,7),e.k0s(),e.j41(675,"pre")(676,"code",26),e.EFF(677,"\nimport * as Joi from 'joi';\n\n@Module({\n  imports: [\n    ConfigModule.forRoot({\n      validationSchema: Joi.object({\n        NODE_ENV: Joi.string()\n          .valid('development', 'production', 'test', 'provision')\n          .default('development'),\n        PORT: Joi.number().port().default(3000),\n      }),\n      validationOptions: {\n        allowUnknown: false,\n        abortEarly: true,\n      },\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(678,"p"),e.EFF(679,"The "),e.j41(680,"code"),e.EFF(681,"@nestjs/config"),e.k0s(),e.EFF(682," package uses default settings of:"),e.k0s(),e.j41(683,"ul")(684,"li")(685,"code"),e.EFF(686,"allowUnknown"),e.k0s(),e.EFF(687,": controls whether or not to allow unknown keys in the environment variables. Default is "),e.j41(688,"code"),e.EFF(689,"true"),e.k0s()(),e.j41(690,"li")(691,"code"),e.EFF(692,"abortEarly"),e.k0s(),e.EFF(693,": if true, stops validation on the first error; if false, returns all errors. Defaults to "),e.j41(694,"code"),e.EFF(695,"false"),e.k0s(),e.EFF(696,"."),e.k0s()(),e.j41(697,"p"),e.EFF(698,"Note that once you decide to pass a "),e.j41(699,"code"),e.EFF(700,"validationOptions"),e.k0s(),e.EFF(701," object, any settings you do not explicitly pass will default to "),e.j41(702,"code"),e.EFF(703,"Joi"),e.k0s(),e.EFF(704," standard defaults (not the "),e.j41(705,"code"),e.EFF(706,"@nestjs/config"),e.k0s(),e.EFF(707," defaults). For example, if you leave "),e.j41(708,"code"),e.EFF(709,"allowUnknowns"),e.k0s(),e.EFF(710," unspecified in your custom "),e.j41(711,"code"),e.EFF(712,"validationOptions"),e.k0s(),e.EFF(713," object, it will have the "),e.j41(714,"code"),e.EFF(715,"Joi"),e.k0s(),e.EFF(716," default value of "),e.j41(717,"code"),e.EFF(718,"false"),e.k0s(),e.EFF(719,". Hence, it is probably safest to specify "),e.j41(720,"strong"),e.EFF(721,"both"),e.k0s(),e.EFF(722," of these settings in your custom object."),e.k0s(),e.j41(723,"h4",45)(724,"span"),e.EFF(725,"Custom validate function"),e.k0s()(),e.j41(726,"p"),e.EFF(727,"Alternatively, you can specify a "),e.j41(728,"strong"),e.EFF(729,"synchronous"),e.k0s(),e.j41(730,"code"),e.EFF(731,"validate"),e.k0s(),e.EFF(732," function that takes an object containing the environment variables (from env file and process) and returns an object containing validated environment variables so that you can convert/mutate them if needed. If the function throws an error, it will prevent the application from bootstrapping."),e.k0s(),e.j41(733,"p"),e.EFF(734,"In this example, we'll proceed with the "),e.j41(735,"code"),e.EFF(736,"class-transformer"),e.k0s(),e.EFF(737," and "),e.j41(738,"code"),e.EFF(739,"class-validator"),e.k0s(),e.EFF(740," packages. First, we have to define:"),e.k0s(),e.j41(741,"ul")(742,"li"),e.EFF(743,"a class with validation constraints,"),e.k0s(),e.j41(744,"li"),e.EFF(745,"a validate function that makes use of the "),e.j41(746,"code"),e.EFF(747,"plainToInstance"),e.k0s(),e.EFF(748," and "),e.j41(749,"code"),e.EFF(750,"validateSync"),e.k0s(),e.EFF(751," functions."),e.k0s()(),e.j41(752,"span",25),e.EFF(753),e.nI1(754,"extension"),e.nrm(755,"app-tabs",null,8),e.k0s(),e.j41(757,"pre")(758,"code",26),e.EFF(759,'\nimport { plainToInstance } from \'class-transformer\';\nimport { IsEnum, IsNumber, Max, Min, validateSync } from \'class-validator\';\n\nenum Environment {\n  Development = "development",\n  Production = "production",\n  Test = "test",\n  Provision = "provision",\n}\n\nclass EnvironmentVariables {\n  @IsEnum(Environment)\n  NODE_ENV: Environment;\n\n  @IsNumber()\n  @Min(0)\n  @Max(65535)\n  PORT: number;\n}\n\nexport function validate(config: Record<string, unknown>) {\n  const validatedConfig = plainToInstance(\n    EnvironmentVariables,\n    config,\n    { enableImplicitConversion: true },\n  );\n  const errors = validateSync(validatedConfig, { skipMissingProperties: false });\n\n  if (errors.length > 0) {\n    throw new Error(errors.toString());\n  }\n  return validatedConfig;\n}\n'),e.k0s()(),e.j41(760,"p"),e.EFF(761,"With this in place, use the "),e.j41(762,"code"),e.EFF(763,"validate"),e.k0s(),e.EFF(764," function as a configuration option of the "),e.j41(765,"code"),e.EFF(766,"ConfigModule"),e.k0s(),e.EFF(767,", as follows:"),e.k0s(),e.j41(768,"span",25),e.EFF(769),e.nI1(770,"extension"),e.nrm(771,"app-tabs",null,9),e.k0s(),e.j41(773,"pre")(774,"code",26),e.EFF(775,"\nimport { validate } from './env.validation';\n\n@Module({\n  imports: [\n    ConfigModule.forRoot({\n      validate,\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(776,"h4",46)(777,"span"),e.EFF(778,"Custom getter functions"),e.k0s()(),e.j41(779,"p")(780,"code"),e.EFF(781,"ConfigService"),e.k0s(),e.EFF(782," defines a generic "),e.j41(783,"code"),e.EFF(784,"get()"),e.k0s(),e.EFF(785," method to retrieve a configuration value by key. We may also add "),e.j41(786,"code"),e.EFF(787,"getter"),e.k0s(),e.EFF(788," functions to enable a little more natural coding style:"),e.k0s(),e.j41(789,"span",25),e.nrm(790,"app-tabs",null,10),e.k0s(),e.j41(792,"pre")(793,"code",26),e.EFF(794,"\n@Injectable()\nexport class ApiConfigService {\n  constructor(private configService: ConfigService) {}\n\n  get isAuthEnabled(): boolean {\n    return this.configService.get('AUTH_ENABLED') === 'true';\n  }\n}\n"),e.k0s()(),e.j41(795,"pre")(796,"code",26),e.EFF(797,"\n@Dependencies(ConfigService)\n@Injectable()\nexport class ApiConfigService {\n  constructor(configService) {\n    this.configService = configService;\n  }\n\n  get isAuthEnabled() {\n    return this.configService.get('AUTH_ENABLED') === 'true';\n  }\n}\n"),e.k0s()(),e.j41(798,"p"),e.EFF(799,"Now we can use the getter function as follows:"),e.k0s(),e.j41(800,"span",25),e.EFF(801),e.nI1(802,"extension"),e.nrm(803,"app-tabs",null,11),e.k0s(),e.j41(805,"pre")(806,"code",26),e.EFF(807,"\n@Injectable()\nexport class AppService {\n  constructor(apiConfigService: ApiConfigService) {\n    if (apiConfigService.isAuthEnabled) {\n      // Authentication is enabled\n    }\n  }\n}\n"),e.k0s()(),e.j41(808,"pre")(809,"code",26),e.EFF(810,"\n@Dependencies(ApiConfigService)\n@Injectable()\nexport class AppService {\n  constructor(apiConfigService) {\n    if (apiConfigService.isAuthEnabled) {\n      // Authentication is enabled\n    }\n  }\n}\n"),e.k0s()(),e.j41(811,"h4",47)(812,"span"),e.EFF(813,"Environment variables loaded hook"),e.k0s()(),e.j41(814,"p"),e.EFF(815,"If a module configuration depends on the environment variables, and these variables are loaded from the "),e.j41(816,"code"),e.EFF(817,".env"),e.k0s(),e.EFF(818," file, you can use the "),e.j41(819,"code"),e.EFF(820,"ConfigModule.envVariablesLoaded"),e.k0s(),e.EFF(821," hook to ensure that the file was loaded before interacting with the "),e.j41(822,"code"),e.EFF(823,"process.env"),e.k0s(),e.EFF(824," object, see the following example:"),e.k0s(),e.j41(825,"pre")(826,"code",26),e.EFF(827,"\nexport async function getStorageModule() {\n  await ConfigModule.envVariablesLoaded;\n  return process.env.STORAGE === 'S3' ? S3StorageModule : DefaultStorageModule;\n}\n"),e.k0s()(),e.j41(828,"p"),e.EFF(829,"This construction guarantees that after the "),e.j41(830,"code"),e.EFF(831,"ConfigModule.envVariablesLoaded"),e.k0s(),e.EFF(832," Promise resolves, all configuration variables are loaded up."),e.k0s(),e.j41(833,"h4",48)(834,"span"),e.EFF(835,"Conditional module configuration"),e.k0s()(),e.j41(836,"p"),e.EFF(837,"There may be times where you want to conditionally load in a module and specify the condition in an env variable. Fortunately, "),e.j41(838,"code"),e.EFF(839,"@nestjs/config"),e.k0s(),e.EFF(840," provides a "),e.j41(841,"code"),e.EFF(842,"ConditionalModule"),e.k0s(),e.EFF(843," that allows you to do just that."),e.k0s(),e.j41(844,"pre")(845,"code",26),e.EFF(846,"\n@Module({\n  imports: [ConfigModule.forRoot(), ConditionalModule.registerWhen(FooModule, 'USE_FOO')],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(847,"p"),e.EFF(848,"The above module would only load in the "),e.j41(849,"code"),e.EFF(850,"FooModule"),e.k0s(),e.EFF(851," if in the "),e.j41(852,"code"),e.EFF(853,".env"),e.k0s(),e.EFF(854," file there is not a "),e.j41(855,"code"),e.EFF(856,"false"),e.k0s(),e.EFF(857," value for the env variable "),e.j41(858,"code"),e.EFF(859,"USE_FOO"),e.k0s(),e.EFF(860,". You can also pass a custom condition yourself, a function receiving the "),e.j41(861,"code"),e.EFF(862,"process.env"),e.k0s(),e.EFF(863," reference that should return a boolean for the "),e.j41(864,"code"),e.EFF(865,"ConditionalModule"),e.k0s(),e.EFF(866," to handle:"),e.k0s(),e.j41(867,"pre")(868,"code",26),e.EFF(869,"\n@Module({\n  imports: [ConfigModule.forRoot(), ConditionalModule.registerWhen(FooBarModule, (env: NodeJS.ProcessEnv) => !!env['foo'] && !!env['bar'])],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(870,"p"),e.EFF(871,"It is important to be sure that when using the "),e.j41(872,"code"),e.EFF(873,"ConditionalModule"),e.k0s(),e.EFF(874," you also have the "),e.j41(875,"code"),e.EFF(876,"ConfigModule"),e.k0s(),e.EFF(877," loaded in the application, so that the "),e.j41(878,"code"),e.EFF(879,"ConfigModule.envVariablesLoaded"),e.k0s(),e.EFF(880," hook can be properly referenced and utilized. If the hook is not flipped to true within 5 seconds, or a timeout in milliseconds, set by the user in the third options parameter of the "),e.j41(881,"code"),e.EFF(882,"registerWhen"),e.k0s(),e.EFF(883," method, then the "),e.j41(884,"code"),e.EFF(885,"ConditionalModule"),e.k0s(),e.EFF(886," will throw an error and Nest will abort starting the application."),e.k0s(),e.j41(887,"h4",49)(888,"span"),e.EFF(889,"Expandable variables"),e.k0s()(),e.j41(890,"p"),e.EFF(891,"The "),e.j41(892,"code"),e.EFF(893,"@nestjs/config"),e.k0s(),e.EFF(894," package supports environment variable expansion. With this technique, you can create nested environment variables, where one variable is referred to within the definition of another. For example:"),e.k0s(),e.j41(895,"pre")(896,"code",27),e.EFF(897,"\nAPP_URL=mywebsite.com\nSUPPORT_EMAIL=support@${APP_URL}\n"),e.k0s()(),e.j41(898,"p"),e.EFF(899,"With this construction, the variable "),e.j41(900,"code"),e.EFF(901,"SUPPORT_EMAIL"),e.k0s(),e.EFF(902," resolves to "),e.j41(903,"code"),e.EFF(904,"'support@mywebsite.com'"),e.k0s(),e.EFF(905,". Note the use of the "),e.j41(906,"code"),e.EFF(907),e.k0s(),e.EFF(908," syntax to trigger resolving the value of the variable "),e.j41(909,"code"),e.EFF(910,"APP_URL"),e.k0s(),e.EFF(911," inside the definition of "),e.j41(912,"code"),e.EFF(913,"SUPPORT_EMAIL"),e.k0s(),e.EFF(914,"."),e.k0s(),e.j41(915,"blockquote",21)(916,"strong"),e.EFF(917,"Hint"),e.k0s(),e.EFF(918," For this feature, "),e.j41(919,"code"),e.EFF(920,"@nestjs/config"),e.k0s(),e.EFF(921," package internally uses "),e.j41(922,"a",50),e.EFF(923,"dotenv-expand"),e.k0s(),e.EFF(924,".\n"),e.k0s(),e.j41(925,"p"),e.EFF(926,"Enable environment variable expansion using the "),e.j41(927,"code"),e.EFF(928,"expandVariables"),e.k0s(),e.EFF(929," property in the options object passed to the "),e.j41(930,"code"),e.EFF(931,"forRoot()"),e.k0s(),e.EFF(932," method of the "),e.j41(933,"code"),e.EFF(934,"ConfigModule"),e.k0s(),e.EFF(935,", as shown below:"),e.k0s(),e.j41(936,"span",25),e.EFF(937),e.nI1(938,"extension"),e.nrm(939,"app-tabs",null,12),e.k0s(),e.j41(941,"pre")(942,"code",26),e.EFF(943,"\n@Module({\n  imports: [\n    ConfigModule.forRoot({\n      // ...\n      expandVariables: true,\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(944,"h4",51)(945,"span"),e.EFF(946,"Using in the "),e.j41(947,"code"),e.EFF(948,"main.ts"),e.k0s()()(),e.j41(949,"p"),e.EFF(950,"While our config is stored in a service, it can still be used in the "),e.j41(951,"code"),e.EFF(952,"main.ts"),e.k0s(),e.EFF(953," file. This way, you can use it to store variables such as the application port or the CORS host."),e.k0s(),e.j41(954,"p"),e.EFF(955,"To access it, you must use the "),e.j41(956,"code"),e.EFF(957,"app.get()"),e.k0s(),e.EFF(958," method, followed by the service reference:"),e.k0s(),e.j41(959,"pre")(960,"code",26),e.EFF(961,"\nconst configService = app.get(ConfigService);\n"),e.k0s()(),e.j41(962,"p"),e.EFF(963,"You can then use it as usual, by calling the "),e.j41(964,"code"),e.EFF(965,"get"),e.k0s(),e.EFF(966," method with the configuration key:"),e.k0s(),e.j41(967,"pre")(968,"code",26),e.EFF(969,"\nconst port = configService.get('PORT');\n"),e.k0s()()()),2&s){const a=e.sdS(90),r=e.sdS(233),l=e.sdS(280),c=e.sdS(343),u=e.sdS(467),h=e.sdS(635),k=e.sdS(674),j=e.sdS(756),g=e.sdS(772),f=e.sdS(791),b=e.sdS(804),y=e.sdS(940);e.R7$(87),e.SpI(" ",e.i5U(88,23,"app.module",a.isJsActive),"\n"),e.R7$(143),e.SpI(" ",e.i5U(231,26,"config/configuration",r.isJsActive),"\n"),e.R7$(47),e.SpI(" ",e.i5U(278,29,"config/configuration",l.isJsActive),"\n"),e.R7$(30),e.Lme('"assets": [',"{",'"include": "../config/*.yaml", "outDir": "./dist/config"',"}","]"),e.R7$(33),e.SpI(" ",e.i5U(341,32,"feature.module",c.isJsActive),"\n"),e.R7$(124),e.SpI(" ",e.i5U(465,35,"config/database.config",u.isJsActive),"\n"),e.R7$(168),e.SpI(" ",e.i5U(633,38,"app.module",h.isJsActive),"\n"),e.R7$(39),e.SpI(" ",e.i5U(672,41,"app.module",k.isJsActive),"\n"),e.R7$(82),e.SpI(" ",e.i5U(754,44,"env.validation",j.isJsActive),"\n"),e.R7$(16),e.SpI(" ",e.i5U(770,47,"app.module",g.isJsActive),"\n"),e.R7$(23),e.AVh("hide",f.isJsActive),e.R7$(3),e.AVh("hide",!f.isJsActive),e.R7$(6),e.SpI(" ",e.i5U(802,50,"app.service",b.isJsActive),"\n"),e.R7$(4),e.AVh("hide",b.isJsActive),e.R7$(3),e.AVh("hide",!b.isJsActive),e.R7$(99),e.Lme("$","{","...","}",""),e.R7$(30),e.SpI(" ",e.i5U(938,53,"app.module",y.isJsActive),"\n")}},dependencies:[p.O,F.a,T._,m.M],encapsulation:2,changeDetection:0})}return t})(),R=(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-cookies-docs"]],features:[e.Vt3],decls:243,vars:0,consts:[["contentReference",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/cookies.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","cookies"],["appAnchor","","id","use-with-express-default"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/cookie-parser"],[1,"language-shell"],[1,"language-typescript"],["rel","nofollow","target","_blank","href","https://www.npmjs.org/package/cookie"],[1,"info"],[1,"warning"],["href","/controllers#library-specific-approach"],["appAnchor","","id","use-with-fastify"],["rel","nofollow","target","_blank","href","https://github.com/fastify/fastify-cookie#sending"],["appAnchor","","id","creating-a-custom-decorator-cross-platform"],["routerLink","/custom-decorators"]],template:function(s,n){1&s&&(e.j41(0,"div",1,0)(2,"div",2)(3,"a",3),e.nrm(4,"i",4),e.k0s()(),e.j41(5,"h3",5),e.EFF(6,"Cookies"),e.k0s(),e.j41(7,"p"),e.EFF(8,"An "),e.j41(9,"strong"),e.EFF(10,"HTTP cookie"),e.k0s(),e.EFF(11," is a small piece of data stored by the user's browser. Cookies were designed to be a reliable mechanism for websites to remember stateful information. When the user visits the website again, the cookie is automatically sent with the request."),e.k0s(),e.j41(12,"h4",6)(13,"span"),e.EFF(14,"Use with Express (default)"),e.k0s()(),e.j41(15,"p"),e.EFF(16,"First install the "),e.j41(17,"a",7),e.EFF(18,"required package"),e.k0s(),e.EFF(19," (and its types for TypeScript users):"),e.k0s(),e.j41(20,"pre")(21,"code",8),e.EFF(22,"\n$ npm i cookie-parser\n$ npm i -D @types/cookie-parser\n"),e.k0s()(),e.j41(23,"p"),e.EFF(24,"Once the installation is complete, apply the "),e.j41(25,"code"),e.EFF(26,"cookie-parser"),e.k0s(),e.EFF(27," middleware as global middleware (for example, in your "),e.j41(28,"code"),e.EFF(29,"main.ts"),e.k0s(),e.EFF(30," file)."),e.k0s(),e.j41(31,"pre")(32,"code",9),e.EFF(33,"\nimport * as cookieParser from 'cookie-parser';\n// somewhere in your initialization file\napp.use(cookieParser());\n"),e.k0s()(),e.j41(34,"p"),e.EFF(35,"You can pass several options to the "),e.j41(36,"code"),e.EFF(37,"cookieParser"),e.k0s(),e.EFF(38," middleware:"),e.k0s(),e.j41(39,"ul")(40,"li")(41,"code"),e.EFF(42,"secret"),e.k0s(),e.EFF(43," a string or array used for signing cookies. This is optional and if not specified, will not parse signed cookies. If a string is provided, this is used as the secret. If an array is provided, an attempt will be made to unsign the cookie with each secret in order."),e.k0s(),e.j41(44,"li")(45,"code"),e.EFF(46,"options"),e.k0s(),e.EFF(47," an object that is passed to "),e.j41(48,"code"),e.EFF(49,"cookie.parse"),e.k0s(),e.EFF(50," as the second option. See "),e.j41(51,"a",10),e.EFF(52,"cookie"),e.k0s(),e.EFF(53," for more information."),e.k0s()(),e.j41(54,"p"),e.EFF(55,"The middleware will parse the "),e.j41(56,"code"),e.EFF(57,"Cookie"),e.k0s(),e.EFF(58," header on the request and expose the cookie data as the property "),e.j41(59,"code"),e.EFF(60,"req.cookies"),e.k0s(),e.EFF(61," and, if a secret was provided, as the property "),e.j41(62,"code"),e.EFF(63,"req.signedCookies"),e.k0s(),e.EFF(64,". These properties are name value pairs of the cookie name to cookie value."),e.k0s(),e.j41(65,"p"),e.EFF(66,"When a secret is provided, this module will unsign and validate any signed cookie values and move those name value pairs from "),e.j41(67,"code"),e.EFF(68,"req.cookies"),e.k0s(),e.EFF(69," into "),e.j41(70,"code"),e.EFF(71,"req.signedCookies"),e.k0s(),e.EFF(72,". A signed cookie is a cookie that has a value prefixed with "),e.j41(73,"code"),e.EFF(74,"s:"),e.k0s(),e.EFF(75,". Signed cookies that fail signature validation will have the value "),e.j41(76,"code"),e.EFF(77,"false"),e.k0s(),e.EFF(78," instead of the tampered value."),e.k0s(),e.j41(79,"p"),e.EFF(80,"With this in place, you can now read cookies from within the route handlers, as follows:"),e.k0s(),e.j41(81,"pre")(82,"code",9),e.EFF(83,"\n@Get()\nfindAll(@Req() request: Request) {\n  console.log(request.cookies); // or \"request.cookies['cookieKey']\"\n  // or console.log(request.signedCookies);\n}\n"),e.k0s()(),e.j41(84,"blockquote",11)(85,"strong"),e.EFF(86,"Hint"),e.k0s(),e.EFF(87," The "),e.j41(88,"code"),e.EFF(89,"@Req()"),e.k0s(),e.EFF(90," decorator is imported from the "),e.j41(91,"code"),e.EFF(92,"@nestjs/common"),e.k0s(),e.EFF(93,", while "),e.j41(94,"code"),e.EFF(95,"Request"),e.k0s(),e.EFF(96," from the "),e.j41(97,"code"),e.EFF(98,"express"),e.k0s(),e.EFF(99," package.\n"),e.k0s(),e.j41(100,"p"),e.EFF(101,"To attach a cookie to an outgoing response, use the "),e.j41(102,"code"),e.EFF(103,"Response#cookie()"),e.k0s(),e.EFF(104," method:"),e.k0s(),e.j41(105,"pre")(106,"code",9),e.EFF(107,"\n@Get()\nfindAll(@Res({ passthrough: true }) response: Response) {\n  response.cookie('key', 'value')\n}\n"),e.k0s()(),e.j41(108,"blockquote",12)(109,"strong"),e.EFF(110,"Warning"),e.k0s(),e.EFF(111," If you want to leave the response handling logic to the framework, remember to set the "),e.j41(112,"code"),e.EFF(113,"passthrough"),e.k0s(),e.EFF(114," option to "),e.j41(115,"code"),e.EFF(116,"true"),e.k0s(),e.EFF(117,", as shown above. Read more "),e.j41(118,"a",13),e.EFF(119,"here"),e.k0s(),e.EFF(120,".\n"),e.k0s(),e.j41(121,"blockquote",11)(122,"strong"),e.EFF(123,"Hint"),e.k0s(),e.EFF(124," The "),e.j41(125,"code"),e.EFF(126,"@Res()"),e.k0s(),e.EFF(127," decorator is imported from the "),e.j41(128,"code"),e.EFF(129,"@nestjs/common"),e.k0s(),e.EFF(130,", while "),e.j41(131,"code"),e.EFF(132,"Response"),e.k0s(),e.EFF(133," from the "),e.j41(134,"code"),e.EFF(135,"express"),e.k0s(),e.EFF(136," package.\n"),e.k0s(),e.j41(137,"h4",14)(138,"span"),e.EFF(139,"Use with Fastify"),e.k0s()(),e.j41(140,"p"),e.EFF(141,"First install the required package:"),e.k0s(),e.j41(142,"pre")(143,"code",8),e.EFF(144,"\n$ npm i @fastify/cookie\n"),e.k0s()(),e.j41(145,"p"),e.EFF(146,"Once the installation is complete, register the "),e.j41(147,"code"),e.EFF(148,"@fastify/cookie"),e.k0s(),e.EFF(149," plugin:"),e.k0s(),e.j41(150,"pre")(151,"code",9),e.EFF(152,"\nimport fastifyCookie from '@fastify/cookie';\n\n// somewhere in your initialization file\nconst app = await NestFactory.create<NestFastifyApplication>(AppModule, new FastifyAdapter());\nawait app.register(fastifyCookie, {\n  secret: 'my-secret', // for cookies signature\n});\n"),e.k0s()(),e.j41(153,"p"),e.EFF(154,"With this in place, you can now read cookies from within the route handlers, as follows:"),e.k0s(),e.j41(155,"pre")(156,"code",9),e.EFF(157,"\n@Get()\nfindAll(@Req() request: FastifyRequest) {\n  console.log(request.cookies); // or \"request.cookies['cookieKey']\"\n}\n"),e.k0s()(),e.j41(158,"blockquote",11)(159,"strong"),e.EFF(160,"Hint"),e.k0s(),e.EFF(161," The "),e.j41(162,"code"),e.EFF(163,"@Req()"),e.k0s(),e.EFF(164," decorator is imported from the "),e.j41(165,"code"),e.EFF(166,"@nestjs/common"),e.k0s(),e.EFF(167,", while "),e.j41(168,"code"),e.EFF(169,"FastifyRequest"),e.k0s(),e.EFF(170," from the "),e.j41(171,"code"),e.EFF(172,"fastify"),e.k0s(),e.EFF(173," package.\n"),e.k0s(),e.j41(174,"p"),e.EFF(175,"To attach a cookie to an outgoing response, use the "),e.j41(176,"code"),e.EFF(177,"FastifyReply#setCookie()"),e.k0s(),e.EFF(178," method:"),e.k0s(),e.j41(179,"pre")(180,"code",9),e.EFF(181,"\n@Get()\nfindAll(@Res({ passthrough: true }) response: FastifyReply) {\n  response.setCookie('key', 'value')\n}\n"),e.k0s()(),e.j41(182,"p"),e.EFF(183,"To read more about "),e.j41(184,"code"),e.EFF(185,"FastifyReply#setCookie()"),e.k0s(),e.EFF(186," method, check out this "),e.j41(187,"a",15),e.EFF(188,"page"),e.k0s(),e.EFF(189,"."),e.k0s(),e.j41(190,"blockquote",12)(191,"strong"),e.EFF(192,"Warning"),e.k0s(),e.EFF(193," If you want to leave the response handling logic to the framework, remember to set the "),e.j41(194,"code"),e.EFF(195,"passthrough"),e.k0s(),e.EFF(196," option to "),e.j41(197,"code"),e.EFF(198,"true"),e.k0s(),e.EFF(199,", as shown above. Read more "),e.j41(200,"a",13),e.EFF(201,"here"),e.k0s(),e.EFF(202,".\n"),e.k0s(),e.j41(203,"blockquote",11)(204,"strong"),e.EFF(205,"Hint"),e.k0s(),e.EFF(206," The "),e.j41(207,"code"),e.EFF(208,"@Res()"),e.k0s(),e.EFF(209," decorator is imported from the "),e.j41(210,"code"),e.EFF(211,"@nestjs/common"),e.k0s(),e.EFF(212,", while "),e.j41(213,"code"),e.EFF(214,"FastifyReply"),e.k0s(),e.EFF(215," from the "),e.j41(216,"code"),e.EFF(217,"fastify"),e.k0s(),e.EFF(218," package.\n"),e.k0s(),e.j41(219,"h4",16)(220,"span"),e.EFF(221,"Creating a custom decorator (cross-platform)"),e.k0s()(),e.j41(222,"p"),e.EFF(223,"To provide a convenient, declarative way of accessing incoming cookies, we can create a "),e.j41(224,"a",17),e.EFF(225,"custom decorator"),e.k0s(),e.EFF(226,"."),e.k0s(),e.j41(227,"pre")(228,"code",9),e.EFF(229,"\nimport { createParamDecorator, ExecutionContext } from '@nestjs/common';\n\nexport const Cookies = createParamDecorator((data: string, ctx: ExecutionContext) => {\n  const request = ctx.switchToHttp().getRequest();\n  return data ? request.cookies?.[data] : request.cookies;\n});\n"),e.k0s()(),e.j41(230,"p"),e.EFF(231,"The "),e.j41(232,"code"),e.EFF(233,"@Cookies()"),e.k0s(),e.EFF(234," decorator will extract all cookies, or a named cookie from the "),e.j41(235,"code"),e.EFF(236,"req.cookies"),e.k0s(),e.EFF(237," object and populate the decorated parameter with that value."),e.k0s(),e.j41(238,"p"),e.EFF(239,"With this in place, we can now use the decorator in a route handler signature, as follows:"),e.k0s(),e.j41(240,"pre")(241,"code",9),e.EFF(242,"\n@Get()\nfindAll(@Cookies('name') name: string) {}\n"),e.k0s()()())},dependencies:[F.a,E.Wk],encapsulation:2,changeDetection:0})}return t})(),O=(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-events"]],features:[e.Vt3],decls:211,vars:4,consts:[["contentReference",""],["app8cb772f940b7c1724c07edeb311c96f15a7f1230",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/events.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","events"],["rel","nofollow","target","_blank","href","https://www.npmjs.com/package/@nestjs/event-emitter"],["rel","nofollow","target","_blank","href","https://github.com/EventEmitter2/EventEmitter2"],["appAnchor","","id","getting-started"],[1,"language-shell"],[1,"filename"],[1,"language-typescript"],["appAnchor","","id","dispatching-events"],[1,"info"],["appAnchor","","id","listening-to-events"],[1,"warning"],["rel","nofollow","target","_blank","href","https://github.com/EventEmitter2/EventEmitter2#emitteronevent-listener-options-objectboolean"],["rel","nofollow","target","_blank","href","https://github.com/EventEmitter2/EventEmitter2#multi-level-wildcards"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/30-event-emitter"]],template:function(s,n){if(1&s&&(e.j41(0,"div",2,0)(2,"div",3)(3,"a",4),e.nrm(4,"i",5),e.k0s()(),e.j41(5,"h3",6),e.EFF(6,"Events"),e.k0s(),e.j41(7,"p")(8,"a",7),e.EFF(9,"Event Emitter"),e.k0s(),e.EFF(10," package ("),e.j41(11,"code"),e.EFF(12,"@nestjs/event-emitter"),e.k0s(),e.EFF(13,") provides a simple observer implementation, allowing you to subscribe and listen for various events that occur in your application. Events serve as a great way to decouple various aspects of your application, since a single event can have multiple listeners that do not depend on each other."),e.k0s(),e.j41(14,"p")(15,"code"),e.EFF(16,"EventEmitterModule"),e.k0s(),e.EFF(17," internally uses the "),e.j41(18,"a",8),e.EFF(19,"eventemitter2"),e.k0s(),e.EFF(20," package."),e.k0s(),e.j41(21,"h4",9)(22,"span"),e.EFF(23,"Getting started"),e.k0s()(),e.j41(24,"p"),e.EFF(25,"First install the required package:"),e.k0s(),e.j41(26,"pre")(27,"code",10),e.EFF(28,"\n$ npm i --save @nestjs/event-emitter\n"),e.k0s()(),e.j41(29,"p"),e.EFF(30,"Once the installation is complete, import the "),e.j41(31,"code"),e.EFF(32,"EventEmitterModule"),e.k0s(),e.EFF(33," into the root "),e.j41(34,"code"),e.EFF(35,"AppModule"),e.k0s(),e.EFF(36," and run the "),e.j41(37,"code"),e.EFF(38,"forRoot()"),e.k0s(),e.EFF(39," static method as shown below:"),e.k0s(),e.j41(40,"span",11),e.EFF(41),e.nI1(42,"extension"),e.nrm(43,"app-tabs",null,1),e.k0s(),e.j41(45,"pre")(46,"code",12),e.EFF(47,"\nimport { Module } from '@nestjs/common';\nimport { EventEmitterModule } from '@nestjs/event-emitter';\n\n@Module({\n  imports: [\n    EventEmitterModule.forRoot()\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(48,"p"),e.EFF(49,"The "),e.j41(50,"code"),e.EFF(51,".forRoot()"),e.k0s(),e.EFF(52," call initializes the event emitter and registers any declarative event listeners that exist within your app. Registration occurs when the "),e.j41(53,"code"),e.EFF(54,"onApplicationBootstrap"),e.k0s(),e.EFF(55," lifecycle hook occurs, ensuring that all modules have loaded and declared any scheduled jobs."),e.k0s(),e.j41(56,"p"),e.EFF(57,"To configure the underlying "),e.j41(58,"code"),e.EFF(59,"EventEmitter"),e.k0s(),e.EFF(60," instance, pass the configuration object to the "),e.j41(61,"code"),e.EFF(62,".forRoot()"),e.k0s(),e.EFF(63," method, as follows:"),e.k0s(),e.j41(64,"pre")(65,"code",12),e.EFF(66,"\nEventEmitterModule.forRoot({\n  // set this to `true` to use wildcards\n  wildcard: false,\n  // the delimiter used to segment namespaces\n  delimiter: '.',\n  // set this to `true` if you want to emit the newListener event\n  newListener: false,\n  // set this to `true` if you want to emit the removeListener event\n  removeListener: false,\n  // the maximum amount of listeners that can be assigned to an event\n  maxListeners: 10,\n  // show event name in memory leak message when more than maximum amount of listeners is assigned\n  verboseMemoryLeak: false,\n  // disable throwing uncaughtException if an error event is emitted and it has no listeners\n  ignoreErrors: false,\n});\n"),e.k0s()(),e.j41(67,"h4",13)(68,"span"),e.EFF(69,"Dispatching Events"),e.k0s()(),e.j41(70,"p"),e.EFF(71,"To dispatch (i.e., fire) an event, first inject "),e.j41(72,"code"),e.EFF(73,"EventEmitter2"),e.k0s(),e.EFF(74," using standard constructor injection:"),e.k0s(),e.j41(75,"pre")(76,"code",12),e.EFF(77,"\nconstructor(private eventEmitter: EventEmitter2) {}\n"),e.k0s()(),e.j41(78,"blockquote",14)(79,"strong"),e.EFF(80,"Hint"),e.k0s(),e.EFF(81," Import the "),e.j41(82,"code"),e.EFF(83,"EventEmitter2"),e.k0s(),e.EFF(84," from the "),e.j41(85,"code"),e.EFF(86,"@nestjs/event-emitter"),e.k0s(),e.EFF(87," package.\n"),e.k0s(),e.j41(88,"p"),e.EFF(89,"Then use it in a class as follows:"),e.k0s(),e.j41(90,"pre")(91,"code",12),e.EFF(92,"\nthis.eventEmitter.emit(\n  'order.created',\n  new OrderCreatedEvent({\n    orderId: 1,\n    payload: {},\n  }),\n);\n"),e.k0s()(),e.j41(93,"h4",15)(94,"span"),e.EFF(95,"Listening to Events"),e.k0s()(),e.j41(96,"p"),e.EFF(97,"To declare an event listener, decorate a method with the "),e.j41(98,"code"),e.EFF(99,"@OnEvent()"),e.k0s(),e.EFF(100," decorator preceding the method definition containing the code to be executed, as follows:"),e.k0s(),e.j41(101,"pre")(102,"code",12),e.EFF(103,"\n@OnEvent('order.created')\nhandleOrderCreatedEvent(payload: OrderCreatedEvent) {\n  // handle and process \"OrderCreatedEvent\" event\n}\n"),e.k0s()(),e.j41(104,"blockquote",16)(105,"strong"),e.EFF(106,"Warning"),e.k0s(),e.EFF(107," Event subscribers cannot be request-scoped.\n"),e.k0s(),e.j41(108,"p"),e.EFF(109,"The first argument can be a "),e.j41(110,"code"),e.EFF(111,"string"),e.k0s(),e.EFF(112," or "),e.j41(113,"code"),e.EFF(114,"symbol"),e.k0s(),e.EFF(115," for a simple event emitter and a "),e.j41(116,"code"),e.EFF(117,"string | symbol | Array<string | symbol>"),e.k0s(),e.EFF(118," in a case of a wildcard emitter. "),e.k0s(),e.j41(119,"p"),e.EFF(120,"The second argument (optional) is a listener options object as follows:"),e.k0s(),e.j41(121,"pre")(122,"code",12),e.EFF(123,'\nexport type OnEventOptions = OnOptions & {\n  /**\n   * If "true", prepends (instead of append) the given listener to the array of listeners.\n   *\n   * @see https://github.com/EventEmitter2/EventEmitter2#emitterprependlistenerevent-listener-options\n   *\n   * @default false\n   */\n  prependListener?: boolean;\n\n  /**\n   * If "true", the onEvent callback will not throw an error while handling the event. Otherwise, if "false" it will throw an error.\n   * \n   * @default true\n   */\n  suppressErrors?: boolean;\n};\n'),e.k0s()(),e.j41(124,"blockquote",14)(125,"strong"),e.EFF(126,"Hint"),e.k0s(),e.EFF(127," Read more about the "),e.j41(128,"code"),e.EFF(129,"OnOptions"),e.k0s(),e.EFF(130," options object from "),e.j41(131,"a",17)(132,"code"),e.EFF(133,"eventemitter2"),e.k0s()(),e.EFF(134,".\n"),e.k0s(),e.j41(135,"pre")(136,"code",12),e.EFF(137,"\n@OnEvent('order.created', { async: true })\nhandleOrderCreatedEvent(payload: OrderCreatedEvent) {\n  // handle and process \"OrderCreatedEvent\" event\n}\n"),e.k0s()(),e.j41(138,"p"),e.EFF(139,"To use namespaces/wildcards, pass the "),e.j41(140,"code"),e.EFF(141,"wildcard"),e.k0s(),e.EFF(142," option into the "),e.j41(143,"code"),e.EFF(144,"EventEmitterModule#forRoot()"),e.k0s(),e.EFF(145," method. When namespaces/wildcards are enabled, events can either be strings ("),e.j41(146,"code"),e.EFF(147,"foo.bar"),e.k0s(),e.EFF(148,") separated by a delimiter or arrays ("),e.j41(149,"code"),e.EFF(150,"['foo', 'bar']"),e.k0s(),e.EFF(151,"). The delimiter is also configurable as a configuration property ("),e.j41(152,"code"),e.EFF(153,"delimiter"),e.k0s(),e.EFF(154,"). With namespaces feature enabled, you can subscribe to events using a wildcard:"),e.k0s(),e.j41(155,"pre")(156,"code",12),e.EFF(157,"\n@OnEvent('order.*')\nhandleOrderEvents(payload: OrderCreatedEvent | OrderRemovedEvent | OrderUpdatedEvent) {\n  // handle and process an event\n}\n"),e.k0s()(),e.j41(158,"p"),e.EFF(159,"Note that such a wildcard only applies to one block. The argument "),e.j41(160,"code"),e.EFF(161,"order.*"),e.k0s(),e.EFF(162," will match, for example, the events "),e.j41(163,"code"),e.EFF(164,"order.created"),e.k0s(),e.EFF(165," and "),e.j41(166,"code"),e.EFF(167,"order.shipped"),e.k0s(),e.EFF(168," but not "),e.j41(169,"code"),e.EFF(170,"order.delayed.out_of_stock"),e.k0s(),e.EFF(171,". In order to listen to such events,\nuse the "),e.j41(172,"code"),e.EFF(173,"multilevel wildcard"),e.k0s(),e.EFF(174," pattern (i.e, "),e.j41(175,"code"),e.EFF(176,"**"),e.k0s(),e.EFF(177,"), described in the "),e.j41(178,"code"),e.EFF(179,"EventEmitter2"),e.k0s(),e.j41(180,"a",18),e.EFF(181,"documentation"),e.k0s(),e.EFF(182,"."),e.k0s(),e.j41(183,"p"),e.EFF(184,"With this pattern, you can, for example, create an event listener that catches all events."),e.k0s(),e.j41(185,"pre")(186,"code",12),e.EFF(187,"\n@OnEvent('**')\nhandleEverything(payload: any) {\n  // handle and process an event\n}\n"),e.k0s()(),e.j41(188,"blockquote",14)(189,"strong"),e.EFF(190,"Hint"),e.k0s(),e.j41(191,"code"),e.EFF(192,"EventEmitter2"),e.k0s(),e.EFF(193," class provides several useful methods for interacting with events, like "),e.j41(194,"code"),e.EFF(195,"waitFor"),e.k0s(),e.EFF(196," and "),e.j41(197,"code"),e.EFF(198,"onAny"),e.k0s(),e.EFF(199,". You can read more about them "),e.j41(200,"a",8),e.EFF(201,"here"),e.k0s(),e.EFF(202,".\n"),e.k0s(),e.j41(203,"h4",19)(204,"span"),e.EFF(205,"Example"),e.k0s()(),e.j41(206,"p"),e.EFF(207,"A working example is available "),e.j41(208,"a",20),e.EFF(209,"here"),e.k0s(),e.EFF(210,"."),e.k0s()()),2&s){const a=e.sdS(44);e.R7$(41),e.SpI(" ",e.i5U(42,1,"app.module",a.isJsActive),"\n")}},dependencies:[p.O,F.a,m.M],encapsulation:2,changeDetection:0})}return t})(),U=(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-file-upload"]],features:[e.Vt3],decls:514,vars:18,consts:[["contentReference",""],["app699b8a475f51973fc25e320fccf291ca8978dadc",""],["app2002c409fd77663dcb765942137eb784f96a3a0a",""],["app22539e6f5163e40d8cb5aed59e1ce7588264f348",""],["app26b9e17811d9978639f515b24934a8c8f63f4c29",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/file-upload.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","file-upload"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/multer"],[1,"warning"],[1,"language-shell"],["appAnchor","","id","basic-example"],[1,"filename"],[1,"language-typescript"],[1,"info"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/multer#multeropts"],["appAnchor","","id","file-validation"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/pipes"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/blob/master/packages/common/pipes/file/file-type.validator.ts"],["rel","nofollow","target","_blank","href","https://www.ibm.com/support/pages/what-magic-number"],["appAnchor","","id","array-of-files"],["appAnchor","","id","multiple-files"],["appAnchor","","id","any-files"],["appAnchor","","id","no-files"],["appAnchor","","id","default-options"],["appAnchor","","id","async-configuration"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/fundamentals/custom-providers#factory-providers-usefactory"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/29-file-upload"]],template:function(s,n){if(1&s&&(e.j41(0,"div",5,0)(2,"div",6)(3,"a",7),e.nrm(4,"i",8),e.k0s()(),e.j41(5,"h3",9),e.EFF(6,"File upload"),e.k0s(),e.j41(7,"p"),e.EFF(8,"To handle file uploading, Nest provides a built-in module based on the "),e.j41(9,"a",10),e.EFF(10,"multer"),e.k0s(),e.EFF(11," middleware package for Express. Multer handles data posted in the "),e.j41(12,"code"),e.EFF(13,"multipart/form-data"),e.k0s(),e.EFF(14," format, which is primarily used for uploading files via an HTTP "),e.j41(15,"code"),e.EFF(16,"POST"),e.k0s(),e.EFF(17," request. This module is fully configurable and you can adjust its behavior to your application requirements."),e.k0s(),e.j41(18,"blockquote",11)(19,"strong"),e.EFF(20,"Warning"),e.k0s(),e.EFF(21," Multer cannot process data which is not in the supported multipart format ("),e.j41(22,"code"),e.EFF(23,"multipart/form-data"),e.k0s(),e.EFF(24,"). Also, note that this package is not compatible with the "),e.j41(25,"code"),e.EFF(26,"FastifyAdapter"),e.k0s(),e.EFF(27,".\n"),e.k0s(),e.j41(28,"p"),e.EFF(29,"For better type safety, let's install Multer typings package:"),e.k0s(),e.j41(30,"pre")(31,"code",12),e.EFF(32,"\n$ npm i -D @types/multer\n"),e.k0s()(),e.j41(33,"p"),e.EFF(34,"With this package installed, we can now use the "),e.j41(35,"code"),e.EFF(36,"Express.Multer.File"),e.k0s(),e.EFF(37," type (you can import this type as follows: "),e.j41(38,"code"),e.EFF(39),e.k0s(),e.EFF(40,")."),e.k0s(),e.j41(41,"h4",13)(42,"span"),e.EFF(43,"Basic example"),e.k0s()(),e.j41(44,"p"),e.EFF(45,"To upload a single file, simply tie the "),e.j41(46,"code"),e.EFF(47,"FileInterceptor()"),e.k0s(),e.EFF(48," interceptor to the route handler and extract "),e.j41(49,"code"),e.EFF(50,"file"),e.k0s(),e.EFF(51," from the "),e.j41(52,"code"),e.EFF(53,"request"),e.k0s(),e.EFF(54," using the "),e.j41(55,"code"),e.EFF(56,"@UploadedFile()"),e.k0s(),e.EFF(57," decorator."),e.k0s(),e.j41(58,"span",14),e.nrm(59,"app-tabs",null,1),e.k0s(),e.j41(61,"pre")(62,"code",15),e.EFF(63,"\n@Post('upload')\n@UseInterceptors(FileInterceptor('file'))\nuploadFile(@UploadedFile() file: Express.Multer.File) {\n  console.log(file);\n}\n"),e.k0s()(),e.j41(64,"pre")(65,"code",15),e.EFF(66,"\n@Post('upload')\n@UseInterceptors(FileInterceptor('file'))\n@Bind(UploadedFile())\nuploadFile(file) {\n  console.log(file);\n}\n"),e.k0s()(),e.j41(67,"blockquote",16)(68,"strong"),e.EFF(69,"Hint"),e.k0s(),e.EFF(70," The "),e.j41(71,"code"),e.EFF(72,"FileInterceptor()"),e.k0s(),e.EFF(73," decorator is exported from the "),e.j41(74,"code"),e.EFF(75,"@nestjs/platform-express"),e.k0s(),e.EFF(76," package. The "),e.j41(77,"code"),e.EFF(78,"@UploadedFile()"),e.k0s(),e.EFF(79," decorator is exported from "),e.j41(80,"code"),e.EFF(81,"@nestjs/common"),e.k0s(),e.EFF(82,".\n"),e.k0s(),e.j41(83,"p"),e.EFF(84,"The "),e.j41(85,"code"),e.EFF(86,"FileInterceptor()"),e.k0s(),e.EFF(87," decorator takes two arguments:"),e.k0s(),e.j41(88,"ul")(89,"li")(90,"code"),e.EFF(91,"fieldName"),e.k0s(),e.EFF(92,": string that supplies the name of the field from the HTML form that holds a file"),e.k0s(),e.j41(93,"li")(94,"code"),e.EFF(95,"options"),e.k0s(),e.EFF(96,": optional object of type "),e.j41(97,"code"),e.EFF(98,"MulterOptions"),e.k0s(),e.EFF(99,". This is the same object used by the multer constructor (more details "),e.j41(100,"a",17),e.EFF(101,"here"),e.k0s(),e.EFF(102,")."),e.k0s()(),e.j41(103,"blockquote",11)(104,"strong"),e.EFF(105,"Warning"),e.k0s(),e.j41(106,"code"),e.EFF(107,"FileInterceptor()"),e.k0s(),e.EFF(108," may not be compatible with third party cloud providers like Google Firebase or others.\n"),e.k0s(),e.j41(109,"h4",18)(110,"span"),e.EFF(111,"File validation"),e.k0s()(),e.j41(112,"p"),e.EFF(113,"Often times it can be useful to validate incoming file metadata, like file size or file mime-type. For this, you can create your own "),e.j41(114,"a",19),e.EFF(115,"Pipe"),e.k0s(),e.EFF(116," and bind it to the parameter annotated with the "),e.j41(117,"code"),e.EFF(118,"UploadedFile"),e.k0s(),e.EFF(119," decorator. The example below demonstrates how a basic file size validator pipe could be implemented:"),e.k0s(),e.j41(120,"pre")(121,"code",15),e.EFF(122,"\nimport { PipeTransform, Injectable, ArgumentMetadata } from '@nestjs/common';\n\n@Injectable()\nexport class FileSizeValidationPipe implements PipeTransform {\n  transform(value: any, metadata: ArgumentMetadata) {\n    // \"value\" is an object containing the file's attributes and metadata\n    const oneKb = 1000;\n    return value.size < oneKb;\n  }\n}\n"),e.k0s()(),e.j41(123,"p"),e.EFF(124,"Nest provides a built-in pipe to handle common use cases and facilitate/standardize the addition of new ones. This pipe is called "),e.j41(125,"code"),e.EFF(126,"ParseFilePipe"),e.k0s(),e.EFF(127,", and you can use it as follows:"),e.k0s(),e.j41(128,"pre")(129,"code",15),e.EFF(130,"\n@Post('file')\nuploadFileAndPassValidation(\n  @Body() body: SampleDto,\n  @UploadedFile(\n    new ParseFilePipe({\n      validators: [\n        // ... Set of file validator instances here\n      ]\n    })\n  )\n  file: Express.Multer.File,\n) {\n  return {\n    body,\n    file: file.buffer.toString(),\n  };\n}\n"),e.k0s()(),e.j41(131,"p"),e.EFF(132,"As you can see, it's required to specify an array of file validators that will be executed by the "),e.j41(133,"code"),e.EFF(134,"ParseFilePipe"),e.k0s(),e.EFF(135,". We'll discuss the interface of a validator, but it's worth mentioning this pipe also has two additional "),e.j41(136,"strong"),e.EFF(137,"optional"),e.k0s(),e.EFF(138," options:"),e.k0s(),e.j41(139,"table")(140,"tr")(141,"td")(142,"code"),e.EFF(143,"errorHttpStatusCode"),e.k0s()(),e.j41(144,"td"),e.EFF(145,"The HTTP status code to be thrown in case "),e.j41(146,"b"),e.EFF(147,"any"),e.k0s(),e.EFF(148," validator fails. Default is "),e.j41(149,"code"),e.EFF(150,"400"),e.k0s(),e.EFF(151," (BAD REQUEST)"),e.k0s()(),e.j41(152,"tr")(153,"td")(154,"code"),e.EFF(155,"exceptionFactory"),e.k0s()(),e.j41(156,"td"),e.EFF(157,"A factory which receives the error message and returns an error."),e.k0s()()(),e.j41(158,"p"),e.EFF(159,"Now, back to the "),e.j41(160,"code"),e.EFF(161,"FileValidator"),e.k0s(),e.EFF(162," interface. To integrate validators with this pipe, you have to either use built-in implementations or provide your own custom "),e.j41(163,"code"),e.EFF(164,"FileValidator"),e.k0s(),e.EFF(165,". See example below:"),e.k0s(),e.j41(166,"pre")(167,"code",15),e.EFF(168,"\nexport abstract class FileValidator<TValidationOptions = Record<string, any>> {\n  constructor(protected readonly validationOptions: TValidationOptions) {}\n\n  /**\n   * Indicates if this file should be considered valid, according to the options passed in the constructor.\n   * @param file the file from the request object\n   */\n  abstract isValid(file?: any): boolean | Promise<boolean>;\n\n  /**\n   * Builds an error message in case the validation fails.\n   * @param file the file from the request object\n   */\n  abstract buildErrorMessage(file: any): string;\n}\n"),e.k0s()(),e.j41(169,"blockquote",16)(170,"strong"),e.EFF(171,"Hint"),e.k0s(),e.EFF(172," The "),e.j41(173,"code"),e.EFF(174,"FileValidator"),e.k0s(),e.EFF(175," interfaces supports async validation via its "),e.j41(176,"code"),e.EFF(177,"isValid"),e.k0s(),e.EFF(178," function. To leverage type security, you can also type the "),e.j41(179,"code"),e.EFF(180,"file"),e.k0s(),e.EFF(181," parameter as "),e.j41(182,"code"),e.EFF(183,"Express.Multer.File"),e.k0s(),e.EFF(184," in case you are using express (default) as a driver.\n"),e.k0s(),e.j41(185,"p")(186,"code"),e.EFF(187,"FileValidator"),e.k0s(),e.EFF(188," is a regular class that has access to the file object and validates it according to the options provided by the client. Nest has two built-in "),e.j41(189,"code"),e.EFF(190,"FileValidator"),e.k0s(),e.EFF(191," implementations you can use in your project:"),e.k0s(),e.j41(192,"ul")(193,"li")(194,"code"),e.EFF(195,"MaxFileSizeValidator"),e.k0s(),e.EFF(196," - Checks if a given file's size is less than the provided value (measured in "),e.j41(197,"code"),e.EFF(198,"bytes"),e.k0s(),e.EFF(199,")"),e.k0s(),e.j41(200,"li")(201,"code"),e.EFF(202,"FileTypeValidator"),e.k0s(),e.EFF(203," - Checks if a given file's mime-type matches the given value. "),e.k0s()(),e.j41(204,"blockquote",11)(205,"strong"),e.EFF(206,"Warning"),e.k0s(),e.EFF(207," To verify file type, "),e.j41(208,"a",20),e.EFF(209,"FileTypeValidator"),e.k0s(),e.EFF(210," class uses the type as detected by multer. By default, multer derives file type from file extension on user's device. However, it does not check actual file contents. As files can be renamed to arbitrary extensions, consider using a custom implementation (like checking the file's "),e.j41(211,"a",21),e.EFF(212,"magic number"),e.k0s(),e.EFF(213,") if your app requires a safer solution.\n"),e.k0s(),e.j41(214,"p"),e.EFF(215,"To understand how these can be used in conjunction with the aforementioned "),e.j41(216,"code"),e.EFF(217,"FileParsePipe"),e.k0s(),e.EFF(218,", we'll use an altered snippet of the last presented example:"),e.k0s(),e.j41(219,"pre")(220,"code",15),e.EFF(221,"\n@UploadedFile(\n  new ParseFilePipe({\n    validators: [\n      new MaxFileSizeValidator({ maxSize: 1000 }),\n      new FileTypeValidator({ fileType: 'image/jpeg' }),\n    ],\n  }),\n)\nfile: Express.Multer.File,\n"),e.k0s()(),e.j41(222,"blockquote",16)(223,"strong"),e.EFF(224,"Hint"),e.k0s(),e.EFF(225," If the number of validators increase largely or their options are cluttering the file, you can define this array in a separate file and import it here as a named constant like "),e.j41(226,"code"),e.EFF(227,"fileValidators"),e.k0s(),e.EFF(228,".\n"),e.k0s(),e.j41(229,"p"),e.EFF(230,"Finally, you can use the special "),e.j41(231,"code"),e.EFF(232,"ParseFilePipeBuilder"),e.k0s(),e.EFF(233," class that lets you compose & construct your validators. By using it as shown below you can avoid manual instantiation of each validator and just pass their options directly:"),e.k0s(),e.j41(234,"pre")(235,"code",15),e.EFF(236,"\n@UploadedFile(\n  new ParseFilePipeBuilder()\n    .addFileTypeValidator({\n      fileType: 'jpeg',\n    })\n    .addMaxSizeValidator({\n      maxSize: 1000\n    })\n    .build({\n      errorHttpStatusCode: HttpStatus.UNPROCESSABLE_ENTITY\n    }),\n)\nfile: Express.Multer.File,\n"),e.k0s()(),e.j41(237,"blockquote",16)(238,"strong"),e.EFF(239,"Hint"),e.k0s(),e.EFF(240," File presence is required by default, but you can make it optional by adding "),e.j41(241,"code"),e.EFF(242,"fileIsRequired: false"),e.k0s(),e.EFF(243," parameter inside "),e.j41(244,"code"),e.EFF(245,"build"),e.k0s(),e.EFF(246," function options (at the same level as "),e.j41(247,"code"),e.EFF(248,"errorHttpStatusCode"),e.k0s(),e.EFF(249,").\n"),e.k0s(),e.j41(250,"h4",22)(251,"span"),e.EFF(252,"Array of files"),e.k0s()(),e.j41(253,"p"),e.EFF(254,"To upload an array of files (identified with a single field name), use the "),e.j41(255,"code"),e.EFF(256,"FilesInterceptor()"),e.k0s(),e.EFF(257," decorator (note the plural "),e.j41(258,"strong"),e.EFF(259,"Files"),e.k0s(),e.EFF(260," in the decorator name). This decorator takes three arguments:"),e.k0s(),e.j41(261,"ul")(262,"li")(263,"code"),e.EFF(264,"fieldName"),e.k0s(),e.EFF(265,": as described above"),e.k0s(),e.j41(266,"li")(267,"code"),e.EFF(268,"maxCount"),e.k0s(),e.EFF(269,": optional number defining the maximum number of files to accept"),e.k0s(),e.j41(270,"li")(271,"code"),e.EFF(272,"options"),e.k0s(),e.EFF(273,": optional "),e.j41(274,"code"),e.EFF(275,"MulterOptions"),e.k0s(),e.EFF(276," object, as described above"),e.k0s()(),e.j41(277,"p"),e.EFF(278,"When using "),e.j41(279,"code"),e.EFF(280,"FilesInterceptor()"),e.k0s(),e.EFF(281,", extract files from the "),e.j41(282,"code"),e.EFF(283,"request"),e.k0s(),e.EFF(284," with the "),e.j41(285,"code"),e.EFF(286,"@UploadedFiles()"),e.k0s(),e.EFF(287," decorator."),e.k0s(),e.j41(288,"span",14),e.nrm(289,"app-tabs",null,2),e.k0s(),e.j41(291,"pre")(292,"code",15),e.EFF(293,"\n@Post('upload')\n@UseInterceptors(FilesInterceptor('files'))\nuploadFile(@UploadedFiles() files: Array<Express.Multer.File>) {\n  console.log(files);\n}\n"),e.k0s()(),e.j41(294,"pre")(295,"code",15),e.EFF(296,"\n@Post('upload')\n@UseInterceptors(FilesInterceptor('files'))\n@Bind(UploadedFiles())\nuploadFile(files) {\n  console.log(files);\n}\n"),e.k0s()(),e.j41(297,"blockquote",16)(298,"strong"),e.EFF(299,"Hint"),e.k0s(),e.EFF(300," The "),e.j41(301,"code"),e.EFF(302,"FilesInterceptor()"),e.k0s(),e.EFF(303," decorator is exported from the "),e.j41(304,"code"),e.EFF(305,"@nestjs/platform-express"),e.k0s(),e.EFF(306," package. The "),e.j41(307,"code"),e.EFF(308,"@UploadedFiles()"),e.k0s(),e.EFF(309," decorator is exported from "),e.j41(310,"code"),e.EFF(311,"@nestjs/common"),e.k0s(),e.EFF(312,".\n"),e.k0s(),e.j41(313,"h4",23)(314,"span"),e.EFF(315,"Multiple files"),e.k0s()(),e.j41(316,"p"),e.EFF(317,"To upload multiple files (all with different field name keys), use the "),e.j41(318,"code"),e.EFF(319,"FileFieldsInterceptor()"),e.k0s(),e.EFF(320," decorator. This decorator takes two arguments:"),e.k0s(),e.j41(321,"ul")(322,"li")(323,"code"),e.EFF(324,"uploadedFields"),e.k0s(),e.EFF(325,": an array of objects, where each object specifies a required "),e.j41(326,"code"),e.EFF(327,"name"),e.k0s(),e.EFF(328," property with a string value specifying a field name, as described above, and an optional "),e.j41(329,"code"),e.EFF(330,"maxCount"),e.k0s(),e.EFF(331," property, as described above"),e.k0s(),e.j41(332,"li")(333,"code"),e.EFF(334,"options"),e.k0s(),e.EFF(335,": optional "),e.j41(336,"code"),e.EFF(337,"MulterOptions"),e.k0s(),e.EFF(338," object, as described above"),e.k0s()(),e.j41(339,"p"),e.EFF(340,"When using "),e.j41(341,"code"),e.EFF(342,"FileFieldsInterceptor()"),e.k0s(),e.EFF(343,", extract files from the "),e.j41(344,"code"),e.EFF(345,"request"),e.k0s(),e.EFF(346," with the "),e.j41(347,"code"),e.EFF(348,"@UploadedFiles()"),e.k0s(),e.EFF(349," decorator."),e.k0s(),e.j41(350,"span",14),e.nrm(351,"app-tabs",null,3),e.k0s(),e.j41(353,"pre")(354,"code",15),e.EFF(355,"\n@Post('upload')\n@UseInterceptors(FileFieldsInterceptor([\n  { name: 'avatar', maxCount: 1 },\n  { name: 'background', maxCount: 1 },\n]))\nuploadFile(@UploadedFiles() files: { avatar?: Express.Multer.File[], background?: Express.Multer.File[] }) {\n  console.log(files);\n}\n"),e.k0s()(),e.j41(356,"pre")(357,"code",15),e.EFF(358,"\n@Post('upload')\n@Bind(UploadedFiles())\n@UseInterceptors(FileFieldsInterceptor([\n  { name: 'avatar', maxCount: 1 },\n  { name: 'background', maxCount: 1 },\n]))\nuploadFile(files) {\n  console.log(files);\n}\n"),e.k0s()(),e.j41(359,"h4",24)(360,"span"),e.EFF(361,"Any files"),e.k0s()(),e.j41(362,"p"),e.EFF(363,"To upload all fields with arbitrary field name keys, use the "),e.j41(364,"code"),e.EFF(365,"AnyFilesInterceptor()"),e.k0s(),e.EFF(366," decorator. This decorator can accept an optional "),e.j41(367,"code"),e.EFF(368,"options"),e.k0s(),e.EFF(369," object as described above."),e.k0s(),e.j41(370,"p"),e.EFF(371,"When using "),e.j41(372,"code"),e.EFF(373,"AnyFilesInterceptor()"),e.k0s(),e.EFF(374,", extract files from the "),e.j41(375,"code"),e.EFF(376,"request"),e.k0s(),e.EFF(377," with the "),e.j41(378,"code"),e.EFF(379,"@UploadedFiles()"),e.k0s(),e.EFF(380," decorator."),e.k0s(),e.j41(381,"span",14),e.nrm(382,"app-tabs",null,4),e.k0s(),e.j41(384,"pre")(385,"code",15),e.EFF(386,"\n@Post('upload')\n@UseInterceptors(AnyFilesInterceptor())\nuploadFile(@UploadedFiles() files: Array<Express.Multer.File>) {\n  console.log(files);\n}\n"),e.k0s()(),e.j41(387,"pre")(388,"code",15),e.EFF(389,"\n@Post('upload')\n@Bind(UploadedFiles())\n@UseInterceptors(AnyFilesInterceptor())\nuploadFile(files) {\n  console.log(files);\n}\n"),e.k0s()(),e.j41(390,"h4",25)(391,"span"),e.EFF(392,"No files"),e.k0s()(),e.j41(393,"p"),e.EFF(394,"To accept "),e.j41(395,"code"),e.EFF(396,"multipart/form-data"),e.k0s(),e.EFF(397," but not allow any files to be uploaded, use the "),e.j41(398,"code"),e.EFF(399,"NoFilesInterceptor"),e.k0s(),e.EFF(400,". This sets multipart data as attributes on the request body. Any files sent with the request will throw a "),e.j41(401,"code"),e.EFF(402,"BadRequestException"),e.k0s(),e.EFF(403,"."),e.k0s(),e.j41(404,"pre")(405,"code",15),e.EFF(406,"\n@Post('upload')\n@UseInterceptors(NoFilesInterceptor())\nhandleMultiPartData(@Body() body) {\n  console.log(body)\n}\n"),e.k0s()(),e.j41(407,"h4",26)(408,"span"),e.EFF(409,"Default options"),e.k0s()(),e.j41(410,"p"),e.EFF(411,"You can specify multer options in the file interceptors as described above. To set default options, you can call the static "),e.j41(412,"code"),e.EFF(413,"register()"),e.k0s(),e.EFF(414," method when you import the "),e.j41(415,"code"),e.EFF(416,"MulterModule"),e.k0s(),e.EFF(417,", passing in supported options. You can use all options listed "),e.j41(418,"a",17),e.EFF(419,"here"),e.k0s(),e.EFF(420,"."),e.k0s(),e.j41(421,"pre")(422,"code",15),e.EFF(423,"\nMulterModule.register({\n  dest: './upload',\n});\n"),e.k0s()(),e.j41(424,"blockquote",16)(425,"strong"),e.EFF(426,"Hint"),e.k0s(),e.EFF(427," The "),e.j41(428,"code"),e.EFF(429,"MulterModule"),e.k0s(),e.EFF(430," class is exported from the "),e.j41(431,"code"),e.EFF(432,"@nestjs/platform-express"),e.k0s(),e.EFF(433," package.\n"),e.k0s(),e.j41(434,"h4",27)(435,"span"),e.EFF(436,"Async configuration"),e.k0s()(),e.j41(437,"p"),e.EFF(438,"When you need to set "),e.j41(439,"code"),e.EFF(440,"MulterModule"),e.k0s(),e.EFF(441," options asynchronously instead of statically, use the "),e.j41(442,"code"),e.EFF(443,"registerAsync()"),e.k0s(),e.EFF(444," method. As with most dynamic modules, Nest provides several techniques to deal with async configuration."),e.k0s(),e.j41(445,"p"),e.EFF(446,"One technique is to use a factory function:"),e.k0s(),e.j41(447,"pre")(448,"code",15),e.EFF(449,"\nMulterModule.registerAsync({\n  useFactory: () => ({\n    dest: './upload',\n  }),\n});\n"),e.k0s()(),e.j41(450,"p"),e.EFF(451,"Like other "),e.j41(452,"a",28),e.EFF(453,"factory providers"),e.k0s(),e.EFF(454,", our factory function can be "),e.j41(455,"code"),e.EFF(456,"async"),e.k0s(),e.EFF(457," and can inject dependencies through "),e.j41(458,"code"),e.EFF(459,"inject"),e.k0s(),e.EFF(460,"."),e.k0s(),e.j41(461,"pre")(462,"code",15),e.EFF(463,"\nMulterModule.registerAsync({\n  imports: [ConfigModule],\n  useFactory: async (configService: ConfigService) => ({\n    dest: configService.get<string>('MULTER_DEST'),\n  }),\n  inject: [ConfigService],\n});\n"),e.k0s()(),e.j41(464,"p"),e.EFF(465,"Alternatively, you can configure the "),e.j41(466,"code"),e.EFF(467,"MulterModule"),e.k0s(),e.EFF(468," using a class instead of a factory, as shown below:"),e.k0s(),e.j41(469,"pre")(470,"code",15),e.EFF(471,"\nMulterModule.registerAsync({\n  useClass: MulterConfigService,\n});\n"),e.k0s()(),e.j41(472,"p"),e.EFF(473,"The construction above instantiates "),e.j41(474,"code"),e.EFF(475,"MulterConfigService"),e.k0s(),e.EFF(476," inside "),e.j41(477,"code"),e.EFF(478,"MulterModule"),e.k0s(),e.EFF(479,", using it to create the required options object. Note that in this example, the "),e.j41(480,"code"),e.EFF(481,"MulterConfigService"),e.k0s(),e.EFF(482," has to implement the "),e.j41(483,"code"),e.EFF(484,"MulterOptionsFactory"),e.k0s(),e.EFF(485," interface, as shown below. The "),e.j41(486,"code"),e.EFF(487,"MulterModule"),e.k0s(),e.EFF(488," will call the "),e.j41(489,"code"),e.EFF(490,"createMulterOptions()"),e.k0s(),e.EFF(491," method on the instantiated object of the supplied class."),e.k0s(),e.j41(492,"pre")(493,"code",15),e.EFF(494,"\n@Injectable()\nclass MulterConfigService implements MulterOptionsFactory {\n  createMulterOptions(): MulterModuleOptions {\n    return {\n      dest: './upload',\n    };\n  }\n}\n"),e.k0s()(),e.j41(495,"p"),e.EFF(496,"If you want to reuse an existing options provider instead of creating a private copy inside the "),e.j41(497,"code"),e.EFF(498,"MulterModule"),e.k0s(),e.EFF(499,", use the "),e.j41(500,"code"),e.EFF(501,"useExisting"),e.k0s(),e.EFF(502," syntax."),e.k0s(),e.j41(503,"pre")(504,"code",15),e.EFF(505,"\nMulterModule.registerAsync({\n  imports: [ConfigModule],\n  useExisting: ConfigService,\n});\n"),e.k0s()(),e.j41(506,"h4",29)(507,"span"),e.EFF(508,"Example"),e.k0s()(),e.j41(509,"p"),e.EFF(510,"A working example is available "),e.j41(511,"a",30),e.EFF(512,"here"),e.k0s(),e.EFF(513,"."),e.k0s()()),2&s){const a=e.sdS(60),r=e.sdS(290),l=e.sdS(352),c=e.sdS(383);e.R7$(39),e.Lme("import ","{"," Express ","}"," from 'express'"),e.R7$(22),e.AVh("hide",a.isJsActive),e.R7$(3),e.AVh("hide",!a.isJsActive),e.R7$(227),e.AVh("hide",r.isJsActive),e.R7$(3),e.AVh("hide",!r.isJsActive),e.R7$(59),e.AVh("hide",l.isJsActive),e.R7$(3),e.AVh("hide",!l.isJsActive),e.R7$(28),e.AVh("hide",c.isJsActive),e.R7$(3),e.AVh("hide",!c.isJsActive)}},dependencies:[p.O,F.a],encapsulation:2,changeDetection:0})}return t})(),P=(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-http-module"]],features:[e.Vt3],decls:241,vars:4,consts:[["contentReference",""],["appd69d9a9c317b6ef4fd003b7fe68efe9518373e2c",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/http-module.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","http-module"],["rel","nofollow","target","_blank","href","https://github.com/axios/axios"],[1,"info"],["rel","nofollow","target","_blank","href","https://github.com/sindresorhus/got"],["rel","nofollow","target","_blank","href","https://github.com/nodejs/undici"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","getting-started"],[1,"language-typescript"],[1,"filename"],["appAnchor","","id","configuration"],["rel","nofollow","target","_blank","href","https://github.com/axios/axios#request-config"],["appAnchor","","id","async-configuration"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/fundamentals/custom-providers#factory-providers-usefactory"],["appAnchor","","id","using-axios-directly"],["appAnchor","","id","full-example"],["rel","nofollow","target","_blank","href","https://rxjs.dev/api/index/function/firstValueFrom"],["rel","nofollow","target","_blank","href","https://rxjs.dev/api/index/function/lastValueFrom"]],template:function(s,n){if(1&s&&(e.j41(0,"div",2,0)(2,"div",3)(3,"a",4),e.nrm(4,"i",5),e.k0s()(),e.j41(5,"h3",6),e.EFF(6,"HTTP module"),e.k0s(),e.j41(7,"p")(8,"a",7),e.EFF(9,"Axios"),e.k0s(),e.EFF(10," is a richly featured HTTP client package that is widely used. Nest wraps Axios and exposes it via the built-in "),e.j41(11,"code"),e.EFF(12,"HttpModule"),e.k0s(),e.EFF(13,". The "),e.j41(14,"code"),e.EFF(15,"HttpModule"),e.k0s(),e.EFF(16," exports the "),e.j41(17,"code"),e.EFF(18,"HttpService"),e.k0s(),e.EFF(19," class, which exposes Axios-based methods to perform HTTP requests. The library also transforms the resulting HTTP responses into "),e.j41(20,"code"),e.EFF(21,"Observables"),e.k0s(),e.EFF(22,"."),e.k0s(),e.j41(23,"blockquote",8)(24,"strong"),e.EFF(25,"Hint"),e.k0s(),e.EFF(26," You can also use any general purpose Node.js HTTP client library directly, including "),e.j41(27,"a",9),e.EFF(28,"got"),e.k0s(),e.EFF(29," or "),e.j41(30,"a",10),e.EFF(31,"undici"),e.k0s(),e.EFF(32,".\n"),e.k0s(),e.j41(33,"h4",11)(34,"span"),e.EFF(35,"Installation"),e.k0s()(),e.j41(36,"p"),e.EFF(37,"To begin using it, we first install required dependencies."),e.k0s(),e.j41(38,"pre")(39,"code",12),e.EFF(40,"\n$ npm i --save @nestjs/axios axios\n"),e.k0s()(),e.j41(41,"h4",13)(42,"span"),e.EFF(43,"Getting started"),e.k0s()(),e.j41(44,"p"),e.EFF(45,"Once the installation process is complete, to use the "),e.j41(46,"code"),e.EFF(47,"HttpService"),e.k0s(),e.EFF(48,", first import "),e.j41(49,"code"),e.EFF(50,"HttpModule"),e.k0s(),e.EFF(51,"."),e.k0s(),e.j41(52,"pre")(53,"code",14),e.EFF(54,"\n@Module({\n  imports: [HttpModule],\n  providers: [CatsService],\n})\nexport class CatsModule {}\n"),e.k0s()(),e.j41(55,"p"),e.EFF(56,"Next, inject "),e.j41(57,"code"),e.EFF(58,"HttpService"),e.k0s(),e.EFF(59," using normal constructor injection."),e.k0s(),e.j41(60,"blockquote",8)(61,"strong"),e.EFF(62,"Hint"),e.k0s(),e.j41(63,"code"),e.EFF(64,"HttpModule"),e.k0s(),e.EFF(65," and "),e.j41(66,"code"),e.EFF(67,"HttpService"),e.k0s(),e.EFF(68," are imported from "),e.j41(69,"code"),e.EFF(70,"@nestjs/axios"),e.k0s(),e.EFF(71," package.\n"),e.k0s(),e.j41(72,"span",15),e.nrm(73,"app-tabs",null,1),e.k0s(),e.j41(75,"pre")(76,"code",14),e.EFF(77,"\n@Injectable()\nexport class CatsService {\n  constructor(private readonly httpService: HttpService) {}\n\n  findAll(): Observable<AxiosResponse<Cat[]>> {\n    return this.httpService.get('http://localhost:3000/cats');\n  }\n}\n"),e.k0s()(),e.j41(78,"pre")(79,"code",14),e.EFF(80,"\n@Injectable()\n@Dependencies(HttpService)\nexport class CatsService {\n  constructor(httpService) {\n    this.httpService = httpService;\n  }\n\n  findAll() {\n    return this.httpService.get('http://localhost:3000/cats');\n  }\n}\n"),e.k0s()(),e.j41(81,"blockquote",8)(82,"strong"),e.EFF(83,"Hint"),e.k0s(),e.j41(84,"code"),e.EFF(85,"AxiosResponse"),e.k0s(),e.EFF(86," is an interface exported from the "),e.j41(87,"code"),e.EFF(88,"axios"),e.k0s(),e.EFF(89," package ("),e.j41(90,"code"),e.EFF(91,"$ npm i axios"),e.k0s(),e.EFF(92,").\n"),e.k0s(),e.j41(93,"p"),e.EFF(94,"All "),e.j41(95,"code"),e.EFF(96,"HttpService"),e.k0s(),e.EFF(97," methods return an "),e.j41(98,"code"),e.EFF(99,"AxiosResponse"),e.k0s(),e.EFF(100," wrapped in an "),e.j41(101,"code"),e.EFF(102,"Observable"),e.k0s(),e.EFF(103," object."),e.k0s(),e.j41(104,"h4",16)(105,"span"),e.EFF(106,"Configuration"),e.k0s()(),e.j41(107,"p")(108,"a",7),e.EFF(109,"Axios"),e.k0s(),e.EFF(110," can be configured with a variety of options to customize the behavior of the "),e.j41(111,"code"),e.EFF(112,"HttpService"),e.k0s(),e.EFF(113,". Read more about them "),e.j41(114,"a",17),e.EFF(115,"here"),e.k0s(),e.EFF(116,". To configure the underlying Axios instance, pass an optional options object to the "),e.j41(117,"code"),e.EFF(118,"register()"),e.k0s(),e.EFF(119," method of "),e.j41(120,"code"),e.EFF(121,"HttpModule"),e.k0s(),e.EFF(122," when importing it. This options object will be passed directly to the underlying Axios constructor."),e.k0s(),e.j41(123,"pre")(124,"code",14),e.EFF(125,"\n@Module({\n  imports: [\n    HttpModule.register({\n      timeout: 5000,\n      maxRedirects: 5,\n    }),\n  ],\n  providers: [CatsService],\n})\nexport class CatsModule {}\n"),e.k0s()(),e.j41(126,"h4",18)(127,"span"),e.EFF(128,"Async configuration"),e.k0s()(),e.j41(129,"p"),e.EFF(130,"When you need to pass module options asynchronously instead of statically, use the "),e.j41(131,"code"),e.EFF(132,"registerAsync()"),e.k0s(),e.EFF(133," method. As with most dynamic modules, Nest provides several techniques to deal with async configuration."),e.k0s(),e.j41(134,"p"),e.EFF(135,"One technique is to use a factory function:"),e.k0s(),e.j41(136,"pre")(137,"code",14),e.EFF(138,"\nHttpModule.registerAsync({\n  useFactory: () => ({\n    timeout: 5000,\n    maxRedirects: 5,\n  }),\n});\n"),e.k0s()(),e.j41(139,"p"),e.EFF(140,"Like other factory providers, our factory function can be "),e.j41(141,"a",19),e.EFF(142,"async"),e.k0s(),e.EFF(143," and can inject dependencies through "),e.j41(144,"code"),e.EFF(145,"inject"),e.k0s(),e.EFF(146,"."),e.k0s(),e.j41(147,"pre")(148,"code",14),e.EFF(149,"\nHttpModule.registerAsync({\n  imports: [ConfigModule],\n  useFactory: async (configService: ConfigService) => ({\n    timeout: configService.get('HTTP_TIMEOUT'),\n    maxRedirects: configService.get('HTTP_MAX_REDIRECTS'),\n  }),\n  inject: [ConfigService],\n});\n"),e.k0s()(),e.j41(150,"p"),e.EFF(151,"Alternatively, you can configure the "),e.j41(152,"code"),e.EFF(153,"HttpModule"),e.k0s(),e.EFF(154," using a class instead of a factory, as shown below."),e.k0s(),e.j41(155,"pre")(156,"code",14),e.EFF(157,"\nHttpModule.registerAsync({\n  useClass: HttpConfigService,\n});\n"),e.k0s()(),e.j41(158,"p"),e.EFF(159,"The construction above instantiates "),e.j41(160,"code"),e.EFF(161,"HttpConfigService"),e.k0s(),e.EFF(162," inside "),e.j41(163,"code"),e.EFF(164,"HttpModule"),e.k0s(),e.EFF(165,", using it to create an options object. Note that in this example, the "),e.j41(166,"code"),e.EFF(167,"HttpConfigService"),e.k0s(),e.EFF(168," has to implement "),e.j41(169,"code"),e.EFF(170,"HttpModuleOptionsFactory"),e.k0s(),e.EFF(171," interface as shown below. The "),e.j41(172,"code"),e.EFF(173,"HttpModule"),e.k0s(),e.EFF(174," will call the "),e.j41(175,"code"),e.EFF(176,"createHttpOptions()"),e.k0s(),e.EFF(177," method on the instantiated object of the supplied class."),e.k0s(),e.j41(178,"pre")(179,"code",14),e.EFF(180,"\n@Injectable()\nclass HttpConfigService implements HttpModuleOptionsFactory {\n  createHttpOptions(): HttpModuleOptions {\n    return {\n      timeout: 5000,\n      maxRedirects: 5,\n    };\n  }\n}\n"),e.k0s()(),e.j41(181,"p"),e.EFF(182,"If you want to reuse an existing options provider instead of creating a private copy inside the "),e.j41(183,"code"),e.EFF(184,"HttpModule"),e.k0s(),e.EFF(185,", use the "),e.j41(186,"code"),e.EFF(187,"useExisting"),e.k0s(),e.EFF(188," syntax."),e.k0s(),e.j41(189,"pre")(190,"code",14),e.EFF(191,"\nHttpModule.registerAsync({\n  imports: [ConfigModule],\n  useExisting: HttpConfigService,\n});\n"),e.k0s()(),e.j41(192,"h4",20)(193,"span"),e.EFF(194,"Using Axios directly"),e.k0s()(),e.j41(195,"p"),e.EFF(196,"If you think that "),e.j41(197,"code"),e.EFF(198,"HttpModule.register"),e.k0s(),e.EFF(199,"'s options are not enough for you, or if you just want to access the underlying Axios instance created by "),e.j41(200,"code"),e.EFF(201,"@nestjs/axios"),e.k0s(),e.EFF(202,", you can access it via "),e.j41(203,"code"),e.EFF(204,"HttpService#axiosRef"),e.k0s(),e.EFF(205," as follows:"),e.k0s(),e.j41(206,"pre")(207,"code",14),e.EFF(208,"\n@Injectable()\nexport class CatsService {\n  constructor(private readonly httpService: HttpService) {}\n\n  findAll(): Promise<AxiosResponse<Cat[]>> {\n    return this.httpService.axiosRef.get('http://localhost:3000/cats');\n    //                      ^ AxiosInstance interface\n  }\n}\n"),e.k0s()(),e.j41(209,"h4",21)(210,"span"),e.EFF(211,"Full example"),e.k0s()(),e.j41(212,"p"),e.EFF(213,"Since the return value of the "),e.j41(214,"code"),e.EFF(215,"HttpService"),e.k0s(),e.EFF(216," methods is an Observable, we can use "),e.j41(217,"code"),e.EFF(218,"rxjs"),e.k0s(),e.EFF(219," - "),e.j41(220,"code"),e.EFF(221,"firstValueFrom"),e.k0s(),e.EFF(222," or "),e.j41(223,"code"),e.EFF(224,"lastValueFrom"),e.k0s(),e.EFF(225," to retrieve the data of the request in the form of a promise."),e.k0s(),e.j41(226,"pre")(227,"code",14),e.EFF(228,"\nimport { catchError, firstValueFrom } from 'rxjs';\n\n@Injectable()\nexport class CatsService {\n  private readonly logger = new Logger(CatsService.name);\n  constructor(private readonly httpService: HttpService) {}\n\n  async findAll(): Promise<Cat[]> {\n    const { data } = await firstValueFrom(\n      this.httpService.get<Cat[]>('http://localhost:3000/cats').pipe(\n        catchError((error: AxiosError) => {\n          this.logger.error(error.response.data);\n          throw 'An error happened!';\n        }),\n      ),\n    );\n    return data;\n  }\n}\n"),e.k0s()(),e.j41(229,"blockquote",8)(230,"strong"),e.EFF(231,"Hint"),e.k0s(),e.EFF(232," Visit RxJS's documentation on "),e.j41(233,"a",22)(234,"code"),e.EFF(235,"firstValueFrom"),e.k0s()(),e.EFF(236," and "),e.j41(237,"a",23)(238,"code"),e.EFF(239,"lastValueFrom"),e.k0s()(),e.EFF(240," for differences between them.\n"),e.k0s()()),2&s){const a=e.sdS(74);e.R7$(75),e.AVh("hide",a.isJsActive),e.R7$(3),e.AVh("hide",!a.isJsActive)}},dependencies:[p.O,F.a],encapsulation:2,changeDetection:0})}return t})();var v=d(5749);let N=(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-logger"]],features:[e.Vt3],decls:450,vars:0,consts:[["contentReference",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/logger.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","logger"],["rel","nofollow","target","_blank","href","https://github.com/winstonjs/winston"],["appAnchor","","id","basic-customization"],[1,"language-typescript"],[1,"info"],["appAnchor","","id","custom-implementation"],["href","techniques/logger#dependency-injection"],["appAnchor","","id","extend-built-in-logger"],["href","techniques/logger#using-the-logger-for-application-logging"],["href","techniques/logger#custom-logger-implementation"],["appAnchor","","id","dependency-injection"],["href","techniques/logger#injecting-a-custom-logger"],["appAnchor","","id","using-the-logger-for-application-logging"],[1,"language-bash"],["appAnchor","","id","injecting-a-custom-logger"],["routerLink","/fundamentals/injection-scopes"],["appAnchor","","id","use-external-logger"]],template:function(s,n){1&s&&(e.j41(0,"div",1,0)(2,"div",2)(3,"a",3),e.nrm(4,"i",4),e.k0s()(),e.j41(5,"h3",5),e.EFF(6,"Logger"),e.k0s(),e.j41(7,"p"),e.EFF(8,"Nest comes with a built-in text-based logger which is used during application bootstrapping and several other circumstances such as displaying caught exceptions (i.e., system logging). This functionality is provided via the "),e.j41(9,"code"),e.EFF(10,"Logger"),e.k0s(),e.EFF(11," class in the "),e.j41(12,"code"),e.EFF(13,"@nestjs/common"),e.k0s(),e.EFF(14," package. You can fully control the behavior of the logging system, including any of the following:"),e.k0s(),e.j41(15,"ul")(16,"li"),e.EFF(17,"disable logging entirely"),e.k0s(),e.j41(18,"li"),e.EFF(19,"specify the log level of detail (e.g., display errors, warnings, debug information, etc.)"),e.k0s(),e.j41(20,"li"),e.EFF(21,"override timestamp in the default logger (e.g., use ISO8601 standard as date format)"),e.k0s(),e.j41(22,"li"),e.EFF(23,"completely override the default logger"),e.k0s(),e.j41(24,"li"),e.EFF(25,"customize the default logger by extending it"),e.k0s(),e.j41(26,"li"),e.EFF(27,"make use of dependency injection to simplify composing and testing your application"),e.k0s()(),e.j41(28,"p"),e.EFF(29,"You can also make use of the built-in logger, or create your own custom implementation, to log your own application-level events and messages."),e.k0s(),e.j41(30,"p"),e.EFF(31,"For more advanced logging functionality, you can make use of any Node.js logging package, such as "),e.j41(32,"a",6),e.EFF(33,"Winston"),e.k0s(),e.EFF(34,", to implement a completely custom, production grade logging system."),e.k0s(),e.j41(35,"h4",7)(36,"span"),e.EFF(37,"Basic customization"),e.k0s()(),e.j41(38,"p"),e.EFF(39,"To disable logging, set the "),e.j41(40,"code"),e.EFF(41,"logger"),e.k0s(),e.EFF(42," property to "),e.j41(43,"code"),e.EFF(44,"false"),e.k0s(),e.EFF(45," in the (optional) Nest application options object passed as the second argument to the "),e.j41(46,"code"),e.EFF(47,"NestFactory.create()"),e.k0s(),e.EFF(48," method."),e.k0s(),e.j41(49,"pre")(50,"code",8),e.EFF(51,"\nconst app = await NestFactory.create(AppModule, {\n  logger: false,\n});\nawait app.listen(process.env.PORT ?? 3000);\n"),e.k0s()(),e.j41(52,"p"),e.EFF(53,"To enable specific logging levels, set the "),e.j41(54,"code"),e.EFF(55,"logger"),e.k0s(),e.EFF(56," property to an array of strings specifying the log levels to display, as follows:"),e.k0s(),e.j41(57,"pre")(58,"code",8),e.EFF(59,"\nconst app = await NestFactory.create(AppModule, {\n  logger: ['error', 'warn'],\n});\nawait app.listen(process.env.PORT ?? 3000);\n"),e.k0s()(),e.j41(60,"p"),e.EFF(61,"Values in the array can be any combination of "),e.j41(62,"code"),e.EFF(63,"'log'"),e.k0s(),e.EFF(64,", "),e.j41(65,"code"),e.EFF(66,"'fatal'"),e.k0s(),e.EFF(67,", "),e.j41(68,"code"),e.EFF(69,"'error'"),e.k0s(),e.EFF(70,", "),e.j41(71,"code"),e.EFF(72,"'warn'"),e.k0s(),e.EFF(73,", "),e.j41(74,"code"),e.EFF(75,"'debug'"),e.k0s(),e.EFF(76,", and "),e.j41(77,"code"),e.EFF(78,"'verbose'"),e.k0s(),e.EFF(79,"."),e.k0s(),e.j41(80,"blockquote",9)(81,"strong"),e.EFF(82,"Hint"),e.k0s(),e.EFF(83," To disable color in the default logger's messages, set the "),e.j41(84,"code"),e.EFF(85,"NO_COLOR"),e.k0s(),e.EFF(86," environment variable to some non-empty string.\n"),e.k0s(),e.j41(87,"h4",10)(88,"span"),e.EFF(89,"Custom implementation"),e.k0s()(),e.j41(90,"p"),e.EFF(91,"You can provide a custom logger implementation to be used by Nest for system logging by setting the value of the "),e.j41(92,"code"),e.EFF(93,"logger"),e.k0s(),e.EFF(94," property to an object that fulfills the "),e.j41(95,"code"),e.EFF(96,"LoggerService"),e.k0s(),e.EFF(97," interface. For example, you can tell Nest to use the built-in global JavaScript "),e.j41(98,"code"),e.EFF(99,"console"),e.k0s(),e.EFF(100," object (which implements the "),e.j41(101,"code"),e.EFF(102,"LoggerService"),e.k0s(),e.EFF(103," interface), as follows:"),e.k0s(),e.j41(104,"pre")(105,"code",8),e.EFF(106,"\nconst app = await NestFactory.create(AppModule, {\n  logger: console,\n});\nawait app.listen(process.env.PORT ?? 3000);\n"),e.k0s()(),e.j41(107,"p"),e.EFF(108,"Implementing your own custom logger is straightforward. Simply implement each of the methods of the "),e.j41(109,"code"),e.EFF(110,"LoggerService"),e.k0s(),e.EFF(111," interface as shown below."),e.k0s(),e.j41(112,"pre")(113,"code",8),e.EFF(114,"\nimport { LoggerService, Injectable } from '@nestjs/common';\n\n@Injectable()\nexport class MyLogger implements LoggerService {\n  /**\n   * Write a 'log' level log.\n   */\n  log(message: any, ...optionalParams: any[]) {}\n\n  /**\n   * Write a 'fatal' level log.\n   */\n  fatal(message: any, ...optionalParams: any[]) {}\n\n  /**\n   * Write an 'error' level log.\n   */\n  error(message: any, ...optionalParams: any[]) {}\n\n  /**\n   * Write a 'warn' level log.\n   */\n  warn(message: any, ...optionalParams: any[]) {}\n\n  /**\n   * Write a 'debug' level log.\n   */\n  debug?(message: any, ...optionalParams: any[]) {}\n\n  /**\n   * Write a 'verbose' level log.\n   */\n  verbose?(message: any, ...optionalParams: any[]) {}\n}\n"),e.k0s()(),e.j41(115,"p"),e.EFF(116,"You can then supply an instance of "),e.j41(117,"code"),e.EFF(118,"MyLogger"),e.k0s(),e.EFF(119," via the "),e.j41(120,"code"),e.EFF(121,"logger"),e.k0s(),e.EFF(122," property of the Nest application options object."),e.k0s(),e.j41(123,"pre")(124,"code",8),e.EFF(125,"\nconst app = await NestFactory.create(AppModule, {\n  logger: new MyLogger(),\n});\nawait app.listen(process.env.PORT ?? 3000);\n"),e.k0s()(),e.j41(126,"p"),e.EFF(127,"This technique, while simple, doesn't utilize dependency injection for the "),e.j41(128,"code"),e.EFF(129,"MyLogger"),e.k0s(),e.EFF(130," class. This can pose some challenges, particularly for testing, and limit the reusability of "),e.j41(131,"code"),e.EFF(132,"MyLogger"),e.k0s(),e.EFF(133,". For a better solution, see the "),e.j41(134,"a",11),e.EFF(135,"Dependency Injection"),e.k0s(),e.EFF(136," section below."),e.k0s(),e.j41(137,"h4",12)(138,"span"),e.EFF(139,"Extend built-in logger"),e.k0s()(),e.j41(140,"p"),e.EFF(141,"Rather than writing a logger from scratch, you may be able to meet your needs by extending the built-in "),e.j41(142,"code"),e.EFF(143,"ConsoleLogger"),e.k0s(),e.EFF(144," class and overriding selected behavior of the default implementation."),e.k0s(),e.j41(145,"pre")(146,"code",8),e.EFF(147,"\nimport { ConsoleLogger } from '@nestjs/common';\n\nexport class MyLogger extends ConsoleLogger {\n  error(message: any, stack?: string, context?: string) {\n    // add your tailored logic here\n    super.error(...arguments);\n  }\n}\n"),e.k0s()(),e.j41(148,"p"),e.EFF(149,"You can use such an extended logger in your feature modules as described in the "),e.j41(150,"a",13),e.EFF(151,"Using the logger for application logging"),e.k0s(),e.EFF(152," section below."),e.k0s(),e.j41(153,"p"),e.EFF(154,"You can tell Nest to use your extended logger for system logging by passing an instance of it via the "),e.j41(155,"code"),e.EFF(156,"logger"),e.k0s(),e.EFF(157," property of the application options object (as shown in the "),e.j41(158,"a",14),e.EFF(159,"Custom implementation"),e.k0s(),e.EFF(160," section above), or by using the technique shown in the "),e.j41(161,"a",11),e.EFF(162,"Dependency Injection"),e.k0s(),e.EFF(163," section below. If you do so, you should take care to call "),e.j41(164,"code"),e.EFF(165,"super"),e.k0s(),e.EFF(166,", as shown in the sample code above, to delegate the specific log method call to the parent (built-in) class so that Nest can rely on the built-in features it expects."),e.k0s(),e.j41(167,"p"),e.nrm(168,"app-banner-courses"),e.k0s(),e.j41(169,"h4",15)(170,"span"),e.EFF(171,"Dependency injection"),e.k0s()(),e.j41(172,"p"),e.EFF(173,"For more advanced logging functionality, you'll want to take advantage of dependency injection. For example, you may want to inject a "),e.j41(174,"code"),e.EFF(175,"ConfigService"),e.k0s(),e.EFF(176," into your logger to customize it, and in turn inject your custom logger into other controllers and/or providers. To enable dependency injection for your custom logger, create a class that implements "),e.j41(177,"code"),e.EFF(178,"LoggerService"),e.k0s(),e.EFF(179," and register that class as a provider in some module. For example, you can"),e.k0s(),e.j41(180,"ol")(181,"li"),e.EFF(182,"Define a "),e.j41(183,"code"),e.EFF(184,"MyLogger"),e.k0s(),e.EFF(185," class that either extends the built-in "),e.j41(186,"code"),e.EFF(187,"ConsoleLogger"),e.k0s(),e.EFF(188," or completely overrides it, as shown in previous sections. Be sure to implement the "),e.j41(189,"code"),e.EFF(190,"LoggerService"),e.k0s(),e.EFF(191," interface."),e.k0s(),e.j41(192,"li"),e.EFF(193,"Create a "),e.j41(194,"code"),e.EFF(195,"LoggerModule"),e.k0s(),e.EFF(196," as shown below, and provide "),e.j41(197,"code"),e.EFF(198,"MyLogger"),e.k0s(),e.EFF(199," from that module."),e.k0s()(),e.j41(200,"pre")(201,"code",8),e.EFF(202,"\nimport { Module } from '@nestjs/common';\nimport { MyLogger } from './my-logger.service';\n\n@Module({\n  providers: [MyLogger],\n  exports: [MyLogger],\n})\nexport class LoggerModule {}\n"),e.k0s()(),e.j41(203,"p"),e.EFF(204,"With this construct, you are now providing your custom logger for use by any other module. Because your "),e.j41(205,"code"),e.EFF(206,"MyLogger"),e.k0s(),e.EFF(207," class is part of a module, it can use dependency injection (for example, to inject a "),e.j41(208,"code"),e.EFF(209,"ConfigService"),e.k0s(),e.EFF(210,"). There's one more technique needed to provide this custom logger for use by Nest for system logging (e.g., for bootstrapping and error handling)."),e.k0s(),e.j41(211,"p"),e.EFF(212,"Because application instantiation ("),e.j41(213,"code"),e.EFF(214,"NestFactory.create()"),e.k0s(),e.EFF(215,") happens outside the context of any module, it doesn't participate in the normal Dependency Injection phase of initialization. So we must ensure that at least one application module imports the "),e.j41(216,"code"),e.EFF(217,"LoggerModule"),e.k0s(),e.EFF(218," to trigger Nest to instantiate a singleton instance of our "),e.j41(219,"code"),e.EFF(220,"MyLogger"),e.k0s(),e.EFF(221," class."),e.k0s(),e.j41(222,"p"),e.EFF(223,"We can then instruct Nest to use the same singleton instance of "),e.j41(224,"code"),e.EFF(225,"MyLogger"),e.k0s(),e.EFF(226," with the following construction:"),e.k0s(),e.j41(227,"pre")(228,"code",8),e.EFF(229,"\nconst app = await NestFactory.create(AppModule, {\n  bufferLogs: true,\n});\napp.useLogger(app.get(MyLogger));\nawait app.listen(process.env.PORT ?? 3000);\n"),e.k0s()(),e.j41(230,"blockquote",9)(231,"strong"),e.EFF(232,"Note"),e.k0s(),e.EFF(233," In the example above, we set the "),e.j41(234,"code"),e.EFF(235,"bufferLogs"),e.k0s(),e.EFF(236," to "),e.j41(237,"code"),e.EFF(238,"true"),e.k0s(),e.EFF(239," to make sure all logs will be buffered until a custom logger is attached ("),e.j41(240,"code"),e.EFF(241,"MyLogger"),e.k0s(),e.EFF(242," in this case) and the application initialisation process either completes or fails. If the initialisation process fails, Nest will fallback to the original "),e.j41(243,"code"),e.EFF(244,"ConsoleLogger"),e.k0s(),e.EFF(245," to print out any reported error messages. Also, you can set the "),e.j41(246,"code"),e.EFF(247,"autoFlushLogs"),e.k0s(),e.EFF(248," to "),e.j41(249,"code"),e.EFF(250,"false"),e.k0s(),e.EFF(251," (default "),e.j41(252,"code"),e.EFF(253,"true"),e.k0s(),e.EFF(254,") to manually flush logs (using the "),e.j41(255,"code"),e.EFF(256,"Logger#flush()"),e.k0s(),e.EFF(257," method).\n"),e.k0s(),e.j41(258,"p"),e.EFF(259,"Here we use the "),e.j41(260,"code"),e.EFF(261,"get()"),e.k0s(),e.EFF(262," method on the "),e.j41(263,"code"),e.EFF(264,"NestApplication"),e.k0s(),e.EFF(265," instance to retrieve the singleton instance of the "),e.j41(266,"code"),e.EFF(267,"MyLogger"),e.k0s(),e.EFF(268,' object. This technique is essentially a way to "inject" an instance of a logger for use by Nest. The '),e.j41(269,"code"),e.EFF(270,"app.get()"),e.k0s(),e.EFF(271," call retrieves the singleton instance of "),e.j41(272,"code"),e.EFF(273,"MyLogger"),e.k0s(),e.EFF(274,", and depends on that instance being first injected in another module, as described above."),e.k0s(),e.j41(275,"p"),e.EFF(276,"You can also inject this "),e.j41(277,"code"),e.EFF(278,"MyLogger"),e.k0s(),e.EFF(279," provider in your feature classes, thus ensuring consistent logging behavior across both Nest system logging and application logging. See "),e.j41(280,"a",13),e.EFF(281,"Using the logger for application logging"),e.k0s(),e.EFF(282," and "),e.j41(283,"a",16),e.EFF(284,"Injecting a custom logger"),e.k0s(),e.EFF(285," below for more information."),e.k0s(),e.j41(286,"h4",17)(287,"span"),e.EFF(288,"Using the logger for application logging"),e.k0s()(),e.j41(289,"p"),e.EFF(290,"We can combine several of the techniques above to provide consistent behavior and formatting across both Nest system logging and our own application event/message logging."),e.k0s(),e.j41(291,"p"),e.EFF(292,"A good practice is to instantiate "),e.j41(293,"code"),e.EFF(294,"Logger"),e.k0s(),e.EFF(295," class from "),e.j41(296,"code"),e.EFF(297,"@nestjs/common"),e.k0s(),e.EFF(298," in each of our services. We can supply our service name as the "),e.j41(299,"code"),e.EFF(300,"context"),e.k0s(),e.EFF(301," argument in the "),e.j41(302,"code"),e.EFF(303,"Logger"),e.k0s(),e.EFF(304," constructor, like so:"),e.k0s(),e.j41(305,"pre")(306,"code",8),e.EFF(307,"\nimport { Logger, Injectable } from '@nestjs/common';\n\n@Injectable()\nclass MyService {\n  private readonly logger = new Logger(MyService.name);\n\n  doSomething() {\n    this.logger.log('Doing something...');\n  }\n}\n"),e.k0s()(),e.j41(308,"p"),e.EFF(309,"In the default logger implementation, "),e.j41(310,"code"),e.EFF(311,"context"),e.k0s(),e.EFF(312," is printed in the square brackets, like "),e.j41(313,"code"),e.EFF(314,"NestFactory"),e.k0s(),e.EFF(315," in the example below:"),e.k0s(),e.j41(316,"pre")(317,"code",18),e.EFF(318,"\n[Nest] 19096   - 12/08/2019, 7:12:59 AM   [NestFactory] Starting Nest application...\n"),e.k0s()(),e.j41(319,"p"),e.EFF(320,"If we supply a custom logger via "),e.j41(321,"code"),e.EFF(322,"app.useLogger()"),e.k0s(),e.EFF(323,", it will actually be used by Nest internally. That means that our code remains implementation agnostic, while we can easily substitute the default logger for our custom one by calling "),e.j41(324,"code"),e.EFF(325,"app.useLogger()"),e.k0s(),e.EFF(326,"."),e.k0s(),e.j41(327,"p"),e.EFF(328,"That way if we follow the steps from the previous section and call "),e.j41(329,"code"),e.EFF(330,"app.useLogger(app.get(MyLogger))"),e.k0s(),e.EFF(331,", the following calls to "),e.j41(332,"code"),e.EFF(333,"this.logger.log()"),e.k0s(),e.EFF(334," from "),e.j41(335,"code"),e.EFF(336,"MyService"),e.k0s(),e.EFF(337," would result in calls to method "),e.j41(338,"code"),e.EFF(339,"log"),e.k0s(),e.EFF(340," from "),e.j41(341,"code"),e.EFF(342,"MyLogger"),e.k0s(),e.EFF(343," instance."),e.k0s(),e.j41(344,"p"),e.EFF(345,"This should be suitable for most cases. But if you need more customization (like adding and calling custom methods), move to the next section."),e.k0s(),e.j41(346,"h4",19)(347,"span"),e.EFF(348,"Injecting a custom logger"),e.k0s()(),e.j41(349,"p"),e.EFF(350,"To start, extend the built-in logger with code like the following. We supply the "),e.j41(351,"code"),e.EFF(352,"scope"),e.k0s(),e.EFF(353," option as configuration metadata for the "),e.j41(354,"code"),e.EFF(355,"ConsoleLogger"),e.k0s(),e.EFF(356," class, specifying a "),e.j41(357,"a",20),e.EFF(358,"transient"),e.k0s(),e.EFF(359," scope, to ensure that we'll have a unique instance of the "),e.j41(360,"code"),e.EFF(361,"MyLogger"),e.k0s(),e.EFF(362," in each feature module. In this example, we do not extend the individual "),e.j41(363,"code"),e.EFF(364,"ConsoleLogger"),e.k0s(),e.EFF(365," methods (like "),e.j41(366,"code"),e.EFF(367,"log()"),e.k0s(),e.EFF(368,", "),e.j41(369,"code"),e.EFF(370,"warn()"),e.k0s(),e.EFF(371,", etc.), though you may choose to do so."),e.k0s(),e.j41(372,"pre")(373,"code",8),e.EFF(374,"\nimport { Injectable, Scope, ConsoleLogger } from '@nestjs/common';\n\n@Injectable({ scope: Scope.TRANSIENT })\nexport class MyLogger extends ConsoleLogger {\n  customLog() {\n    this.log('Please feed the cat!');\n  }\n}\n"),e.k0s()(),e.j41(375,"p"),e.EFF(376,"Next, create a "),e.j41(377,"code"),e.EFF(378,"LoggerModule"),e.k0s(),e.EFF(379," with a construction like this:"),e.k0s(),e.j41(380,"pre")(381,"code",8),e.EFF(382,"\nimport { Module } from '@nestjs/common';\nimport { MyLogger } from './my-logger.service';\n\n@Module({\n  providers: [MyLogger],\n  exports: [MyLogger],\n})\nexport class LoggerModule {}\n"),e.k0s()(),e.j41(383,"p"),e.EFF(384,"Next, import the "),e.j41(385,"code"),e.EFF(386,"LoggerModule"),e.k0s(),e.EFF(387," into your feature module. Since we extended default "),e.j41(388,"code"),e.EFF(389,"Logger"),e.k0s(),e.EFF(390," we have the convenience of using "),e.j41(391,"code"),e.EFF(392,"setContext"),e.k0s(),e.EFF(393," method. So we can start using the context-aware custom logger, like this:"),e.k0s(),e.j41(394,"pre")(395,"code",8),e.EFF(396,"\nimport { Injectable } from '@nestjs/common';\nimport { MyLogger } from './my-logger.service';\n\n@Injectable()\nexport class CatsService {\n  private readonly cats: Cat[] = [];\n\n  constructor(private myLogger: MyLogger) {\n    // Due to transient scope, CatsService has its own unique instance of MyLogger,\n    // so setting context here will not affect other instances in other services\n    this.myLogger.setContext('CatsService');\n  }\n\n  findAll(): Cat[] {\n    // You can call all the default methods\n    this.myLogger.warn('About to return cats!');\n    // And your custom methods\n    this.myLogger.customLog();\n    return this.cats;\n  }\n}\n"),e.k0s()(),e.j41(397,"p"),e.EFF(398,"Finally, instruct Nest to use an instance of the custom logger in your "),e.j41(399,"code"),e.EFF(400,"main.ts"),e.k0s(),e.EFF(401," file as shown below. Of course in this example, we haven't actually customized the logger behavior (by extending the "),e.j41(402,"code"),e.EFF(403,"Logger"),e.k0s(),e.EFF(404," methods like "),e.j41(405,"code"),e.EFF(406,"log()"),e.k0s(),e.EFF(407,", "),e.j41(408,"code"),e.EFF(409,"warn()"),e.k0s(),e.EFF(410,", etc.), so this step isn't actually needed. But it "),e.j41(411,"strong"),e.EFF(412,"would"),e.k0s(),e.EFF(413," be needed if you added custom logic to those methods and wanted Nest to use the same implementation."),e.k0s(),e.j41(414,"pre")(415,"code",8),e.EFF(416,"\nconst app = await NestFactory.create(AppModule, {\n  bufferLogs: true,\n});\napp.useLogger(new MyLogger());\nawait app.listen(process.env.PORT ?? 3000);\n"),e.k0s()(),e.j41(417,"blockquote",9)(418,"strong"),e.EFF(419,"Hint"),e.k0s(),e.EFF(420," Alternatively, instead of setting "),e.j41(421,"code"),e.EFF(422,"bufferLogs"),e.k0s(),e.EFF(423," to "),e.j41(424,"code"),e.EFF(425,"true"),e.k0s(),e.EFF(426,", you could temporarily disable the logger with "),e.j41(427,"code"),e.EFF(428,"logger: false"),e.k0s(),e.EFF(429," instruction. Be mindful that if you supply "),e.j41(430,"code"),e.EFF(431,"logger: false"),e.k0s(),e.EFF(432," to "),e.j41(433,"code"),e.EFF(434,"NestFactory.create"),e.k0s(),e.EFF(435,", nothing will be logged until you call "),e.j41(436,"code"),e.EFF(437,"useLogger"),e.k0s(),e.EFF(438,", so you may miss some important initialization errors. If you don't mind that some of your initial messages will be logged with the default logger, you can just omit the "),e.j41(439,"code"),e.EFF(440,"logger: false"),e.k0s(),e.EFF(441," option.\n"),e.k0s(),e.j41(442,"h4",21)(443,"span"),e.EFF(444,"Use external logger"),e.k0s()(),e.j41(445,"p"),e.EFF(446,"Production applications often have specific logging requirements, including advanced filtering, formatting and centralized logging. Nest's built-in logger is used for monitoring Nest system behavior, and can also be useful for basic formatted text logging in your feature modules while in development, but production applications often take advantage of dedicated logging modules like "),e.j41(447,"a",6),e.EFF(448,"Winston"),e.k0s(),e.EFF(449,". As with any standard Node.js application, you can take full advantage of such modules in Nest."),e.k0s()())},dependencies:[F.a,v.Q,E.Wk],encapsulation:2,changeDetection:0})}return t})(),_=(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-mongo"]],features:[e.Vt3],decls:618,vars:52,consts:[["contentReference",""],["appbf93d3df87adcb3aecf068142a9f821e516ee5bf",""],["app6a526d5edde68b4c069f4c32a2e58fcb629f8acd",""],["appcb10cc3fbfb0f8a781c59317a29f6c285853dfb0",""],["app34db53bf49ed049775d63ca9ea106df69708069a",""],["appecca7152eb57f4f3af8bbbbba0d5c1e388d0ab1f",""],["app0aa12abb5f1c5080095ab52cace612c4c50a54fe",""],["appebe60899698c7e05336fcf9d3d17bb848ffd35bc",""],["app7476091310bf2bba13fc13a4bc85cd4f181d4250",""],["appbf077610caee2336e2fdfc54a615d7d9db78a13a",""],["app0a886e4abb4cb67b23c088ff1af1b1f8fde78492",""],["app9a2c5992225ec16afb691bcf7b0098b0d8f2eda7",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/mongo.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","mongo"],["rel","nofollow","target","_blank","href","https://www.mongodb.com/"],["rel","nofollow","target","_blank","href","https://github.com/typeorm/typeorm"],["routerLink","/techniques/database"],["rel","nofollow","target","_blank","href","https://mongoosejs.com"],["rel","nofollow","target","_blank","href","https://github.com/Automattic/mongoose"],[1,"language-bash"],[1,"filename"],[1,"language-typescript"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/connections.html"],["appAnchor","","id","model-injection"],["rel","nofollow","target","_blank","href","http://mongoosejs.com/docs/guide.html"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/models.html"],[1,"info"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/guide.html#options"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/schematypes.html"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/schematypes.html#schematype-options"],["appAnchor","","id","connection"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/api.html#Connection"],["appAnchor","","id","multiple-databases"],[1,"warning"],["appAnchor","","id","hooks-middleware"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/middleware.html"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/fundamentals/custom-providers#factory-providers-usefactory"],["appAnchor","","id","plugins"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/plugins.html"],["appAnchor","","id","discriminators"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/discriminators.html"],["appAnchor","","id","testing"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/fundamentals/custom-providers#di-fundamentals"],["routerLink","/fundamentals/custom-providers"],["appAnchor","","id","async-configuration"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/06-mongoose"]],template:function(s,n){if(1&s&&(e.j41(0,"div",12,0)(2,"div",13)(3,"a",14),e.nrm(4,"i",15),e.k0s()(),e.j41(5,"h3",16),e.EFF(6,"Mongo"),e.k0s(),e.j41(7,"p"),e.EFF(8,"Nest supports two methods for integrating with the "),e.j41(9,"a",17),e.EFF(10,"MongoDB"),e.k0s(),e.EFF(11," database. You can either use the built-in "),e.j41(12,"a",18),e.EFF(13,"TypeORM"),e.k0s(),e.EFF(14," module described "),e.j41(15,"a",19),e.EFF(16,"here"),e.k0s(),e.EFF(17,", which has a connector for MongoDB, or use "),e.j41(18,"a",20),e.EFF(19,"Mongoose"),e.k0s(),e.EFF(20,", the most popular MongoDB object modeling tool. In this chapter we'll describe the latter, using the dedicated "),e.j41(21,"code"),e.EFF(22,"@nestjs/mongoose"),e.k0s(),e.EFF(23," package."),e.k0s(),e.j41(24,"p"),e.EFF(25,"Start by installing the "),e.j41(26,"a",21),e.EFF(27,"required dependencies"),e.k0s(),e.EFF(28,":"),e.k0s(),e.j41(29,"pre")(30,"code",22),e.EFF(31,"\n$ npm i @nestjs/mongoose mongoose\n"),e.k0s()(),e.j41(32,"p"),e.EFF(33,"Once the installation process is complete, we can import the "),e.j41(34,"code"),e.EFF(35,"MongooseModule"),e.k0s(),e.EFF(36," into the root "),e.j41(37,"code"),e.EFF(38,"AppModule"),e.k0s(),e.EFF(39,"."),e.k0s(),e.j41(40,"span",23),e.EFF(41),e.nI1(42,"extension"),e.nrm(43,"app-tabs",null,1),e.k0s(),e.j41(45,"pre")(46,"code",24),e.EFF(47,"\nimport { Module } from '@nestjs/common';\nimport { MongooseModule } from '@nestjs/mongoose';\n\n@Module({\n  imports: [MongooseModule.forRoot('mongodb://localhost/nest')],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(48,"p"),e.EFF(49,"The "),e.j41(50,"code"),e.EFF(51,"forRoot()"),e.k0s(),e.EFF(52," method accepts the same configuration object as "),e.j41(53,"code"),e.EFF(54,"mongoose.connect()"),e.k0s(),e.EFF(55," from the Mongoose package, as described "),e.j41(56,"a",25),e.EFF(57,"here"),e.k0s(),e.EFF(58,"."),e.k0s(),e.j41(59,"h4",26)(60,"span"),e.EFF(61,"Model injection"),e.k0s()(),e.j41(62,"p"),e.EFF(63,"With Mongoose, everything is derived from a "),e.j41(64,"a",27),e.EFF(65,"Schema"),e.k0s(),e.EFF(66,". Each schema maps to a MongoDB collection and defines the shape of the documents within that collection. Schemas are used to define "),e.j41(67,"a",28),e.EFF(68,"Models"),e.k0s(),e.EFF(69,". Models are responsible for creating and reading documents from the underlying MongoDB database."),e.k0s(),e.j41(70,"p"),e.EFF(71,"Schemas can be created with NestJS decorators, or with Mongoose itself manually. Using decorators to create schemas greatly reduces boilerplate and improves overall code readability."),e.k0s(),e.j41(72,"p"),e.EFF(73,"Let's define the "),e.j41(74,"code"),e.EFF(75,"CatSchema"),e.k0s(),e.EFF(76,":"),e.k0s(),e.j41(77,"span",23),e.EFF(78),e.nI1(79,"extension"),e.nrm(80,"app-tabs",null,2),e.k0s(),e.j41(82,"pre")(83,"code",24),e.EFF(84,"\nimport { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';\nimport { HydratedDocument } from 'mongoose';\n\nexport type CatDocument = HydratedDocument<Cat>;\n\n@Schema()\nexport class Cat {\n  @Prop()\n  name: string;\n\n  @Prop()\n  age: number;\n\n  @Prop()\n  breed: string;\n}\n\nexport const CatSchema = SchemaFactory.createForClass(Cat);\n"),e.k0s()(),e.j41(85,"blockquote",29)(86,"strong"),e.EFF(87,"Hint"),e.k0s(),e.EFF(88," Note you can also generate a raw schema definition using the "),e.j41(89,"code"),e.EFF(90,"DefinitionsFactory"),e.k0s(),e.EFF(91," class (from the "),e.j41(92,"code"),e.EFF(93,"nestjs/mongoose"),e.k0s(),e.EFF(94,"). This allows you to manually modify the schema definition generated based on the metadata you provided. This is useful for certain edge-cases where it may be hard to represent everything with decorators.\n"),e.k0s(),e.j41(95,"p"),e.EFF(96,"The "),e.j41(97,"code"),e.EFF(98,"@Schema()"),e.k0s(),e.EFF(99," decorator marks a class as a schema definition. It maps our "),e.j41(100,"code"),e.EFF(101,"Cat"),e.k0s(),e.EFF(102," class to a MongoDB collection of the same name, but with an additional \u201cs\u201d at the end - so the final mongo collection name will be "),e.j41(103,"code"),e.EFF(104,"cats"),e.k0s(),e.EFF(105,". This decorator accepts a single optional argument which is a schema options object. Think of it as the object you would normally pass as a second argument of the "),e.j41(106,"code"),e.EFF(107,"mongoose.Schema"),e.k0s(),e.EFF(108," class' constructor (e.g., "),e.j41(109,"code"),e.EFF(110,"new mongoose.Schema(_, options)"),e.k0s(),e.EFF(111,")). To learn more about available schema options, see "),e.j41(112,"a",30),e.EFF(113,"this"),e.k0s(),e.EFF(114," chapter."),e.k0s(),e.j41(115,"p"),e.EFF(116,"The "),e.j41(117,"code"),e.EFF(118,"@Prop()"),e.k0s(),e.EFF(119," decorator defines a property in the document. For example, in the schema definition above, we defined three properties: "),e.j41(120,"code"),e.EFF(121,"name"),e.k0s(),e.EFF(122,", "),e.j41(123,"code"),e.EFF(124,"age"),e.k0s(),e.EFF(125,", and "),e.j41(126,"code"),e.EFF(127,"breed"),e.k0s(),e.EFF(128,". The "),e.j41(129,"a",31),e.EFF(130,"schema types"),e.k0s(),e.EFF(131," for these properties are automatically inferred thanks to TypeScript metadata (and reflection) capabilities. However, in more complex scenarios in which types cannot be implicitly reflected (for example, arrays or nested object structures), types must be indicated explicitly, as follows:"),e.k0s(),e.j41(132,"pre")(133,"code",24),e.EFF(134,"\n@Prop([String])\ntags: string[];\n"),e.k0s()(),e.j41(135,"p"),e.EFF(136,"Alternatively, the "),e.j41(137,"code"),e.EFF(138,"@Prop()"),e.k0s(),e.EFF(139," decorator accepts an options object argument ("),e.j41(140,"a",32),e.EFF(141,"read more"),e.k0s(),e.EFF(142," about the available options). With this, you can indicate whether a property is required or not, specify a default value, or mark it as immutable. For example:"),e.k0s(),e.j41(143,"pre")(144,"code",24),e.EFF(145,"\n@Prop({ required: true })\nname: string;\n"),e.k0s()(),e.j41(146,"p"),e.EFF(147,"In case you want to specify relation to another model, later for populating, you can use "),e.j41(148,"code"),e.EFF(149,"@Prop()"),e.k0s(),e.EFF(150," decorator as well. For example, if "),e.j41(151,"code"),e.EFF(152,"Cat"),e.k0s(),e.EFF(153," has "),e.j41(154,"code"),e.EFF(155,"Owner"),e.k0s(),e.EFF(156," which is stored in a different collection called "),e.j41(157,"code"),e.EFF(158,"owners"),e.k0s(),e.EFF(159,", the property should have type and ref. For example:"),e.k0s(),e.j41(160,"pre")(161,"code",24),e.EFF(162,"\nimport * as mongoose from 'mongoose';\nimport { Owner } from '../owners/schemas/owner.schema';\n\n// inside the class definition\n@Prop({ type: mongoose.Schema.Types.ObjectId, ref: 'Owner' })\nowner: Owner;\n"),e.k0s()(),e.j41(163,"p"),e.EFF(164,"In case there are multiple owners, your property configuration should look as follows:"),e.k0s(),e.j41(165,"pre")(166,"code",24),e.EFF(167,"\n@Prop({ type: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Owner' }] })\nowners: Owner[];\n"),e.k0s()(),e.j41(168,"p"),e.EFF(169,"Finally, the "),e.j41(170,"strong"),e.EFF(171,"raw"),e.k0s(),e.EFF(172," schema definition can also be passed to the decorator. This is useful when, for example, a property represents a nested object which is not defined as a class. For this, use the "),e.j41(173,"code"),e.EFF(174,"raw()"),e.k0s(),e.EFF(175," function from the "),e.j41(176,"code"),e.EFF(177,"@nestjs/mongoose"),e.k0s(),e.EFF(178," package, as follows:"),e.k0s(),e.j41(179,"pre")(180,"code",24),e.EFF(181,"\n@Prop(raw({\n  firstName: { type: String },\n  lastName: { type: String }\n}))\ndetails: Record<string, any>;\n"),e.k0s()(),e.j41(182,"p"),e.EFF(183,"Alternatively, if you prefer "),e.j41(184,"strong"),e.EFF(185,"not using decorators"),e.k0s(),e.EFF(186,", you can define a schema manually. For example:"),e.k0s(),e.j41(187,"pre")(188,"code",24),e.EFF(189,"\nexport const CatSchema = new mongoose.Schema({\n  name: String,\n  age: Number,\n  breed: String,\n});\n"),e.k0s()(),e.j41(190,"p"),e.EFF(191,"The "),e.j41(192,"code"),e.EFF(193,"cat.schema"),e.k0s(),e.EFF(194," file resides in a folder in the "),e.j41(195,"code"),e.EFF(196,"cats"),e.k0s(),e.EFF(197," directory, where we also define the "),e.j41(198,"code"),e.EFF(199,"CatsModule"),e.k0s(),e.EFF(200,". While you can store schema files wherever you prefer, we recommend storing them near their related "),e.j41(201,"strong"),e.EFF(202,"domain"),e.k0s(),e.EFF(203," objects, in the appropriate module directory."),e.k0s(),e.j41(204,"p"),e.EFF(205,"Let's look at the "),e.j41(206,"code"),e.EFF(207,"CatsModule"),e.k0s(),e.EFF(208,":"),e.k0s(),e.j41(209,"span",23),e.EFF(210),e.nI1(211,"extension"),e.nrm(212,"app-tabs",null,3),e.k0s(),e.j41(214,"pre")(215,"code",24),e.EFF(216,"\nimport { Module } from '@nestjs/common';\nimport { MongooseModule } from '@nestjs/mongoose';\nimport { CatsController } from './cats.controller';\nimport { CatsService } from './cats.service';\nimport { Cat, CatSchema } from './schemas/cat.schema';\n\n@Module({\n  imports: [MongooseModule.forFeature([{ name: Cat.name, schema: CatSchema }])],\n  controllers: [CatsController],\n  providers: [CatsService],\n})\nexport class CatsModule {}\n"),e.k0s()(),e.j41(217,"p"),e.EFF(218,"The "),e.j41(219,"code"),e.EFF(220,"MongooseModule"),e.k0s(),e.EFF(221," provides the "),e.j41(222,"code"),e.EFF(223,"forFeature()"),e.k0s(),e.EFF(224," method to configure the module, including defining which models should be registered in the current scope. If you also want to use the models in another module, add MongooseModule to the "),e.j41(225,"code"),e.EFF(226,"exports"),e.k0s(),e.EFF(227," section of "),e.j41(228,"code"),e.EFF(229,"CatsModule"),e.k0s(),e.EFF(230," and import "),e.j41(231,"code"),e.EFF(232,"CatsModule"),e.k0s(),e.EFF(233," in the other module."),e.k0s(),e.j41(234,"p"),e.EFF(235,"Once you've registered the schema, you can inject a "),e.j41(236,"code"),e.EFF(237,"Cat"),e.k0s(),e.EFF(238," model into the "),e.j41(239,"code"),e.EFF(240,"CatsService"),e.k0s(),e.EFF(241," using the "),e.j41(242,"code"),e.EFF(243,"@InjectModel()"),e.k0s(),e.EFF(244," decorator:"),e.k0s(),e.j41(245,"span",23),e.EFF(246),e.nI1(247,"extension"),e.nrm(248,"app-tabs",null,4),e.k0s(),e.j41(250,"pre")(251,"code",24),e.EFF(252,"\nimport { Model } from 'mongoose';\nimport { Injectable } from '@nestjs/common';\nimport { InjectModel } from '@nestjs/mongoose';\nimport { Cat } from './schemas/cat.schema';\nimport { CreateCatDto } from './dto/create-cat.dto';\n\n@Injectable()\nexport class CatsService {\n  constructor(@InjectModel(Cat.name) private catModel: Model<Cat>) {}\n\n  async create(createCatDto: CreateCatDto): Promise<Cat> {\n    const createdCat = new this.catModel(createCatDto);\n    return createdCat.save();\n  }\n\n  async findAll(): Promise<Cat[]> {\n    return this.catModel.find().exec();\n  }\n}\n"),e.k0s()(),e.j41(253,"pre")(254,"code",24),e.EFF(255,"\nimport { Model } from 'mongoose';\nimport { Injectable, Dependencies } from '@nestjs/common';\nimport { getModelToken } from '@nestjs/mongoose';\nimport { Cat } from './schemas/cat.schema';\n\n@Injectable()\n@Dependencies(getModelToken(Cat.name))\nexport class CatsService {\n  constructor(catModel) {\n    this.catModel = catModel;\n  }\n\n  async create(createCatDto) {\n    const createdCat = new this.catModel(createCatDto);\n    return createdCat.save();\n  }\n\n  async findAll() {\n    return this.catModel.find().exec();\n  }\n}\n"),e.k0s()(),e.j41(256,"h4",33)(257,"span"),e.EFF(258,"Connection"),e.k0s()(),e.j41(259,"p"),e.EFF(260,"At times you may need to access the native "),e.j41(261,"a",34),e.EFF(262,"Mongoose Connection"),e.k0s(),e.EFF(263," object. For example, you may want to make native API calls on the connection object. You can inject the Mongoose Connection by using the "),e.j41(264,"code"),e.EFF(265,"@InjectConnection()"),e.k0s(),e.EFF(266," decorator as follows:"),e.k0s(),e.j41(267,"pre")(268,"code",24),e.EFF(269,"\nimport { Injectable } from '@nestjs/common';\nimport { InjectConnection } from '@nestjs/mongoose';\nimport { Connection } from 'mongoose';\n\n@Injectable()\nexport class CatsService {\n  constructor(@InjectConnection() private connection: Connection) {}\n}\n"),e.k0s()(),e.j41(270,"h4",35)(271,"span"),e.EFF(272,"Multiple databases"),e.k0s()(),e.j41(273,"p"),e.EFF(274,"Some projects require multiple database connections. This can also be achieved with this module. To work with multiple connections, first create the connections. In this case, connection naming becomes "),e.j41(275,"strong"),e.EFF(276,"mandatory"),e.k0s(),e.EFF(277,"."),e.k0s(),e.j41(278,"span",23),e.EFF(279),e.nI1(280,"extension"),e.nrm(281,"app-tabs",null,5),e.k0s(),e.j41(283,"pre")(284,"code",24),e.EFF(285,"\nimport { Module } from '@nestjs/common';\nimport { MongooseModule } from '@nestjs/mongoose';\n\n@Module({\n  imports: [\n    MongooseModule.forRoot('mongodb://localhost/test', {\n      connectionName: 'cats',\n    }),\n    MongooseModule.forRoot('mongodb://localhost/users', {\n      connectionName: 'users',\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(286,"blockquote",36)(287,"strong"),e.EFF(288,"Notice"),e.k0s(),e.EFF(289," Please note that you shouldn't have multiple connections without a name, or with the same name, otherwise they will get overridden.\n"),e.k0s(),e.j41(290,"p"),e.EFF(291,"With this setup, you have to tell the "),e.j41(292,"code"),e.EFF(293,"MongooseModule.forFeature()"),e.k0s(),e.EFF(294," function which connection should be used."),e.k0s(),e.j41(295,"pre")(296,"code",24),e.EFF(297,"\n@Module({\n  imports: [\n    MongooseModule.forFeature([{ name: Cat.name, schema: CatSchema }], 'cats'),\n  ],\n})\nexport class CatsModule {}\n"),e.k0s()(),e.j41(298,"p"),e.EFF(299,"You can also inject the "),e.j41(300,"code"),e.EFF(301,"Connection"),e.k0s(),e.EFF(302," for a given connection:"),e.k0s(),e.j41(303,"pre")(304,"code",24),e.EFF(305,"\nimport { Injectable } from '@nestjs/common';\nimport { InjectConnection } from '@nestjs/mongoose';\nimport { Connection } from 'mongoose';\n\n@Injectable()\nexport class CatsService {\n  constructor(@InjectConnection('cats') private connection: Connection) {}\n}\n"),e.k0s()(),e.j41(306,"p"),e.EFF(307,"To inject a given "),e.j41(308,"code"),e.EFF(309,"Connection"),e.k0s(),e.EFF(310," to a custom provider (for example, factory provider), use the "),e.j41(311,"code"),e.EFF(312,"getConnectionToken()"),e.k0s(),e.EFF(313," function passing the name of the connection as an argument."),e.k0s(),e.j41(314,"pre")(315,"code",24),e.EFF(316,"\n{\n  provide: CatsService,\n  useFactory: (catsConnection: Connection) => {\n    return new CatsService(catsConnection);\n  },\n  inject: [getConnectionToken('cats')],\n}\n"),e.k0s()(),e.j41(317,"p"),e.EFF(318,"If you are just looking to inject the model from a named database, you can use the connection name as a second parameter to the "),e.j41(319,"code"),e.EFF(320,"@InjectModel()"),e.k0s(),e.EFF(321," decorator."),e.k0s(),e.j41(322,"span",23),e.EFF(323),e.nI1(324,"extension"),e.nrm(325,"app-tabs",null,6),e.k0s(),e.j41(327,"pre")(328,"code",24),e.EFF(329,"\n@Injectable()\nexport class CatsService {\n  constructor(@InjectModel(Cat.name, 'cats') private catModel: Model<Cat>) {}\n}\n"),e.k0s()(),e.j41(330,"pre")(331,"code",24),e.EFF(332,"\n@Injectable()\n@Dependencies(getModelToken(Cat.name, 'cats'))\nexport class CatsService {\n  constructor(catModel) {\n    this.catModel = catModel;\n  }\n}\n"),e.k0s()(),e.j41(333,"h4",37)(334,"span"),e.EFF(335,"Hooks (middleware)"),e.k0s()(),e.j41(336,"p"),e.EFF(337,"Middleware (also called pre and post hooks) are functions which are passed control during execution of asynchronous functions. Middleware is specified on the schema level and is useful for writing plugins ("),e.j41(338,"a",38),e.EFF(339,"source"),e.k0s(),e.EFF(340,"). Calling "),e.j41(341,"code"),e.EFF(342,"pre()"),e.k0s(),e.EFF(343," or "),e.j41(344,"code"),e.EFF(345,"post()"),e.k0s(),e.EFF(346," after compiling a model does not work in Mongoose. To register a hook "),e.j41(347,"strong"),e.EFF(348,"before"),e.k0s(),e.EFF(349," model registration, use the "),e.j41(350,"code"),e.EFF(351,"forFeatureAsync()"),e.k0s(),e.EFF(352," method of the "),e.j41(353,"code"),e.EFF(354,"MongooseModule"),e.k0s(),e.EFF(355," along with a factory provider (i.e., "),e.j41(356,"code"),e.EFF(357,"useFactory"),e.k0s(),e.EFF(358,"). With this technique, you can access a schema object, then use the "),e.j41(359,"code"),e.EFF(360,"pre()"),e.k0s(),e.EFF(361," or "),e.j41(362,"code"),e.EFF(363,"post()"),e.k0s(),e.EFF(364," method to register a hook on that schema. See example below:"),e.k0s(),e.j41(365,"pre")(366,"code",24),e.EFF(367,"\n@Module({\n  imports: [\n    MongooseModule.forFeatureAsync([\n      {\n        name: Cat.name,\n        useFactory: () => {\n          const schema = CatsSchema;\n          schema.pre('save', function () {\n            console.log('Hello from pre save');\n          });\n          return schema;\n        },\n      },\n    ]),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(368,"p"),e.EFF(369,"Like other "),e.j41(370,"a",39),e.EFF(371,"factory providers"),e.k0s(),e.EFF(372,", our factory function can be "),e.j41(373,"code"),e.EFF(374,"async"),e.k0s(),e.EFF(375," and can inject dependencies through "),e.j41(376,"code"),e.EFF(377,"inject"),e.k0s(),e.EFF(378,"."),e.k0s(),e.j41(379,"pre")(380,"code",24),e.EFF(381,"\n@Module({\n  imports: [\n    MongooseModule.forFeatureAsync([\n      {\n        name: Cat.name,\n        imports: [ConfigModule],\n        useFactory: (configService: ConfigService) => {\n          const schema = CatsSchema;\n          schema.pre('save', function() {\n            console.log(\n              `${configService.get('APP_NAME')}: Hello from pre save`,\n            ),\n          });\n          return schema;\n        },\n        inject: [ConfigService],\n      },\n    ]),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(382,"h4",40)(383,"span"),e.EFF(384,"Plugins"),e.k0s()(),e.j41(385,"p"),e.EFF(386,"To register a "),e.j41(387,"a",41),e.EFF(388,"plugin"),e.k0s(),e.EFF(389," for a given schema, use the "),e.j41(390,"code"),e.EFF(391,"forFeatureAsync()"),e.k0s(),e.EFF(392," method."),e.k0s(),e.j41(393,"pre")(394,"code",24),e.EFF(395,"\n@Module({\n  imports: [\n    MongooseModule.forFeatureAsync([\n      {\n        name: Cat.name,\n        useFactory: () => {\n          const schema = CatsSchema;\n          schema.plugin(require('mongoose-autopopulate'));\n          return schema;\n        },\n      },\n    ]),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(396,"p"),e.EFF(397,"To register a plugin for all schemas at once, call the "),e.j41(398,"code"),e.EFF(399,".plugin()"),e.k0s(),e.EFF(400," method of the "),e.j41(401,"code"),e.EFF(402,"Connection"),e.k0s(),e.EFF(403," object. You should access the connection before models are created; to do this, use the "),e.j41(404,"code"),e.EFF(405,"connectionFactory"),e.k0s(),e.EFF(406,":"),e.k0s(),e.j41(407,"span",23),e.EFF(408),e.nI1(409,"extension"),e.nrm(410,"app-tabs",null,7),e.k0s(),e.j41(412,"pre")(413,"code",24),e.EFF(414,"\nimport { Module } from '@nestjs/common';\nimport { MongooseModule } from '@nestjs/mongoose';\n\n@Module({\n  imports: [\n    MongooseModule.forRoot('mongodb://localhost/test', {\n      connectionFactory: (connection) => {\n        connection.plugin(require('mongoose-autopopulate'));\n        return connection;\n      }\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(415,"h4",42)(416,"span"),e.EFF(417,"Discriminators"),e.k0s()(),e.j41(418,"p")(419,"a",43),e.EFF(420,"Discriminators"),e.k0s(),e.EFF(421," are a schema inheritance mechanism. They enable you to have multiple models with overlapping schemas on top of the same underlying MongoDB collection."),e.k0s(),e.j41(422,"p"),e.EFF(423,"Suppose you wanted to track different types of events in a single collection. Every event will have a timestamp."),e.k0s(),e.j41(424,"span",23),e.EFF(425),e.nI1(426,"extension"),e.nrm(427,"app-tabs",null,8),e.k0s(),e.j41(429,"pre")(430,"code",24),e.EFF(431,"\n@Schema({ discriminatorKey: 'kind' })\nexport class Event {\n  @Prop({\n    type: String,\n    required: true,\n    enum: [ClickedLinkEvent.name, SignUpEvent.name],\n  })\n  kind: string;\n\n  @Prop({ type: Date, required: true })\n  time: Date;\n}\n\nexport const EventSchema = SchemaFactory.createForClass(Event);\n"),e.k0s()(),e.j41(432,"blockquote",29)(433,"strong"),e.EFF(434,"Hint"),e.k0s(),e.EFF(435,' The way mongoose tells the difference between the different discriminator models is by the "discriminator key", which is '),e.j41(436,"code"),e.EFF(437,"__t"),e.k0s(),e.EFF(438," by default. Mongoose adds a String path called "),e.j41(439,"code"),e.EFF(440,"__t"),e.k0s(),e.EFF(441," to your schemas that it uses to track which discriminator this document is an instance of.\nYou may also use the "),e.j41(442,"code"),e.EFF(443,"discriminatorKey"),e.k0s(),e.EFF(444," option to define the path for discrimination.\n"),e.k0s(),e.j41(445,"p")(446,"code"),e.EFF(447,"SignedUpEvent"),e.k0s(),e.EFF(448," and "),e.j41(449,"code"),e.EFF(450,"ClickedLinkEvent"),e.k0s(),e.EFF(451," instances will be stored in the same collection as generic events."),e.k0s(),e.j41(452,"p"),e.EFF(453,"Now, let's define the "),e.j41(454,"code"),e.EFF(455,"ClickedLinkEvent"),e.k0s(),e.EFF(456," class, as follows:"),e.k0s(),e.j41(457,"span",23),e.EFF(458),e.nI1(459,"extension"),e.nrm(460,"app-tabs",null,9),e.k0s(),e.j41(462,"pre")(463,"code",24),e.EFF(464,"\n@Schema()\nexport class ClickedLinkEvent {\n  kind: string;\n  time: Date;\n\n  @Prop({ type: String, required: true })\n  url: string;\n}\n\nexport const ClickedLinkEventSchema = SchemaFactory.createForClass(ClickedLinkEvent);\n"),e.k0s()(),e.j41(465,"p"),e.EFF(466,"And "),e.j41(467,"code"),e.EFF(468,"SignUpEvent"),e.k0s(),e.EFF(469," class:"),e.k0s(),e.j41(470,"span",23),e.EFF(471),e.nI1(472,"extension"),e.nrm(473,"app-tabs",null,10),e.k0s(),e.j41(475,"pre")(476,"code",24),e.EFF(477,"\n@Schema()\nexport class SignUpEvent {\n  kind: string;\n  time: Date;\n\n  @Prop({ type: String, required: true })\n  user: string;\n}\n\nexport const SignUpEventSchema = SchemaFactory.createForClass(SignUpEvent);\n"),e.k0s()(),e.j41(478,"p"),e.EFF(479,"With this in place, use the "),e.j41(480,"code"),e.EFF(481,"discriminators"),e.k0s(),e.EFF(482," option to register a discriminator for a given schema. It works on both "),e.j41(483,"code"),e.EFF(484,"MongooseModule.forFeature"),e.k0s(),e.EFF(485," and "),e.j41(486,"code"),e.EFF(487,"MongooseModule.forFeatureAsync"),e.k0s(),e.EFF(488,":"),e.k0s(),e.j41(489,"span",23),e.EFF(490),e.nI1(491,"extension"),e.nrm(492,"app-tabs",null,11),e.k0s(),e.j41(494,"pre")(495,"code",24),e.EFF(496,"\nimport { Module } from '@nestjs/common';\nimport { MongooseModule } from '@nestjs/mongoose';\n\n@Module({\n  imports: [\n    MongooseModule.forFeature([\n      {\n        name: Event.name,\n        schema: EventSchema,\n        discriminators: [\n          { name: ClickedLinkEvent.name, schema: ClickedLinkEventSchema },\n          { name: SignUpEvent.name, schema: SignUpEventSchema },\n        ],\n      },\n    ]),\n  ]\n})\nexport class EventsModule {}\n"),e.k0s()(),e.j41(497,"h4",44)(498,"span"),e.EFF(499,"Testing"),e.k0s()(),e.j41(500,"p"),e.EFF(501,"When unit testing an application, we usually want to avoid any database connection, making our test suites simpler to set up and faster to execute. But our classes might depend on models that are pulled from the connection instance. How do we resolve these classes? The solution is to create mock models."),e.k0s(),e.j41(502,"p"),e.EFF(503,"To make this easier, the "),e.j41(504,"code"),e.EFF(505,"@nestjs/mongoose"),e.k0s(),e.EFF(506," package exposes a "),e.j41(507,"code"),e.EFF(508,"getModelToken()"),e.k0s(),e.EFF(509," function that returns a prepared "),e.j41(510,"a",45),e.EFF(511,"injection token"),e.k0s(),e.EFF(512," based on a token name. Using this token, you can easily provide a mock implementation using any of the standard "),e.j41(513,"a",46),e.EFF(514,"custom provider"),e.k0s(),e.EFF(515," techniques, including "),e.j41(516,"code"),e.EFF(517,"useClass"),e.k0s(),e.EFF(518,", "),e.j41(519,"code"),e.EFF(520,"useValue"),e.k0s(),e.EFF(521,", and "),e.j41(522,"code"),e.EFF(523,"useFactory"),e.k0s(),e.EFF(524,". For example:"),e.k0s(),e.j41(525,"pre")(526,"code",24),e.EFF(527,"\n@Module({\n  providers: [\n    CatsService,\n    {\n      provide: getModelToken(Cat.name),\n      useValue: catModel,\n    },\n  ],\n})\nexport class CatsModule {}\n"),e.k0s()(),e.j41(528,"p"),e.EFF(529,"In this example, a hardcoded "),e.j41(530,"code"),e.EFF(531,"catModel"),e.k0s(),e.EFF(532," (object instance) will be provided whenever any consumer injects a "),e.j41(533,"code"),e.EFF(534,"Model<Cat>"),e.k0s(),e.EFF(535," using an "),e.j41(536,"code"),e.EFF(537,"@InjectModel()"),e.k0s(),e.EFF(538," decorator."),e.k0s(),e.j41(539,"p"),e.nrm(540,"app-banner-courses"),e.k0s(),e.j41(541,"h4",47)(542,"span"),e.EFF(543,"Async configuration"),e.k0s()(),e.j41(544,"p"),e.EFF(545,"When you need to pass module options asynchronously instead of statically, use the "),e.j41(546,"code"),e.EFF(547,"forRootAsync()"),e.k0s(),e.EFF(548," method. As with most dynamic modules, Nest provides several techniques to deal with async configuration."),e.k0s(),e.j41(549,"p"),e.EFF(550,"One technique is to use a factory function:"),e.k0s(),e.j41(551,"pre")(552,"code",24),e.EFF(553,"\nMongooseModule.forRootAsync({\n  useFactory: () => ({\n    uri: 'mongodb://localhost/nest',\n  }),\n});\n"),e.k0s()(),e.j41(554,"p"),e.EFF(555,"Like other "),e.j41(556,"a",39),e.EFF(557,"factory providers"),e.k0s(),e.EFF(558,", our factory function can be "),e.j41(559,"code"),e.EFF(560,"async"),e.k0s(),e.EFF(561," and can inject dependencies through "),e.j41(562,"code"),e.EFF(563,"inject"),e.k0s(),e.EFF(564,"."),e.k0s(),e.j41(565,"pre")(566,"code",24),e.EFF(567,"\nMongooseModule.forRootAsync({\n  imports: [ConfigModule],\n  useFactory: async (configService: ConfigService) => ({\n    uri: configService.get<string>('MONGODB_URI'),\n  }),\n  inject: [ConfigService],\n});\n"),e.k0s()(),e.j41(568,"p"),e.EFF(569,"Alternatively, you can configure the "),e.j41(570,"code"),e.EFF(571,"MongooseModule"),e.k0s(),e.EFF(572," using a class instead of a factory, as shown below:"),e.k0s(),e.j41(573,"pre")(574,"code",24),e.EFF(575,"\nMongooseModule.forRootAsync({\n  useClass: MongooseConfigService,\n});\n"),e.k0s()(),e.j41(576,"p"),e.EFF(577,"The construction above instantiates "),e.j41(578,"code"),e.EFF(579,"MongooseConfigService"),e.k0s(),e.EFF(580," inside "),e.j41(581,"code"),e.EFF(582,"MongooseModule"),e.k0s(),e.EFF(583,", using it to create the required options object. Note that in this example, the "),e.j41(584,"code"),e.EFF(585,"MongooseConfigService"),e.k0s(),e.EFF(586," has to implement the "),e.j41(587,"code"),e.EFF(588,"MongooseOptionsFactory"),e.k0s(),e.EFF(589," interface, as shown below. The "),e.j41(590,"code"),e.EFF(591,"MongooseModule"),e.k0s(),e.EFF(592," will call the "),e.j41(593,"code"),e.EFF(594,"createMongooseOptions()"),e.k0s(),e.EFF(595," method on the instantiated object of the supplied class."),e.k0s(),e.j41(596,"pre")(597,"code",24),e.EFF(598,"\n@Injectable()\nexport class MongooseConfigService implements MongooseOptionsFactory {\n  createMongooseOptions(): MongooseModuleOptions {\n    return {\n      uri: 'mongodb://localhost/nest',\n    };\n  }\n}\n"),e.k0s()(),e.j41(599,"p"),e.EFF(600,"If you want to reuse an existing options provider instead of creating a private copy inside the "),e.j41(601,"code"),e.EFF(602,"MongooseModule"),e.k0s(),e.EFF(603,", use the "),e.j41(604,"code"),e.EFF(605,"useExisting"),e.k0s(),e.EFF(606," syntax."),e.k0s(),e.j41(607,"pre")(608,"code",24),e.EFF(609,"\nMongooseModule.forRootAsync({\n  imports: [ConfigModule],\n  useExisting: ConfigService,\n});\n"),e.k0s()(),e.j41(610,"h4",48)(611,"span"),e.EFF(612,"Example"),e.k0s()(),e.j41(613,"p"),e.EFF(614,"A working example is available "),e.j41(615,"a",49),e.EFF(616,"here"),e.k0s(),e.EFF(617,"."),e.k0s()()),2&s){const a=e.sdS(44),r=e.sdS(81),l=e.sdS(213),c=e.sdS(249),u=e.sdS(282),h=e.sdS(326),k=e.sdS(411),j=e.sdS(428),g=e.sdS(461),f=e.sdS(474),b=e.sdS(493);e.R7$(41),e.SpI(" ",e.i5U(42,19,"app.module",a.isJsActive),"\n"),e.R7$(37),e.SpI(" ",e.i5U(79,22,"schemas/cat.schema",r.isJsActive),"\n"),e.R7$(132),e.SpI(" ",e.i5U(211,25,"cats.module",l.isJsActive),"\n"),e.R7$(36),e.SpI(" ",e.i5U(247,28,"cats.service",c.isJsActive),"\n"),e.R7$(4),e.AVh("hide",c.isJsActive),e.R7$(3),e.AVh("hide",!c.isJsActive),e.R7$(26),e.SpI(" ",e.i5U(280,31,"app.module",u.isJsActive),"\n"),e.R7$(44),e.SpI(" ",e.i5U(324,34,"cats.service",h.isJsActive),"\n"),e.R7$(4),e.AVh("hide",h.isJsActive),e.R7$(3),e.AVh("hide",!h.isJsActive),e.R7$(78),e.SpI(" ",e.i5U(409,37,"app.module",k.isJsActive),"\n"),e.R7$(17),e.SpI(" ",e.i5U(426,40,"event.schema",j.isJsActive),"\n"),e.R7$(33),e.SpI(" ",e.i5U(459,43,"click-link-event.schema",g.isJsActive),"\n"),e.R7$(13),e.SpI(" ",e.i5U(472,46,"sign-up-event.schema",f.isJsActive),"\n"),e.R7$(19),e.SpI(" ",e.i5U(491,49,"event.module",b.isJsActive),"\n")}},dependencies:[p.O,F.a,v.Q,E.Wk,m.M],encapsulation:2,changeDetection:0})}return t})(),L=(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-mvc"]],features:[e.Vt3],decls:215,vars:29,consts:[["contentReference",""],["app38cdfb4a34dcf7c112abcdd9daf73c655cdc5628",""],["app3a765ff10e7cae4156a675faa9d22d07d5d2a885",""],["appac63d731594e415482573cdfa39ef92fec55a53e",""],["app8f4cc97de2eb73e3707af97c08325803c29f75c3",""],["app882342af0d72d634b1618126b1326e84c758a31e",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/mvc.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","model-view-controller"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/express"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest-cli"],[1,"language-bash"],["rel","nofollow","target","_blank","href","https://expressjs.com/en/guide/using-template-engines.html"],["rel","nofollow","target","_blank","href","https://github.com/pillarjs/hbs#readme"],[1,"filename"],[1,"language-typescript"],["appAnchor","","id","template-rendering"],[1,"language-html"],["appAnchor","","id","dynamic-template-rendering"],[1,"info"],["rel","nofollow","target","_blank","href","https://expressjs.com/en/api.html"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/15-mvc"],["appAnchor","","id","fastify"],["routerLink","/techniques/performance"],["rel","nofollow","target","_blank","href","https://github.com/fastify/fastify"],["appAnchor","","id","example-1"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/17-mvc-fastify"]],template:function(s,n){if(1&s&&(e.j41(0,"div",6,0)(2,"div",7)(3,"a",8),e.nrm(4,"i",9),e.k0s()(),e.j41(5,"h3",10),e.EFF(6,"Model-View-Controller"),e.k0s(),e.j41(7,"p"),e.EFF(8,"Nest, by default, makes use of the "),e.j41(9,"a",11),e.EFF(10,"Express"),e.k0s(),e.EFF(11," library under the hood. Hence, every technique for using the MVC (Model-View-Controller) pattern in Express applies to Nest as well."),e.k0s(),e.j41(12,"p"),e.EFF(13,"First, let's scaffold a simple Nest application using the "),e.j41(14,"a",12),e.EFF(15,"CLI"),e.k0s(),e.EFF(16," tool:"),e.k0s(),e.j41(17,"pre")(18,"code",13),e.EFF(19,"\n$ npm i -g @nestjs/cli\n$ nest new project\n"),e.k0s()(),e.j41(20,"p"),e.EFF(21,"In order to create an MVC app, we also need a "),e.j41(22,"a",14),e.EFF(23,"template engine"),e.k0s(),e.EFF(24," to render our HTML views:"),e.k0s(),e.j41(25,"pre")(26,"code",13),e.EFF(27,"\n$ npm install --save hbs\n"),e.k0s()(),e.j41(28,"p"),e.EFF(29,"We've used the "),e.j41(30,"code"),e.EFF(31,"hbs"),e.k0s(),e.EFF(32," ("),e.j41(33,"a",15),e.EFF(34,"Handlebars"),e.k0s(),e.EFF(35,") engine, though you can use whatever fits your requirements. Once the installation process is complete, we need to configure the express instance using the following code:"),e.k0s(),e.j41(36,"span",16),e.EFF(37),e.nI1(38,"extension"),e.nrm(39,"app-tabs",null,1),e.k0s(),e.j41(41,"pre")(42,"code",17),e.EFF(43,"\nimport { NestFactory } from '@nestjs/core';\nimport { NestExpressApplication } from '@nestjs/platform-express';\nimport { join } from 'path';\nimport { AppModule } from './app.module';\n\nasync function bootstrap() {\n  const app = await NestFactory.create<NestExpressApplication>(\n    AppModule,\n  );\n\n  app.useStaticAssets(join(__dirname, '..', 'public'));\n  app.setBaseViewsDir(join(__dirname, '..', 'views'));\n  app.setViewEngine('hbs');\n\n  await app.listen(process.env.PORT ?? 3000);\n}\nbootstrap();\n"),e.k0s()(),e.j41(44,"pre")(45,"code",17),e.EFF(46,"\nimport { NestFactory } from '@nestjs/core';\nimport { join } from 'path';\nimport { AppModule } from './app.module';\n\nasync function bootstrap() {\n  const app = await NestFactory.create(\n    AppModule,\n  );\n\n  app.useStaticAssets(join(__dirname, '..', 'public'));\n  app.setBaseViewsDir(join(__dirname, '..', 'views'));\n  app.setViewEngine('hbs');\n\n  await app.listen(process.env.PORT ?? 3000);\n}\nbootstrap();\n"),e.k0s()(),e.j41(47,"p"),e.EFF(48,"We told "),e.j41(49,"a",11),e.EFF(50,"Express"),e.k0s(),e.EFF(51," that the "),e.j41(52,"code"),e.EFF(53,"public"),e.k0s(),e.EFF(54," directory will be used for storing static assets, "),e.j41(55,"code"),e.EFF(56,"views"),e.k0s(),e.EFF(57," will contain templates, and the "),e.j41(58,"code"),e.EFF(59,"hbs"),e.k0s(),e.EFF(60," template engine should be used to render HTML output."),e.k0s(),e.j41(61,"h4",18)(62,"span"),e.EFF(63,"Template rendering"),e.k0s()(),e.j41(64,"p"),e.EFF(65,"Now, let's create a "),e.j41(66,"code"),e.EFF(67,"views"),e.k0s(),e.EFF(68," directory and "),e.j41(69,"code"),e.EFF(70,"index.hbs"),e.k0s(),e.EFF(71," template inside it. In the template, we'll print a "),e.j41(72,"code"),e.EFF(73,"message"),e.k0s(),e.EFF(74," passed from the controller:"),e.k0s(),e.j41(75,"pre")(76,"code",19),e.EFF(77),e.k0s()(),e.j41(78,"p"),e.EFF(79,"Next, open the "),e.j41(80,"code"),e.EFF(81,"app.controller"),e.k0s(),e.EFF(82," file and replace the "),e.j41(83,"code"),e.EFF(84,"root()"),e.k0s(),e.EFF(85," method with the following code:"),e.k0s(),e.j41(86,"span",16),e.EFF(87),e.nI1(88,"extension"),e.nrm(89,"app-tabs",null,2),e.k0s(),e.j41(91,"pre")(92,"code",17),e.EFF(93,"\nimport { Get, Controller, Render } from '@nestjs/common';\n\n@Controller()\nexport class AppController {\n  @Get()\n  @Render('index')\n  root() {\n    return { message: 'Hello world!' };\n  }\n}\n"),e.k0s()(),e.j41(94,"p"),e.EFF(95,"In this code, we are specifying the template to use in the "),e.j41(96,"code"),e.EFF(97,"@Render()"),e.k0s(),e.EFF(98," decorator, and the return value of the route handler method is passed to the template for rendering. Notice that the return value is an object with a property "),e.j41(99,"code"),e.EFF(100,"message"),e.k0s(),e.EFF(101,", matching the "),e.j41(102,"code"),e.EFF(103,"message"),e.k0s(),e.EFF(104," placeholder we created in the template."),e.k0s(),e.j41(105,"p"),e.EFF(106,"While the application is running, open your browser and navigate to "),e.j41(107,"code"),e.EFF(108,"http://localhost:3000"),e.k0s(),e.EFF(109,". You should see the "),e.j41(110,"code"),e.EFF(111,"Hello world!"),e.k0s(),e.EFF(112," message."),e.k0s(),e.j41(113,"h4",20)(114,"span"),e.EFF(115,"Dynamic template rendering"),e.k0s()(),e.j41(116,"p"),e.EFF(117,"If the application logic must dynamically decide which template to render, then we should use the "),e.j41(118,"code"),e.EFF(119,"@Res()"),e.k0s(),e.EFF(120," decorator, and supply the view name in our route handler, rather than in the "),e.j41(121,"code"),e.EFF(122,"@Render()"),e.k0s(),e.EFF(123," decorator:"),e.k0s(),e.j41(124,"blockquote",21)(125,"strong"),e.EFF(126,"Hint"),e.k0s(),e.EFF(127," When Nest detects the "),e.j41(128,"code"),e.EFF(129,"@Res()"),e.k0s(),e.EFF(130," decorator, it injects the library-specific "),e.j41(131,"code"),e.EFF(132,"response"),e.k0s(),e.EFF(133," object. We can use this object to dynamically render the template. Learn more about the "),e.j41(134,"code"),e.EFF(135,"response"),e.k0s(),e.EFF(136," object API "),e.j41(137,"a",22),e.EFF(138,"here"),e.k0s(),e.EFF(139,".\n"),e.k0s(),e.j41(140,"span",16),e.EFF(141),e.nI1(142,"extension"),e.nrm(143,"app-tabs",null,3),e.k0s(),e.j41(145,"pre")(146,"code",17),e.EFF(147,"\nimport { Get, Controller, Res, Render } from '@nestjs/common';\nimport { Response } from 'express';\nimport { AppService } from './app.service';\n\n@Controller()\nexport class AppController {\n  constructor(private appService: AppService) {}\n\n  @Get()\n  root(@Res() res: Response) {\n    return res.render(\n      this.appService.getViewName(),\n      { message: 'Hello world!' },\n    );\n  }\n}\n"),e.k0s()(),e.j41(148,"h4",23)(149,"span"),e.EFF(150,"Example"),e.k0s()(),e.j41(151,"p"),e.EFF(152,"A working example is available "),e.j41(153,"a",24),e.EFF(154,"here"),e.k0s(),e.EFF(155,"."),e.k0s(),e.j41(156,"h4",25)(157,"span"),e.EFF(158,"Fastify"),e.k0s()(),e.j41(159,"p"),e.EFF(160,"As mentioned in this "),e.j41(161,"a",26),e.EFF(162,"chapter"),e.k0s(),e.EFF(163,", we are able to use any compatible HTTP provider together with Nest. One such library is "),e.j41(164,"a",27),e.EFF(165,"Fastify"),e.k0s(),e.EFF(166,". In order to create an MVC application with Fastify, we have to install the following packages:"),e.k0s(),e.j41(167,"pre")(168,"code",13),e.EFF(169,"\n$ npm i --save @fastify/static @fastify/view handlebars\n"),e.k0s()(),e.j41(170,"p"),e.EFF(171,"The next steps cover almost the same process used with Express, with minor differences specific to the platform. Once the installation process is complete, open the "),e.j41(172,"code"),e.EFF(173,"main.ts"),e.k0s(),e.EFF(174," file and update its contents:"),e.k0s(),e.j41(175,"span",16),e.EFF(176),e.nI1(177,"extension"),e.nrm(178,"app-tabs",null,4),e.k0s(),e.j41(180,"pre")(181,"code",17),e.EFF(182,"\nimport { NestFactory } from '@nestjs/core';\nimport { NestFastifyApplication, FastifyAdapter } from '@nestjs/platform-fastify';\nimport { AppModule } from './app.module';\nimport { join } from 'path';\n\nasync function bootstrap() {\n  const app = await NestFactory.create<NestFastifyApplication>(\n    AppModule,\n    new FastifyAdapter(),\n  );\n  app.useStaticAssets({\n    root: join(__dirname, '..', 'public'),\n    prefix: '/public/',\n  });\n  app.setViewEngine({\n    engine: {\n      handlebars: require('handlebars'),\n    },\n    templates: join(__dirname, '..', 'views'),\n  });\n  await app.listen(process.env.PORT ?? 3000);\n}\nbootstrap();\n"),e.k0s()(),e.j41(183,"pre")(184,"code",17),e.EFF(185,"\nimport { NestFactory } from '@nestjs/core';\nimport { FastifyAdapter } from '@nestjs/platform-fastify';\nimport { AppModule } from './app.module';\nimport { join } from 'path';\n\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule, new FastifyAdapter());\n  app.useStaticAssets({\n    root: join(__dirname, '..', 'public'),\n    prefix: '/public/',\n  });\n  app.setViewEngine({\n    engine: {\n      handlebars: require('handlebars'),\n    },\n    templates: join(__dirname, '..', 'views'),\n  });\n  await app.listen(process.env.PORT ?? 3000);\n}\nbootstrap();\n"),e.k0s()(),e.j41(186,"p"),e.EFF(187,"The Fastify API is slightly different but the end result of those methods calls remains the same. One difference to notice with Fastify is that the template name passed into the "),e.j41(188,"code"),e.EFF(189,"@Render()"),e.k0s(),e.EFF(190," decorator must include a file extension."),e.k0s(),e.j41(191,"span",16),e.EFF(192),e.nI1(193,"extension"),e.nrm(194,"app-tabs",null,5),e.k0s(),e.j41(196,"pre")(197,"code",17),e.EFF(198,"\nimport { Get, Controller, Render } from '@nestjs/common';\n\n@Controller()\nexport class AppController {\n  @Get()\n  @Render('index.hbs')\n  root() {\n    return { message: 'Hello world!' };\n  }\n}\n"),e.k0s()(),e.j41(199,"p"),e.EFF(200,"While the application is running, open your browser and navigate to "),e.j41(201,"code"),e.EFF(202,"http://localhost:3000"),e.k0s(),e.EFF(203,". You should see the "),e.j41(204,"code"),e.EFF(205,"Hello world!"),e.k0s(),e.EFF(206," message."),e.k0s(),e.j41(207,"h4",28)(208,"span"),e.EFF(209,"Example"),e.k0s()(),e.j41(210,"p"),e.EFF(211,"A working example is available "),e.j41(212,"a",29),e.EFF(213,"here"),e.k0s(),e.EFF(214,"."),e.k0s()()),2&s){const a=e.sdS(40),r=e.sdS(90),l=e.sdS(144),c=e.sdS(179),u=e.sdS(195);e.R7$(37),e.SpI(" ",e.i5U(38,14,"main",a.isJsActive),"\n"),e.R7$(4),e.AVh("hide",a.isJsActive),e.R7$(3),e.AVh("hide",!a.isJsActive),e.R7$(33),e.SpI('\n<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset="utf-8" />\n    <title>App</title>\n  </head>\n  <body>\n    ',"{{ message }}","\n  </body>\n</html>\n"),e.R7$(10),e.SpI(" ",e.i5U(88,17,"app.controller",r.isJsActive),"\n"),e.R7$(54),e.SpI(" ",e.i5U(142,20,"app.controller",l.isJsActive),"\n"),e.R7$(35),e.SpI(" ",e.i5U(177,23,"main",c.isJsActive),"\n"),e.R7$(4),e.AVh("hide",c.isJsActive),e.R7$(3),e.AVh("hide",!c.isJsActive),e.R7$(9),e.SpI(" ",e.i5U(193,26,"app.controller",u.isJsActive),"\n")}},dependencies:[p.O,F.a,E.Wk,m.M],encapsulation:2,changeDetection:0})}return t})(),D=(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-performance"]],features:[e.Vt3],decls:184,vars:12,consts:[["contentReference",""],["appc7e88ce18b4534840423c8af360094adc5d28104",""],["appccde0f8147b282410109d8ee6518f304f057d38c",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/performance.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","performance-fastify"],["rel","nofollow","target","_blank","href","https://expressjs.com/"],["rel","nofollow","target","_blank","href","https://github.com/fastify/fastify"],[1,"info"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","adapter"],[1,"filename"],[1,"language-typescript"],["rel","nofollow","target","_blank","href","https://www.fastify.io/docs/latest/Guides/Getting-Started/#your-first-server"],["appAnchor","","id","platform-specific-packages"],["appAnchor","","id","redirect-response"],["appAnchor","","id","fastify-options"],["appAnchor","","id","middleware"],["rel","nofollow","target","_blank","href","https://www.fastify.io/docs/latest/Reference/Middleware/"],["appAnchor","","id","route-config"],["rel","nofollow","target","_blank","href","https://fastify.dev/docs/latest/Reference/Routes/#config"],["appAnchor","","id","route-constraints"],["rel","nofollow","target","_blank","href","https://fastify.dev/docs/latest/Reference/Routes/#constraints"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/10-fastify"]],template:function(s,n){if(1&s&&(e.j41(0,"div",3,0)(2,"div",4)(3,"a",5),e.nrm(4,"i",6),e.k0s()(),e.j41(5,"h3",7),e.EFF(6,"Performance (Fastify)"),e.k0s(),e.j41(7,"p"),e.EFF(8,"By default, Nest makes use of the "),e.j41(9,"a",8),e.EFF(10,"Express"),e.k0s(),e.EFF(11," framework. As mentioned earlier, Nest also provides compatibility with other libraries such as, for example, "),e.j41(12,"a",9),e.EFF(13,"Fastify"),e.k0s(),e.EFF(14,". Nest achieves this framework independence by implementing a framework adapter whose primary function is to proxy middleware and handlers to appropriate library-specific implementations."),e.k0s(),e.j41(15,"blockquote",10)(16,"strong"),e.EFF(17,"Hint"),e.k0s(),e.EFF(18," Note that in order for a framework adapter to be implemented, the target library has to provide similar request/response pipeline processing as found in Express.\n"),e.k0s(),e.j41(19,"p")(20,"a",9),e.EFF(21,"Fastify"),e.k0s(),e.EFF(22," provides a good alternative framework for Nest because it solves design issues in a similar manner to Express. However, fastify is much "),e.j41(23,"strong"),e.EFF(24,"faster"),e.k0s(),e.EFF(25," than Express, achieving almost two times better benchmarks results. A fair question is why does Nest use Express as the default HTTP provider? The reason is that Express is widely-used, well-known, and has an enormous set of compatible middleware, which is available to Nest users out-of-the-box."),e.k0s(),e.j41(26,"p"),e.EFF(27,"But since Nest provides framework-independence, you can easily migrate between them. Fastify can be a better choice when you place high value on very fast performance. To utilize Fastify, simply choose the built-in "),e.j41(28,"code"),e.EFF(29,"FastifyAdapter"),e.k0s(),e.EFF(30," as shown in this chapter."),e.k0s(),e.j41(31,"h4",11)(32,"span"),e.EFF(33,"Installation"),e.k0s()(),e.j41(34,"p"),e.EFF(35,"First, we need to install the required package:"),e.k0s(),e.j41(36,"pre")(37,"code",12),e.EFF(38,"\n$ npm i --save @nestjs/platform-fastify\n"),e.k0s()(),e.j41(39,"h4",13)(40,"span"),e.EFF(41,"Adapter"),e.k0s()(),e.j41(42,"p"),e.EFF(43,"Once the Fastify platform is installed, we can use the "),e.j41(44,"code"),e.EFF(45,"FastifyAdapter"),e.k0s(),e.EFF(46,"."),e.k0s(),e.j41(47,"span",14),e.EFF(48),e.nI1(49,"extension"),e.nrm(50,"app-tabs",null,1),e.k0s(),e.j41(52,"pre")(53,"code",15),e.EFF(54,"\nimport { NestFactory } from '@nestjs/core';\nimport {\n  FastifyAdapter,\n  NestFastifyApplication,\n} from '@nestjs/platform-fastify';\nimport { AppModule } from './app.module';\n\nasync function bootstrap() {\n  const app = await NestFactory.create<NestFastifyApplication>(\n    AppModule,\n    new FastifyAdapter()\n  );\n  await app.listen(process.env.PORT ?? 3000);\n}\nbootstrap();\n"),e.k0s()(),e.j41(55,"p"),e.EFF(56,"By default, Fastify listens only on the "),e.j41(57,"code"),e.EFF(58,"localhost 127.0.0.1"),e.k0s(),e.EFF(59," interface ("),e.j41(60,"a",16),e.EFF(61,"read more"),e.k0s(),e.EFF(62,"). If you want to accept connections on other hosts, you should specify "),e.j41(63,"code"),e.EFF(64,"'0.0.0.0'"),e.k0s(),e.EFF(65," in the "),e.j41(66,"code"),e.EFF(67,"listen()"),e.k0s(),e.EFF(68," call:"),e.k0s(),e.j41(69,"pre")(70,"code",15),e.EFF(71,"\nasync function bootstrap() {\n  const app = await NestFactory.create<NestFastifyApplication>(\n    AppModule,\n    new FastifyAdapter(),\n  );\n  await app.listen(3000, '0.0.0.0');\n}\n"),e.k0s()(),e.j41(72,"h4",17)(73,"span"),e.EFF(74,"Platform specific packages"),e.k0s()(),e.j41(75,"p"),e.EFF(76,"Keep in mind that when you use the "),e.j41(77,"code"),e.EFF(78,"FastifyAdapter"),e.k0s(),e.EFF(79,", Nest uses Fastify as the "),e.j41(80,"strong"),e.EFF(81,"HTTP provider"),e.k0s(),e.EFF(82,". This means that each recipe that relies on Express may no longer work. You should, instead, use Fastify equivalent packages."),e.k0s(),e.j41(83,"h4",18)(84,"span"),e.EFF(85,"Redirect response"),e.k0s()(),e.j41(86,"p"),e.EFF(87,"Fastify handles redirect responses slightly differently than Express. To do a proper redirect with Fastify, return both the status code and the URL, as follows:"),e.k0s(),e.j41(88,"pre")(89,"code",15),e.EFF(90,"\n@Get()\nindex(@Res() res) {\n  res.status(302).redirect('/login');\n}\n"),e.k0s()(),e.j41(91,"h4",19)(92,"span"),e.EFF(93,"Fastify options"),e.k0s()(),e.j41(94,"p"),e.EFF(95,"You can pass options into the Fastify constructor through the "),e.j41(96,"code"),e.EFF(97,"FastifyAdapter"),e.k0s(),e.EFF(98," constructor. For example:"),e.k0s(),e.j41(99,"pre")(100,"code",15),e.EFF(101,"\nnew FastifyAdapter({ logger: true });\n"),e.k0s()(),e.j41(102,"h4",20)(103,"span"),e.EFF(104,"Middleware"),e.k0s()(),e.j41(105,"p"),e.EFF(106,"Middleware functions retrieve the raw "),e.j41(107,"code"),e.EFF(108,"req"),e.k0s(),e.EFF(109," and "),e.j41(110,"code"),e.EFF(111,"res"),e.k0s(),e.EFF(112," objects instead of Fastify's wrappers. This is how the "),e.j41(113,"code"),e.EFF(114,"middie"),e.k0s(),e.EFF(115," package works (that's used under the hood) and "),e.j41(116,"code"),e.EFF(117,"fastify"),e.k0s(),e.EFF(118," - check out this "),e.j41(119,"a",21),e.EFF(120,"page"),e.k0s(),e.EFF(121," for more information,"),e.k0s(),e.j41(122,"span",14),e.EFF(123),e.nI1(124,"extension"),e.nrm(125,"app-tabs",null,2),e.k0s(),e.j41(127,"pre")(128,"code",15),e.EFF(129,"\nimport { Injectable, NestMiddleware } from '@nestjs/common';\nimport { FastifyRequest, FastifyReply } from 'fastify';\n\n@Injectable()\nexport class LoggerMiddleware implements NestMiddleware {\n  use(req: FastifyRequest['raw'], res: FastifyReply['raw'], next: () => void) {\n    console.log('Request...');\n    next();\n  }\n}\n"),e.k0s()(),e.j41(130,"pre")(131,"code",15),e.EFF(132,"\nimport { Injectable } from '@nestjs/common';\n\n@Injectable()\nexport class LoggerMiddleware {\n  use(req, res, next) {\n    console.log('Request...');\n    next();\n  }\n}\n"),e.k0s()(),e.j41(133,"h4",22)(134,"span"),e.EFF(135,"Route Config"),e.k0s()(),e.j41(136,"p"),e.EFF(137,"You can use the "),e.j41(138,"a",23),e.EFF(139,"route config"),e.k0s(),e.EFF(140," feature of Fastify with the "),e.j41(141,"code"),e.EFF(142,"@RouteConfig()"),e.k0s(),e.EFF(143," decorator."),e.k0s(),e.j41(144,"pre")(145,"code",15),e.EFF(146,"\n@RouteConfig({ output: 'hello world' })\n@Get()\nindex(@Req() req) {\n  return req.routeConfig.output;\n}\n"),e.k0s()(),e.j41(147,"h4",24)(148,"span"),e.EFF(149,"Route Constraints"),e.k0s()(),e.j41(150,"p"),e.EFF(151,"As of v10.3.0, "),e.j41(152,"code"),e.EFF(153,"@nestjs/platform-fastify"),e.k0s(),e.EFF(154," supports "),e.j41(155,"a",25),e.EFF(156,"route constraints"),e.k0s(),e.EFF(157," feature of Fastify with "),e.j41(158,"code"),e.EFF(159,"@RouteConstraints"),e.k0s(),e.EFF(160," decorator."),e.k0s(),e.j41(161,"pre")(162,"code",15),e.EFF(163,"\n@RouteConstraints({ version: '1.2.x' })\nnewFeature() {\n  return 'This works only for version >= 1.2.x';\n}\n"),e.k0s()(),e.j41(164,"blockquote",10)(165,"strong"),e.EFF(166,"Hint"),e.k0s(),e.j41(167,"code"),e.EFF(168,"@RouteConfig()"),e.k0s(),e.EFF(169," and "),e.j41(170,"code"),e.EFF(171,"@RouteConstraints"),e.k0s(),e.EFF(172," are imported from "),e.j41(173,"code"),e.EFF(174,"@nestjs/platform-fastify"),e.k0s(),e.EFF(175,".\n"),e.k0s(),e.j41(176,"h4",26)(177,"span"),e.EFF(178,"Example"),e.k0s()(),e.j41(179,"p"),e.EFF(180,"A working example is available "),e.j41(181,"a",27),e.EFF(182,"here"),e.k0s(),e.EFF(183,"."),e.k0s()()),2&s){const a=e.sdS(51),r=e.sdS(126);e.R7$(48),e.SpI(" ",e.i5U(49,6,"main",a.isJsActive),"\n"),e.R7$(75),e.SpI(" ",e.i5U(124,9,"logger.middleware",r.isJsActive),"\n"),e.R7$(4),e.AVh("hide",r.isJsActive),e.R7$(3),e.AVh("hide",!r.isJsActive)}},dependencies:[p.O,F.a,m.M],encapsulation:2,changeDetection:0})}return t})();var w=d(8149);const V=[{path:"authentication",redirectTo:"/security/authentication"},{path:"mvc",component:L,data:{title:"MVC"}},{path:"serialization",component:(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-serialization"]],features:[e.Vt3],decls:178,vars:2,consts:[["contentReference",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/serialization.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","serialization"],["appAnchor","","id","overview"],["rel","nofollow","target","_blank","href","https://github.com/typestack/class-transformer"],[1,"info"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/techniques/streaming-files#streamable-file-class"],["appAnchor","","id","exclude-properties"],[1,"language-typescript"],[1,""],[1,"language-json"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/interceptors#binding-interceptors"],["appAnchor","","id","expose-properties"],["appAnchor","","id","transform"],["appAnchor","","id","pass-options"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/21-serializer"],["appAnchor","","id","websockets-and-microservices"],["appAnchor","","id","learn-more"]],template:function(s,n){1&s&&(e.j41(0,"div",1,0)(2,"div",2)(3,"a",3),e.nrm(4,"i",4),e.k0s()(),e.j41(5,"h3",5),e.EFF(6,"Serialization"),e.k0s(),e.j41(7,"p"),e.EFF(8,"Serialization is a process that happens before objects are returned in a network response. This is an appropriate place to provide rules for transforming and sanitizing the data to be returned to the client. For example, sensitive data like passwords should always be excluded from the response. Or, certain properties might require additional transformation, such as sending only a subset of properties of an entity. Performing these transformations manually can be tedious and error prone, and can leave you uncertain that all cases have been covered."),e.k0s(),e.j41(9,"h4",6)(10,"span"),e.EFF(11,"Overview"),e.k0s()(),e.j41(12,"p"),e.EFF(13,"Nest provides a built-in capability to help ensure that these operations can be performed in a straightforward way. The "),e.j41(14,"code"),e.EFF(15,"ClassSerializerInterceptor"),e.k0s(),e.EFF(16," interceptor uses the powerful "),e.j41(17,"a",7),e.EFF(18,"class-transformer"),e.k0s(),e.EFF(19," package to provide a declarative and extensible way of transforming objects. The basic operation it performs is to take the value returned by a method handler and apply the "),e.j41(20,"code"),e.EFF(21,"instanceToPlain()"),e.k0s(),e.EFF(22," function from "),e.j41(23,"a",7),e.EFF(24,"class-transformer"),e.k0s(),e.EFF(25,". In doing so, it can apply rules expressed by "),e.j41(26,"code"),e.EFF(27,"class-transformer"),e.k0s(),e.EFF(28," decorators on an entity/DTO class, as described below."),e.k0s(),e.j41(29,"blockquote",8)(30,"strong"),e.EFF(31,"Hint"),e.k0s(),e.EFF(32," The serialization does not apply to "),e.j41(33,"a",9),e.EFF(34,"StreamableFile"),e.k0s(),e.EFF(35," responses.\n"),e.k0s(),e.j41(36,"h4",10)(37,"span"),e.EFF(38,"Exclude properties"),e.k0s()(),e.j41(39,"p"),e.EFF(40,"Let's assume that we want to automatically exclude a "),e.j41(41,"code"),e.EFF(42,"password"),e.k0s(),e.EFF(43," property from a user entity. We annotate the entity as follows:"),e.k0s(),e.j41(44,"pre")(45,"code",11),e.EFF(46,"\nimport { Exclude } from 'class-transformer';\n\nexport class UserEntity {\n  id: number;\n  firstName: string;\n  lastName: string;\n\n  @Exclude()\n  password: string;\n\n  constructor(partial: Partial<UserEntity>) {\n    Object.assign(this, partial);\n  }\n}\n"),e.k0s()(),e.j41(47,"p"),e.EFF(48,"Now consider a controller with a method handler that returns an instance of this class."),e.k0s(),e.j41(49,"pre")(50,"code",11),e.EFF(51,"\n@UseInterceptors(ClassSerializerInterceptor)\n@Get()\nfindOne(): UserEntity {\n  return new UserEntity({\n    id: 1,\n    firstName: 'Kamil',\n    lastName: 'Mysliwiec',\n    password: 'password',\n  });\n}\n"),e.k0s()(),e.j41(52,"blockquote",12)(53,"strong"),e.EFF(54,"Warning"),e.k0s(),e.EFF(55," Note that we must return an instance of the class. If you return a plain JavaScript object, for example, "),e.j41(56,"code"),e.EFF(57),e.k0s(),e.EFF(58,", the object won't be properly serialized.\n"),e.k0s(),e.j41(59,"blockquote",8)(60,"strong"),e.EFF(61,"Hint"),e.k0s(),e.EFF(62," The "),e.j41(63,"code"),e.EFF(64,"ClassSerializerInterceptor"),e.k0s(),e.EFF(65," is imported from "),e.j41(66,"code"),e.EFF(67,"@nestjs/common"),e.k0s(),e.EFF(68,".\n"),e.k0s(),e.j41(69,"p"),e.EFF(70,"When this endpoint is requested, the client receives the following response:"),e.k0s(),e.j41(71,"pre")(72,"code",13),e.EFF(73,'\n{\n  "id": 1,\n  "firstName": "Kamil",\n  "lastName": "Mysliwiec"\n}\n'),e.k0s()(),e.j41(74,"p"),e.EFF(75,"Note that the interceptor can be applied application-wide (as covered "),e.j41(76,"a",14),e.EFF(77,"here"),e.k0s(),e.EFF(78,"). The combination of the interceptor and the entity class declaration ensures that "),e.j41(79,"strong"),e.EFF(80,"any"),e.k0s(),e.EFF(81," method that returns a "),e.j41(82,"code"),e.EFF(83,"UserEntity"),e.k0s(),e.EFF(84," will be sure to remove the "),e.j41(85,"code"),e.EFF(86,"password"),e.k0s(),e.EFF(87," property. This gives you a measure of centralized enforcement of this business rule."),e.k0s(),e.j41(88,"h4",15)(89,"span"),e.EFF(90,"Expose properties"),e.k0s()(),e.j41(91,"p"),e.EFF(92,"You can use the "),e.j41(93,"code"),e.EFF(94,"@Expose()"),e.k0s(),e.EFF(95," decorator to provide alias names for properties, or to execute a function to calculate a property value (analogous to "),e.j41(96,"strong"),e.EFF(97,"getter"),e.k0s(),e.EFF(98," functions), as shown below."),e.k0s(),e.j41(99,"pre")(100,"code",11),e.EFF(101,"\n@Expose()\nget fullName(): string {\n  return `${this.firstName} ${this.lastName}`;\n}\n"),e.k0s()(),e.j41(102,"h4",16)(103,"span"),e.EFF(104,"Transform"),e.k0s()(),e.j41(105,"p"),e.EFF(106,"You can perform additional data transformation using the "),e.j41(107,"code"),e.EFF(108,"@Transform()"),e.k0s(),e.EFF(109," decorator. For example, the following construct returns the name property of the "),e.j41(110,"code"),e.EFF(111,"RoleEntity"),e.k0s(),e.EFF(112," instead of returning the whole object."),e.k0s(),e.j41(113,"pre")(114,"code",11),e.EFF(115,"\n@Transform(({ value }) => value.name)\nrole: RoleEntity;\n"),e.k0s()(),e.j41(116,"h4",17)(117,"span"),e.EFF(118,"Pass options"),e.k0s()(),e.j41(119,"p"),e.EFF(120,"You may want to modify the default behavior of the transformation functions. To override default settings, pass them in an "),e.j41(121,"code"),e.EFF(122,"options"),e.k0s(),e.EFF(123," object with the "),e.j41(124,"code"),e.EFF(125,"@SerializeOptions()"),e.k0s(),e.EFF(126," decorator."),e.k0s(),e.j41(127,"pre")(128,"code",11),e.EFF(129,"\n@SerializeOptions({\n  excludePrefixes: ['_'],\n})\n@Get()\nfindOne(): UserEntity {\n  return new UserEntity();\n}\n"),e.k0s()(),e.j41(130,"blockquote",8)(131,"strong"),e.EFF(132,"Hint"),e.k0s(),e.EFF(133," The "),e.j41(134,"code"),e.EFF(135,"@SerializeOptions()"),e.k0s(),e.EFF(136," decorator is imported from "),e.j41(137,"code"),e.EFF(138,"@nestjs/common"),e.k0s(),e.EFF(139,".\n"),e.k0s(),e.j41(140,"p"),e.EFF(141,"Options passed via "),e.j41(142,"code"),e.EFF(143,"@SerializeOptions()"),e.k0s(),e.EFF(144," are passed as the second argument of the underlying "),e.j41(145,"code"),e.EFF(146,"instanceToPlain()"),e.k0s(),e.EFF(147," function. In this example, we are automatically excluding all properties that begin with the "),e.j41(148,"code"),e.EFF(149,"_"),e.k0s(),e.EFF(150," prefix."),e.k0s(),e.j41(151,"h4",18)(152,"span"),e.EFF(153,"Example"),e.k0s()(),e.j41(154,"p"),e.EFF(155,"A working example is available "),e.j41(156,"a",19),e.EFF(157,"here"),e.k0s(),e.EFF(158,"."),e.k0s(),e.j41(159,"h4",20)(160,"span"),e.EFF(161,"WebSockets and Microservices"),e.k0s()(),e.j41(162,"p"),e.EFF(163,"While this chapter shows examples using HTTP style applications (e.g., Express or Fastify), the "),e.j41(164,"code"),e.EFF(165,"ClassSerializerInterceptor"),e.k0s(),e.EFF(166," works the same for WebSockets and Microservices, regardless of the transport method that is used."),e.k0s(),e.j41(167,"h4",21)(168,"span"),e.EFF(169,"Learn more"),e.k0s()(),e.j41(170,"p"),e.EFF(171,"Read more about available decorators and options as provided by the "),e.j41(172,"code"),e.EFF(173,"class-transformer"),e.k0s(),e.EFF(174," package "),e.j41(175,"a",7),e.EFF(176,"here"),e.k0s(),e.EFF(177,"."),e.k0s()()),2&s&&(e.R7$(57),e.Lme("","{"," user: new UserEntity() ","}",""))},dependencies:[F.a],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Serialization"}},{path:"caching",component:C,data:{title:"Caching"}},{path:"validation",component:(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-validation"]],features:[e.Vt3],decls:751,vars:8,consts:[["contentReference",""],["app197be0b8998f2a8bebbadef0223b19c9eded18ae",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/validation.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","validation"],["rel","nofollow","target","_blank","href","https://github.com/typestack/class-validator"],["appAnchor","","id","overview"],["routerLink","/pipes"],["appAnchor","","id","using-the-built-in-validationpipe"],[1,"language-bash"],[1,"info"],["rel","nofollow","target","_blank","href","https://github.com/typestack/class-transformer"],[1,"language-typescript"],["appAnchor","","id","auto-validation"],["rel","nofollow","target","_blank","href","https://github.com/typestack/class-validator#validation-decorators"],[1,"language-json"],["appAnchor","","id","disable-detailed-errors"],["appAnchor","","id","stripping-properties"],["appAnchor","","id","transform-payload-objects"],[1,"filename"],["appAnchor","","id","explicit-conversion"],["appAnchor","","id","mapped-types"],[1,""],["routerLink","/openapi/mapped-types"],["routerLink","/graphql/mapped-types"],["appAnchor","","id","parsing-and-validating-arrays"],["appAnchor","","id","websockets-and-microservices"],["appAnchor","","id","learn-more"]],template:function(s,n){if(1&s&&(e.j41(0,"div",2,0)(2,"div",3)(3,"a",4),e.nrm(4,"i",5),e.k0s()(),e.j41(5,"h3",6),e.EFF(6,"Validation"),e.k0s(),e.j41(7,"p"),e.EFF(8,"It is best practice to validate the correctness of any data sent into a web application. To automatically validate incoming requests, Nest provides several pipes available right out-of-the-box:"),e.k0s(),e.j41(9,"ul")(10,"li")(11,"code"),e.EFF(12,"ValidationPipe"),e.k0s()(),e.j41(13,"li")(14,"code"),e.EFF(15,"ParseIntPipe"),e.k0s()(),e.j41(16,"li")(17,"code"),e.EFF(18,"ParseBoolPipe"),e.k0s()(),e.j41(19,"li")(20,"code"),e.EFF(21,"ParseArrayPipe"),e.k0s()(),e.j41(22,"li")(23,"code"),e.EFF(24,"ParseUUIDPipe"),e.k0s()()(),e.j41(25,"p"),e.EFF(26,"The "),e.j41(27,"code"),e.EFF(28,"ValidationPipe"),e.k0s(),e.EFF(29," makes use of the powerful "),e.j41(30,"a",7),e.EFF(31,"class-validator"),e.k0s(),e.EFF(32," package and its declarative validation decorators. The "),e.j41(33,"code"),e.EFF(34,"ValidationPipe"),e.k0s(),e.EFF(35," provides a convenient approach to enforce validation rules for all incoming client payloads, where the specific rules are declared with simple annotations in local class/DTO declarations in each module."),e.k0s(),e.j41(36,"h4",8)(37,"span"),e.EFF(38,"Overview"),e.k0s()(),e.j41(39,"p"),e.EFF(40,"In the "),e.j41(41,"a",9),e.EFF(42,"Pipes"),e.k0s(),e.EFF(43," chapter, we went through the process of building simple pipes and binding them to controllers, methods or to the global app to demonstrate how the process works. Be sure to review that chapter to best understand the topics of this chapter. Here, we'll focus on various "),e.j41(44,"strong"),e.EFF(45,"real world"),e.k0s(),e.EFF(46," use cases of the "),e.j41(47,"code"),e.EFF(48,"ValidationPipe"),e.k0s(),e.EFF(49,", and show how to use some of its advanced customization features."),e.k0s(),e.j41(50,"h4",10)(51,"span"),e.EFF(52,"Using the built-in ValidationPipe"),e.k0s()(),e.j41(53,"p"),e.EFF(54,"To begin using it, we first install the required dependency."),e.k0s(),e.j41(55,"pre")(56,"code",11),e.EFF(57,"\n$ npm i --save class-validator class-transformer\n"),e.k0s()(),e.j41(58,"blockquote",12)(59,"strong"),e.EFF(60,"Hint"),e.k0s(),e.EFF(61," The "),e.j41(62,"code"),e.EFF(63,"ValidationPipe"),e.k0s(),e.EFF(64," is exported from the "),e.j41(65,"code"),e.EFF(66,"@nestjs/common"),e.k0s(),e.EFF(67," package.\n"),e.k0s(),e.j41(68,"p"),e.EFF(69,"Because this pipe uses the "),e.j41(70,"a",7)(71,"code"),e.EFF(72,"class-validator"),e.k0s()(),e.EFF(73," and "),e.j41(74,"a",13)(75,"code"),e.EFF(76,"class-transformer"),e.k0s()(),e.EFF(77," libraries, there are many options available. You configure these settings via a configuration object passed to the pipe. Following are the built-in options:"),e.k0s(),e.j41(78,"pre")(79,"code",14),e.EFF(80,"\nexport interface ValidationPipeOptions extends ValidatorOptions {\n  transform?: boolean;\n  disableErrorMessages?: boolean;\n  exceptionFactory?: (errors: ValidationError[]) => any;\n}\n"),e.k0s()(),e.j41(81,"p"),e.EFF(82,"In addition to these, all "),e.j41(83,"code"),e.EFF(84,"class-validator"),e.k0s(),e.EFF(85," options (inherited from the "),e.j41(86,"code"),e.EFF(87,"ValidatorOptions"),e.k0s(),e.EFF(88," interface) are available:"),e.k0s(),e.j41(89,"table")(90,"tr")(91,"th"),e.EFF(92,"Option"),e.k0s(),e.j41(93,"th"),e.EFF(94,"Type"),e.k0s(),e.j41(95,"th"),e.EFF(96,"Description"),e.k0s()(),e.j41(97,"tr")(98,"td")(99,"code"),e.EFF(100,"enableDebugMessages"),e.k0s()(),e.j41(101,"td")(102,"code"),e.EFF(103,"boolean"),e.k0s()(),e.j41(104,"td"),e.EFF(105,"If set to true, validator will print extra warning messages to the console when something is not right."),e.k0s()(),e.j41(106,"tr")(107,"td")(108,"code"),e.EFF(109,"skipUndefinedProperties"),e.k0s()(),e.j41(110,"td")(111,"code"),e.EFF(112,"boolean"),e.k0s()(),e.j41(113,"td"),e.EFF(114,"If set to true then validator will skip validation of all properties that are undefined in the validating object."),e.k0s()(),e.j41(115,"tr")(116,"td")(117,"code"),e.EFF(118,"skipNullProperties"),e.k0s()(),e.j41(119,"td")(120,"code"),e.EFF(121,"boolean"),e.k0s()(),e.j41(122,"td"),e.EFF(123,"If set to true then validator will skip validation of all properties that are null in the validating object."),e.k0s()(),e.j41(124,"tr")(125,"td")(126,"code"),e.EFF(127,"skipMissingProperties"),e.k0s()(),e.j41(128,"td")(129,"code"),e.EFF(130,"boolean"),e.k0s()(),e.j41(131,"td"),e.EFF(132,"If set to true then validator will skip validation of all properties that are null or undefined in the validating object."),e.k0s()(),e.j41(133,"tr")(134,"td")(135,"code"),e.EFF(136,"whitelist"),e.k0s()(),e.j41(137,"td")(138,"code"),e.EFF(139,"boolean"),e.k0s()(),e.j41(140,"td"),e.EFF(141,"If set to true, validator will strip validated (returned) object of any properties that do not use any validation decorators."),e.k0s()(),e.j41(142,"tr")(143,"td")(144,"code"),e.EFF(145,"forbidNonWhitelisted"),e.k0s()(),e.j41(146,"td")(147,"code"),e.EFF(148,"boolean"),e.k0s()(),e.j41(149,"td"),e.EFF(150,"If set to true, instead of stripping non-whitelisted properties validator will throw an exception."),e.k0s()(),e.j41(151,"tr")(152,"td")(153,"code"),e.EFF(154,"forbidUnknownValues"),e.k0s()(),e.j41(155,"td")(156,"code"),e.EFF(157,"boolean"),e.k0s()(),e.j41(158,"td"),e.EFF(159,"If set to true, attempts to validate unknown objects fail immediately."),e.k0s()(),e.j41(160,"tr")(161,"td")(162,"code"),e.EFF(163,"disableErrorMessages"),e.k0s()(),e.j41(164,"td")(165,"code"),e.EFF(166,"boolean"),e.k0s()(),e.j41(167,"td"),e.EFF(168,"If set to true, validation errors will not be returned to the client."),e.k0s()(),e.j41(169,"tr")(170,"td")(171,"code"),e.EFF(172,"errorHttpStatusCode"),e.k0s()(),e.j41(173,"td")(174,"code"),e.EFF(175,"number"),e.k0s()(),e.j41(176,"td"),e.EFF(177,"This setting allows you to specify which exception type will be used in case of an error. By default it throws "),e.j41(178,"code"),e.EFF(179,"BadRequestException"),e.k0s(),e.EFF(180,"."),e.k0s()(),e.j41(181,"tr")(182,"td")(183,"code"),e.EFF(184,"exceptionFactory"),e.k0s()(),e.j41(185,"td")(186,"code"),e.EFF(187,"Function"),e.k0s()(),e.j41(188,"td"),e.EFF(189,"Takes an array of the validation errors and returns an exception object to be thrown."),e.k0s()(),e.j41(190,"tr")(191,"td")(192,"code"),e.EFF(193,"groups"),e.k0s()(),e.j41(194,"td")(195,"code"),e.EFF(196,"string[]"),e.k0s()(),e.j41(197,"td"),e.EFF(198,"Groups to be used during validation of the object."),e.k0s()(),e.j41(199,"tr")(200,"td")(201,"code"),e.EFF(202,"always"),e.k0s()(),e.j41(203,"td")(204,"code"),e.EFF(205,"boolean"),e.k0s()(),e.j41(206,"td"),e.EFF(207,"Set default for "),e.j41(208,"code"),e.EFF(209,"always"),e.k0s(),e.EFF(210," option of decorators. Default can be overridden in decorator options"),e.k0s()(),e.j41(211,"tr")(212,"td")(213,"code"),e.EFF(214,"strictGroups"),e.k0s()(),e.j41(215,"td")(216,"code"),e.EFF(217,"boolean"),e.k0s()(),e.j41(218,"td"),e.EFF(219,"If "),e.j41(220,"code"),e.EFF(221,"groups"),e.k0s(),e.EFF(222," is not given or is empty, ignore decorators with at least one group."),e.k0s()(),e.j41(223,"tr")(224,"td")(225,"code"),e.EFF(226,"dismissDefaultMessages"),e.k0s()(),e.j41(227,"td")(228,"code"),e.EFF(229,"boolean"),e.k0s()(),e.j41(230,"td"),e.EFF(231,"If set to true, the validation will not use default messages. Error message always will be "),e.j41(232,"code"),e.EFF(233,"undefined"),e.k0s(),e.EFF(234," if its not explicitly set."),e.k0s()(),e.j41(235,"tr")(236,"td")(237,"code"),e.EFF(238,"validationError.target"),e.k0s()(),e.j41(239,"td")(240,"code"),e.EFF(241,"boolean"),e.k0s()(),e.j41(242,"td"),e.EFF(243,"Indicates if target should be exposed in "),e.j41(244,"code"),e.EFF(245,"ValidationError"),e.k0s(),e.EFF(246,"."),e.k0s()(),e.j41(247,"tr")(248,"td")(249,"code"),e.EFF(250,"validationError.value"),e.k0s()(),e.j41(251,"td")(252,"code"),e.EFF(253,"boolean"),e.k0s()(),e.j41(254,"td"),e.EFF(255,"Indicates if validated value should be exposed in "),e.j41(256,"code"),e.EFF(257,"ValidationError"),e.k0s(),e.EFF(258,"."),e.k0s()(),e.j41(259,"tr")(260,"td")(261,"code"),e.EFF(262,"stopAtFirstError"),e.k0s()(),e.j41(263,"td")(264,"code"),e.EFF(265,"boolean"),e.k0s()(),e.j41(266,"td"),e.EFF(267,"When set to true, validation of the given property will stop after encountering the first error. Defaults to false."),e.k0s()()(),e.j41(268,"blockquote",12)(269,"strong"),e.EFF(270,"Notice"),e.k0s(),e.EFF(271," Find more information about the "),e.j41(272,"code"),e.EFF(273,"class-validator"),e.k0s(),e.EFF(274," package in its "),e.j41(275,"a",7),e.EFF(276,"repository"),e.k0s(),e.EFF(277,".\n"),e.k0s(),e.j41(278,"h4",15)(279,"span"),e.EFF(280,"Auto-validation"),e.k0s()(),e.j41(281,"p"),e.EFF(282,"We'll start by binding "),e.j41(283,"code"),e.EFF(284,"ValidationPipe"),e.k0s(),e.EFF(285," at the application level, thus ensuring all endpoints are protected from receiving incorrect data."),e.k0s(),e.j41(286,"pre")(287,"code",14),e.EFF(288,"\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule);\n  app.useGlobalPipes(new ValidationPipe());\n  await app.listen(process.env.PORT ?? 3000);\n}\nbootstrap();\n"),e.k0s()(),e.j41(289,"p"),e.EFF(290,"To test our pipe, let's create a basic endpoint."),e.k0s(),e.j41(291,"pre")(292,"code",14),e.EFF(293,"\n@Post()\ncreate(@Body() createUserDto: CreateUserDto) {\n  return 'This action adds a new user';\n}\n"),e.k0s()(),e.j41(294,"blockquote",12)(295,"strong"),e.EFF(296,"Hint"),e.k0s(),e.EFF(297," Since TypeScript does not store metadata about "),e.j41(298,"strong"),e.EFF(299,"generics or interfaces"),e.k0s(),e.EFF(300,", when you use them in your DTOs, "),e.j41(301,"code"),e.EFF(302,"ValidationPipe"),e.k0s(),e.EFF(303," may not be able to properly validate incoming data. For this reason, consider using concrete classes in your DTOs.\n"),e.k0s(),e.j41(304,"blockquote",12)(305,"strong"),e.EFF(306,"Hint"),e.k0s(),e.EFF(307," When importing your DTOs, you can't use a type-only import as that would be erased at runtime, i.e. remember to "),e.j41(308,"code"),e.EFF(309),e.k0s(),e.EFF(310," instead of "),e.j41(311,"code"),e.EFF(312),e.k0s(),e.EFF(313,".\n"),e.k0s(),e.j41(314,"p"),e.EFF(315,"Now we can add a few validation rules in our "),e.j41(316,"code"),e.EFF(317,"CreateUserDto"),e.k0s(),e.EFF(318,". We do this using decorators provided by the "),e.j41(319,"code"),e.EFF(320,"class-validator"),e.k0s(),e.EFF(321," package, described in detail "),e.j41(322,"a",16),e.EFF(323,"here"),e.k0s(),e.EFF(324,". In this fashion, any route that uses the "),e.j41(325,"code"),e.EFF(326,"CreateUserDto"),e.k0s(),e.EFF(327," will automatically enforce these validation rules."),e.k0s(),e.j41(328,"pre")(329,"code",14),e.EFF(330,"\nimport { IsEmail, IsNotEmpty } from 'class-validator';\n\nexport class CreateUserDto {\n  @IsEmail()\n  email: string;\n\n  @IsNotEmpty()\n  password: string;\n}\n"),e.k0s()(),e.j41(331,"p"),e.EFF(332,"With these rules in place, if a request hits our endpoint with an invalid "),e.j41(333,"code"),e.EFF(334,"email"),e.k0s(),e.EFF(335," property in the request body, the application will automatically respond with a "),e.j41(336,"code"),e.EFF(337,"400 Bad Request"),e.k0s(),e.EFF(338," code, along with the following response body:"),e.k0s(),e.j41(339,"pre")(340,"code",17),e.EFF(341,'\n{\n  "statusCode": 400,\n  "error": "Bad Request",\n  "message": ["email must be an email"]\n}\n'),e.k0s()(),e.j41(342,"p"),e.EFF(343,"In addition to validating request bodies, the "),e.j41(344,"code"),e.EFF(345,"ValidationPipe"),e.k0s(),e.EFF(346," can be used with other request object properties as well. Imagine that we would like to accept "),e.j41(347,"code"),e.EFF(348,":id"),e.k0s(),e.EFF(349," in the endpoint path. To ensure that only numbers are accepted for this request parameter, we can use the following construct:"),e.k0s(),e.j41(350,"pre")(351,"code",14),e.EFF(352,"\n@Get(':id')\nfindOne(@Param() params: FindOneParams) {\n  return 'This action returns a user';\n}\n"),e.k0s()(),e.j41(353,"p")(354,"code"),e.EFF(355,"FindOneParams"),e.k0s(),e.EFF(356,", like a DTO, is simply a class that defines validation rules using "),e.j41(357,"code"),e.EFF(358,"class-validator"),e.k0s(),e.EFF(359,". It would look like this:"),e.k0s(),e.j41(360,"pre")(361,"code",14),e.EFF(362,"\nimport { IsNumberString } from 'class-validator';\n\nexport class FindOneParams {\n  @IsNumberString()\n  id: number;\n}\n"),e.k0s()(),e.j41(363,"h4",18)(364,"span"),e.EFF(365,"Disable detailed errors"),e.k0s()(),e.j41(366,"p"),e.EFF(367,"Error messages can be helpful to explain what was incorrect in a request. However, some production environments prefer to disable detailed errors. Do this by passing an options object to the "),e.j41(368,"code"),e.EFF(369,"ValidationPipe"),e.k0s(),e.EFF(370,":"),e.k0s(),e.j41(371,"pre")(372,"code",14),e.EFF(373,"\napp.useGlobalPipes(\n  new ValidationPipe({\n    disableErrorMessages: true,\n  }),\n);\n"),e.k0s()(),e.j41(374,"p"),e.EFF(375,"As a result, detailed error messages won't be displayed in the response body."),e.k0s(),e.j41(376,"h4",19)(377,"span"),e.EFF(378,"Stripping properties"),e.k0s()(),e.j41(379,"p"),e.EFF(380,"Our "),e.j41(381,"code"),e.EFF(382,"ValidationPipe"),e.k0s(),e.EFF(383," can also filter out properties that should not be received by the method handler. In this case, we can "),e.j41(384,"strong"),e.EFF(385,"whitelist"),e.k0s(),e.EFF(386," the acceptable properties, and any property not included in the whitelist is automatically stripped from the resulting object. For example, if our handler expects "),e.j41(387,"code"),e.EFF(388,"email"),e.k0s(),e.EFF(389," and "),e.j41(390,"code"),e.EFF(391,"password"),e.k0s(),e.EFF(392," properties, but a request also includes an "),e.j41(393,"code"),e.EFF(394,"age"),e.k0s(),e.EFF(395," property, this property can be automatically removed from the resulting DTO. To enable such behavior, set "),e.j41(396,"code"),e.EFF(397,"whitelist"),e.k0s(),e.EFF(398," to "),e.j41(399,"code"),e.EFF(400,"true"),e.k0s(),e.EFF(401,"."),e.k0s(),e.j41(402,"pre")(403,"code",14),e.EFF(404,"\napp.useGlobalPipes(\n  new ValidationPipe({\n    whitelist: true,\n  }),\n);\n"),e.k0s()(),e.j41(405,"p"),e.EFF(406,"When set to true, this will automatically remove non-whitelisted properties (those without any decorator in the validation class)."),e.k0s(),e.j41(407,"p"),e.EFF(408,"Alternatively, you can stop the request from processing when non-whitelisted properties are present, and return an error response to the user. To enable this, set the "),e.j41(409,"code"),e.EFF(410,"forbidNonWhitelisted"),e.k0s(),e.EFF(411," option property to "),e.j41(412,"code"),e.EFF(413,"true"),e.k0s(),e.EFF(414,", in combination with setting "),e.j41(415,"code"),e.EFF(416,"whitelist"),e.k0s(),e.EFF(417," to "),e.j41(418,"code"),e.EFF(419,"true"),e.k0s(),e.EFF(420,"."),e.k0s(),e.j41(421,"p"),e.nrm(422,"app-banner-courses"),e.k0s(),e.j41(423,"h4",20)(424,"span"),e.EFF(425,"Transform payload objects"),e.k0s()(),e.j41(426,"p"),e.EFF(427,"Payloads coming in over the network are plain JavaScript objects. The "),e.j41(428,"code"),e.EFF(429,"ValidationPipe"),e.k0s(),e.EFF(430," can automatically transform payloads to be objects typed according to their DTO classes. To enable auto-transformation, set "),e.j41(431,"code"),e.EFF(432,"transform"),e.k0s(),e.EFF(433," to "),e.j41(434,"code"),e.EFF(435,"true"),e.k0s(),e.EFF(436,". This can be done at a method level:"),e.k0s(),e.j41(437,"span",21),e.EFF(438),e.nI1(439,"extension"),e.nrm(440,"app-tabs",null,1),e.k0s(),e.j41(442,"pre")(443,"code",14),e.EFF(444,"\n@Post()\n@UsePipes(new ValidationPipe({ transform: true }))\nasync create(@Body() createCatDto: CreateCatDto) {\n  this.catsService.create(createCatDto);\n}\n"),e.k0s()(),e.j41(445,"p"),e.EFF(446,"To enable this behavior globally, set the option on a global pipe:"),e.k0s(),e.j41(447,"pre")(448,"code",14),e.EFF(449,"\napp.useGlobalPipes(\n  new ValidationPipe({\n    transform: true,\n  }),\n);\n"),e.k0s()(),e.j41(450,"p"),e.EFF(451,"With the auto-transformation option enabled, the "),e.j41(452,"code"),e.EFF(453,"ValidationPipe"),e.k0s(),e.EFF(454," will also perform conversion of primitive types. In the following example, the "),e.j41(455,"code"),e.EFF(456,"findOne()"),e.k0s(),e.EFF(457," method takes one argument which represents an extracted "),e.j41(458,"code"),e.EFF(459,"id"),e.k0s(),e.EFF(460," path parameter:"),e.k0s(),e.j41(461,"pre")(462,"code",14),e.EFF(463,"\n@Get(':id')\nfindOne(@Param('id') id: number) {\n  console.log(typeof id === 'number'); // true\n  return 'This action returns a user';\n}\n"),e.k0s()(),e.j41(464,"p"),e.EFF(465,"By default, every path parameter and query parameter comes over the network as a "),e.j41(466,"code"),e.EFF(467,"string"),e.k0s(),e.EFF(468,". In the above example, we specified the "),e.j41(469,"code"),e.EFF(470,"id"),e.k0s(),e.EFF(471," type as a "),e.j41(472,"code"),e.EFF(473,"number"),e.k0s(),e.EFF(474," (in the method signature). Therefore, the "),e.j41(475,"code"),e.EFF(476,"ValidationPipe"),e.k0s(),e.EFF(477," will try to automatically convert a string identifier to a number."),e.k0s(),e.j41(478,"h4",22)(479,"span"),e.EFF(480,"Explicit conversion"),e.k0s()(),e.j41(481,"p"),e.EFF(482,"In the above section, we showed how the "),e.j41(483,"code"),e.EFF(484,"ValidationPipe"),e.k0s(),e.EFF(485," can implicitly transform query and path parameters based on the expected type. However, this feature requires having auto-transformation enabled."),e.k0s(),e.j41(486,"p"),e.EFF(487,"Alternatively (with auto-transformation disabled), you can explicitly cast values using the "),e.j41(488,"code"),e.EFF(489,"ParseIntPipe"),e.k0s(),e.EFF(490," or "),e.j41(491,"code"),e.EFF(492,"ParseBoolPipe"),e.k0s(),e.EFF(493," (note that "),e.j41(494,"code"),e.EFF(495,"ParseStringPipe"),e.k0s(),e.EFF(496," is not needed because, as mentioned earlier, every path parameter and query parameter comes over the network as a "),e.j41(497,"code"),e.EFF(498,"string"),e.k0s(),e.EFF(499," by default)."),e.k0s(),e.j41(500,"pre")(501,"code",14),e.EFF(502,"\n@Get(':id')\nfindOne(\n  @Param('id', ParseIntPipe) id: number,\n  @Query('sort', ParseBoolPipe) sort: boolean,\n) {\n  console.log(typeof id === 'number'); // true\n  console.log(typeof sort === 'boolean'); // true\n  return 'This action returns a user';\n}\n"),e.k0s()(),e.j41(503,"blockquote",12)(504,"strong"),e.EFF(505,"Hint"),e.k0s(),e.EFF(506," The "),e.j41(507,"code"),e.EFF(508,"ParseIntPipe"),e.k0s(),e.EFF(509," and "),e.j41(510,"code"),e.EFF(511,"ParseBoolPipe"),e.k0s(),e.EFF(512," are exported from the "),e.j41(513,"code"),e.EFF(514,"@nestjs/common"),e.k0s(),e.EFF(515," package.\n"),e.k0s(),e.j41(516,"h4",23)(517,"span"),e.EFF(518,"Mapped types"),e.k0s()(),e.j41(519,"p"),e.EFF(520,"As you build out features like "),e.j41(521,"strong"),e.EFF(522,"CRUD"),e.k0s(),e.EFF(523," (Create/Read/Update/Delete) it's often useful to construct variants on a base entity type. Nest provides several utility functions that perform type transformations to make this task more convenient."),e.k0s(),e.j41(524,"blockquote",24)(525,"strong"),e.EFF(526,"Warning"),e.k0s(),e.EFF(527," If your application uses the "),e.j41(528,"code"),e.EFF(529,"@nestjs/swagger"),e.k0s(),e.EFF(530," package, see "),e.j41(531,"a",25),e.EFF(532,"this chapter"),e.k0s(),e.EFF(533," for more information about Mapped Types. Likewise, if you use the "),e.j41(534,"code"),e.EFF(535,"@nestjs/graphql"),e.k0s(),e.EFF(536," package see "),e.j41(537,"a",26),e.EFF(538,"this chapter"),e.k0s(),e.EFF(539,". Both packages heavily rely on types and so they require a different import to be used. Therefore, if you used "),e.j41(540,"code"),e.EFF(541,"@nestjs/mapped-types"),e.k0s(),e.EFF(542," (instead of an appropriate one, either "),e.j41(543,"code"),e.EFF(544,"@nestjs/swagger"),e.k0s(),e.EFF(545," or "),e.j41(546,"code"),e.EFF(547,"@nestjs/graphql"),e.k0s(),e.EFF(548," depending on the type of your app), you may face various, undocumented side-effects.\n"),e.k0s(),e.j41(549,"p"),e.EFF(550,"When building input validation types (also called DTOs), it's often useful to build "),e.j41(551,"strong"),e.EFF(552,"create"),e.k0s(),e.EFF(553," and "),e.j41(554,"strong"),e.EFF(555,"update"),e.k0s(),e.EFF(556," variations on the same type. For example, the "),e.j41(557,"strong"),e.EFF(558,"create"),e.k0s(),e.EFF(559," variant may require all fields, while the "),e.j41(560,"strong"),e.EFF(561,"update"),e.k0s(),e.EFF(562," variant may make all fields optional."),e.k0s(),e.j41(563,"p"),e.EFF(564,"Nest provides the "),e.j41(565,"code"),e.EFF(566,"PartialType()"),e.k0s(),e.EFF(567," utility function to make this task easier and minimize boilerplate."),e.k0s(),e.j41(568,"p"),e.EFF(569,"The "),e.j41(570,"code"),e.EFF(571,"PartialType()"),e.k0s(),e.EFF(572," function returns a type (class) with all the properties of the input type set to optional. For example, suppose we have a "),e.j41(573,"strong"),e.EFF(574,"create"),e.k0s(),e.EFF(575," type as follows:"),e.k0s(),e.j41(576,"pre")(577,"code",14),e.EFF(578,"\nexport class CreateCatDto {\n  name: string;\n  age: number;\n  breed: string;\n}\n"),e.k0s()(),e.j41(579,"p"),e.EFF(580,"By default, all of these fields are required. To create a type with the same fields, but with each one optional, use "),e.j41(581,"code"),e.EFF(582,"PartialType()"),e.k0s(),e.EFF(583," passing the class reference ("),e.j41(584,"code"),e.EFF(585,"CreateCatDto"),e.k0s(),e.EFF(586,") as an argument:"),e.k0s(),e.j41(587,"pre")(588,"code",14),e.EFF(589,"\nexport class UpdateCatDto extends PartialType(CreateCatDto) {}\n"),e.k0s()(),e.j41(590,"blockquote",12)(591,"strong"),e.EFF(592,"Hint"),e.k0s(),e.EFF(593," The "),e.j41(594,"code"),e.EFF(595,"PartialType()"),e.k0s(),e.EFF(596," function is imported from the "),e.j41(597,"code"),e.EFF(598,"@nestjs/mapped-types"),e.k0s(),e.EFF(599," package.\n"),e.k0s(),e.j41(600,"p"),e.EFF(601,"The "),e.j41(602,"code"),e.EFF(603,"PickType()"),e.k0s(),e.EFF(604," function constructs a new type (class) by picking a set of properties from an input type. For example, suppose we start with a type like:"),e.k0s(),e.j41(605,"pre")(606,"code",14),e.EFF(607,"\nexport class CreateCatDto {\n  name: string;\n  age: number;\n  breed: string;\n}\n"),e.k0s()(),e.j41(608,"p"),e.EFF(609,"We can pick a set of properties from this class using the "),e.j41(610,"code"),e.EFF(611,"PickType()"),e.k0s(),e.EFF(612," utility function:"),e.k0s(),e.j41(613,"pre")(614,"code",14),e.EFF(615,"\nexport class UpdateCatAgeDto extends PickType(CreateCatDto, ['age'] as const) {}\n"),e.k0s()(),e.j41(616,"blockquote",12)(617,"strong"),e.EFF(618,"Hint"),e.k0s(),e.EFF(619," The "),e.j41(620,"code"),e.EFF(621,"PickType()"),e.k0s(),e.EFF(622," function is imported from the "),e.j41(623,"code"),e.EFF(624,"@nestjs/mapped-types"),e.k0s(),e.EFF(625," package.\n"),e.k0s(),e.j41(626,"p"),e.EFF(627,"The "),e.j41(628,"code"),e.EFF(629,"OmitType()"),e.k0s(),e.EFF(630," function constructs a type by picking all properties from an input type and then removing a particular set of keys. For example, suppose we start with a type like:"),e.k0s(),e.j41(631,"pre")(632,"code",14),e.EFF(633,"\nexport class CreateCatDto {\n  name: string;\n  age: number;\n  breed: string;\n}\n"),e.k0s()(),e.j41(634,"p"),e.EFF(635,"We can generate a derived type that has every property "),e.j41(636,"strong"),e.EFF(637,"except"),e.k0s(),e.j41(638,"code"),e.EFF(639,"name"),e.k0s(),e.EFF(640," as shown below. In this construct, the second argument to "),e.j41(641,"code"),e.EFF(642,"OmitType"),e.k0s(),e.EFF(643," is an array of property names."),e.k0s(),e.j41(644,"pre")(645,"code",14),e.EFF(646,"\nexport class UpdateCatDto extends OmitType(CreateCatDto, ['name'] as const) {}\n"),e.k0s()(),e.j41(647,"blockquote",12)(648,"strong"),e.EFF(649,"Hint"),e.k0s(),e.EFF(650," The "),e.j41(651,"code"),e.EFF(652,"OmitType()"),e.k0s(),e.EFF(653," function is imported from the "),e.j41(654,"code"),e.EFF(655,"@nestjs/mapped-types"),e.k0s(),e.EFF(656," package.\n"),e.k0s(),e.j41(657,"p"),e.EFF(658,"The "),e.j41(659,"code"),e.EFF(660,"IntersectionType()"),e.k0s(),e.EFF(661," function combines two types into one new type (class). For example, suppose we start with two types like:"),e.k0s(),e.j41(662,"pre")(663,"code",14),e.EFF(664,"\nexport class CreateCatDto {\n  name: string;\n  breed: string;\n}\n\nexport class AdditionalCatInfo {\n  color: string;\n}\n"),e.k0s()(),e.j41(665,"p"),e.EFF(666,"We can generate a new type that combines all properties in both types."),e.k0s(),e.j41(667,"pre")(668,"code",14),e.EFF(669,"\nexport class UpdateCatDto extends IntersectionType(\n  CreateCatDto,\n  AdditionalCatInfo,\n) {}\n"),e.k0s()(),e.j41(670,"blockquote",12)(671,"strong"),e.EFF(672,"Hint"),e.k0s(),e.EFF(673," The "),e.j41(674,"code"),e.EFF(675,"IntersectionType()"),e.k0s(),e.EFF(676," function is imported from the "),e.j41(677,"code"),e.EFF(678,"@nestjs/mapped-types"),e.k0s(),e.EFF(679," package.\n"),e.k0s(),e.j41(680,"p"),e.EFF(681,"The type mapping utility functions are composable. For example, the following will produce a type (class) that has all of the properties of the "),e.j41(682,"code"),e.EFF(683,"CreateCatDto"),e.k0s(),e.EFF(684," type except for "),e.j41(685,"code"),e.EFF(686,"name"),e.k0s(),e.EFF(687,", and those properties will be set to optional:"),e.k0s(),e.j41(688,"pre")(689,"code",14),e.EFF(690,"\nexport class UpdateCatDto extends PartialType(\n  OmitType(CreateCatDto, ['name'] as const),\n) {}\n"),e.k0s()(),e.j41(691,"h4",27)(692,"span"),e.EFF(693,"Parsing and validating arrays"),e.k0s()(),e.j41(694,"p"),e.EFF(695,"TypeScript does not store metadata about generics or interfaces, so when you use them in your DTOs, "),e.j41(696,"code"),e.EFF(697,"ValidationPipe"),e.k0s(),e.EFF(698," may not be able to properly validate incoming data. For instance, in the following code, "),e.j41(699,"code"),e.EFF(700,"createUserDtos"),e.k0s(),e.EFF(701," won't be correctly validated:"),e.k0s(),e.j41(702,"pre")(703,"code",14),e.EFF(704,"\n@Post()\ncreateBulk(@Body() createUserDtos: CreateUserDto[]) {\n  return 'This action adds new users';\n}\n"),e.k0s()(),e.j41(705,"p"),e.EFF(706,"To validate the array, create a dedicated class which contains a property that wraps the array, or use the "),e.j41(707,"code"),e.EFF(708,"ParseArrayPipe"),e.k0s(),e.EFF(709,"."),e.k0s(),e.j41(710,"pre")(711,"code",14),e.EFF(712,"\n@Post()\ncreateBulk(\n  @Body(new ParseArrayPipe({ items: CreateUserDto }))\n  createUserDtos: CreateUserDto[],\n) {\n  return 'This action adds new users';\n}\n"),e.k0s()(),e.j41(713,"p"),e.EFF(714,"In addition, the "),e.j41(715,"code"),e.EFF(716,"ParseArrayPipe"),e.k0s(),e.EFF(717," may come in handy when parsing query parameters. Let's consider a "),e.j41(718,"code"),e.EFF(719,"findByIds()"),e.k0s(),e.EFF(720," method that returns users based on identifiers passed as query parameters."),e.k0s(),e.j41(721,"pre")(722,"code",14),e.EFF(723,"\n@Get()\nfindByIds(\n  @Query('ids', new ParseArrayPipe({ items: Number, separator: ',' }))\n  ids: number[],\n) {\n  return 'This action returns users by ids';\n}\n"),e.k0s()(),e.j41(724,"p"),e.EFF(725,"This construction validates the incoming query parameters from an HTTP "),e.j41(726,"code"),e.EFF(727,"GET"),e.k0s(),e.EFF(728," request like the following:"),e.k0s(),e.j41(729,"pre")(730,"code",11),e.EFF(731,"\nGET /?ids=1,2,3\n"),e.k0s()(),e.j41(732,"h4",28)(733,"span"),e.EFF(734,"WebSockets and Microservices"),e.k0s()(),e.j41(735,"p"),e.EFF(736,"While this chapter shows examples using HTTP style applications (e.g., Express or Fastify), the "),e.j41(737,"code"),e.EFF(738,"ValidationPipe"),e.k0s(),e.EFF(739," works the same for WebSockets and microservices, regardless of the transport method that is used."),e.k0s(),e.j41(740,"h4",29)(741,"span"),e.EFF(742,"Learn more"),e.k0s()(),e.j41(743,"p"),e.EFF(744,"Read more about custom validators, error messages, and available decorators as provided by the "),e.j41(745,"code"),e.EFF(746,"class-validator"),e.k0s(),e.EFF(747," package "),e.j41(748,"a",7),e.EFF(749,"here"),e.k0s(),e.EFF(750,"."),e.k0s()()),2&s){const a=e.sdS(441);e.R7$(309),e.Lme("import ","{"," CreateUserDto ","}",""),e.R7$(3),e.Lme("import type ","{"," CreateUserDto ","}",""),e.R7$(126),e.SpI(" ",e.i5U(439,5,"cats.controller",a.isJsActive),"\n")}},dependencies:[p.O,F.a,v.Q,E.Wk,m.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Validation"}},{path:"sql",redirectTo:"database"},{path:"database",component:(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-sql"]],features:[e.Vt3],decls:1471,vars:96,consts:[["contentReference",""],["app2c27103a20fc90d691eeaf27fb06f115528b08d7",""],["appc7215370ded48481ee53fe2b27fa31bda432aa67",""],["appf385df108c7c448abd1679c5ea608d571befa508",""],["appf9173f5c68b87ad938ea16d3379bab56cfc802dc",""],["app11066d8a785c441fad082ffb195df93f84558da5",""],["appb821995229e66cfdc57f91e96c85562d017b1adb",""],["app36d4285b3a38ae95708c3301b3dc13a9cc9886a2",""],["app14621e910e65201b511e271ef4f6ee690e8ea9ac",""],["appd1779280d757dea7e57d0e5b71df58bfb54c5d73",""],["appb756a4bfc17593ec63a563c872b6587f5b5ed1d6",""],["app1e41c14ea870239030693981a432ee81546201c7",""],["app3d8ff74d8ecb0a58a8d211ab5c1147962b328081",""],["appfaa095f5243cf1b4209c482969f3607d939df346",""],["appc4b4634129374a0d5c8decbc53ec92d5733e3fbc",""],["app79a97121eabbcee2dbf0b5d40f0f4fff62955059",""],["app2064e4b6ea943acf2b59bf7b37e8893523b34811",""],["appe695e01686873c6575fc08b6cdcde65fb9e20cbb",""],["app131ca96afae6d954b455086ae31485b3171aa20d",""],["appfda58853e920d400189f1da6563452bbae2984e9",""],["appf36ab4172a6bf7dcf0955113f62454b964e52eab",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/sql.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","database"],["rel","nofollow","target","_blank","href","https://expressjs.com/en/guide/database-integration.html"],["rel","nofollow","target","_blank","href","https://mikro-orm.io/"],["routerLink","/recipes/mikroorm"],["rel","nofollow","target","_blank","href","https://sequelize.org/"],["href","/techniques/database#sequelize-integration"],["rel","nofollow","target","_blank","href","https://knexjs.org/"],["rel","nofollow","target","_blank","href","https://dev.to/nestjs/build-a-nestjs-module-for-knex-js-or-other-resource-based-libraries-in-5-minutes-12an"],["rel","nofollow","target","_blank","href","https://github.com/typeorm/typeorm"],["rel","nofollow","target","_blank","href","https://www.github.com/prisma/prisma"],["routerLink","/recipes/prisma"],["routerLink","/techniques/mongodb"],["id","typeorm-integration"],["rel","nofollow","target","_blank","href","https://www.mysql.com/"],[1,"language-bash"],[1,"filename"],[1,"language-typescript"],[1,"warning"],["rel","nofollow","target","_blank","href","https://typeorm.io/data-source-options#common-data-source-options"],[1,"info"],["rel","nofollow","target","_blank","href","https://typeorm.io/data-source-options"],["appAnchor","","id","repository-pattern"],["rel","nofollow","target","_blank","href","https://typeorm.io/#/entities"],["appAnchor","","id","relations"],["rel","nofollow","target","_blank","href","https://typeorm.io/#/relations"],["appAnchor","","id","auto-load-entities"],["appAnchor","","id","separating-entity-definition"],["rel","nofollow","target","_blank","href","https://typeorm.io/#/separating-entity-definition"],[1,"warning","error"],["appAnchor","","id","typeorm-transactions"],["rel","nofollow","target","_blank","href","https://en.wikipedia.org/wiki/Database_transaction"],["rel","nofollow","target","_blank","href","https://typeorm.io/#/transactions"],["rel","nofollow","target","_blank","href","https://typeorm.io/#/transactions/creating-and-using-transactions"],["appAnchor","","id","subscribers"],["rel","nofollow","target","_blank","href","https://typeorm.io/#/listeners-and-subscribers/what-is-a-subscriber"],[1,"error"],["routerLink","/fundamentals/injection-scopes"],["appAnchor","","id","migrations"],["rel","nofollow","target","_blank","href","https://typeorm.io/#/migrations"],["rel","nofollow","target","_blank","href","https://typeorm.io/#/migrations/creating-a-new-migration"],["appAnchor","","id","multiple-databases"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/typeorm/issues/86"],["appAnchor","","id","testing"],["routerLink","/fundamentals/custom-providers"],["appAnchor","","id","async-configuration"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/fundamentals/async-providers"],["appAnchor","","id","custom-datasource-factory"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/05-sql-typeorm"],["id","sequelize-integration"],["rel","nofollow","target","_blank","href","https://github.com/RobinBuschmann/sequelize-typescript"],["rel","nofollow","target","_blank","href","https://sequelize.org/v5/manual/getting-started.html#setting-up-a-connection"],["appAnchor","","id","models"],["rel","nofollow","target","_blank","href","https://github.com/RobinBuschmann/sequelize-typescript#column"],["appAnchor","","id","relations-1"],["rel","nofollow","target","_blank","href","https://github.com/RobinBuschmann/sequelize-typescript#model-association"],["appAnchor","","id","auto-load-models"],["appAnchor","","id","sequelize-transactions"],["rel","nofollow","target","_blank","href","https://sequelize.org/v5/manual/transactions.html"],["appAnchor","","id","migrations-1"],["rel","nofollow","target","_blank","href","https://sequelize.org/v5/manual/migrations.html"],["rel","nofollow","target","_blank","href","https://sequelize.org/v5/manual/migrations.html#the-cli"],["appAnchor","","id","multiple-databases-1"],["appAnchor","","id","testing-1"],["appAnchor","","id","async-configuration-1"],["appAnchor","","id","example-1"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/07-sequelize"]],template:function(s,n){if(1&s&&(e.j41(0,"div",21,0)(2,"div",22)(3,"a",23),e.nrm(4,"i",24),e.k0s()(),e.j41(5,"h3",25),e.EFF(6,"Database"),e.k0s(),e.j41(7,"p"),e.EFF(8,"Nest is database agnostic, allowing you to easily integrate with any SQL or NoSQL database. You have a number of options available to you, depending on your preferences. At the most general level, connecting Nest to a database is simply a matter of loading an appropriate Node.js driver for the database, just as you would with "),e.j41(9,"a",26),e.EFF(10,"Express"),e.k0s(),e.EFF(11," or Fastify."),e.k0s(),e.j41(12,"p"),e.EFF(13,"You can also directly use any general purpose Node.js database integration "),e.j41(14,"strong"),e.EFF(15,"library"),e.k0s(),e.EFF(16," or ORM, such as "),e.j41(17,"a",27),e.EFF(18,"MikroORM"),e.k0s(),e.EFF(19," (see "),e.j41(20,"a",28),e.EFF(21,"MikroORM recipe"),e.k0s(),e.EFF(22,"), "),e.j41(23,"a",29),e.EFF(24,"Sequelize"),e.k0s(),e.EFF(25," (see "),e.j41(26,"a",30),e.EFF(27,"Sequelize integration"),e.k0s(),e.EFF(28,"), "),e.j41(29,"a",31),e.EFF(30,"Knex.js"),e.k0s(),e.EFF(31," (see "),e.j41(32,"a",32),e.EFF(33,"Knex.js tutorial"),e.k0s(),e.EFF(34,"), "),e.j41(35,"a",33),e.EFF(36,"TypeORM"),e.k0s(),e.EFF(37,", and "),e.j41(38,"a",34),e.EFF(39,"Prisma"),e.k0s(),e.EFF(40," (see "),e.j41(41,"a",35),e.EFF(42,"Prisma recipe"),e.k0s(),e.EFF(43,"), to operate at a higher level of abstraction."),e.k0s(),e.j41(44,"p"),e.EFF(45,"For convenience, Nest provides tight integration with TypeORM and Sequelize out-of-the-box with the "),e.j41(46,"code"),e.EFF(47,"@nestjs/typeorm"),e.k0s(),e.EFF(48," and "),e.j41(49,"code"),e.EFF(50,"@nestjs/sequelize"),e.k0s(),e.EFF(51," packages respectively, which we'll cover in the current chapter, and Mongoose with "),e.j41(52,"code"),e.EFF(53,"@nestjs/mongoose"),e.k0s(),e.EFF(54,", which is covered in "),e.j41(55,"a",36),e.EFF(56,"this chapter"),e.k0s(),e.EFF(57,". These integrations provide additional NestJS-specific features, such as model/repository injection, testability, and asynchronous configuration to make accessing your chosen database even easier."),e.k0s(),e.j41(58,"h3",37),e.EFF(59,"TypeORM Integration"),e.k0s(),e.j41(60,"p"),e.EFF(61,"For integrating with SQL and NoSQL databases, Nest provides the "),e.j41(62,"code"),e.EFF(63,"@nestjs/typeorm"),e.k0s(),e.EFF(64," package. "),e.j41(65,"a",33),e.EFF(66,"TypeORM"),e.k0s(),e.EFF(67," is the most mature Object Relational Mapper (ORM) available for TypeScript. Since it's written in TypeScript, it integrates well with the Nest framework."),e.k0s(),e.j41(68,"p"),e.EFF(69,"To begin using it, we first install the required dependencies. In this chapter, we'll demonstrate using the popular "),e.j41(70,"a",38),e.EFF(71,"MySQL"),e.k0s(),e.EFF(72," Relational DBMS, but TypeORM provides support for many relational databases, such as PostgreSQL, Oracle, Microsoft SQL Server, SQLite, and even NoSQL databases like MongoDB. The procedure we walk through in this chapter will be the same for any database supported by TypeORM. You'll simply need to install the associated client API libraries for your selected database."),e.k0s(),e.j41(73,"pre")(74,"code",39),e.EFF(75,"\n$ npm install --save @nestjs/typeorm typeorm mysql2\n"),e.k0s()(),e.j41(76,"p"),e.EFF(77,"Once the installation process is complete, we can import the "),e.j41(78,"code"),e.EFF(79,"TypeOrmModule"),e.k0s(),e.EFF(80," into the root "),e.j41(81,"code"),e.EFF(82,"AppModule"),e.k0s(),e.EFF(83,"."),e.k0s(),e.j41(84,"span",40),e.EFF(85),e.nI1(86,"extension"),e.nrm(87,"app-tabs",null,1),e.k0s(),e.j41(89,"pre")(90,"code",41),e.EFF(91,"\nimport { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\n\n@Module({\n  imports: [\n    TypeOrmModule.forRoot({\n      type: 'mysql',\n      host: 'localhost',\n      port: 3306,\n      username: 'root',\n      password: 'root',\n      database: 'test',\n      entities: [],\n      synchronize: true,\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(92,"blockquote",42)(93,"strong"),e.EFF(94,"Warning"),e.k0s(),e.EFF(95," Setting "),e.j41(96,"code"),e.EFF(97,"synchronize: true"),e.k0s(),e.EFF(98," shouldn't be used in production - otherwise you can lose production data.\n"),e.k0s(),e.j41(99,"p"),e.EFF(100,"The "),e.j41(101,"code"),e.EFF(102,"forRoot()"),e.k0s(),e.EFF(103," method supports all the configuration properties exposed by the "),e.j41(104,"code"),e.EFF(105,"DataSource"),e.k0s(),e.EFF(106," constructor from the "),e.j41(107,"a",43),e.EFF(108,"TypeORM"),e.k0s(),e.EFF(109," package. In addition, there are several extra configuration properties described below."),e.k0s(),e.j41(110,"table")(111,"tr")(112,"td")(113,"code"),e.EFF(114,"retryAttempts"),e.k0s()(),e.j41(115,"td"),e.EFF(116,"Number of attempts to connect to the database (default: "),e.j41(117,"code"),e.EFF(118,"10"),e.k0s(),e.EFF(119,")"),e.k0s()(),e.j41(120,"tr")(121,"td")(122,"code"),e.EFF(123,"retryDelay"),e.k0s()(),e.j41(124,"td"),e.EFF(125,"Delay between connection retry attempts (ms) (default: "),e.j41(126,"code"),e.EFF(127,"3000"),e.k0s(),e.EFF(128,")"),e.k0s()(),e.j41(129,"tr")(130,"td")(131,"code"),e.EFF(132,"autoLoadEntities"),e.k0s()(),e.j41(133,"td"),e.EFF(134,"If "),e.j41(135,"code"),e.EFF(136,"true"),e.k0s(),e.EFF(137,", entities will be loaded automatically (default: "),e.j41(138,"code"),e.EFF(139,"false"),e.k0s(),e.EFF(140,")"),e.k0s()()(),e.j41(141,"blockquote",44)(142,"strong"),e.EFF(143,"Hint"),e.k0s(),e.EFF(144," Learn more about the data source options "),e.j41(145,"a",45),e.EFF(146,"here"),e.k0s(),e.EFF(147,".\n"),e.k0s(),e.j41(148,"p"),e.EFF(149,"Once this is done, the TypeORM "),e.j41(150,"code"),e.EFF(151,"DataSource"),e.k0s(),e.EFF(152," and "),e.j41(153,"code"),e.EFF(154,"EntityManager"),e.k0s(),e.EFF(155," objects will be available to inject across the entire project (without needing to import any modules), for example:"),e.k0s(),e.j41(156,"span",40),e.EFF(157),e.nI1(158,"extension"),e.nrm(159,"app-tabs",null,2),e.k0s(),e.j41(161,"pre")(162,"code",41),e.EFF(163,"\nimport { DataSource } from 'typeorm';\n\n@Module({\n  imports: [TypeOrmModule.forRoot(), UsersModule],\n})\nexport class AppModule {\n  constructor(private dataSource: DataSource) {}\n}\n"),e.k0s()(),e.j41(164,"pre")(165,"code",41),e.EFF(166,"\nimport { DataSource } from 'typeorm';\n\n@Dependencies(DataSource)\n@Module({\n  imports: [TypeOrmModule.forRoot(), UsersModule],\n})\nexport class AppModule {\n  constructor(dataSource) {\n    this.dataSource = dataSource;\n  }\n}\n"),e.k0s()(),e.j41(167,"h4",46)(168,"span"),e.EFF(169,"Repository pattern"),e.k0s()(),e.j41(170,"p")(171,"a",33),e.EFF(172,"TypeORM"),e.k0s(),e.EFF(173," supports the "),e.j41(174,"strong"),e.EFF(175,"repository design pattern"),e.k0s(),e.EFF(176,", so each entity has its own repository. These repositories can be obtained from the database data source."),e.k0s(),e.j41(177,"p"),e.EFF(178,"To continue the example, we need at least one entity. Let's define the "),e.j41(179,"code"),e.EFF(180,"User"),e.k0s(),e.EFF(181," entity."),e.k0s(),e.j41(182,"span",40),e.EFF(183),e.nI1(184,"extension"),e.nrm(185,"app-tabs",null,3),e.k0s(),e.j41(187,"pre")(188,"code",41),e.EFF(189,"\nimport { Entity, Column, PrimaryGeneratedColumn } from 'typeorm';\n\n@Entity()\nexport class User {\n  @PrimaryGeneratedColumn()\n  id: number;\n\n  @Column()\n  firstName: string;\n\n  @Column()\n  lastName: string;\n\n  @Column({ default: true })\n  isActive: boolean;\n}\n"),e.k0s()(),e.j41(190,"blockquote",44)(191,"strong"),e.EFF(192,"Hint"),e.k0s(),e.EFF(193," Learn more about entities\xa0in the "),e.j41(194,"a",47),e.EFF(195,"TypeORM documentation"),e.k0s(),e.EFF(196,".\n"),e.k0s(),e.j41(197,"p"),e.EFF(198,"The "),e.j41(199,"code"),e.EFF(200,"User"),e.k0s(),e.EFF(201," entity file sits in the "),e.j41(202,"code"),e.EFF(203,"users"),e.k0s(),e.EFF(204," directory. This directory contains all files related to the "),e.j41(205,"code"),e.EFF(206,"UsersModule"),e.k0s(),e.EFF(207,". You can decide where to keep your model files, however, we recommend creating them near their "),e.j41(208,"strong"),e.EFF(209,"domain"),e.k0s(),e.EFF(210,", in the corresponding module directory."),e.k0s(),e.j41(211,"p"),e.EFF(212,"To begin using the "),e.j41(213,"code"),e.EFF(214,"User"),e.k0s(),e.EFF(215," entity, we need to let TypeORM know about it by inserting it into the "),e.j41(216,"code"),e.EFF(217,"entities"),e.k0s(),e.EFF(218," array in the module "),e.j41(219,"code"),e.EFF(220,"forRoot()"),e.k0s(),e.EFF(221," method options (unless you use a static glob path):"),e.k0s(),e.j41(222,"span",40),e.EFF(223),e.nI1(224,"extension"),e.nrm(225,"app-tabs",null,4),e.k0s(),e.j41(227,"pre")(228,"code",41),e.EFF(229,"\nimport { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { User } from './users/user.entity';\n\n@Module({\n  imports: [\n    TypeOrmModule.forRoot({\n      type: 'mysql',\n      host: 'localhost',\n      port: 3306,\n      username: 'root',\n      password: 'root',\n      database: 'test',\n      entities: [User],\n      synchronize: true,\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(230,"p"),e.EFF(231,"Next, let's look at the "),e.j41(232,"code"),e.EFF(233,"UsersModule"),e.k0s(),e.EFF(234,":"),e.k0s(),e.j41(235,"span",40),e.EFF(236),e.nI1(237,"extension"),e.nrm(238,"app-tabs",null,5),e.k0s(),e.j41(240,"pre")(241,"code",41),e.EFF(242,"\nimport { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { UsersService } from './users.service';\nimport { UsersController } from './users.controller';\nimport { User } from './user.entity';\n\n@Module({\n  imports: [TypeOrmModule.forFeature([User])],\n  providers: [UsersService],\n  controllers: [UsersController],\n})\nexport class UsersModule {}\n"),e.k0s()(),e.j41(243,"p"),e.EFF(244,"This module uses the "),e.j41(245,"code"),e.EFF(246,"forFeature()"),e.k0s(),e.EFF(247," method to define which repositories are registered in the current scope. With that in place, we can inject the "),e.j41(248,"code"),e.EFF(249,"UsersRepository"),e.k0s(),e.EFF(250," into the "),e.j41(251,"code"),e.EFF(252,"UsersService"),e.k0s(),e.EFF(253," using the "),e.j41(254,"code"),e.EFF(255,"@InjectRepository()"),e.k0s(),e.EFF(256," decorator:"),e.k0s(),e.j41(257,"span",40),e.EFF(258),e.nI1(259,"extension"),e.nrm(260,"app-tabs",null,6),e.k0s(),e.j41(262,"pre")(263,"code",41),e.EFF(264,"\nimport { Injectable } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { User } from './user.entity';\n\n@Injectable()\nexport class UsersService {\n  constructor(\n    @InjectRepository(User)\n    private usersRepository: Repository<User>,\n  ) {}\n\n  findAll(): Promise<User[]> {\n    return this.usersRepository.find();\n  }\n\n  findOne(id: number): Promise<User | null> {\n    return this.usersRepository.findOneBy({ id });\n  }\n\n  async remove(id: number): Promise<void> {\n    await this.usersRepository.delete(id);\n  }\n}\n"),e.k0s()(),e.j41(265,"pre")(266,"code",41),e.EFF(267,"\nimport { Injectable, Dependencies } from '@nestjs/common';\nimport { getRepositoryToken } from '@nestjs/typeorm';\nimport { User } from './user.entity';\n\n@Injectable()\n@Dependencies(getRepositoryToken(User))\nexport class UsersService {\n  constructor(usersRepository) {\n    this.usersRepository = usersRepository;\n  }\n\n  findAll() {\n    return this.usersRepository.find();\n  }\n\n  findOne(id) {\n    return this.usersRepository.findOneBy({ id });\n  }\n\n  async remove(id) {\n    await this.usersRepository.delete(id);\n  }\n}\n"),e.k0s()(),e.j41(268,"blockquote",42)(269,"strong"),e.EFF(270,"Notice"),e.k0s(),e.EFF(271," Don't forget to import the "),e.j41(272,"code"),e.EFF(273,"UsersModule"),e.k0s(),e.EFF(274," into the root "),e.j41(275,"code"),e.EFF(276,"AppModule"),e.k0s(),e.EFF(277,".\n"),e.k0s(),e.j41(278,"p"),e.EFF(279,"If you want to use the repository outside of the module which imports "),e.j41(280,"code"),e.EFF(281,"TypeOrmModule.forFeature"),e.k0s(),e.EFF(282,", you'll need to re-export the providers generated by it.\nYou can do this by exporting the whole module, like this:"),e.k0s(),e.j41(283,"span",40),e.EFF(284),e.nI1(285,"extension"),e.nrm(286,"app-tabs",null,7),e.k0s(),e.j41(288,"pre")(289,"code",41),e.EFF(290,"\nimport { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { User } from './user.entity';\n\n@Module({\n  imports: [TypeOrmModule.forFeature([User])],\n  exports: [TypeOrmModule]\n})\nexport class UsersModule {}\n"),e.k0s()(),e.j41(291,"p"),e.EFF(292,"Now if we import "),e.j41(293,"code"),e.EFF(294,"UsersModule"),e.k0s(),e.EFF(295," in "),e.j41(296,"code"),e.EFF(297,"UserHttpModule"),e.k0s(),e.EFF(298,", we can use "),e.j41(299,"code"),e.EFF(300,"@InjectRepository(User)"),e.k0s(),e.EFF(301," in the providers of the latter module."),e.k0s(),e.j41(302,"span",40),e.EFF(303),e.nI1(304,"extension"),e.nrm(305,"app-tabs",null,8),e.k0s(),e.j41(307,"pre")(308,"code",41),e.EFF(309,"\nimport { Module } from '@nestjs/common';\nimport { UsersModule } from './users.module';\nimport { UsersService } from './users.service';\nimport { UsersController } from './users.controller';\n\n@Module({\n  imports: [UsersModule],\n  providers: [UsersService],\n  controllers: [UsersController]\n})\nexport class UserHttpModule {}\n"),e.k0s()(),e.j41(310,"h4",48)(311,"span"),e.EFF(312,"Relations"),e.k0s()(),e.j41(313,"p"),e.EFF(314,"Relations are associations established between two or more tables. Relations are based on common fields from each table, often involving primary and foreign keys."),e.k0s(),e.j41(315,"p"),e.EFF(316,"There are three types of relations:"),e.k0s(),e.j41(317,"table")(318,"tr")(319,"td")(320,"code"),e.EFF(321,"One-to-one"),e.k0s()(),e.j41(322,"td"),e.EFF(323,"Every row in the primary table has one and only one associated row in the foreign table. Use the "),e.j41(324,"code"),e.EFF(325,"@OneToOne()"),e.k0s(),e.EFF(326," decorator to define this type of relation."),e.k0s()(),e.j41(327,"tr")(328,"td")(329,"code"),e.EFF(330,"One-to-many / Many-to-one"),e.k0s()(),e.j41(331,"td"),e.EFF(332,"Every row in the primary table has one or more related rows in the foreign table. Use the "),e.j41(333,"code"),e.EFF(334,"@OneToMany()"),e.k0s(),e.EFF(335," and "),e.j41(336,"code"),e.EFF(337,"@ManyToOne()"),e.k0s(),e.EFF(338," decorators to define this type of relation."),e.k0s()(),e.j41(339,"tr")(340,"td")(341,"code"),e.EFF(342,"Many-to-many"),e.k0s()(),e.j41(343,"td"),e.EFF(344,"Every row in the primary table has many related rows in the foreign table, and every record in the foreign table has many related rows in the primary table. Use the "),e.j41(345,"code"),e.EFF(346,"@ManyToMany()"),e.k0s(),e.EFF(347," decorator to define this type of relation."),e.k0s()()(),e.j41(348,"p"),e.EFF(349,"To define relations in entities, use the corresponding "),e.j41(350,"strong"),e.EFF(351,"decorators"),e.k0s(),e.EFF(352,". For example, to define that each "),e.j41(353,"code"),e.EFF(354,"User"),e.k0s(),e.EFF(355," can have multiple photos, use the "),e.j41(356,"code"),e.EFF(357,"@OneToMany()"),e.k0s(),e.EFF(358," decorator."),e.k0s(),e.j41(359,"span",40),e.EFF(360),e.nI1(361,"extension"),e.nrm(362,"app-tabs",null,9),e.k0s(),e.j41(364,"pre")(365,"code",41),e.EFF(366,"\nimport { Entity, Column, PrimaryGeneratedColumn, OneToMany } from 'typeorm';\nimport { Photo } from '../photos/photo.entity';\n\n@Entity()\nexport class User {\n  @PrimaryGeneratedColumn()\n  id: number;\n\n  @Column()\n  firstName: string;\n\n  @Column()\n  lastName: string;\n\n  @Column({ default: true })\n  isActive: boolean;\n\n  @OneToMany(type => Photo, photo => photo.user)\n  photos: Photo[];\n}\n"),e.k0s()(),e.j41(367,"blockquote",44)(368,"strong"),e.EFF(369,"Hint"),e.k0s(),e.EFF(370," To learn more about relations in TypeORM, visit the "),e.j41(371,"a",49),e.EFF(372,"TypeORM documentation"),e.k0s(),e.EFF(373,".\n"),e.k0s(),e.j41(374,"h4",50)(375,"span"),e.EFF(376,"Auto-load entities"),e.k0s()(),e.j41(377,"p"),e.EFF(378,"Manually adding entities to the "),e.j41(379,"code"),e.EFF(380,"entities"),e.k0s(),e.EFF(381," array of the data source options can be tedious. In addition, referencing entities from the root module breaks application domain boundaries and causes leaking implementation details to other parts of the application. To address this issue, an alternative solution is provided. To automatically load entities, set the "),e.j41(382,"code"),e.EFF(383,"autoLoadEntities"),e.k0s(),e.EFF(384," property of the configuration object (passed into the "),e.j41(385,"code"),e.EFF(386,"forRoot()"),e.k0s(),e.EFF(387," method) to "),e.j41(388,"code"),e.EFF(389,"true"),e.k0s(),e.EFF(390,", as shown below:"),e.k0s(),e.j41(391,"span",40),e.EFF(392),e.nI1(393,"extension"),e.nrm(394,"app-tabs",null,10),e.k0s(),e.j41(396,"pre")(397,"code",41),e.EFF(398,"\nimport { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\n\n@Module({\n  imports: [\n    TypeOrmModule.forRoot({\n      ...\n      autoLoadEntities: true,\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(399,"p"),e.EFF(400,"With that option specified, every entity registered through the "),e.j41(401,"code"),e.EFF(402,"forFeature()"),e.k0s(),e.EFF(403," method will be automatically added to the "),e.j41(404,"code"),e.EFF(405,"entities"),e.k0s(),e.EFF(406," array of the configuration object."),e.k0s(),e.j41(407,"blockquote",42)(408,"strong"),e.EFF(409,"Warning"),e.k0s(),e.EFF(410," Note that entities that aren't registered through the "),e.j41(411,"code"),e.EFF(412,"forFeature()"),e.k0s(),e.EFF(413," method, but are only referenced from the entity (via a relationship), won't be included by way of the "),e.j41(414,"code"),e.EFF(415,"autoLoadEntities"),e.k0s(),e.EFF(416," setting.\n"),e.k0s(),e.j41(417,"h4",51)(418,"span"),e.EFF(419,"Separating entity definition"),e.k0s()(),e.j41(420,"p"),e.EFF(421,"You can define an entity and its columns right in the model, using decorators. But some people prefer to define entities and their columns inside separate files using the "),e.j41(422,"a",52),e.EFF(423,'"entity schemas"'),e.k0s(),e.EFF(424,"."),e.k0s(),e.j41(425,"pre")(426,"code",41),e.EFF(427,"\nimport { EntitySchema } from 'typeorm';\nimport { User } from './user.entity';\n\nexport const UserSchema = new EntitySchema<User>({\n  name: 'User',\n  target: User,\n  columns: {\n    id: {\n      type: Number,\n      primary: true,\n      generated: true,\n    },\n    firstName: {\n      type: String,\n    },\n    lastName: {\n      type: String,\n    },\n    isActive: {\n      type: Boolean,\n      default: true,\n    },\n  },\n  relations: {\n    photos: {\n      type: 'one-to-many',\n      target: 'Photo', // the name of the PhotoSchema\n    },\n  },\n});\n"),e.k0s()(),e.j41(428,"blockquote",53)(429,"strong"),e.EFF(430,"Warning"),e.k0s(),e.EFF(431," If you provide the "),e.j41(432,"code"),e.EFF(433,"target"),e.k0s(),e.EFF(434," option, the "),e.j41(435,"code"),e.EFF(436,"name"),e.k0s(),e.EFF(437," option value has to be the same as the name of the target class.\nIf you do not provide the "),e.j41(438,"code"),e.EFF(439,"target"),e.k0s(),e.EFF(440," you can use any name.\n"),e.k0s(),e.j41(441,"p"),e.EFF(442,"Nest allows you to use an "),e.j41(443,"code"),e.EFF(444,"EntitySchema"),e.k0s(),e.EFF(445," instance wherever an "),e.j41(446,"code"),e.EFF(447,"Entity"),e.k0s(),e.EFF(448," is expected, for example:"),e.k0s(),e.j41(449,"pre")(450,"code",41),e.EFF(451,"\nimport { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { UserSchema } from './user.schema';\nimport { UsersController } from './users.controller';\nimport { UsersService } from './users.service';\n\n@Module({\n  imports: [TypeOrmModule.forFeature([UserSchema])],\n  providers: [UsersService],\n  controllers: [UsersController],\n})\nexport class UsersModule {}\n"),e.k0s()(),e.j41(452,"h4",54)(453,"span"),e.EFF(454,"TypeORM Transactions"),e.k0s()(),e.j41(455,"p"),e.EFF(456,"A database transaction symbolizes a unit of work performed within a database management system against a database, and treated in a coherent and reliable way independent of other transactions. A transaction generally represents any change in a database ("),e.j41(457,"a",55),e.EFF(458,"learn more"),e.k0s(),e.EFF(459,")."),e.k0s(),e.j41(460,"p"),e.EFF(461,"There are many different strategies to handle "),e.j41(462,"a",56),e.EFF(463,"TypeORM transactions"),e.k0s(),e.EFF(464,". We recommend using the "),e.j41(465,"code"),e.EFF(466,"QueryRunner"),e.k0s(),e.EFF(467," class because it gives full control over the transaction."),e.k0s(),e.j41(468,"p"),e.EFF(469,"First, we need to inject the "),e.j41(470,"code"),e.EFF(471,"DataSource"),e.k0s(),e.EFF(472," object into a class in the normal way:"),e.k0s(),e.j41(473,"pre")(474,"code",41),e.EFF(475,"\n@Injectable()\nexport class UsersService {\n  constructor(private dataSource: DataSource) {}\n}\n"),e.k0s()(),e.j41(476,"blockquote",44)(477,"strong"),e.EFF(478,"Hint"),e.k0s(),e.EFF(479," The "),e.j41(480,"code"),e.EFF(481,"DataSource"),e.k0s(),e.EFF(482," class is imported from the "),e.j41(483,"code"),e.EFF(484,"typeorm"),e.k0s(),e.EFF(485," package.\n"),e.k0s(),e.j41(486,"p"),e.EFF(487,"Now, we can use this object to create a transaction."),e.k0s(),e.j41(488,"pre")(489,"code",41),e.EFF(490,"\nasync createMany(users: User[]) {\n  const queryRunner = this.dataSource.createQueryRunner();\n\n  await queryRunner.connect();\n  await queryRunner.startTransaction();\n  try {\n    await queryRunner.manager.save(users[0]);\n    await queryRunner.manager.save(users[1]);\n\n    await queryRunner.commitTransaction();\n  } catch (err) {\n    // since we have errors lets rollback the changes we made\n    await queryRunner.rollbackTransaction();\n  } finally {\n    // you need to release a queryRunner which was manually instantiated\n    await queryRunner.release();\n  }\n}\n"),e.k0s()(),e.j41(491,"blockquote",44)(492,"strong"),e.EFF(493,"Hint"),e.k0s(),e.EFF(494," Note that the "),e.j41(495,"code"),e.EFF(496,"dataSource"),e.k0s(),e.EFF(497," is used only to create the "),e.j41(498,"code"),e.EFF(499,"QueryRunner"),e.k0s(),e.EFF(500,". However, to test this class would require mocking the entire "),e.j41(501,"code"),e.EFF(502,"DataSource"),e.k0s(),e.EFF(503," object (which exposes several methods). Thus, we recommend using a helper factory class (e.g., "),e.j41(504,"code"),e.EFF(505,"QueryRunnerFactory"),e.k0s(),e.EFF(506,") and defining an interface with a limited set of methods required to maintain transactions. This technique makes mocking these methods pretty straightforward.\n"),e.k0s(),e.j41(507,"p"),e.nrm(508,"app-banner-devtools"),e.k0s(),e.j41(509,"p"),e.EFF(510,"Alternatively, you can use the callback-style approach with the "),e.j41(511,"code"),e.EFF(512,"transaction"),e.k0s(),e.EFF(513," method of the "),e.j41(514,"code"),e.EFF(515,"DataSource"),e.k0s(),e.EFF(516," object ("),e.j41(517,"a",57),e.EFF(518,"read more"),e.k0s(),e.EFF(519,")."),e.k0s(),e.j41(520,"pre")(521,"code",41),e.EFF(522,"\nasync createMany(users: User[]) {\n  await this.dataSource.transaction(async manager => {\n    await manager.save(users[0]);\n    await manager.save(users[1]);\n  });\n}\n"),e.k0s()(),e.j41(523,"h4",58)(524,"span"),e.EFF(525,"Subscribers"),e.k0s()(),e.j41(526,"p"),e.EFF(527,"With TypeORM "),e.j41(528,"a",59),e.EFF(529,"subscribers"),e.k0s(),e.EFF(530,", you can listen to specific entity events."),e.k0s(),e.j41(531,"pre")(532,"code",41),e.EFF(533,"\nimport {\n  DataSource,\n  EntitySubscriberInterface,\n  EventSubscriber,\n  InsertEvent,\n} from 'typeorm';\nimport { User } from './user.entity';\n\n@EventSubscriber()\nexport class UserSubscriber implements EntitySubscriberInterface<User> {\n  constructor(dataSource: DataSource) {\n    dataSource.subscribers.push(this);\n  }\n\n  listenTo() {\n    return User;\n  }\n\n  beforeInsert(event: InsertEvent<User>) {\n    console.log(`BEFORE USER INSERTED: `, event.entity);\n  }\n}\n"),e.k0s()(),e.j41(534,"blockquote",60)(535,"strong"),e.EFF(536,"Warning"),e.k0s(),e.EFF(537," Event subscribers can not be "),e.j41(538,"a",61),e.EFF(539,"request-scoped"),e.k0s(),e.EFF(540,".\n"),e.k0s(),e.j41(541,"p"),e.EFF(542,"Now, add the "),e.j41(543,"code"),e.EFF(544,"UserSubscriber"),e.k0s(),e.EFF(545," class to the "),e.j41(546,"code"),e.EFF(547,"providers"),e.k0s(),e.EFF(548," array:"),e.k0s(),e.j41(549,"pre")(550,"code",41),e.EFF(551,"\nimport { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { User } from './user.entity';\nimport { UsersController } from './users.controller';\nimport { UsersService } from './users.service';\nimport { UserSubscriber } from './user.subscriber';\n\n@Module({\n  imports: [TypeOrmModule.forFeature([User])],\n  providers: [UsersService, UserSubscriber],\n  controllers: [UsersController],\n})\nexport class UsersModule {}\n"),e.k0s()(),e.j41(552,"blockquote",44)(553,"strong"),e.EFF(554,"Hint"),e.k0s(),e.EFF(555," Learn more about entity subscribers "),e.j41(556,"a",59),e.EFF(557,"here"),e.k0s(),e.EFF(558,".\n"),e.k0s(),e.j41(559,"h4",62)(560,"span"),e.EFF(561,"Migrations"),e.k0s()(),e.j41(562,"p")(563,"a",63),e.EFF(564,"Migrations"),e.k0s(),e.EFF(565," provide a way to incrementally update the database schema to keep it in sync with the application's data model while preserving existing data in the database. To generate, run, and revert migrations, TypeORM provides a dedicated "),e.j41(566,"a",64),e.EFF(567,"CLI"),e.k0s(),e.EFF(568,"."),e.k0s(),e.j41(569,"p"),e.EFF(570,"Migration classes are separate from the Nest application source code. Their lifecycle is maintained by the TypeORM CLI. Therefore, you are not able to leverage dependency injection and other Nest specific features with migrations. To learn more about migrations, follow the guide in the "),e.j41(571,"a",64),e.EFF(572,"TypeORM documentation"),e.k0s(),e.EFF(573,"."),e.k0s(),e.j41(574,"h4",65)(575,"span"),e.EFF(576,"Multiple databases"),e.k0s()(),e.j41(577,"p"),e.EFF(578,"Some projects require multiple database connections. This can also be achieved with this module. To work with multiple connections, first create the connections. In this case, data source naming becomes "),e.j41(579,"strong"),e.EFF(580,"mandatory"),e.k0s(),e.EFF(581,"."),e.k0s(),e.j41(582,"p"),e.EFF(583,"Suppose you have an "),e.j41(584,"code"),e.EFF(585,"Album"),e.k0s(),e.EFF(586," entity stored in its own database."),e.k0s(),e.j41(587,"pre")(588,"code",41),e.EFF(589,"\nconst defaultOptions = {\n  type: 'postgres',\n  port: 5432,\n  username: 'user',\n  password: 'password',\n  database: 'db',\n  synchronize: true,\n};\n\n@Module({\n  imports: [\n    TypeOrmModule.forRoot({\n      ...defaultOptions,\n      host: 'user_db_host',\n      entities: [User],\n    }),\n    TypeOrmModule.forRoot({\n      ...defaultOptions,\n      name: 'albumsConnection',\n      host: 'album_db_host',\n      entities: [Album],\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(590,"blockquote",42)(591,"strong"),e.EFF(592,"Notice"),e.k0s(),e.EFF(593," If you don't set the "),e.j41(594,"code"),e.EFF(595,"name"),e.k0s(),e.EFF(596," for a data source, its name is set to "),e.j41(597,"code"),e.EFF(598,"default"),e.k0s(),e.EFF(599,". Please note that you shouldn't have multiple connections without a name, or with the same name, otherwise they will get overridden.\n"),e.k0s(),e.j41(600,"blockquote",42)(601,"strong"),e.EFF(602,"Notice"),e.k0s(),e.EFF(603," If you are using "),e.j41(604,"code"),e.EFF(605,"TypeOrmModule.forRootAsync"),e.k0s(),e.EFF(606,", you have to "),e.j41(607,"strong"),e.EFF(608,"also"),e.k0s(),e.EFF(609," set the data source name outside "),e.j41(610,"code"),e.EFF(611,"useFactory"),e.k0s(),e.EFF(612,". For example:\n"),e.j41(613,"pre")(614,"code",41),e.EFF(615,"\nTypeOrmModule.forRootAsync({\n  name: 'albumsConnection',\n  useFactory: ...,\n  inject: ...,\n}),\n"),e.k0s()(),e.j41(616,"p"),e.EFF(617,"See "),e.j41(618,"a",66),e.EFF(619,"this issue"),e.k0s(),e.EFF(620," for more details."),e.k0s()(),e.j41(621,"p"),e.EFF(622,"At this point, you have "),e.j41(623,"code"),e.EFF(624,"User"),e.k0s(),e.EFF(625," and "),e.j41(626,"code"),e.EFF(627,"Album"),e.k0s(),e.EFF(628," entities registered with their own data source. With this setup, you have to tell the "),e.j41(629,"code"),e.EFF(630,"TypeOrmModule.forFeature()"),e.k0s(),e.EFF(631," method and the "),e.j41(632,"code"),e.EFF(633,"@InjectRepository()"),e.k0s(),e.EFF(634," decorator which data source should be used. If you do not pass any data source name, the "),e.j41(635,"code"),e.EFF(636,"default"),e.k0s(),e.EFF(637," data source is used."),e.k0s(),e.j41(638,"pre")(639,"code",41),e.EFF(640,"\n@Module({\n  imports: [\n    TypeOrmModule.forFeature([User]),\n    TypeOrmModule.forFeature([Album], 'albumsConnection'),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(641,"p"),e.EFF(642,"You can also inject the "),e.j41(643,"code"),e.EFF(644,"DataSource"),e.k0s(),e.EFF(645," or "),e.j41(646,"code"),e.EFF(647,"EntityManager"),e.k0s(),e.EFF(648," for a given data source:"),e.k0s(),e.j41(649,"pre")(650,"code",41),e.EFF(651,"\n@Injectable()\nexport class AlbumsService {\n  constructor(\n    @InjectDataSource('albumsConnection')\n    private dataSource: DataSource,\n    @InjectEntityManager('albumsConnection')\n    private entityManager: EntityManager,\n  ) {}\n}\n"),e.k0s()(),e.j41(652,"p"),e.EFF(653,"It's also possible to inject any "),e.j41(654,"code"),e.EFF(655,"DataSource"),e.k0s(),e.EFF(656," to the providers:"),e.k0s(),e.j41(657,"pre")(658,"code",41),e.EFF(659,"\n@Module({\n  providers: [\n    {\n      provide: AlbumsService,\n      useFactory: (albumsConnection: DataSource) => {\n        return new AlbumsService(albumsConnection);\n      },\n      inject: [getDataSourceToken('albumsConnection')],\n    },\n  ],\n})\nexport class AlbumsModule {}\n"),e.k0s()(),e.j41(660,"h4",67)(661,"span"),e.EFF(662,"Testing"),e.k0s()(),e.j41(663,"p"),e.EFF(664,"When it comes to unit testing an application, we usually want to avoid making a database connection, keeping our test suites independent and their execution process as fast as possible. But our classes might depend on repositories that are pulled from the data source (connection) instance. How do we handle that? The solution is to create mock repositories. In order to achieve that, we set up "),e.j41(665,"a",68),e.EFF(666,"custom providers"),e.k0s(),e.EFF(667,". Each registered repository is automatically represented by an "),e.j41(668,"code"),e.EFF(669,"<EntityName>Repository"),e.k0s(),e.EFF(670," token, where "),e.j41(671,"code"),e.EFF(672,"EntityName"),e.k0s(),e.EFF(673," is the name of your entity class."),e.k0s(),e.j41(674,"p"),e.EFF(675,"The "),e.j41(676,"code"),e.EFF(677,"@nestjs/typeorm"),e.k0s(),e.EFF(678," package exposes the "),e.j41(679,"code"),e.EFF(680,"getRepositoryToken()"),e.k0s(),e.EFF(681," function which returns a prepared token based on a given entity."),e.k0s(),e.j41(682,"pre")(683,"code",41),e.EFF(684,"\n@Module({\n  providers: [\n    UsersService,\n    {\n      provide: getRepositoryToken(User),\n      useValue: mockRepository,\n    },\n  ],\n})\nexport class UsersModule {}\n"),e.k0s()(),e.j41(685,"p"),e.EFF(686,"Now a substitute "),e.j41(687,"code"),e.EFF(688,"mockRepository"),e.k0s(),e.EFF(689," will be used as the "),e.j41(690,"code"),e.EFF(691,"UsersRepository"),e.k0s(),e.EFF(692,". Whenever any class asks for "),e.j41(693,"code"),e.EFF(694,"UsersRepository"),e.k0s(),e.EFF(695," using an "),e.j41(696,"code"),e.EFF(697,"@InjectRepository()"),e.k0s(),e.EFF(698," decorator, Nest will use the registered "),e.j41(699,"code"),e.EFF(700,"mockRepository"),e.k0s(),e.EFF(701," object."),e.k0s(),e.j41(702,"h4",69)(703,"span"),e.EFF(704,"Async configuration"),e.k0s()(),e.j41(705,"p"),e.EFF(706,"You may want to pass your repository module options asynchronously instead of statically. In this case, use the "),e.j41(707,"code"),e.EFF(708,"forRootAsync()"),e.k0s(),e.EFF(709," method, which provides several ways to deal with async configuration."),e.k0s(),e.j41(710,"p"),e.EFF(711,"One approach is to use a factory function:"),e.k0s(),e.j41(712,"pre")(713,"code",41),e.EFF(714,"\nTypeOrmModule.forRootAsync({\n  useFactory: () => ({\n    type: 'mysql',\n    host: 'localhost',\n    port: 3306,\n    username: 'root',\n    password: 'root',\n    database: 'test',\n    entities: [],\n    synchronize: true,\n  }),\n});\n"),e.k0s()(),e.j41(715,"p"),e.EFF(716,"Our factory behaves like any other "),e.j41(717,"a",70),e.EFF(718,"asynchronous provider"),e.k0s(),e.EFF(719," (e.g., it can be "),e.j41(720,"code"),e.EFF(721,"async"),e.k0s(),e.EFF(722," and it's able to inject dependencies through "),e.j41(723,"code"),e.EFF(724,"inject"),e.k0s(),e.EFF(725,")."),e.k0s(),e.j41(726,"pre")(727,"code",41),e.EFF(728,"\nTypeOrmModule.forRootAsync({\n  imports: [ConfigModule],\n  useFactory: (configService: ConfigService) => ({\n    type: 'mysql',\n    host: configService.get('HOST'),\n    port: +configService.get('PORT'),\n    username: configService.get('USERNAME'),\n    password: configService.get('PASSWORD'),\n    database: configService.get('DATABASE'),\n    entities: [],\n    synchronize: true,\n  }),\n  inject: [ConfigService],\n});\n"),e.k0s()(),e.j41(729,"p"),e.EFF(730,"Alternatively, you can use the "),e.j41(731,"code"),e.EFF(732,"useClass"),e.k0s(),e.EFF(733," syntax:"),e.k0s(),e.j41(734,"pre")(735,"code",41),e.EFF(736,"\nTypeOrmModule.forRootAsync({\n  useClass: TypeOrmConfigService,\n});\n"),e.k0s()(),e.j41(737,"p"),e.EFF(738,"The construction above will instantiate "),e.j41(739,"code"),e.EFF(740,"TypeOrmConfigService"),e.k0s(),e.EFF(741," inside "),e.j41(742,"code"),e.EFF(743,"TypeOrmModule"),e.k0s(),e.EFF(744," and use it to provide an options object by calling "),e.j41(745,"code"),e.EFF(746,"createTypeOrmOptions()"),e.k0s(),e.EFF(747,". Note that this means that the "),e.j41(748,"code"),e.EFF(749,"TypeOrmConfigService"),e.k0s(),e.EFF(750," has to implement the "),e.j41(751,"code"),e.EFF(752,"TypeOrmOptionsFactory"),e.k0s(),e.EFF(753," interface, as shown below:"),e.k0s(),e.j41(754,"pre")(755,"code",41),e.EFF(756,"\n@Injectable()\nexport class TypeOrmConfigService implements TypeOrmOptionsFactory {\n  createTypeOrmOptions(): TypeOrmModuleOptions {\n    return {\n      type: 'mysql',\n      host: 'localhost',\n      port: 3306,\n      username: 'root',\n      password: 'root',\n      database: 'test',\n      entities: [],\n      synchronize: true,\n    };\n  }\n}\n"),e.k0s()(),e.j41(757,"p"),e.EFF(758,"In order to prevent the creation of "),e.j41(759,"code"),e.EFF(760,"TypeOrmConfigService"),e.k0s(),e.EFF(761," inside "),e.j41(762,"code"),e.EFF(763,"TypeOrmModule"),e.k0s(),e.EFF(764," and use a provider imported from a different module, you can use the "),e.j41(765,"code"),e.EFF(766,"useExisting"),e.k0s(),e.EFF(767," syntax."),e.k0s(),e.j41(768,"pre")(769,"code",41),e.EFF(770,"\nTypeOrmModule.forRootAsync({\n  imports: [ConfigModule],\n  useExisting: ConfigService,\n});\n"),e.k0s()(),e.j41(771,"p"),e.EFF(772,"This construction works the same as "),e.j41(773,"code"),e.EFF(774,"useClass"),e.k0s(),e.EFF(775," with one critical difference - "),e.j41(776,"code"),e.EFF(777,"TypeOrmModule"),e.k0s(),e.EFF(778," will lookup imported modules to reuse an existing "),e.j41(779,"code"),e.EFF(780,"ConfigService"),e.k0s(),e.EFF(781," instead of instantiating a new one."),e.k0s(),e.j41(782,"blockquote",44)(783,"strong"),e.EFF(784,"Hint"),e.k0s(),e.EFF(785," Make sure that the "),e.j41(786,"code"),e.EFF(787,"name"),e.k0s(),e.EFF(788," property is defined at the same level as the "),e.j41(789,"code"),e.EFF(790,"useFactory"),e.k0s(),e.EFF(791,", "),e.j41(792,"code"),e.EFF(793,"useClass"),e.k0s(),e.EFF(794,", or "),e.j41(795,"code"),e.EFF(796,"useValue"),e.k0s(),e.EFF(797," property. This will allow Nest to properly register the data source under the appropriate injection token.\n"),e.k0s(),e.j41(798,"h4",71)(799,"span"),e.EFF(800,"Custom DataSource Factory"),e.k0s()(),e.j41(801,"p"),e.EFF(802,"In conjunction with async configuration using "),e.j41(803,"code"),e.EFF(804,"useFactory"),e.k0s(),e.EFF(805,", "),e.j41(806,"code"),e.EFF(807,"useClass"),e.k0s(),e.EFF(808,", or "),e.j41(809,"code"),e.EFF(810,"useExisting"),e.k0s(),e.EFF(811,", you can optionally specify a "),e.j41(812,"code"),e.EFF(813,"dataSourceFactory"),e.k0s(),e.EFF(814," function which will allow you to provide your own TypeORM data source rather than allowing "),e.j41(815,"code"),e.EFF(816,"TypeOrmModule"),e.k0s(),e.EFF(817," to create the data source."),e.k0s(),e.j41(818,"p")(819,"code"),e.EFF(820,"dataSourceFactory"),e.k0s(),e.EFF(821," receives the TypeORM "),e.j41(822,"code"),e.EFF(823,"DataSourceOptions"),e.k0s(),e.EFF(824," configured during async configuration using "),e.j41(825,"code"),e.EFF(826,"useFactory"),e.k0s(),e.EFF(827,", "),e.j41(828,"code"),e.EFF(829,"useClass"),e.k0s(),e.EFF(830,", or "),e.j41(831,"code"),e.EFF(832,"useExisting"),e.k0s(),e.EFF(833," and returns a "),e.j41(834,"code"),e.EFF(835,"Promise"),e.k0s(),e.EFF(836," that resolves a TypeORM "),e.j41(837,"code"),e.EFF(838,"DataSource"),e.k0s(),e.EFF(839,"."),e.k0s(),e.j41(840,"pre")(841,"code",41),e.EFF(842,"\nTypeOrmModule.forRootAsync({\n  imports: [ConfigModule],\n  inject: [ConfigService],\n  // Use useFactory, useClass, or useExisting\n  // to configure the DataSourceOptions.\n  useFactory: (configService: ConfigService) => ({\n    type: 'mysql',\n    host: configService.get('HOST'),\n    port: +configService.get('PORT'),\n    username: configService.get('USERNAME'),\n    password: configService.get('PASSWORD'),\n    database: configService.get('DATABASE'),\n    entities: [],\n    synchronize: true,\n  }),\n  // dataSource receives the configured DataSourceOptions\n  // and returns a Promise<DataSource>.\n  dataSourceFactory: async (options) => {\n    const dataSource = await new DataSource(options).initialize();\n    return dataSource;\n  },\n});\n"),e.k0s()(),e.j41(843,"blockquote",44)(844,"strong"),e.EFF(845,"Hint"),e.k0s(),e.EFF(846," The "),e.j41(847,"code"),e.EFF(848,"DataSource"),e.k0s(),e.EFF(849," class is imported from the "),e.j41(850,"code"),e.EFF(851,"typeorm"),e.k0s(),e.EFF(852," package.\n"),e.k0s(),e.j41(853,"h4",72)(854,"span"),e.EFF(855,"Example"),e.k0s()(),e.j41(856,"p"),e.EFF(857,"A working example is available "),e.j41(858,"a",73),e.EFF(859,"here"),e.k0s(),e.EFF(860,"."),e.k0s(),e.j41(861,"p"),e.nrm(862,"app-banner-enterprise"),e.k0s(),e.j41(863,"h3",74),e.EFF(864,"Sequelize Integration"),e.k0s(),e.j41(865,"p"),e.EFF(866,"An alternative to using TypeORM is to use the "),e.j41(867,"a",29),e.EFF(868,"Sequelize"),e.k0s(),e.EFF(869," ORM with the "),e.j41(870,"code"),e.EFF(871,"@nestjs/sequelize"),e.k0s(),e.EFF(872," package. In addition, we leverage the "),e.j41(873,"a",75),e.EFF(874,"sequelize-typescript"),e.k0s(),e.EFF(875," package which provides a set of additional decorators to declaratively define entities."),e.k0s(),e.j41(876,"p"),e.EFF(877,"To begin using it, we first install the required dependencies. In this chapter, we'll demonstrate using the popular "),e.j41(878,"a",38),e.EFF(879,"MySQL"),e.k0s(),e.EFF(880," Relational DBMS, but Sequelize provides support for many relational databases, such as PostgreSQL, MySQL, Microsoft SQL Server, SQLite, and MariaDB. The procedure we walk through in this chapter will be the same for any database supported by Sequelize. You'll simply need to install the associated client API libraries for your selected database."),e.k0s(),e.j41(881,"pre")(882,"code",39),e.EFF(883,"\n$ npm install --save @nestjs/sequelize sequelize sequelize-typescript mysql2\n$ npm install --save-dev @types/sequelize\n"),e.k0s()(),e.j41(884,"p"),e.EFF(885,"Once the installation process is complete, we can import the "),e.j41(886,"code"),e.EFF(887,"SequelizeModule"),e.k0s(),e.EFF(888," into the root "),e.j41(889,"code"),e.EFF(890,"AppModule"),e.k0s(),e.EFF(891,"."),e.k0s(),e.j41(892,"span",40),e.EFF(893),e.nI1(894,"extension"),e.nrm(895,"app-tabs",null,11),e.k0s(),e.j41(897,"pre")(898,"code",41),e.EFF(899,"\nimport { Module } from '@nestjs/common';\nimport { SequelizeModule } from '@nestjs/sequelize';\n\n@Module({\n  imports: [\n    SequelizeModule.forRoot({\n      dialect: 'mysql',\n      host: 'localhost',\n      port: 3306,\n      username: 'root',\n      password: 'root',\n      database: 'test',\n      models: [],\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(900,"p"),e.EFF(901,"The "),e.j41(902,"code"),e.EFF(903,"forRoot()"),e.k0s(),e.EFF(904," method supports all the configuration properties exposed by the Sequelize constructor ("),e.j41(905,"a",76),e.EFF(906,"read more"),e.k0s(),e.EFF(907,"). In addition, there are several extra configuration properties described below."),e.k0s(),e.j41(908,"table")(909,"tr")(910,"td")(911,"code"),e.EFF(912,"retryAttempts"),e.k0s()(),e.j41(913,"td"),e.EFF(914,"Number of attempts to connect to the database (default: "),e.j41(915,"code"),e.EFF(916,"10"),e.k0s(),e.EFF(917,")"),e.k0s()(),e.j41(918,"tr")(919,"td")(920,"code"),e.EFF(921,"retryDelay"),e.k0s()(),e.j41(922,"td"),e.EFF(923,"Delay between connection retry attempts (ms) (default: "),e.j41(924,"code"),e.EFF(925,"3000"),e.k0s(),e.EFF(926,")"),e.k0s()(),e.j41(927,"tr")(928,"td")(929,"code"),e.EFF(930,"autoLoadModels"),e.k0s()(),e.j41(931,"td"),e.EFF(932,"If "),e.j41(933,"code"),e.EFF(934,"true"),e.k0s(),e.EFF(935,", models will be loaded automatically (default: "),e.j41(936,"code"),e.EFF(937,"false"),e.k0s(),e.EFF(938,")"),e.k0s()(),e.j41(939,"tr")(940,"td")(941,"code"),e.EFF(942,"keepConnectionAlive"),e.k0s()(),e.j41(943,"td"),e.EFF(944,"If "),e.j41(945,"code"),e.EFF(946,"true"),e.k0s(),e.EFF(947,", connection will not be closed on the application shutdown (default: "),e.j41(948,"code"),e.EFF(949,"false"),e.k0s(),e.EFF(950,")"),e.k0s()(),e.j41(951,"tr")(952,"td")(953,"code"),e.EFF(954,"synchronize"),e.k0s()(),e.j41(955,"td"),e.EFF(956,"If "),e.j41(957,"code"),e.EFF(958,"true"),e.k0s(),e.EFF(959,", automatically loaded models will be synchronized (default: "),e.j41(960,"code"),e.EFF(961,"true"),e.k0s(),e.EFF(962,")"),e.k0s()()(),e.j41(963,"p"),e.EFF(964,"Once this is done, the "),e.j41(965,"code"),e.EFF(966,"Sequelize"),e.k0s(),e.EFF(967," object will be available to inject across the entire project (without needing to import any modules), for example:"),e.k0s(),e.j41(968,"span",40),e.EFF(969),e.nI1(970,"extension"),e.nrm(971,"app-tabs",null,12),e.k0s(),e.j41(973,"pre")(974,"code",41),e.EFF(975,"\nimport { Injectable } from '@nestjs/common';\nimport { Sequelize } from 'sequelize-typescript';\n\n@Injectable()\nexport class AppService {\n  constructor(private sequelize: Sequelize) {}\n}\n"),e.k0s()(),e.j41(976,"pre")(977,"code",41),e.EFF(978,"\nimport { Injectable } from '@nestjs/common';\nimport { Sequelize } from 'sequelize-typescript';\n\n@Dependencies(Sequelize)\n@Injectable()\nexport class AppService {\n  constructor(sequelize) {\n    this.sequelize = sequelize;\n  }\n}\n"),e.k0s()(),e.j41(979,"h4",77)(980,"span"),e.EFF(981,"Models"),e.k0s()(),e.j41(982,"p"),e.EFF(983,"Sequelize implements the Active Record pattern. With this pattern, you use model classes directly to interact with the database. To continue the example, we need at least one model. Let's define the "),e.j41(984,"code"),e.EFF(985,"User"),e.k0s(),e.EFF(986," model."),e.k0s(),e.j41(987,"span",40),e.EFF(988),e.nI1(989,"extension"),e.nrm(990,"app-tabs",null,13),e.k0s(),e.j41(992,"pre")(993,"code",41),e.EFF(994,"\nimport { Column, Model, Table } from 'sequelize-typescript';\n\n@Table\nexport class User extends Model {\n  @Column\n  firstName: string;\n\n  @Column\n  lastName: string;\n\n  @Column({ defaultValue: true })\n  isActive: boolean;\n}\n"),e.k0s()(),e.j41(995,"blockquote",44)(996,"strong"),e.EFF(997,"Hint"),e.k0s(),e.EFF(998," Learn more about the available decorators "),e.j41(999,"a",78),e.EFF(1e3,"here"),e.k0s(),e.EFF(1001,".\n"),e.k0s(),e.j41(1002,"p"),e.EFF(1003,"The "),e.j41(1004,"code"),e.EFF(1005,"User"),e.k0s(),e.EFF(1006," model file sits in the "),e.j41(1007,"code"),e.EFF(1008,"users"),e.k0s(),e.EFF(1009," directory. This directory contains all files related to the "),e.j41(1010,"code"),e.EFF(1011,"UsersModule"),e.k0s(),e.EFF(1012,". You can decide where to keep your model files, however, we recommend creating them near their "),e.j41(1013,"strong"),e.EFF(1014,"domain"),e.k0s(),e.EFF(1015,", in the corresponding module directory."),e.k0s(),e.j41(1016,"p"),e.EFF(1017,"To begin using the "),e.j41(1018,"code"),e.EFF(1019,"User"),e.k0s(),e.EFF(1020," model, we need to let Sequelize know about it by inserting it into the "),e.j41(1021,"code"),e.EFF(1022,"models"),e.k0s(),e.EFF(1023," array in the module "),e.j41(1024,"code"),e.EFF(1025,"forRoot()"),e.k0s(),e.EFF(1026," method options:"),e.k0s(),e.j41(1027,"span",40),e.EFF(1028),e.nI1(1029,"extension"),e.nrm(1030,"app-tabs",null,14),e.k0s(),e.j41(1032,"pre")(1033,"code",41),e.EFF(1034,"\nimport { Module } from '@nestjs/common';\nimport { SequelizeModule } from '@nestjs/sequelize';\nimport { User } from './users/user.model';\n\n@Module({\n  imports: [\n    SequelizeModule.forRoot({\n      dialect: 'mysql',\n      host: 'localhost',\n      port: 3306,\n      username: 'root',\n      password: 'root',\n      database: 'test',\n      models: [User],\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(1035,"p"),e.EFF(1036,"Next, let's look at the "),e.j41(1037,"code"),e.EFF(1038,"UsersModule"),e.k0s(),e.EFF(1039,":"),e.k0s(),e.j41(1040,"span",40),e.EFF(1041),e.nI1(1042,"extension"),e.nrm(1043,"app-tabs",null,15),e.k0s(),e.j41(1045,"pre")(1046,"code",41),e.EFF(1047,"\nimport { Module } from '@nestjs/common';\nimport { SequelizeModule } from '@nestjs/sequelize';\nimport { User } from './user.model';\nimport { UsersController } from './users.controller';\nimport { UsersService } from './users.service';\n\n@Module({\n  imports: [SequelizeModule.forFeature([User])],\n  providers: [UsersService],\n  controllers: [UsersController],\n})\nexport class UsersModule {}\n"),e.k0s()(),e.j41(1048,"p"),e.EFF(1049,"This module uses the "),e.j41(1050,"code"),e.EFF(1051,"forFeature()"),e.k0s(),e.EFF(1052," method to define which models are registered in the current scope. With that in place, we can inject the "),e.j41(1053,"code"),e.EFF(1054,"UserModel"),e.k0s(),e.EFF(1055," into the "),e.j41(1056,"code"),e.EFF(1057,"UsersService"),e.k0s(),e.EFF(1058," using the "),e.j41(1059,"code"),e.EFF(1060,"@InjectModel()"),e.k0s(),e.EFF(1061," decorator:"),e.k0s(),e.j41(1062,"span",40),e.EFF(1063),e.nI1(1064,"extension"),e.nrm(1065,"app-tabs",null,16),e.k0s(),e.j41(1067,"pre")(1068,"code",41),e.EFF(1069,"\nimport { Injectable } from '@nestjs/common';\nimport { InjectModel } from '@nestjs/sequelize';\nimport { User } from './user.model';\n\n@Injectable()\nexport class UsersService {\n  constructor(\n    @InjectModel(User)\n    private userModel: typeof User,\n  ) {}\n\n  async findAll(): Promise<User[]> {\n    return this.userModel.findAll();\n  }\n\n  findOne(id: string): Promise<User> {\n    return this.userModel.findOne({\n      where: {\n        id,\n      },\n    });\n  }\n\n  async remove(id: string): Promise<void> {\n    const user = await this.findOne(id);\n    await user.destroy();\n  }\n}\n"),e.k0s()(),e.j41(1070,"pre")(1071,"code",41),e.EFF(1072,"\nimport { Injectable, Dependencies } from '@nestjs/common';\nimport { getModelToken } from '@nestjs/sequelize';\nimport { User } from './user.model';\n\n@Injectable()\n@Dependencies(getModelToken(User))\nexport class UsersService {\n  constructor(usersRepository) {\n    this.usersRepository = usersRepository;\n  }\n\n  async findAll() {\n    return this.userModel.findAll();\n  }\n\n  findOne(id) {\n    return this.userModel.findOne({\n      where: {\n        id,\n      },\n    });\n  }\n\n  async remove(id) {\n    const user = await this.findOne(id);\n    await user.destroy();\n  }\n}\n"),e.k0s()(),e.j41(1073,"blockquote",42)(1074,"strong"),e.EFF(1075,"Notice"),e.k0s(),e.EFF(1076," Don't forget to import the "),e.j41(1077,"code"),e.EFF(1078,"UsersModule"),e.k0s(),e.EFF(1079," into the root "),e.j41(1080,"code"),e.EFF(1081,"AppModule"),e.k0s(),e.EFF(1082,".\n"),e.k0s(),e.j41(1083,"p"),e.EFF(1084,"If you want to use the repository outside of the module which imports "),e.j41(1085,"code"),e.EFF(1086,"SequelizeModule.forFeature"),e.k0s(),e.EFF(1087,", you'll need to re-export the providers generated by it.\nYou can do this by exporting the whole module, like this:"),e.k0s(),e.j41(1088,"span",40),e.EFF(1089),e.nI1(1090,"extension"),e.nrm(1091,"app-tabs",null,17),e.k0s(),e.j41(1093,"pre")(1094,"code",41),e.EFF(1095,"\nimport { Module } from '@nestjs/common';\nimport { SequelizeModule } from '@nestjs/sequelize';\nimport { User } from './user.entity';\n\n@Module({\n  imports: [SequelizeModule.forFeature([User])],\n  exports: [SequelizeModule]\n})\nexport class UsersModule {}\n"),e.k0s()(),e.j41(1096,"p"),e.EFF(1097,"Now if we import "),e.j41(1098,"code"),e.EFF(1099,"UsersModule"),e.k0s(),e.EFF(1100," in "),e.j41(1101,"code"),e.EFF(1102,"UserHttpModule"),e.k0s(),e.EFF(1103,", we can use "),e.j41(1104,"code"),e.EFF(1105,"@InjectModel(User)"),e.k0s(),e.EFF(1106," in the providers of the latter module."),e.k0s(),e.j41(1107,"span",40),e.EFF(1108),e.nI1(1109,"extension"),e.nrm(1110,"app-tabs",null,18),e.k0s(),e.j41(1112,"pre")(1113,"code",41),e.EFF(1114,"\nimport { Module } from '@nestjs/common';\nimport { UsersModule } from './users.module';\nimport { UsersService } from './users.service';\nimport { UsersController } from './users.controller';\n\n@Module({\n  imports: [UsersModule],\n  providers: [UsersService],\n  controllers: [UsersController]\n})\nexport class UserHttpModule {}\n"),e.k0s()(),e.j41(1115,"h4",79)(1116,"span"),e.EFF(1117,"Relations"),e.k0s()(),e.j41(1118,"p"),e.EFF(1119,"Relations are associations established between two or more tables. Relations are based on common fields from each table, often involving primary and foreign keys."),e.k0s(),e.j41(1120,"p"),e.EFF(1121,"There are three types of relations:"),e.k0s(),e.j41(1122,"table")(1123,"tr")(1124,"td")(1125,"code"),e.EFF(1126,"One-to-one"),e.k0s()(),e.j41(1127,"td"),e.EFF(1128,"Every row in the primary table has one and only one associated row in the foreign table"),e.k0s()(),e.j41(1129,"tr")(1130,"td")(1131,"code"),e.EFF(1132,"One-to-many / Many-to-one"),e.k0s()(),e.j41(1133,"td"),e.EFF(1134,"Every row in the primary table has one or more related rows in the foreign table"),e.k0s()(),e.j41(1135,"tr")(1136,"td")(1137,"code"),e.EFF(1138,"Many-to-many"),e.k0s()(),e.j41(1139,"td"),e.EFF(1140,"Every row in the primary table has many related rows in the foreign table, and every record in the foreign table has many related rows in the primary table"),e.k0s()()(),e.j41(1141,"p"),e.EFF(1142,"To define relations in models, use the corresponding "),e.j41(1143,"strong"),e.EFF(1144,"decorators"),e.k0s(),e.EFF(1145,". For example, to define that each "),e.j41(1146,"code"),e.EFF(1147,"User"),e.k0s(),e.EFF(1148," can have multiple photos, use the "),e.j41(1149,"code"),e.EFF(1150,"@HasMany()"),e.k0s(),e.EFF(1151," decorator."),e.k0s(),e.j41(1152,"span",40),e.EFF(1153),e.nI1(1154,"extension"),e.nrm(1155,"app-tabs",null,19),e.k0s(),e.j41(1157,"pre")(1158,"code",41),e.EFF(1159,"\nimport { Column, Model, Table, HasMany } from 'sequelize-typescript';\nimport { Photo } from '../photos/photo.model';\n\n@Table\nexport class User extends Model {\n  @Column\n  firstName: string;\n\n  @Column\n  lastName: string;\n\n  @Column({ defaultValue: true })\n  isActive: boolean;\n\n  @HasMany(() => Photo)\n  photos: Photo[];\n}\n"),e.k0s()(),e.j41(1160,"blockquote",44)(1161,"strong"),e.EFF(1162,"Hint"),e.k0s(),e.EFF(1163," To learn more about associations in Sequelize, read "),e.j41(1164,"a",80),e.EFF(1165,"this"),e.k0s(),e.EFF(1166," chapter.\n"),e.k0s(),e.j41(1167,"h4",81)(1168,"span"),e.EFF(1169,"Auto-load models"),e.k0s()(),e.j41(1170,"p"),e.EFF(1171,"Manually adding models to the "),e.j41(1172,"code"),e.EFF(1173,"models"),e.k0s(),e.EFF(1174," array of the connection options can be tedious. In addition, referencing models from the root module breaks application domain boundaries and causes leaking implementation details to other parts of the application. To solve this issue, automatically load models by setting both "),e.j41(1175,"code"),e.EFF(1176,"autoLoadModels"),e.k0s(),e.EFF(1177," and "),e.j41(1178,"code"),e.EFF(1179,"synchronize"),e.k0s(),e.EFF(1180," properties of the configuration object (passed into the "),e.j41(1181,"code"),e.EFF(1182,"forRoot()"),e.k0s(),e.EFF(1183," method) to "),e.j41(1184,"code"),e.EFF(1185,"true"),e.k0s(),e.EFF(1186,", as shown below:"),e.k0s(),e.j41(1187,"span",40),e.EFF(1188),e.nI1(1189,"extension"),e.nrm(1190,"app-tabs",null,20),e.k0s(),e.j41(1192,"pre")(1193,"code",41),e.EFF(1194,"\nimport { Module } from '@nestjs/common';\nimport { SequelizeModule } from '@nestjs/sequelize';\n\n@Module({\n  imports: [\n    SequelizeModule.forRoot({\n      ...\n      autoLoadModels: true,\n      synchronize: true,\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(1195,"p"),e.EFF(1196,"With that option specified, every model registered through the "),e.j41(1197,"code"),e.EFF(1198,"forFeature()"),e.k0s(),e.EFF(1199," method will be automatically added to the "),e.j41(1200,"code"),e.EFF(1201,"models"),e.k0s(),e.EFF(1202," array of the configuration object."),e.k0s(),e.j41(1203,"blockquote",42)(1204,"strong"),e.EFF(1205,"Warning"),e.k0s(),e.EFF(1206," Note that models that aren't registered through the "),e.j41(1207,"code"),e.EFF(1208,"forFeature()"),e.k0s(),e.EFF(1209," method, but are only referenced from the model (via an association), won't be included.\n"),e.k0s(),e.j41(1210,"h4",82)(1211,"span"),e.EFF(1212,"Sequelize Transactions"),e.k0s()(),e.j41(1213,"p"),e.EFF(1214,"A database transaction symbolizes a unit of work performed within a database management system against a database, and treated in a coherent and reliable way independent of other transactions. A transaction generally represents any change in a database ("),e.j41(1215,"a",55),e.EFF(1216,"learn more"),e.k0s(),e.EFF(1217,")."),e.k0s(),e.j41(1218,"p"),e.EFF(1219,"There are many different strategies to handle "),e.j41(1220,"a",83),e.EFF(1221,"Sequelize transactions"),e.k0s(),e.EFF(1222,". Below is a sample implementation of a managed transaction (auto-callback)."),e.k0s(),e.j41(1223,"p"),e.EFF(1224,"First, we need to inject the "),e.j41(1225,"code"),e.EFF(1226,"Sequelize"),e.k0s(),e.EFF(1227," object into a class in the normal way:"),e.k0s(),e.j41(1228,"pre")(1229,"code",41),e.EFF(1230,"\n@Injectable()\nexport class UsersService {\n  constructor(private sequelize: Sequelize) {}\n}\n"),e.k0s()(),e.j41(1231,"blockquote",44)(1232,"strong"),e.EFF(1233,"Hint"),e.k0s(),e.EFF(1234," The "),e.j41(1235,"code"),e.EFF(1236,"Sequelize"),e.k0s(),e.EFF(1237," class is imported from the "),e.j41(1238,"code"),e.EFF(1239,"sequelize-typescript"),e.k0s(),e.EFF(1240," package.\n"),e.k0s(),e.j41(1241,"p"),e.EFF(1242,"Now, we can use this object to create a transaction."),e.k0s(),e.j41(1243,"pre")(1244,"code",41),e.EFF(1245,"\nasync createMany() {\n  try {\n    await this.sequelize.transaction(async t => {\n      const transactionHost = { transaction: t };\n\n      await this.userModel.create(\n          { firstName: 'Abraham', lastName: 'Lincoln' },\n          transactionHost,\n      );\n      await this.userModel.create(\n          { firstName: 'John', lastName: 'Boothe' },\n          transactionHost,\n      );\n    });\n  } catch (err) {\n    // Transaction has been rolled back\n    // err is whatever rejected the promise chain returned to the transaction callback\n  }\n}\n"),e.k0s()(),e.j41(1246,"blockquote",44)(1247,"strong"),e.EFF(1248,"Hint"),e.k0s(),e.EFF(1249," Note that the "),e.j41(1250,"code"),e.EFF(1251,"Sequelize"),e.k0s(),e.EFF(1252," instance is used only to start the transaction. However, to test this class would require mocking the entire "),e.j41(1253,"code"),e.EFF(1254,"Sequelize"),e.k0s(),e.EFF(1255," object (which exposes several methods). Thus, we recommend using a helper factory class (e.g., "),e.j41(1256,"code"),e.EFF(1257,"TransactionRunner"),e.k0s(),e.EFF(1258,") and defining an interface with a limited set of methods required to maintain transactions. This technique makes mocking these methods pretty straightforward.\n"),e.k0s(),e.j41(1259,"h4",84)(1260,"span"),e.EFF(1261,"Migrations"),e.k0s()(),e.j41(1262,"p")(1263,"a",85),e.EFF(1264,"Migrations"),e.k0s(),e.EFF(1265," provide a way to incrementally update the database schema to keep it in sync with the application's data model while preserving existing data in the database. To generate, run, and revert migrations, Sequelize provides a dedicated "),e.j41(1266,"a",86),e.EFF(1267,"CLI"),e.k0s(),e.EFF(1268,"."),e.k0s(),e.j41(1269,"p"),e.EFF(1270,"Migration classes are separate from the Nest application source code. Their lifecycle is maintained by the Sequelize CLI. Therefore, you are not able to leverage dependency injection and other Nest specific features with migrations. To learn more about migrations, follow the guide in the "),e.j41(1271,"a",86),e.EFF(1272,"Sequelize documentation"),e.k0s(),e.EFF(1273,"."),e.k0s(),e.j41(1274,"p"),e.nrm(1275,"app-banner-courses"),e.k0s(),e.j41(1276,"h4",87)(1277,"span"),e.EFF(1278,"Multiple databases"),e.k0s()(),e.j41(1279,"p"),e.EFF(1280,"Some projects require multiple database connections. This can also be achieved with this module. To work with multiple connections, first create the connections. In this case, connection naming becomes "),e.j41(1281,"strong"),e.EFF(1282,"mandatory"),e.k0s(),e.EFF(1283,"."),e.k0s(),e.j41(1284,"p"),e.EFF(1285,"Suppose you have an "),e.j41(1286,"code"),e.EFF(1287,"Album"),e.k0s(),e.EFF(1288," entity stored in its own database."),e.k0s(),e.j41(1289,"pre")(1290,"code",41),e.EFF(1291,"\nconst defaultOptions = {\n  dialect: 'postgres',\n  port: 5432,\n  username: 'user',\n  password: 'password',\n  database: 'db',\n  synchronize: true,\n};\n\n@Module({\n  imports: [\n    SequelizeModule.forRoot({\n      ...defaultOptions,\n      host: 'user_db_host',\n      models: [User],\n    }),\n    SequelizeModule.forRoot({\n      ...defaultOptions,\n      name: 'albumsConnection',\n      host: 'album_db_host',\n      models: [Album],\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(1292,"blockquote",42)(1293,"strong"),e.EFF(1294,"Notice"),e.k0s(),e.EFF(1295," If you don't set the "),e.j41(1296,"code"),e.EFF(1297,"name"),e.k0s(),e.EFF(1298," for a connection, its name is set to "),e.j41(1299,"code"),e.EFF(1300,"default"),e.k0s(),e.EFF(1301,". Please note that you shouldn't have multiple connections without a name, or with the same name, otherwise they will get overridden.\n"),e.k0s(),e.j41(1302,"p"),e.EFF(1303,"At this point, you have "),e.j41(1304,"code"),e.EFF(1305,"User"),e.k0s(),e.EFF(1306," and "),e.j41(1307,"code"),e.EFF(1308,"Album"),e.k0s(),e.EFF(1309," models registered with their own connection. With this setup, you have to tell the "),e.j41(1310,"code"),e.EFF(1311,"SequelizeModule.forFeature()"),e.k0s(),e.EFF(1312," method and the "),e.j41(1313,"code"),e.EFF(1314,"@InjectModel()"),e.k0s(),e.EFF(1315," decorator which connection should be used. If you do not pass any connection name, the "),e.j41(1316,"code"),e.EFF(1317,"default"),e.k0s(),e.EFF(1318," connection is used."),e.k0s(),e.j41(1319,"pre")(1320,"code",41),e.EFF(1321,"\n@Module({\n  imports: [\n    SequelizeModule.forFeature([User]),\n    SequelizeModule.forFeature([Album], 'albumsConnection'),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(1322,"p"),e.EFF(1323,"You can also inject the "),e.j41(1324,"code"),e.EFF(1325,"Sequelize"),e.k0s(),e.EFF(1326," instance for a given connection:"),e.k0s(),e.j41(1327,"pre")(1328,"code",41),e.EFF(1329,"\n@Injectable()\nexport class AlbumsService {\n  constructor(\n    @InjectConnection('albumsConnection')\n    private sequelize: Sequelize,\n  ) {}\n}\n"),e.k0s()(),e.j41(1330,"p"),e.EFF(1331,"It's also possible to inject any "),e.j41(1332,"code"),e.EFF(1333,"Sequelize"),e.k0s(),e.EFF(1334," instance to the providers:"),e.k0s(),e.j41(1335,"pre")(1336,"code",41),e.EFF(1337,"\n@Module({\n  providers: [\n    {\n      provide: AlbumsService,\n      useFactory: (albumsSequelize: Sequelize) => {\n        return new AlbumsService(albumsSequelize);\n      },\n      inject: [getDataSourceToken('albumsConnection')],\n    },\n  ],\n})\nexport class AlbumsModule {}\n"),e.k0s()(),e.j41(1338,"h4",88)(1339,"span"),e.EFF(1340,"Testing"),e.k0s()(),e.j41(1341,"p"),e.EFF(1342,"When it comes to unit testing an application, we usually want to avoid making a database connection, keeping our test suites independent and their execution process as fast as possible. But our classes might depend on models that are pulled from the connection instance. How do we handle that? The solution is to create mock models. In order to achieve that, we set up "),e.j41(1343,"a",68),e.EFF(1344,"custom providers"),e.k0s(),e.EFF(1345,". Each registered model is automatically represented by a "),e.j41(1346,"code"),e.EFF(1347,"<ModelName>Model"),e.k0s(),e.EFF(1348," token, where "),e.j41(1349,"code"),e.EFF(1350,"ModelName"),e.k0s(),e.EFF(1351," is the name of your model class."),e.k0s(),e.j41(1352,"p"),e.EFF(1353,"The "),e.j41(1354,"code"),e.EFF(1355,"@nestjs/sequelize"),e.k0s(),e.EFF(1356," package exposes the "),e.j41(1357,"code"),e.EFF(1358,"getModelToken()"),e.k0s(),e.EFF(1359," function which returns a prepared token based on a given model."),e.k0s(),e.j41(1360,"pre")(1361,"code",41),e.EFF(1362,"\n@Module({\n  providers: [\n    UsersService,\n    {\n      provide: getModelToken(User),\n      useValue: mockModel,\n    },\n  ],\n})\nexport class UsersModule {}\n"),e.k0s()(),e.j41(1363,"p"),e.EFF(1364,"Now a substitute "),e.j41(1365,"code"),e.EFF(1366,"mockModel"),e.k0s(),e.EFF(1367," will be used as the "),e.j41(1368,"code"),e.EFF(1369,"UserModel"),e.k0s(),e.EFF(1370,". Whenever any class asks for "),e.j41(1371,"code"),e.EFF(1372,"UserModel"),e.k0s(),e.EFF(1373," using an "),e.j41(1374,"code"),e.EFF(1375,"@InjectModel()"),e.k0s(),e.EFF(1376," decorator, Nest will use the registered "),e.j41(1377,"code"),e.EFF(1378,"mockModel"),e.k0s(),e.EFF(1379," object."),e.k0s(),e.j41(1380,"h4",89)(1381,"span"),e.EFF(1382,"Async configuration"),e.k0s()(),e.j41(1383,"p"),e.EFF(1384,"You may want to pass your "),e.j41(1385,"code"),e.EFF(1386,"SequelizeModule"),e.k0s(),e.EFF(1387," options asynchronously instead of statically. In this case, use the "),e.j41(1388,"code"),e.EFF(1389,"forRootAsync()"),e.k0s(),e.EFF(1390," method, which provides several ways to deal with async configuration."),e.k0s(),e.j41(1391,"p"),e.EFF(1392,"One approach is to use a factory function:"),e.k0s(),e.j41(1393,"pre")(1394,"code",41),e.EFF(1395,"\nSequelizeModule.forRootAsync({\n  useFactory: () => ({\n    dialect: 'mysql',\n    host: 'localhost',\n    port: 3306,\n    username: 'root',\n    password: 'root',\n    database: 'test',\n    models: [],\n  }),\n});\n"),e.k0s()(),e.j41(1396,"p"),e.EFF(1397,"Our factory behaves like any other "),e.j41(1398,"a",70),e.EFF(1399,"asynchronous provider"),e.k0s(),e.EFF(1400," (e.g., it can be "),e.j41(1401,"code"),e.EFF(1402,"async"),e.k0s(),e.EFF(1403," and it's able to inject dependencies through "),e.j41(1404,"code"),e.EFF(1405,"inject"),e.k0s(),e.EFF(1406,")."),e.k0s(),e.j41(1407,"pre")(1408,"code",41),e.EFF(1409,"\nSequelizeModule.forRootAsync({\n  imports: [ConfigModule],\n  useFactory: (configService: ConfigService) => ({\n    dialect: 'mysql',\n    host: configService.get('HOST'),\n    port: +configService.get('PORT'),\n    username: configService.get('USERNAME'),\n    password: configService.get('PASSWORD'),\n    database: configService.get('DATABASE'),\n    models: [],\n  }),\n  inject: [ConfigService],\n});\n"),e.k0s()(),e.j41(1410,"p"),e.EFF(1411,"Alternatively, you can use the "),e.j41(1412,"code"),e.EFF(1413,"useClass"),e.k0s(),e.EFF(1414," syntax:"),e.k0s(),e.j41(1415,"pre")(1416,"code",41),e.EFF(1417,"\nSequelizeModule.forRootAsync({\n  useClass: SequelizeConfigService,\n});\n"),e.k0s()(),e.j41(1418,"p"),e.EFF(1419,"The construction above will instantiate "),e.j41(1420,"code"),e.EFF(1421,"SequelizeConfigService"),e.k0s(),e.EFF(1422," inside "),e.j41(1423,"code"),e.EFF(1424,"SequelizeModule"),e.k0s(),e.EFF(1425," and use it to provide an options object by calling "),e.j41(1426,"code"),e.EFF(1427,"createSequelizeOptions()"),e.k0s(),e.EFF(1428,". Note that this means that the "),e.j41(1429,"code"),e.EFF(1430,"SequelizeConfigService"),e.k0s(),e.EFF(1431," has to implement the "),e.j41(1432,"code"),e.EFF(1433,"SequelizeOptionsFactory"),e.k0s(),e.EFF(1434," interface, as shown below:"),e.k0s(),e.j41(1435,"pre")(1436,"code",41),e.EFF(1437,"\n@Injectable()\nclass SequelizeConfigService implements SequelizeOptionsFactory {\n  createSequelizeOptions(): SequelizeModuleOptions {\n    return {\n      dialect: 'mysql',\n      host: 'localhost',\n      port: 3306,\n      username: 'root',\n      password: 'root',\n      database: 'test',\n      models: [],\n    };\n  }\n}\n"),e.k0s()(),e.j41(1438,"p"),e.EFF(1439,"In order to prevent the creation of "),e.j41(1440,"code"),e.EFF(1441,"SequelizeConfigService"),e.k0s(),e.EFF(1442," inside "),e.j41(1443,"code"),e.EFF(1444,"SequelizeModule"),e.k0s(),e.EFF(1445," and use a provider imported from a different module, you can use the "),e.j41(1446,"code"),e.EFF(1447,"useExisting"),e.k0s(),e.EFF(1448," syntax."),e.k0s(),e.j41(1449,"pre")(1450,"code",41),e.EFF(1451,"\nSequelizeModule.forRootAsync({\n  imports: [ConfigModule],\n  useExisting: ConfigService,\n});\n"),e.k0s()(),e.j41(1452,"p"),e.EFF(1453,"This construction works the same as "),e.j41(1454,"code"),e.EFF(1455,"useClass"),e.k0s(),e.EFF(1456," with one critical difference - "),e.j41(1457,"code"),e.EFF(1458,"SequelizeModule"),e.k0s(),e.EFF(1459," will lookup imported modules to reuse an existing "),e.j41(1460,"code"),e.EFF(1461,"ConfigService"),e.k0s(),e.EFF(1462," instead of instantiating a new one."),e.k0s(),e.j41(1463,"h4",90)(1464,"span"),e.EFF(1465,"Example"),e.k0s()(),e.j41(1466,"p"),e.EFF(1467,"A working example is available "),e.j41(1468,"a",91),e.EFF(1469,"here"),e.k0s(),e.EFF(1470,"."),e.k0s()()),2&s){const a=e.sdS(88),r=e.sdS(160),l=e.sdS(186),c=e.sdS(226),u=e.sdS(239),h=e.sdS(261),k=e.sdS(287),j=e.sdS(306),g=e.sdS(363),f=e.sdS(395),b=e.sdS(896),y=e.sdS(972),H=e.sdS(991),J=e.sdS(1031),z=e.sdS(1044),S=e.sdS(1066),$=e.sdS(1092),W=e.sdS(1111),Q=e.sdS(1156),G=e.sdS(1191);e.R7$(85),e.SpI(" ",e.i5U(86,36,"app.module",a.isJsActive),"\n"),e.R7$(72),e.SpI(" ",e.i5U(158,39,"app.module",r.isJsActive),"\n"),e.R7$(4),e.AVh("hide",r.isJsActive),e.R7$(3),e.AVh("hide",!r.isJsActive),e.R7$(19),e.SpI(" ",e.i5U(184,42,"user.entity",l.isJsActive),"\n"),e.R7$(40),e.SpI(" ",e.i5U(224,45,"app.module",c.isJsActive),"\n"),e.R7$(13),e.SpI(" ",e.i5U(237,48,"users.module",u.isJsActive),"\n"),e.R7$(22),e.SpI(" ",e.i5U(259,51,"users.service",h.isJsActive),"\n"),e.R7$(4),e.AVh("hide",h.isJsActive),e.R7$(3),e.AVh("hide",!h.isJsActive),e.R7$(19),e.SpI(" ",e.i5U(285,54,"users.module",k.isJsActive),"\n"),e.R7$(19),e.SpI(" ",e.i5U(304,57,"users-http.module",j.isJsActive),"\n"),e.R7$(57),e.SpI(" ",e.i5U(361,60,"user.entity",g.isJsActive),"\n"),e.R7$(32),e.SpI(" ",e.i5U(393,63,"app.module",f.isJsActive),"\n"),e.R7$(501),e.SpI(" ",e.i5U(894,66,"app.module",b.isJsActive),"\n"),e.R7$(76),e.SpI(" ",e.i5U(970,69,"app.service",y.isJsActive),"\n"),e.R7$(4),e.AVh("hide",y.isJsActive),e.R7$(3),e.AVh("hide",!y.isJsActive),e.R7$(12),e.SpI(" ",e.i5U(989,72,"user.model",H.isJsActive),"\n"),e.R7$(40),e.SpI(" ",e.i5U(1029,75,"app.module",J.isJsActive),"\n"),e.R7$(13),e.SpI(" ",e.i5U(1042,78,"users.module",z.isJsActive),"\n"),e.R7$(22),e.SpI(" ",e.i5U(1064,81,"users.service",S.isJsActive),"\n"),e.R7$(4),e.AVh("hide",S.isJsActive),e.R7$(3),e.AVh("hide",!S.isJsActive),e.R7$(19),e.SpI(" ",e.i5U(1090,84,"users.module",$.isJsActive),"\n"),e.R7$(19),e.SpI(" ",e.i5U(1109,87,"users-http.module",W.isJsActive),"\n"),e.R7$(45),e.SpI(" ",e.i5U(1154,90,"user.model",Q.isJsActive),"\n"),e.R7$(35),e.SpI(" ",e.i5U(1189,93,"app.module",G.isJsActive),"\n")}},dependencies:[p.O,F.a,v.Q,w.d,T._,E.Wk,m.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Database"}},{path:"mongodb",component:_,data:{title:"MongoDB"}},{path:"file-upload",component:U,data:{title:"File upload"}},{path:"streaming-files",component:(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-streaming-files"]],features:[e.Vt3],decls:103,vars:0,consts:[["contentReference",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/streaming-files.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","streaming-files"],[1,"info"],[1,"language-ts"],["appAnchor","","id","streamable-file-class"],["appAnchor","","id","cross-platform-support"],["appAnchor","","id","example"],["href","/controllers#headers"]],template:function(s,n){1&s&&(e.j41(0,"div",1,0)(2,"div",2)(3,"a",3),e.nrm(4,"i",4),e.k0s()(),e.j41(5,"h3",5),e.EFF(6,"Streaming files"),e.k0s(),e.j41(7,"blockquote",6)(8,"strong"),e.EFF(9,"Note"),e.k0s(),e.EFF(10," This chapter shows how you can stream files from your "),e.j41(11,"strong"),e.EFF(12,"HTTP application"),e.k0s(),e.EFF(13,". The examples presented below do not apply to GraphQL or Microservice applications.\n"),e.k0s(),e.j41(14,"p"),e.EFF(15,"There may be times where you would like to send back a file from your REST API to the client. To do this with Nest, normally you'd do the following:"),e.k0s(),e.j41(16,"pre")(17,"code",7),e.EFF(18,"\n@Controller('file')\nexport class FileController {\n  @Get()\n  getFile(@Res() res: Response) {\n    const file = createReadStream(join(process.cwd(), 'package.json'));\n    file.pipe(res);\n  }\n}\n"),e.k0s()(),e.j41(19,"p"),e.EFF(20,"But in doing so you end up losing access to your post-controller interceptor logic. To handle this, you can return a "),e.j41(21,"code"),e.EFF(22,"StreamableFile"),e.k0s(),e.EFF(23," instance and under the hood, the framework will take care of piping the response."),e.k0s(),e.j41(24,"h4",8)(25,"span"),e.EFF(26,"Streamable File class"),e.k0s()(),e.j41(27,"p"),e.EFF(28,"A "),e.j41(29,"code"),e.EFF(30,"StreamableFile"),e.k0s(),e.EFF(31," is a class that holds onto the stream that is to be returned. To create a new "),e.j41(32,"code"),e.EFF(33,"StreamableFile"),e.k0s(),e.EFF(34,", you can pass either a "),e.j41(35,"code"),e.EFF(36,"Buffer"),e.k0s(),e.EFF(37," or a "),e.j41(38,"code"),e.EFF(39,"Stream"),e.k0s(),e.EFF(40," to the "),e.j41(41,"code"),e.EFF(42,"StreamableFile"),e.k0s(),e.EFF(43," constructor."),e.k0s(),e.j41(44,"blockquote",6)(45,"strong"),e.EFF(46,"hint"),e.k0s(),e.EFF(47," The "),e.j41(48,"code"),e.EFF(49,"StreamableFile"),e.k0s(),e.EFF(50," class can be imported from "),e.j41(51,"code"),e.EFF(52,"@nestjs/common"),e.k0s(),e.EFF(53,".\n"),e.k0s(),e.j41(54,"h4",9)(55,"span"),e.EFF(56,"Cross-platform support"),e.k0s()(),e.j41(57,"p"),e.EFF(58,"Fastify, by default, can support sending files without needing to call "),e.j41(59,"code"),e.EFF(60,"stream.pipe(res)"),e.k0s(),e.EFF(61,", so you don't need to use the "),e.j41(62,"code"),e.EFF(63,"StreamableFile"),e.k0s(),e.EFF(64," class at all. However, Nest supports the use of "),e.j41(65,"code"),e.EFF(66,"StreamableFile"),e.k0s(),e.EFF(67," in both platform types, so if you end up switching between Express and Fastify there's no need to worry about compatibility between the two engines."),e.k0s(),e.j41(68,"h4",10)(69,"span"),e.EFF(70,"Example"),e.k0s()(),e.j41(71,"p"),e.EFF(72,"You can find a simple example of returning the "),e.j41(73,"code"),e.EFF(74,"package.json"),e.k0s(),e.EFF(75," as a file instead of a JSON below, but the idea extends out naturally to images, documents, and any other file type."),e.k0s(),e.j41(76,"pre")(77,"code",7),e.EFF(78,"\nimport { Controller, Get, StreamableFile } from '@nestjs/common';\nimport { createReadStream } from 'fs';\nimport { join } from 'path';\n\n@Controller('file')\nexport class FileController {\n  @Get()\n  getFile(): StreamableFile {\n    const file = createReadStream(join(process.cwd(), 'package.json'));\n    return new StreamableFile(file);\n  }\n}\n"),e.k0s()(),e.j41(79,"p"),e.EFF(80,"The default content type (the value for "),e.j41(81,"code"),e.EFF(82,"Content-Type"),e.k0s(),e.EFF(83," HTTP response header) is "),e.j41(84,"code"),e.EFF(85,"application/octet-stream"),e.k0s(),e.EFF(86,". If you need to customize this value you can use the "),e.j41(87,"code"),e.EFF(88,"type"),e.k0s(),e.EFF(89," option from "),e.j41(90,"code"),e.EFF(91,"StreamableFile"),e.k0s(),e.EFF(92,", or use the "),e.j41(93,"code"),e.EFF(94,"res.set"),e.k0s(),e.EFF(95," method or the "),e.j41(96,"a",11)(97,"code"),e.EFF(98,"@Header()"),e.k0s()(),e.EFF(99," decorator, like this:"),e.k0s(),e.j41(100,"pre")(101,"code",7),e.EFF(102,"\nimport { Controller, Get, StreamableFile, Res } from '@nestjs/common';\nimport { createReadStream } from 'fs';\nimport { join } from 'path';\nimport type { Response } from 'express'; // Assuming that we are using the ExpressJS HTTP Adapter\n\n@Controller('file')\nexport class FileController {\n  @Get()\n  getFile(): StreamableFile {\n    const file = createReadStream(join(process.cwd(), 'package.json'));\n    return new StreamableFile(file, {\n      type: 'application/json',\n      disposition: 'attachment; filename=\"package.json\"',\n      // If you want to define the Content-Length value to another value instead of file's length:\n      // length: 123,\n    });\n  }\n\n  // Or even:\n  @Get()\n  getFileChangingResponseObjDirectly(@Res({ passthrough: true }) res: Response): StreamableFile {\n    const file = createReadStream(join(process.cwd(), 'package.json'));\n    res.set({\n      'Content-Type': 'application/json',\n      'Content-Disposition': 'attachment; filename=\"package.json\"',\n    });\n    return new StreamableFile(file);\n  }\n\n  // Or even:\n  @Get()\n  @Header('Content-Type', 'application/json')\n  @Header('Content-Disposition', 'attachment; filename=\"package.json\"')\n  getFileUsingStaticValues(): StreamableFile {\n    const file = createReadStream(join(process.cwd(), 'package.json'));\n    return new StreamableFile(file);\n  }  \n}\n"),e.k0s()()())},dependencies:[F.a],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Streaming Files"}},{path:"logger",component:N,data:{title:"Logger"}},{path:"performance",component:D,data:{title:"Performance (Fastify)"}},{path:"http-module",component:P,data:{title:"HTTP module"}},{path:"configuration",component:I,data:{title:"Configuration"}},{path:"security",redirectTo:"/security/helmet"},{path:"cookies",component:R,data:{title:"Cookies"}},{path:"task-scheduling",component:(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-task-scheduling"]],features:[e.Vt3],decls:625,vars:4,consts:[["contentReference",""],["app0fd859cb77acaabc98cb21656d4d2c34569ec080",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/task-scheduling.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","task-scheduling"],["rel","nofollow","target","_blank","href","https://en.wikipedia.org/wiki/Cron"],["rel","nofollow","target","_blank","href","https://github.com/kelektiv/node-cron"],["appAnchor","","id","installation"],[1,"language-bash"],[1,"filename"],[1,"language-typescript"],["href","techniques/task-scheduling#declarative-cron-jobs"],["href","techniques/task-scheduling#declarative-timeouts"],["href","techniques/task-scheduling#declarative-intervals"],["appAnchor","","id","declarative-cron-jobs"],["rel","nofollow","target","_blank","href","http://crontab.org/"],[1,"language-javascript"],[1,"info"],["href","http://momentjs.com/timezone/"],["href","/techniques/task-scheduling#dynamic-schedule-module-api"],["appAnchor","","id","declarative-intervals"],["href","techniques/task-scheduling#dynamic-intervals"],["appAnchor","","id","declarative-timeouts"],["href","techniques/task-scheduling#dynamic-timeouts"],["appAnchor","","id","dynamic-schedule-module-api"],["appAnchor","","id","dynamic-cron-jobs"],[1,"warning"],["appAnchor","","id","dynamic-intervals"],["appAnchor","","id","dynamic-timeouts"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/27-scheduling"]],template:function(s,n){if(1&s&&(e.j41(0,"div",2,0)(2,"div",3)(3,"a",4),e.nrm(4,"i",5),e.k0s()(),e.j41(5,"h3",6),e.EFF(6,"Task Scheduling"),e.k0s(),e.j41(7,"p"),e.EFF(8,"Task scheduling allows you to schedule arbitrary code (methods/functions) to execute at a fixed date/time, at recurring intervals, or once after a specified interval. In the Linux world, this is often handled by packages like "),e.j41(9,"a",7),e.EFF(10,"cron"),e.k0s(),e.EFF(11," at the OS level. For Node.js apps, there are several packages that emulate cron-like functionality. Nest provides the "),e.j41(12,"code"),e.EFF(13,"@nestjs/schedule"),e.k0s(),e.EFF(14," package, which integrates with the popular Node.js "),e.j41(15,"a",8),e.EFF(16,"cron"),e.k0s(),e.EFF(17," package. We'll cover this package in the current chapter."),e.k0s(),e.j41(18,"h4",9)(19,"span"),e.EFF(20,"Installation"),e.k0s()(),e.j41(21,"p"),e.EFF(22,"To begin using it, we first install the required dependencies."),e.k0s(),e.j41(23,"pre")(24,"code",10),e.EFF(25,"\n$ npm install --save @nestjs/schedule\n"),e.k0s()(),e.j41(26,"p"),e.EFF(27,"To activate job scheduling, import the "),e.j41(28,"code"),e.EFF(29,"ScheduleModule"),e.k0s(),e.EFF(30," into the root "),e.j41(31,"code"),e.EFF(32,"AppModule"),e.k0s(),e.EFF(33," and run the "),e.j41(34,"code"),e.EFF(35,"forRoot()"),e.k0s(),e.EFF(36," static method as shown below:"),e.k0s(),e.j41(37,"span",11),e.EFF(38),e.nI1(39,"extension"),e.nrm(40,"app-tabs",null,1),e.k0s(),e.j41(42,"pre")(43,"code",12),e.EFF(44,"\nimport { Module } from '@nestjs/common';\nimport { ScheduleModule } from '@nestjs/schedule';\n\n@Module({\n  imports: [\n    ScheduleModule.forRoot()\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(45,"p"),e.EFF(46,"The "),e.j41(47,"code"),e.EFF(48,".forRoot()"),e.k0s(),e.EFF(49," call initializes the scheduler and registers any declarative "),e.j41(50,"a",13),e.EFF(51,"cron jobs"),e.k0s(),e.EFF(52,", "),e.j41(53,"a",14),e.EFF(54,"timeouts"),e.k0s(),e.EFF(55," and "),e.j41(56,"a",15),e.EFF(57,"intervals"),e.k0s(),e.EFF(58," that exist within your app. Registration occurs when the "),e.j41(59,"code"),e.EFF(60,"onApplicationBootstrap"),e.k0s(),e.EFF(61," lifecycle hook occurs, ensuring that all modules have loaded and declared any scheduled jobs."),e.k0s(),e.j41(62,"h4",16)(63,"span"),e.EFF(64,"Declarative cron jobs"),e.k0s()(),e.j41(65,"p"),e.EFF(66,"A cron job schedules an arbitrary function (method call) to run automatically. Cron jobs can run:"),e.k0s(),e.j41(67,"ul")(68,"li"),e.EFF(69,"Once, at a specified date/time."),e.k0s(),e.j41(70,"li"),e.EFF(71,"On a recurring basis; recurring jobs can run at a specified instant within a specified interval (for example, once per hour, once per week, once every 5 minutes)"),e.k0s()(),e.j41(72,"p"),e.EFF(73,"Declare a cron job with the "),e.j41(74,"code"),e.EFF(75,"@Cron()"),e.k0s(),e.EFF(76," decorator preceding the method definition containing the code to be executed, as follows:"),e.k0s(),e.j41(77,"pre")(78,"code",12),e.EFF(79,"\nimport { Injectable, Logger } from '@nestjs/common';\nimport { Cron } from '@nestjs/schedule';\n\n@Injectable()\nexport class TasksService {\n  private readonly logger = new Logger(TasksService.name);\n\n  @Cron('45 * * * * *')\n  handleCron() {\n    this.logger.debug('Called when the current second is 45');\n  }\n}\n"),e.k0s()(),e.j41(80,"p"),e.EFF(81,"In this example, the "),e.j41(82,"code"),e.EFF(83,"handleCron()"),e.k0s(),e.EFF(84," method will be called each time the current second is "),e.j41(85,"code"),e.EFF(86,"45"),e.k0s(),e.EFF(87,". In other words, the method will be run once per minute, at the 45 second mark."),e.k0s(),e.j41(88,"p"),e.EFF(89,"The "),e.j41(90,"code"),e.EFF(91,"@Cron()"),e.k0s(),e.EFF(92," decorator supports the following standard "),e.j41(93,"a",17),e.EFF(94,"cron patterns"),e.k0s(),e.EFF(95,":"),e.k0s(),e.j41(96,"ul")(97,"li"),e.EFF(98,"Asterisk (e.g. "),e.j41(99,"code"),e.EFF(100,"*"),e.k0s(),e.EFF(101,")"),e.k0s(),e.j41(102,"li"),e.EFF(103,"Ranges (e.g. "),e.j41(104,"code"),e.EFF(105,"1-3,5"),e.k0s(),e.EFF(106,")"),e.k0s(),e.j41(107,"li"),e.EFF(108,"Steps (e.g. "),e.j41(109,"code"),e.EFF(110,"*/2"),e.k0s(),e.EFF(111,")"),e.k0s()(),e.j41(112,"p"),e.EFF(113,"In the example above, we passed "),e.j41(114,"code"),e.EFF(115,"45 * * * * *"),e.k0s(),e.EFF(116," to the decorator. The following key shows how each position in the cron pattern string is interpreted:"),e.k0s(),e.j41(117,"pre",18)(118,"code",18),e.EFF(119,"\n* * * * * *\n| | | | | |\n| | | | | day of week\n| | | | months\n| | | day of month\n| | hours\n| minutes\nseconds (optional)\n"),e.k0s()(),e.j41(120,"p"),e.EFF(121,"Some sample cron patterns are:"),e.k0s(),e.j41(122,"table")(123,"tbody")(124,"tr")(125,"td")(126,"code"),e.EFF(127,"* * * * * *"),e.k0s()(),e.j41(128,"td"),e.EFF(129,"every second"),e.k0s()(),e.j41(130,"tr")(131,"td")(132,"code"),e.EFF(133,"45 * * * * *"),e.k0s()(),e.j41(134,"td"),e.EFF(135,"every minute, on the 45th second"),e.k0s()(),e.j41(136,"tr")(137,"td")(138,"code"),e.EFF(139,"0 10 * * * *"),e.k0s()(),e.j41(140,"td"),e.EFF(141,"every hour, at the start of the 10th minute"),e.k0s()(),e.j41(142,"tr")(143,"td")(144,"code"),e.EFF(145,"0 */30 9-17 * * *"),e.k0s()(),e.j41(146,"td"),e.EFF(147,"every 30 minutes between 9am and 5pm"),e.k0s()(),e.j41(148,"tr")(149,"td")(150,"code"),e.EFF(151,"0 30 11 * * 1-5"),e.k0s()(),e.j41(152,"td"),e.EFF(153,"Monday to Friday at 11:30am"),e.k0s()()()(),e.j41(154,"p"),e.EFF(155,"The "),e.j41(156,"code"),e.EFF(157,"@nestjs/schedule"),e.k0s(),e.EFF(158," package provides a convenient enum with commonly used cron patterns. You can use this enum as follows:"),e.k0s(),e.j41(159,"pre")(160,"code",12),e.EFF(161,"\nimport { Injectable, Logger } from '@nestjs/common';\nimport { Cron, CronExpression } from '@nestjs/schedule';\n\n@Injectable()\nexport class TasksService {\n  private readonly logger = new Logger(TasksService.name);\n\n  @Cron(CronExpression.EVERY_30_SECONDS)\n  handleCron() {\n    this.logger.debug('Called every 30 seconds');\n  }\n}\n"),e.k0s()(),e.j41(162,"p"),e.EFF(163,"In this example, the "),e.j41(164,"code"),e.EFF(165,"handleCron()"),e.k0s(),e.EFF(166," method will be called every "),e.j41(167,"code"),e.EFF(168,"30"),e.k0s(),e.EFF(169," seconds."),e.k0s(),e.j41(170,"p"),e.EFF(171,"Alternatively, you can supply a JavaScript "),e.j41(172,"code"),e.EFF(173,"Date"),e.k0s(),e.EFF(174," object to the "),e.j41(175,"code"),e.EFF(176,"@Cron()"),e.k0s(),e.EFF(177," decorator. Doing so causes the job to execute exactly once, at the specified date."),e.k0s(),e.j41(178,"blockquote",19)(179,"strong"),e.EFF(180,"Hint"),e.k0s(),e.EFF(181," Use JavaScript date arithmetic to schedule jobs relative to the current date. For example, "),e.j41(182,"code"),e.EFF(183,"@Cron(new Date(Date.now() + 10 * 1000))"),e.k0s(),e.EFF(184," to schedule a job to run 10 seconds after the app starts.\n"),e.k0s(),e.j41(185,"p"),e.EFF(186,"Also, you can supply additional options as the second parameter to the "),e.j41(187,"code"),e.EFF(188,"@Cron()"),e.k0s(),e.EFF(189," decorator."),e.k0s(),e.j41(190,"table")(191,"tbody")(192,"tr")(193,"td")(194,"code"),e.EFF(195,"name"),e.k0s()(),e.j41(196,"td"),e.EFF(197," Useful to access and control a cron job after it's been declared. "),e.k0s()(),e.j41(198,"tr")(199,"td")(200,"code"),e.EFF(201,"timeZone"),e.k0s()(),e.j41(202,"td"),e.EFF(203," Specify the timezone for the execution. This will modify the actual time relative to your timezone. If the timezone is invalid, an error is thrown. You can check all timezones available at "),e.j41(204,"a",20),e.EFF(205,"Moment Timezone"),e.k0s(),e.EFF(206," website. "),e.k0s()(),e.j41(207,"tr")(208,"td")(209,"code"),e.EFF(210,"utcOffset"),e.k0s()(),e.j41(211,"td"),e.EFF(212," This allows you to specify the offset of your timezone rather than using the "),e.j41(213,"code"),e.EFF(214,"timeZone"),e.k0s(),e.EFF(215," param. "),e.k0s()(),e.j41(216,"tr")(217,"td")(218,"code"),e.EFF(219,"disabled"),e.k0s()(),e.j41(220,"td"),e.EFF(221," This indicates whether the job will be executed at all. "),e.k0s()()()(),e.j41(222,"pre")(223,"code",12),e.EFF(224,"\nimport { Injectable } from '@nestjs/common';\nimport { Cron, CronExpression } from '@nestjs/schedule';\n\n@Injectable()\nexport class NotificationService {\n  @Cron('* * 0 * * *', {\n    name: 'notifications',\n    timeZone: 'Europe/Paris',\n  })\n  triggerNotifications() {}\n}\n"),e.k0s()(),e.j41(225,"p"),e.EFF(226,"You can access and control a cron job after it's been declared, or dynamically create a cron job (where its cron pattern is defined at runtime) with the "),e.j41(227,"a",21),e.EFF(228,"Dynamic API"),e.k0s(),e.EFF(229,". To access a declarative cron job via the API, you must associate the job with a name by passing the "),e.j41(230,"code"),e.EFF(231,"name"),e.k0s(),e.EFF(232," property in an optional options object as the second argument of the decorator."),e.k0s(),e.j41(233,"h4",22)(234,"span"),e.EFF(235,"Declarative intervals"),e.k0s()(),e.j41(236,"p"),e.EFF(237,"To declare that a method should run at a (recurring) specified interval, prefix the method definition with the "),e.j41(238,"code"),e.EFF(239,"@Interval()"),e.k0s(),e.EFF(240," decorator. Pass the interval value, as a number in milliseconds, to the decorator as shown below:"),e.k0s(),e.j41(241,"pre")(242,"code",12),e.EFF(243,"\n@Interval(10000)\nhandleInterval() {\n  this.logger.debug('Called every 10 seconds');\n}\n"),e.k0s()(),e.j41(244,"blockquote",19)(245,"strong"),e.EFF(246,"Hint"),e.k0s(),e.EFF(247," This mechanism uses the JavaScript "),e.j41(248,"code"),e.EFF(249,"setInterval()"),e.k0s(),e.EFF(250," function under the hood. You can also utilize a cron job to schedule recurring jobs.\n"),e.k0s(),e.j41(251,"p"),e.EFF(252,"If you want to control your declarative interval from outside the declaring class via the "),e.j41(253,"a",21),e.EFF(254,"Dynamic API"),e.k0s(),e.EFF(255,", associate the interval with a name using the following construction:"),e.k0s(),e.j41(256,"pre")(257,"code",12),e.EFF(258,"\n@Interval('notifications', 2500)\nhandleInterval() {}\n"),e.k0s()(),e.j41(259,"p"),e.EFF(260,"The "),e.j41(261,"a",23),e.EFF(262,"Dynamic API"),e.k0s(),e.EFF(263," also enables "),e.j41(264,"strong"),e.EFF(265,"creating"),e.k0s(),e.EFF(266," dynamic intervals, where the interval's properties are defined at runtime, and "),e.j41(267,"strong"),e.EFF(268,"listing and deleting"),e.k0s(),e.EFF(269," them."),e.k0s(),e.j41(270,"p"),e.nrm(271,"app-banner-enterprise"),e.k0s(),e.j41(272,"h4",24)(273,"span"),e.EFF(274,"Declarative timeouts"),e.k0s()(),e.j41(275,"p"),e.EFF(276,"To declare that a method should run (once) at a specified timeout, prefix the method definition with the "),e.j41(277,"code"),e.EFF(278,"@Timeout()"),e.k0s(),e.EFF(279," decorator. Pass the relative time offset (in milliseconds), from application startup, to the decorator as shown below:"),e.k0s(),e.j41(280,"pre")(281,"code",12),e.EFF(282,"\n@Timeout(5000)\nhandleTimeout() {\n  this.logger.debug('Called once after 5 seconds');\n}\n"),e.k0s()(),e.j41(283,"blockquote",19)(284,"strong"),e.EFF(285,"Hint"),e.k0s(),e.EFF(286," This mechanism uses the JavaScript "),e.j41(287,"code"),e.EFF(288,"setTimeout()"),e.k0s(),e.EFF(289," function under the hood.\n"),e.k0s(),e.j41(290,"p"),e.EFF(291,"If you want to control your declarative timeout from outside the declaring class via the "),e.j41(292,"a",21),e.EFF(293,"Dynamic API"),e.k0s(),e.EFF(294,", associate the timeout with a name using the following construction:"),e.k0s(),e.j41(295,"pre")(296,"code",12),e.EFF(297,"\n@Timeout('notifications', 2500)\nhandleTimeout() {}\n"),e.k0s()(),e.j41(298,"p"),e.EFF(299,"The "),e.j41(300,"a",25),e.EFF(301,"Dynamic API"),e.k0s(),e.EFF(302," also enables "),e.j41(303,"strong"),e.EFF(304,"creating"),e.k0s(),e.EFF(305," dynamic timeouts, where the timeout's properties are defined at runtime, and "),e.j41(306,"strong"),e.EFF(307,"listing and deleting"),e.k0s(),e.EFF(308," them."),e.k0s(),e.j41(309,"h4",26)(310,"span"),e.EFF(311,"Dynamic schedule module API"),e.k0s()(),e.j41(312,"p"),e.EFF(313,"The "),e.j41(314,"code"),e.EFF(315,"@nestjs/schedule"),e.k0s(),e.EFF(316," module provides a dynamic API that enables managing declarative "),e.j41(317,"a",13),e.EFF(318,"cron jobs"),e.k0s(),e.EFF(319,", "),e.j41(320,"a",14),e.EFF(321,"timeouts"),e.k0s(),e.EFF(322," and "),e.j41(323,"a",15),e.EFF(324,"intervals"),e.k0s(),e.EFF(325,". The API also enables creating and managing "),e.j41(326,"strong"),e.EFF(327,"dynamic"),e.k0s(),e.EFF(328," cron jobs, timeouts and intervals, where the properties are defined at runtime."),e.k0s(),e.j41(329,"h4",27)(330,"span"),e.EFF(331,"Dynamic cron jobs"),e.k0s()(),e.j41(332,"p"),e.EFF(333,"Obtain a reference to a "),e.j41(334,"code"),e.EFF(335,"CronJob"),e.k0s(),e.EFF(336," instance by name from anywhere in your code using the "),e.j41(337,"code"),e.EFF(338,"SchedulerRegistry"),e.k0s(),e.EFF(339," API. First, inject "),e.j41(340,"code"),e.EFF(341,"SchedulerRegistry"),e.k0s(),e.EFF(342," using standard constructor injection:"),e.k0s(),e.j41(343,"pre")(344,"code",12),e.EFF(345,"\nconstructor(private schedulerRegistry: SchedulerRegistry) {}\n"),e.k0s()(),e.j41(346,"blockquote",19)(347,"strong"),e.EFF(348,"Hint"),e.k0s(),e.EFF(349," Import the "),e.j41(350,"code"),e.EFF(351,"SchedulerRegistry"),e.k0s(),e.EFF(352," from the "),e.j41(353,"code"),e.EFF(354,"@nestjs/schedule"),e.k0s(),e.EFF(355," package.\n"),e.k0s(),e.j41(356,"p"),e.EFF(357,"Then use it in a class as follows. Assume a cron job was created with the following declaration:"),e.k0s(),e.j41(358,"pre")(359,"code",12),e.EFF(360,"\n@Cron('* * 8 * * *', {\n  name: 'notifications',\n})\ntriggerNotifications() {}\n"),e.k0s()(),e.j41(361,"p"),e.EFF(362,"Access this job using the following:"),e.k0s(),e.j41(363,"pre")(364,"code",12),e.EFF(365,"\nconst job = this.schedulerRegistry.getCronJob('notifications');\n\njob.stop();\nconsole.log(job.lastDate());\n"),e.k0s()(),e.j41(366,"p"),e.EFF(367,"The "),e.j41(368,"code"),e.EFF(369,"getCronJob()"),e.k0s(),e.EFF(370," method returns the named cron job. The returned "),e.j41(371,"code"),e.EFF(372,"CronJob"),e.k0s(),e.EFF(373," object has the following methods:"),e.k0s(),e.j41(374,"ul")(375,"li")(376,"code"),e.EFF(377,"stop()"),e.k0s(),e.EFF(378," - stops a job that is scheduled to run."),e.k0s(),e.j41(379,"li")(380,"code"),e.EFF(381,"start()"),e.k0s(),e.EFF(382," - restarts a job that has been stopped."),e.k0s(),e.j41(383,"li")(384,"code"),e.EFF(385,"setTime(time: CronTime)"),e.k0s(),e.EFF(386," - stops a job, sets a new time for it, and then starts it"),e.k0s(),e.j41(387,"li")(388,"code"),e.EFF(389,"lastDate()"),e.k0s(),e.EFF(390," - returns a "),e.j41(391,"code"),e.EFF(392,"DateTime"),e.k0s(),e.EFF(393," representation of the date on which the last execution of a job occurred."),e.k0s(),e.j41(394,"li")(395,"code"),e.EFF(396,"nextDate()"),e.k0s(),e.EFF(397," - returns a "),e.j41(398,"code"),e.EFF(399,"DateTime"),e.k0s(),e.EFF(400," representation of the date when the next execution of a job is scheduled."),e.k0s(),e.j41(401,"li")(402,"code"),e.EFF(403,"nextDates(count: number)"),e.k0s(),e.EFF(404," - Provides an array (size "),e.j41(405,"code"),e.EFF(406,"count"),e.k0s(),e.EFF(407,") of "),e.j41(408,"code"),e.EFF(409,"DateTime"),e.k0s(),e.EFF(410," representations for the next set of dates that will trigger job execution. "),e.j41(411,"code"),e.EFF(412,"count"),e.k0s(),e.EFF(413," defaults to 0, returning an empty array."),e.k0s()(),e.j41(414,"blockquote",19)(415,"strong"),e.EFF(416,"Hint"),e.k0s(),e.EFF(417," Use "),e.j41(418,"code"),e.EFF(419,"toJSDate()"),e.k0s(),e.EFF(420," on "),e.j41(421,"code"),e.EFF(422,"DateTime"),e.k0s(),e.EFF(423," objects to render them as a JavaScript Date equivalent to this DateTime.\n"),e.k0s(),e.j41(424,"p")(425,"strong"),e.EFF(426,"Create"),e.k0s(),e.EFF(427," a new cron job dynamically using the "),e.j41(428,"code"),e.EFF(429,"SchedulerRegistry#addCronJob"),e.k0s(),e.EFF(430," method, as follows:"),e.k0s(),e.j41(431,"pre")(432,"code",12),e.EFF(433,"\naddCronJob(name: string, seconds: string) {\n  const job = new CronJob(`${seconds} * * * * *`, () => {\n    this.logger.warn(`time (${seconds}) for job ${name} to run!`);\n  });\n\n  this.schedulerRegistry.addCronJob(name, job);\n  job.start();\n\n  this.logger.warn(\n    `job ${name} added for each minute at ${seconds} seconds!`,\n  );\n}\n"),e.k0s()(),e.j41(434,"p"),e.EFF(435,"In this code, we use the "),e.j41(436,"code"),e.EFF(437,"CronJob"),e.k0s(),e.EFF(438," object from the "),e.j41(439,"code"),e.EFF(440,"cron"),e.k0s(),e.EFF(441," package to create the cron job. The "),e.j41(442,"code"),e.EFF(443,"CronJob"),e.k0s(),e.EFF(444," constructor takes a cron pattern (just like the "),e.j41(445,"code"),e.EFF(446,"@Cron()"),e.k0s(),e.j41(447,"a",13),e.EFF(448,"decorator"),e.k0s(),e.EFF(449,") as its first argument, and a callback to be executed when the cron timer fires as its second argument. The "),e.j41(450,"code"),e.EFF(451,"SchedulerRegistry#addCronJob"),e.k0s(),e.EFF(452," method takes two arguments: a name for the "),e.j41(453,"code"),e.EFF(454,"CronJob"),e.k0s(),e.EFF(455,", and the "),e.j41(456,"code"),e.EFF(457,"CronJob"),e.k0s(),e.EFF(458," object itself."),e.k0s(),e.j41(459,"blockquote",28)(460,"strong"),e.EFF(461,"Warning"),e.k0s(),e.EFF(462," Remember to inject the "),e.j41(463,"code"),e.EFF(464,"SchedulerRegistry"),e.k0s(),e.EFF(465," before accessing it. Import "),e.j41(466,"code"),e.EFF(467,"CronJob"),e.k0s(),e.EFF(468," from the "),e.j41(469,"code"),e.EFF(470,"cron"),e.k0s(),e.EFF(471," package.\n"),e.k0s(),e.j41(472,"p")(473,"strong"),e.EFF(474,"Delete"),e.k0s(),e.EFF(475," a named cron job using the "),e.j41(476,"code"),e.EFF(477,"SchedulerRegistry#deleteCronJob"),e.k0s(),e.EFF(478," method, as follows:"),e.k0s(),e.j41(479,"pre")(480,"code",12),e.EFF(481,"\ndeleteCron(name: string) {\n  this.schedulerRegistry.deleteCronJob(name);\n  this.logger.warn(`job ${name} deleted!`);\n}\n"),e.k0s()(),e.j41(482,"p")(483,"strong"),e.EFF(484,"List"),e.k0s(),e.EFF(485," all cron jobs using the "),e.j41(486,"code"),e.EFF(487,"SchedulerRegistry#getCronJobs"),e.k0s(),e.EFF(488," method as follows:"),e.k0s(),e.j41(489,"pre")(490,"code",12),e.EFF(491,"\ngetCrons() {\n  const jobs = this.schedulerRegistry.getCronJobs();\n  jobs.forEach((value, key, map) => {\n    let next;\n    try {\n      next = value.nextDate().toJSDate();\n    } catch (e) {\n      next = 'error: next fire date is in the past!';\n    }\n    this.logger.log(`job: ${key} -> next: ${next}`);\n  });\n}\n"),e.k0s()(),e.j41(492,"p"),e.EFF(493,"The "),e.j41(494,"code"),e.EFF(495,"getCronJobs()"),e.k0s(),e.EFF(496," method returns a "),e.j41(497,"code"),e.EFF(498,"map"),e.k0s(),e.EFF(499,". In this code, we iterate over the map and attempt to access the "),e.j41(500,"code"),e.EFF(501,"nextDate()"),e.k0s(),e.EFF(502," method of each "),e.j41(503,"code"),e.EFF(504,"CronJob"),e.k0s(),e.EFF(505,". In the "),e.j41(506,"code"),e.EFF(507,"CronJob"),e.k0s(),e.EFF(508," API, if a job has already fired and has no future firing date, it throws an exception."),e.k0s(),e.j41(509,"h4",29)(510,"span"),e.EFF(511,"Dynamic intervals"),e.k0s()(),e.j41(512,"p"),e.EFF(513,"Obtain a reference to an interval with the "),e.j41(514,"code"),e.EFF(515,"SchedulerRegistry#getInterval"),e.k0s(),e.EFF(516," method. As above, inject "),e.j41(517,"code"),e.EFF(518,"SchedulerRegistry"),e.k0s(),e.EFF(519," using standard constructor injection:"),e.k0s(),e.j41(520,"pre")(521,"code",12),e.EFF(522,"\nconstructor(private schedulerRegistry: SchedulerRegistry) {}\n"),e.k0s()(),e.j41(523,"p"),e.EFF(524,"And use it as follows:"),e.k0s(),e.j41(525,"pre")(526,"code",12),e.EFF(527,"\nconst interval = this.schedulerRegistry.getInterval('notifications');\nclearInterval(interval);\n"),e.k0s()(),e.j41(528,"p")(529,"strong"),e.EFF(530,"Create"),e.k0s(),e.EFF(531," a new interval dynamically using the "),e.j41(532,"code"),e.EFF(533,"SchedulerRegistry#addInterval"),e.k0s(),e.EFF(534," method, as follows:"),e.k0s(),e.j41(535,"pre")(536,"code",12),e.EFF(537,"\naddInterval(name: string, milliseconds: number) {\n  const callback = () => {\n    this.logger.warn(`Interval ${name} executing at time (${milliseconds})!`);\n  };\n\n  const interval = setInterval(callback, milliseconds);\n  this.schedulerRegistry.addInterval(name, interval);\n}\n"),e.k0s()(),e.j41(538,"p"),e.EFF(539,"In this code, we create a standard JavaScript interval, then pass it to the "),e.j41(540,"code"),e.EFF(541,"SchedulerRegistry#addInterval"),e.k0s(),e.EFF(542," method.\nThat method takes two arguments: a name for the interval, and the interval itself."),e.k0s(),e.j41(543,"p")(544,"strong"),e.EFF(545,"Delete"),e.k0s(),e.EFF(546," a named interval using the "),e.j41(547,"code"),e.EFF(548,"SchedulerRegistry#deleteInterval"),e.k0s(),e.EFF(549," method, as follows:"),e.k0s(),e.j41(550,"pre")(551,"code",12),e.EFF(552,"\ndeleteInterval(name: string) {\n  this.schedulerRegistry.deleteInterval(name);\n  this.logger.warn(`Interval ${name} deleted!`);\n}\n"),e.k0s()(),e.j41(553,"p")(554,"strong"),e.EFF(555,"List"),e.k0s(),e.EFF(556," all intervals using the "),e.j41(557,"code"),e.EFF(558,"SchedulerRegistry#getIntervals"),e.k0s(),e.EFF(559," method as follows:"),e.k0s(),e.j41(560,"pre")(561,"code",12),e.EFF(562,"\ngetIntervals() {\n  const intervals = this.schedulerRegistry.getIntervals();\n  intervals.forEach(key => this.logger.log(`Interval: ${key}`));\n}\n"),e.k0s()(),e.j41(563,"h4",30)(564,"span"),e.EFF(565,"Dynamic timeouts"),e.k0s()(),e.j41(566,"p"),e.EFF(567,"Obtain a reference to a timeout with the "),e.j41(568,"code"),e.EFF(569,"SchedulerRegistry#getTimeout"),e.k0s(),e.EFF(570," method. As above, inject "),e.j41(571,"code"),e.EFF(572,"SchedulerRegistry"),e.k0s(),e.EFF(573," using standard constructor injection:"),e.k0s(),e.j41(574,"pre")(575,"code",12),e.EFF(576,"\nconstructor(private readonly schedulerRegistry: SchedulerRegistry) {}\n"),e.k0s()(),e.j41(577,"p"),e.EFF(578,"And use it as follows:"),e.k0s(),e.j41(579,"pre")(580,"code",12),e.EFF(581,"\nconst timeout = this.schedulerRegistry.getTimeout('notifications');\nclearTimeout(timeout);\n"),e.k0s()(),e.j41(582,"p")(583,"strong"),e.EFF(584,"Create"),e.k0s(),e.EFF(585," a new timeout dynamically using the "),e.j41(586,"code"),e.EFF(587,"SchedulerRegistry#addTimeout"),e.k0s(),e.EFF(588," method, as follows:"),e.k0s(),e.j41(589,"pre")(590,"code",12),e.EFF(591,"\naddTimeout(name: string, milliseconds: number) {\n  const callback = () => {\n    this.logger.warn(`Timeout ${name} executing after (${milliseconds})!`);\n  };\n\n  const timeout = setTimeout(callback, milliseconds);\n  this.schedulerRegistry.addTimeout(name, timeout);\n}\n"),e.k0s()(),e.j41(592,"p"),e.EFF(593,"In this code, we create a standard JavaScript timeout, then pass it to the "),e.j41(594,"code"),e.EFF(595,"SchedulerRegistry#addTimeout"),e.k0s(),e.EFF(596," method.\nThat method takes two arguments: a name for the timeout, and the timeout itself."),e.k0s(),e.j41(597,"p")(598,"strong"),e.EFF(599,"Delete"),e.k0s(),e.EFF(600," a named timeout using the "),e.j41(601,"code"),e.EFF(602,"SchedulerRegistry#deleteTimeout"),e.k0s(),e.EFF(603," method, as follows:"),e.k0s(),e.j41(604,"pre")(605,"code",12),e.EFF(606,"\ndeleteTimeout(name: string) {\n  this.schedulerRegistry.deleteTimeout(name);\n  this.logger.warn(`Timeout ${name} deleted!`);\n}\n"),e.k0s()(),e.j41(607,"p")(608,"strong"),e.EFF(609,"List"),e.k0s(),e.EFF(610," all timeouts using the "),e.j41(611,"code"),e.EFF(612,"SchedulerRegistry#getTimeouts"),e.k0s(),e.EFF(613," method as follows:"),e.k0s(),e.j41(614,"pre")(615,"code",12),e.EFF(616,"\ngetTimeouts() {\n  const timeouts = this.schedulerRegistry.getTimeouts();\n  timeouts.forEach(key => this.logger.log(`Timeout: ${key}`));\n}\n"),e.k0s()(),e.j41(617,"h4",31)(618,"span"),e.EFF(619,"Example"),e.k0s()(),e.j41(620,"p"),e.EFF(621,"A working example is available "),e.j41(622,"a",32),e.EFF(623,"here"),e.k0s(),e.EFF(624,"."),e.k0s()()),2&s){const a=e.sdS(41);e.R7$(38),e.SpI(" ",e.i5U(39,1,"app.module",a.isJsActive),"\n")}},dependencies:[p.O,F.a,w.d,m.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Task Scheduling"}},{path:"compression",component:q,data:{title:"Compression"}},{path:"queues",component:(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-queues"]],features:[e.Vt3],decls:1536,vars:22,consts:[["contentReference",""],["app563086634e03ea93c9473ee58c093b820c074747",""],["appbe9c59ce54b377881a2d3a52b39da2c725550414",""],["app9155a9d69b9fb8c00f91e42233525b0485d98bde",""],["app4790f6f451db6bd6ceadbd5667221ea3ee46270d",""],["app046f6df24af10b0950d8b97ab729b31b12ff9f6f",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/queues.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","queues"],["rel","nofollow","target","_blank","href","https://redis.io/"],["href","techniques/queues#producers"],["href","techniques/queues#consumers"],["href","techniques/queues#event-listeners"],["rel","nofollow","target","_blank","href","https://docs.bullmq.io/"],["rel","nofollow","target","_blank","href","https://github.com/OptimalBits/bull/blob/master/REFERENCE.md"],["appAnchor","","id","bullmq-installation"],[1,"language-bash"],[1,"filename"],[1,"language-typescript"],["rel","nofollow","target","_blank","href","https://docs.bullmq.io/guide/connections"],["rel","nofollow","target","_blank","href","https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#queueadd"],["rel","nofollow","target","_blank","href","https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#queue"],["rel","nofollow","target","_blank","href","https://api.docs.bullmq.io/interfaces/v4.QueueOptions.html"],[1,"info"],["rel","nofollow","target","_blank","href","https://docs.bullmq.io/guide/flows"],["appAnchor","","id","named-configurations"],["appAnchor","","id","producers"],["routerLink","/providers"],["appAnchor","","id","job-options"],["rel","nofollow","target","_blank","href","https://api.docs.bullmq.io/types/v4.JobsOptions.html"],["rel","nofollow","target","_blank","href","https://api.docs.bullmq.io/interfaces/v4.BaseJobOptions.html"],["appAnchor","","id","consumers"],["rel","nofollow","target","_blank","href","https://api.docs.bullmq.io/classes/v4.Job.html"],[1,"warning"],["rel","nofollow","target","_blank","href","https://docs.bullmq.io/patterns/named-processor"],["appAnchor","","id","request-scoped-consumers"],["href","/fundamentals/injection-scopes#provider-scope"],["appAnchor","","id","event-listeners"],["rel","nofollow","target","_blank","href","https://api.docs.bullmq.io/interfaces/v4.WorkerListener.html"],["rel","nofollow","target","_blank","href","https://api.docs.bullmq.io/interfaces/v4.QueueEventsListener.html"],["appAnchor","","id","queue-management"],["rel","nofollow","target","_blank","href","https://api.docs.bullmq.io/classes/v4.Queue.html"],["appAnchor","","id","separate-processes"],["rel","nofollow","target","_blank","href","https://docs.bullmq.io/guide/workers/sandboxed-processors"],["appAnchor","","id","async-configuration"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/fundamentals/async-providers"],["appAnchor","","id","bull-installation"],["appAnchor","","id","named-configurations-1"],["appAnchor","","id","producers-1"],["appAnchor","","id","named-jobs"],[1,"Warning"],["appAnchor","","id","job-options-1"],["appAnchor","","id","consumers-1"],["rel","nofollow","target","_blank","href","https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#job"],["appAnchor","","id","request-scoped-consumers-1"],["appAnchor","","id","event-listeners-1"],["rel","nofollow","target","_blank","href","https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#events"],["appAnchor","","id","queue-management-1"],["appAnchor","","id","separate-processes-1"],["rel","nofollow","target","_blank","href","https://github.com/OptimalBits/bull#separate-processes"],[1,"language-ts"],["appAnchor","","id","async-configuration-1"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/26-queues"]],template:function(s,n){if(1&s&&(e.j41(0,"div",6,0)(2,"div",7)(3,"a",8),e.nrm(4,"i",9),e.k0s()(),e.j41(5,"h3",10),e.EFF(6,"Queues"),e.k0s(),e.j41(7,"p"),e.EFF(8,"Queues are a powerful design pattern that help you deal with common application scaling and performance challenges. Some examples of problems that Queues can help you solve are:"),e.k0s(),e.j41(9,"ul")(10,"li"),e.EFF(11,"Smooth out processing peaks. For example, if users can initiate resource-intensive tasks at arbitrary times, you can add these tasks to a queue instead of performing them synchronously. Then you can have worker processes pull tasks from the queue in a controlled manner. You can easily add new Queue consumers to scale up the back-end task handling as the application scales up."),e.k0s(),e.j41(12,"li"),e.EFF(13,"Break up monolithic tasks that may otherwise block the Node.js event loop. For example, if a user request requires CPU intensive work like audio transcoding, you can delegate this task to other processes, freeing up user-facing processes to remain responsive."),e.k0s(),e.j41(14,"li"),e.EFF(15,"Provide a reliable communication channel across various services. For example, you can queue tasks (jobs) in one process or service, and consume them in another. You can be notified (by listening for status events) upon completion, error or other state changes in the job life cycle from any process or service. When Queue producers or consumers fail, their state is preserved and task handling can restart automatically when nodes are restarted."),e.k0s()(),e.j41(16,"p"),e.EFF(17,"Nest provides the "),e.j41(18,"code"),e.EFF(19,"@nestjs/bullmq"),e.k0s(),e.EFF(20," package for BullMQ integration and "),e.j41(21,"code"),e.EFF(22,"@nestjs/bull"),e.k0s(),e.EFF(23," package for Bull integration. Both packages are abstractions/wrappers on top of their respective libraries, which were developed by the same team. Bull is currently in maintenance mode, with the team focusing on fixing bugs, while BullMQ is actively developed, featuring a modern TypeScript implementation and a different set of features. If Bull meets your requirements, it remains a reliable and battle-tested choice. The Nest packages make it easy to integrate both, BullMQ or Bull Queues, into your Nest application in a friendly way."),e.k0s(),e.j41(24,"p"),e.EFF(25,"Both BullMQ and Bull use "),e.j41(26,"a",11),e.EFF(27,"Redis"),e.k0s(),e.EFF(28," to persist job data, so you'll need to have Redis installed on your system. Because they are Redis-backed, your Queue architecture can be completely distributed and platform-independent. For example, you can have some Queue "),e.j41(29,"a",12),e.EFF(30,"producers"),e.k0s(),e.EFF(31," and "),e.j41(32,"a",13),e.EFF(33,"consumers"),e.k0s(),e.EFF(34," and "),e.j41(35,"a",14),e.EFF(36,"listeners"),e.k0s(),e.EFF(37," running in Nest on one (or several) nodes, and other producers, consumers and listeners running on other Node.js platforms on other network nodes."),e.k0s(),e.j41(38,"p"),e.EFF(39,"This chapter covers the "),e.j41(40,"code"),e.EFF(41,"@nestjs/bullmq"),e.k0s(),e.EFF(42," and "),e.j41(43,"code"),e.EFF(44,"@nestjs/bull"),e.k0s(),e.EFF(45," packages. We also recommend reading the "),e.j41(46,"a",15),e.EFF(47,"BullMQ"),e.k0s(),e.EFF(48," and "),e.j41(49,"a",16),e.EFF(50,"Bull"),e.k0s(),e.EFF(51," documentation for more background and specific implementation details."),e.k0s(),e.j41(52,"h4",17)(53,"span"),e.EFF(54,"BullMQ installation"),e.k0s()(),e.j41(55,"p"),e.EFF(56,"To begin using BullMQ, we first install the required dependencies."),e.k0s(),e.j41(57,"pre")(58,"code",18),e.EFF(59,"\n$ npm install --save @nestjs/bullmq bullmq\n"),e.k0s()(),e.j41(60,"p"),e.EFF(61,"Once the installation process is complete, we can import the "),e.j41(62,"code"),e.EFF(63,"BullModule"),e.k0s(),e.EFF(64," into the root "),e.j41(65,"code"),e.EFF(66,"AppModule"),e.k0s(),e.EFF(67,"."),e.k0s(),e.j41(68,"span",19),e.EFF(69),e.nI1(70,"extension"),e.nrm(71,"app-tabs",null,1),e.k0s(),e.j41(73,"pre")(74,"code",20),e.EFF(75,"\nimport { Module } from '@nestjs/common';\nimport { BullModule } from '@nestjs/bullmq';\n\n@Module({\n  imports: [\n    BullModule.forRoot({\n      connection: {\n        host: 'localhost',\n        port: 6379,\n      },\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(76,"p"),e.EFF(77,"The "),e.j41(78,"code"),e.EFF(79,"forRoot()"),e.k0s(),e.EFF(80," method is used to register a "),e.j41(81,"code"),e.EFF(82,"bullmq"),e.k0s(),e.EFF(83," package configuration object that will be used by all queues registered in the application (unless specified otherwise). For your reference, the following are a few of the properties within a configuration object:"),e.k0s(),e.j41(84,"ul")(85,"li")(86,"code"),e.EFF(87,"connection: ConnectionOptions"),e.k0s(),e.EFF(88," - Options to configure the Redis connection. See "),e.j41(89,"a",21),e.EFF(90,"Connections"),e.k0s(),e.EFF(91," for more information. Optional."),e.k0s(),e.j41(92,"li")(93,"code"),e.EFF(94,"prefix: string"),e.k0s(),e.EFF(95," - Prefix for all queue keys. Optional."),e.k0s(),e.j41(96,"li")(97,"code"),e.EFF(98,"defaultJobOptions: JobOpts"),e.k0s(),e.EFF(99," - Options to control the default settings for new jobs. See "),e.j41(100,"a",22),e.EFF(101,"JobOpts"),e.k0s(),e.EFF(102," for more information. Optional."),e.k0s(),e.j41(103,"li")(104,"code"),e.EFF(105,"settings: AdvancedSettings"),e.k0s(),e.EFF(106," - Advanced Queue configuration settings. These should usually not be changed. See "),e.j41(107,"a",23),e.EFF(108,"AdvancedSettings"),e.k0s(),e.EFF(109," for more information. Optional."),e.k0s()(),e.j41(110,"p"),e.EFF(111,"All the options are optional, providing detailed control over queue behavior. These are passed directly to the BullMQ "),e.j41(112,"code"),e.EFF(113,"Queue"),e.k0s(),e.EFF(114," constructor. Read more about these options and other options "),e.j41(115,"a",24),e.EFF(116,"here"),e.k0s(),e.EFF(117,"."),e.k0s(),e.j41(118,"p"),e.EFF(119,"To register a queue, import the "),e.j41(120,"code"),e.EFF(121,"BullModule.registerQueue()"),e.k0s(),e.EFF(122," dynamic module, as follows:"),e.k0s(),e.j41(123,"pre")(124,"code",20),e.EFF(125,"\nBullModule.registerQueue({\n  name: 'audio',\n});\n"),e.k0s()(),e.j41(126,"blockquote",25)(127,"strong"),e.EFF(128,"Hint"),e.k0s(),e.EFF(129," Create multiple queues by passing multiple comma-separated configuration objects to the "),e.j41(130,"code"),e.EFF(131,"registerQueue()"),e.k0s(),e.EFF(132," method.\n"),e.k0s(),e.j41(133,"p"),e.EFF(134,"The "),e.j41(135,"code"),e.EFF(136,"registerQueue()"),e.k0s(),e.EFF(137," method is used to instantiate and/or register queues. Queues are shared across modules and processes that connect to the same underlying Redis database with the same credentials. Each queue is unique by its name property. A queue name is used as both an injection token (for injecting the queue into controllers/providers), and as an argument to decorators to associate consumer classes and listeners with queues."),e.k0s(),e.j41(138,"p"),e.EFF(139,"You can also override some of the pre-configured options for a specific queue, as follows:"),e.k0s(),e.j41(140,"pre")(141,"code",20),e.EFF(142,"\nBullModule.registerQueue({\n  name: 'audio',\n  connection: {\n    port: 6380,\n  },\n});\n"),e.k0s()(),e.j41(143,"p"),e.EFF(144,"BullMQ also supports parent - child relationships between jobs. This functionality enables the creation of flows where jobs are the node of trees of arbitrary depth. To read more about them check "),e.j41(145,"a",26),e.EFF(146,"here"),e.k0s(),e.EFF(147,"."),e.k0s(),e.j41(148,"p"),e.EFF(149,"To add a flow, you can do the following:"),e.k0s(),e.j41(150,"pre")(151,"code",20),e.EFF(152,"\nBullModule.registerFlowProducer({\n  name: 'flowProducerName',\n});\n"),e.k0s()(),e.j41(153,"p"),e.EFF(154,"Since jobs are persisted in Redis, each time a specific named queue is instantiated (e.g., when an app is started/restarted), it attempts to process any old jobs that may exist from a previous unfinished session."),e.k0s(),e.j41(155,"p"),e.EFF(156,"Each queue can have one or many producers, consumers, and listeners. Consumers retrieve jobs from the queue in a specific order: FIFO (the default), LIFO, or according to priorities. Controlling queue processing order is discussed "),e.j41(157,"a",13),e.EFF(158,"here"),e.k0s(),e.EFF(159,"."),e.k0s(),e.j41(160,"p"),e.nrm(161,"app-banner-enterprise"),e.k0s(),e.j41(162,"h4",27)(163,"span"),e.EFF(164,"Named configurations"),e.k0s()(),e.j41(165,"p"),e.EFF(166,"If your queues connect to multiple different Redis instances, you can use a technique called "),e.j41(167,"strong"),e.EFF(168,"named configurations"),e.k0s(),e.EFF(169,". This feature allows you to register several configurations under specified keys, which then you can refer to in the queue options."),e.k0s(),e.j41(170,"p"),e.EFF(171,"For example, assuming that you have an additional Redis instance (apart from the default one) used by a few queues registered in your application, you can register its configuration as follows:"),e.k0s(),e.j41(172,"pre")(173,"code",20),e.EFF(174,"\nBullModule.forRoot('alternative-config', {\n  connection: {\n    port: 6381,\n  },\n});\n"),e.k0s()(),e.j41(175,"p"),e.EFF(176,"In the example above, "),e.j41(177,"code"),e.EFF(178,"'alternative-config'"),e.k0s(),e.EFF(179," is just a configuration key (it can be any arbitrary string)."),e.k0s(),e.j41(180,"p"),e.EFF(181,"With this in place, you can now point to this configuration in the "),e.j41(182,"code"),e.EFF(183,"registerQueue()"),e.k0s(),e.EFF(184," options object:"),e.k0s(),e.j41(185,"pre")(186,"code",20),e.EFF(187,"\nBullModule.registerQueue({\n  configKey: 'alternative-config',\n  name: 'video',\n});\n"),e.k0s()(),e.j41(188,"h4",28)(189,"span"),e.EFF(190,"Producers"),e.k0s()(),e.j41(191,"p"),e.EFF(192,"Job producers add jobs to queues. Producers are typically application services (Nest "),e.j41(193,"a",29),e.EFF(194,"providers"),e.k0s(),e.EFF(195,"). To add jobs to a queue, first inject the queue into the service as follows:"),e.k0s(),e.j41(196,"pre")(197,"code",20),e.EFF(198,"\nimport { Injectable } from '@nestjs/common';\nimport { Queue } from 'bullmq';\nimport { InjectQueue } from '@nestjs/bullmq';\n\n@Injectable()\nexport class AudioService {\n  constructor(@InjectQueue('audio') private audioQueue: Queue) {}\n}\n"),e.k0s()(),e.j41(199,"blockquote",25)(200,"strong"),e.EFF(201,"Hint"),e.k0s(),e.EFF(202," The "),e.j41(203,"code"),e.EFF(204,"@InjectQueue()"),e.k0s(),e.EFF(205," decorator identifies the queue by its name, as provided in the "),e.j41(206,"code"),e.EFF(207,"registerQueue()"),e.k0s(),e.EFF(208," method call (e.g., "),e.j41(209,"code"),e.EFF(210,"'audio'"),e.k0s(),e.EFF(211,").\n"),e.k0s(),e.j41(212,"p"),e.EFF(213,"Now, add a job by calling the queue's "),e.j41(214,"code"),e.EFF(215,"add()"),e.k0s(),e.EFF(216," method, passing a user-defined job object. Jobs are represented as serializable JavaScript objects (since that is how they are stored in the Redis database). The shape of the job you pass is arbitrary; use it to represent the semantics of your job object. You also need to give it a name. This allows you to create specialized "),e.j41(217,"a",13),e.EFF(218,"consumers"),e.k0s(),e.EFF(219," that will only process jobs with a given name."),e.k0s(),e.j41(220,"pre")(221,"code",20),e.EFF(222,"\nconst job = await this.audioQueue.add('transcode', {\n  foo: 'bar',\n});\n"),e.k0s()(),e.j41(223,"h4",30)(224,"span"),e.EFF(225,"Job options"),e.k0s()(),e.j41(226,"p"),e.EFF(227,"Jobs can have additional options associated with them. Pass an options object after the "),e.j41(228,"code"),e.EFF(229,"job"),e.k0s(),e.EFF(230," argument in the "),e.j41(231,"code"),e.EFF(232,"Queue.add()"),e.k0s(),e.EFF(233," method. Some of the job options properties are:"),e.k0s(),e.j41(234,"ul")(235,"li")(236,"code"),e.EFF(237,"priority"),e.k0s(),e.EFF(238,": "),e.j41(239,"code"),e.EFF(240,"number"),e.k0s(),e.EFF(241," - Optional priority value. Ranges from 1 (highest priority) to MAX_INT (lowest priority). Note that using priorities has a slight impact on performance, so use them with caution."),e.k0s(),e.j41(242,"li")(243,"code"),e.EFF(244,"delay"),e.k0s(),e.EFF(245,": "),e.j41(246,"code"),e.EFF(247,"number"),e.k0s(),e.EFF(248," - An amount of time (milliseconds) to wait until this job can be processed. Note that for accurate delays, both server and clients should have their clocks synchronized."),e.k0s(),e.j41(249,"li")(250,"code"),e.EFF(251,"attempts"),e.k0s(),e.EFF(252,": "),e.j41(253,"code"),e.EFF(254,"number"),e.k0s(),e.EFF(255," - The total number of attempts to try the job until it completes."),e.k0s(),e.j41(256,"li")(257,"code"),e.EFF(258,"repeat"),e.k0s(),e.EFF(259,": "),e.j41(260,"code"),e.EFF(261,"RepeatOpts"),e.k0s(),e.EFF(262," - Repeat job according to a cron specification. See "),e.j41(263,"a",22),e.EFF(264,"RepeatOpts"),e.k0s(),e.EFF(265,"."),e.k0s(),e.j41(266,"li")(267,"code"),e.EFF(268,"backoff"),e.k0s(),e.EFF(269,": "),e.j41(270,"code"),e.EFF(271,"number | BackoffOpts"),e.k0s(),e.EFF(272," - Backoff setting for automatic retries if the job fails. See "),e.j41(273,"a",22),e.EFF(274,"BackoffOpts"),e.k0s(),e.EFF(275,"."),e.k0s(),e.j41(276,"li")(277,"code"),e.EFF(278,"lifo"),e.k0s(),e.EFF(279,": "),e.j41(280,"code"),e.EFF(281,"boolean"),e.k0s(),e.EFF(282," - If true, adds the job to the right end of the queue instead of the left (default false)."),e.k0s(),e.j41(283,"li")(284,"code"),e.EFF(285,"jobId"),e.k0s(),e.EFF(286,": "),e.j41(287,"code"),e.EFF(288,"number"),e.k0s(),e.EFF(289," | "),e.j41(290,"code"),e.EFF(291,"string"),e.k0s(),e.EFF(292," - Override the job ID - by default, the job ID is a unique\ninteger, but you can use this setting to override it. If you use this option, it is up to you to ensure the jobId is unique. If you attempt to add a job with an id that already exists, it will not be added."),e.k0s(),e.j41(293,"li")(294,"code"),e.EFF(295,"removeOnComplete"),e.k0s(),e.EFF(296,": "),e.j41(297,"code"),e.EFF(298,"boolean | number"),e.k0s(),e.EFF(299," - If true, removes the job when it successfully completes. A number specifies the amount of jobs to keep. Default behavior is to keep the job in the completed set."),e.k0s(),e.j41(300,"li")(301,"code"),e.EFF(302,"removeOnFail"),e.k0s(),e.EFF(303,": "),e.j41(304,"code"),e.EFF(305,"boolean | number"),e.k0s(),e.EFF(306," - If true, removes the job when it fails after all attempts. A number specifies the amount of jobs to keep. Default behavior is to keep the job in the failed set."),e.k0s(),e.j41(307,"li")(308,"code"),e.EFF(309,"stackTraceLimit"),e.k0s(),e.EFF(310,": "),e.j41(311,"code"),e.EFF(312,"number"),e.k0s(),e.EFF(313," - Limits the amount of stack trace lines that will be recorded in the stacktrace."),e.k0s()(),e.j41(314,"p"),e.EFF(315,"Here are a few examples of customizing jobs with job options."),e.k0s(),e.j41(316,"p"),e.EFF(317,"To delay the start of a job, use the "),e.j41(318,"code"),e.EFF(319,"delay"),e.k0s(),e.EFF(320," configuration property."),e.k0s(),e.j41(321,"pre")(322,"code",20),e.EFF(323,"\nconst job = await this.audioQueue.add(\n  'transcode',\n  {\n    foo: 'bar',\n  },\n  { delay: 3000 }, // 3 seconds delayed\n);\n"),e.k0s()(),e.j41(324,"p"),e.EFF(325,"To add a job to the right end of the queue (process the job as "),e.j41(326,"strong"),e.EFF(327,"LIFO"),e.k0s(),e.EFF(328," (Last In First Out)), set the "),e.j41(329,"code"),e.EFF(330,"lifo"),e.k0s(),e.EFF(331," property of the configuration object to "),e.j41(332,"code"),e.EFF(333,"true"),e.k0s(),e.EFF(334,"."),e.k0s(),e.j41(335,"pre")(336,"code",20),e.EFF(337,"\nconst job = await this.audioQueue.add(\n  'transcode',\n  {\n    foo: 'bar',\n  },\n  { lifo: true },\n);\n"),e.k0s()(),e.j41(338,"p"),e.EFF(339,"To prioritize a job, use the "),e.j41(340,"code"),e.EFF(341,"priority"),e.k0s(),e.EFF(342," property."),e.k0s(),e.j41(343,"pre")(344,"code",20),e.EFF(345,"\nconst job = await this.audioQueue.add(\n  'transcode',\n  {\n    foo: 'bar',\n  },\n  { priority: 2 },\n);\n"),e.k0s()(),e.j41(346,"p"),e.EFF(347,"For a full list of options, check the API documentation "),e.j41(348,"a",31),e.EFF(349,"here"),e.k0s(),e.EFF(350," and "),e.j41(351,"a",32),e.EFF(352,"here"),e.k0s(),e.EFF(353,"."),e.k0s(),e.j41(354,"h4",33)(355,"span"),e.EFF(356,"Consumers"),e.k0s()(),e.j41(357,"p"),e.EFF(358,"A consumer is a "),e.j41(359,"strong"),e.EFF(360,"class"),e.k0s(),e.EFF(361," defining methods that either process jobs added into the queue, or listen for events on the queue, or both. Declare a consumer class using the "),e.j41(362,"code"),e.EFF(363,"@Processor()"),e.k0s(),e.EFF(364," decorator as follows:"),e.k0s(),e.j41(365,"pre")(366,"code",20),e.EFF(367,"\nimport { Processor } from '@nestjs/bullmq';\n\n@Processor('audio')\nexport class AudioConsumer {}\n"),e.k0s()(),e.j41(368,"blockquote",25)(369,"strong"),e.EFF(370,"Hint"),e.k0s(),e.EFF(371," Consumers must be registered as "),e.j41(372,"code"),e.EFF(373,"providers"),e.k0s(),e.EFF(374," so the "),e.j41(375,"code"),e.EFF(376,"@nestjs/bullmq"),e.k0s(),e.EFF(377," package can pick them up.\n"),e.k0s(),e.j41(378,"p"),e.EFF(379,"Where the decorator's string argument (e.g., "),e.j41(380,"code"),e.EFF(381,"'audio'"),e.k0s(),e.EFF(382,") is the name of the queue to be associated with the class methods."),e.k0s(),e.j41(383,"pre")(384,"code",20),e.EFF(385,"\nimport { Processor, WorkerHost } from '@nestjs/bullmq';\nimport { Job } from 'bullmq';\n\n@Processor('audio')\nexport class AudioConsumer extends WorkerHost {\n  async process(job: Job<any, any, string>): Promise<any> {\n    let progress = 0;\n    for (i = 0; i < 100; i++) {\n      await doSomething(job.data);\n      progress += 1;\n      await job.progress(progress);\n    }\n    return {};\n  }\n}\n"),e.k0s()(),e.j41(386,"p"),e.EFF(387,"The process method is called whenever the worker is idle and there are jobs to process in the queue. This handler method receives the "),e.j41(388,"code"),e.EFF(389,"job"),e.k0s(),e.EFF(390," object as its only argument. The value returned by the handler method is stored in the job object and can be accessed later on, for example in a listener for the completed event."),e.k0s(),e.j41(391,"p")(392,"code"),e.EFF(393,"Job"),e.k0s(),e.EFF(394," objects have multiple methods that allow you to interact with their state. For example, the above code uses the "),e.j41(395,"code"),e.EFF(396,"progress()"),e.k0s(),e.EFF(397," method to update the job's progress. See "),e.j41(398,"a",34),e.EFF(399,"here"),e.k0s(),e.EFF(400," for the complete "),e.j41(401,"code"),e.EFF(402,"Job"),e.k0s(),e.EFF(403," object API reference."),e.k0s(),e.j41(404,"p"),e.EFF(405,"In the older version, Bull, you could designate that a job handler method will handle "),e.j41(406,"strong"),e.EFF(407,"only"),e.k0s(),e.EFF(408," jobs of a certain type (jobs with a specific "),e.j41(409,"code"),e.EFF(410,"name"),e.k0s(),e.EFF(411,") by passing that "),e.j41(412,"code"),e.EFF(413,"name"),e.k0s(),e.EFF(414," to the "),e.j41(415,"code"),e.EFF(416,"@Process()"),e.k0s(),e.EFF(417," decorator as shown below."),e.k0s(),e.j41(418,"blockquote",35)(419,"strong"),e.EFF(420,"Warning"),e.k0s(),e.EFF(421," This doesn't work with BullMQ, keep reading.\n"),e.k0s(),e.j41(422,"pre")(423,"code",20),e.EFF(424,"\n@Process('transcode')\nasync transcode(job: Job<unknown>) { ... }\n"),e.k0s()(),e.j41(425,"p"),e.EFF(426,"This behavior is not supported in BullMQ due to confusions it generated. Instead, you need switch cases to call different services or logic for each job name:"),e.k0s(),e.j41(427,"pre")(428,"code",20),e.EFF(429,"\nimport { Processor, WorkerHost } from '@nestjs/bullmq';\nimport { Job } from 'bullmq';\n\n@Processor('audio')\nexport class AudioConsumer extends WorkerHost {\n  async process(job: Job<any, any, string>): Promise<any> {\n    switch (job.name) {\n      case 'transcode': {\n        let progress = 0;\n        for (i = 0; i < 100; i++) {\n          await doSomething(job.data);\n          progress += 1;\n          await job.progress(progress);\n        }\n        return {};\n      }\n      case 'concatenate': {\n        await doSomeLogic2();\n        break;\n      }\n    }\n  }\n}\n"),e.k0s()(),e.j41(430,"p"),e.EFF(431,"This is covered in the "),e.j41(432,"a",36),e.EFF(433,"named processor"),e.k0s(),e.EFF(434," section of the BullMQ documentation."),e.k0s(),e.j41(435,"h4",37)(436,"span"),e.EFF(437,"Request-scoped consumers"),e.k0s()(),e.j41(438,"p"),e.EFF(439,"When a consumer is flagged as request-scoped (learn more about the injection scopes "),e.j41(440,"a",38),e.EFF(441,"here"),e.k0s(),e.EFF(442,"), a new instance of the class will be created exclusively for each job. The instance will be garbage-collected after the job has completed."),e.k0s(),e.j41(443,"pre")(444,"code",20),e.EFF(445,"\n@Processor({\n  name: 'audio',\n  scope: Scope.REQUEST,\n})\n"),e.k0s()(),e.j41(446,"p"),e.EFF(447,"Since request-scoped consumer classes are instantiated dynamically and scoped to a single job, you can inject a "),e.j41(448,"code"),e.EFF(449,"JOB_REF"),e.k0s(),e.EFF(450," through the constructor using a standard approach."),e.k0s(),e.j41(451,"pre")(452,"code",20),e.EFF(453,"\nconstructor(@Inject(JOB_REF) jobRef: Job) {\n  console.log(jobRef);\n}\n"),e.k0s()(),e.j41(454,"blockquote",25)(455,"strong"),e.EFF(456,"Hint"),e.k0s(),e.EFF(457," The "),e.j41(458,"code"),e.EFF(459,"JOB_REF"),e.k0s(),e.EFF(460," token is imported from the "),e.j41(461,"code"),e.EFF(462,"@nestjs/bullmq"),e.k0s(),e.EFF(463," package.\n"),e.k0s(),e.j41(464,"h4",39)(465,"span"),e.EFF(466,"Event listeners"),e.k0s()(),e.j41(467,"p"),e.EFF(468,"BullMQ generates a set of useful events when queue and/or job state changes occur. These events can be subscribed to at the Worker level using the "),e.j41(469,"code"),e.EFF(470,"@OnWorkerEvent(event)"),e.k0s(),e.EFF(471," decorator, or at the Queue level with a dedicated listener class and the "),e.j41(472,"code"),e.EFF(473,"@OnQueueEvent(event)"),e.k0s(),e.EFF(474," decorator."),e.k0s(),e.j41(475,"p"),e.EFF(476,"Worker events must be declared within a "),e.j41(477,"a",13),e.EFF(478,"consumer"),e.k0s(),e.EFF(479," class (i.e., within a class decorated with the "),e.j41(480,"code"),e.EFF(481,"@Processor()"),e.k0s(),e.EFF(482," decorator). To listen for an event, use the "),e.j41(483,"code"),e.EFF(484,"@OnWorkerEvent(event)"),e.k0s(),e.EFF(485," decorator with the event you want to be handled. For example, to listen to the event emitted when a job enters the active state in the "),e.j41(486,"code"),e.EFF(487,"audio"),e.k0s(),e.EFF(488," queue, use the following construct:"),e.k0s(),e.j41(489,"pre")(490,"code",20),e.EFF(491,"\nimport { Processor, Process, OnWorkerEvent } from '@nestjs/bullmq';\nimport { Job } from 'bullmq';\n\n@Processor('audio')\nexport class AudioConsumer {\n  @OnWorkerEvent('active')\n  onActive(job: Job) {\n    console.log(\n      `Processing job ${job.id} of type ${job.name} with data ${job.data}...`,\n    );\n  }\n\n  // ...\n}\n"),e.k0s()(),e.j41(492,"p"),e.EFF(493,"You can see the complete list of events and their arguments as properties of WorkerListener "),e.j41(494,"a",40),e.EFF(495,"here"),e.k0s(),e.EFF(496,"."),e.k0s(),e.j41(497,"p"),e.EFF(498,"QueueEvent listeners must use the "),e.j41(499,"code"),e.EFF(500,"@QueueEventsListener(queue)"),e.k0s(),e.EFF(501," decorator and extend the "),e.j41(502,"code"),e.EFF(503,"QueueEventsHost"),e.k0s(),e.EFF(504," class provided by "),e.j41(505,"code"),e.EFF(506,"@nestjs/bullmq"),e.k0s(),e.EFF(507,". To listen for an event, use the "),e.j41(508,"code"),e.EFF(509,"@OnQueueEvent(event)"),e.k0s(),e.EFF(510," decorator with the event you want to be handled. For example, to listen to the event emitted when a job enters the active state in the "),e.j41(511,"code"),e.EFF(512,"audio"),e.k0s(),e.EFF(513," queue, use the following construct:"),e.k0s(),e.j41(514,"pre")(515,"code",20),e.EFF(516,"\nimport { QueueEventsHost, QueueEventsListener, OnQueueEvent } from '@nestjs/bullmq';\n\n@QueueEventsListener('audio')\nexport class AudioEventsListener extends QueueEventsHost {\n  @OnQueueEvent('active')\n  onActive(job: { jobId: string; prev?: string; }) {\n    console.log(\n      `Processing job ${job.jobId}...`,\n    );\n  }\n\n  // ...\n}\n"),e.k0s()(),e.j41(517,"blockquote",25)(518,"strong"),e.EFF(519,"Hint"),e.k0s(),e.EFF(520," QueueEvent Listeners must be registered as "),e.j41(521,"code"),e.EFF(522,"providers"),e.k0s(),e.EFF(523," so the "),e.j41(524,"code"),e.EFF(525,"@nestjs/bullmq"),e.k0s(),e.EFF(526," package can pick them up.\n"),e.k0s(),e.j41(527,"p"),e.EFF(528,"You can see the complete list of events and their arguments as properties of QueueEventsListener "),e.j41(529,"a",41),e.EFF(530,"here"),e.k0s(),e.EFF(531,"."),e.k0s(),e.j41(532,"h4",42)(533,"span"),e.EFF(534,"Queue management"),e.k0s()(),e.j41(535,"p"),e.EFF(536,"Queues have an API that allows you to perform management functions like pausing and resuming, retrieving the count of jobs in various states, and several more. You can find the full queue API "),e.j41(537,"a",43),e.EFF(538,"here"),e.k0s(),e.EFF(539,". Invoke any of these methods directly on the "),e.j41(540,"code"),e.EFF(541,"Queue"),e.k0s(),e.EFF(542," object, as shown below with the pause/resume examples."),e.k0s(),e.j41(543,"p"),e.EFF(544,"Pause a queue with the "),e.j41(545,"code"),e.EFF(546,"pause()"),e.k0s(),e.EFF(547," method call. A paused queue will not process new jobs until resumed, but current jobs being processed will continue until they are finalized."),e.k0s(),e.j41(548,"pre")(549,"code",20),e.EFF(550,"\nawait audioQueue.pause();\n"),e.k0s()(),e.j41(551,"p"),e.EFF(552,"To resume a paused queue, use the "),e.j41(553,"code"),e.EFF(554,"resume()"),e.k0s(),e.EFF(555," method, as follows:"),e.k0s(),e.j41(556,"pre")(557,"code",20),e.EFF(558,"\nawait audioQueue.resume();\n"),e.k0s()(),e.j41(559,"h4",44)(560,"span"),e.EFF(561,"Separate processes"),e.k0s()(),e.j41(562,"p"),e.EFF(563,"Job handlers can also be run in a separate (forked) process ("),e.j41(564,"a",45),e.EFF(565,"source"),e.k0s(),e.EFF(566,"). This has several advantages:"),e.k0s(),e.j41(567,"ul")(568,"li"),e.EFF(569,"The process is sandboxed so if it crashes it does not affect the worker."),e.k0s(),e.j41(570,"li"),e.EFF(571,"You can run blocking code without affecting the queue (jobs will not stall)."),e.k0s(),e.j41(572,"li"),e.EFF(573,"Much better utilization of multi-core CPUs."),e.k0s(),e.j41(574,"li"),e.EFF(575,"Less connections to redis."),e.k0s()(),e.j41(576,"span",19),e.EFF(577),e.nI1(578,"extension"),e.nrm(579,"app-tabs",null,2),e.k0s(),e.j41(581,"pre")(582,"code",20),e.EFF(583,"\nimport { Module } from '@nestjs/common';\nimport { BullModule } from '@nestjs/bullmq';\nimport { join } from 'path';\n\n@Module({\n  imports: [\n    BullModule.registerQueue({\n      name: 'audio',\n      processors: [join(__dirname, 'processor.js')],\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(584,"blockquote",35)(585,"strong"),e.EFF(586,"Warning"),e.k0s(),e.EFF(587," Please note that because your function is being executed in a forked process, Dependency Injection (and IoC container) won't be available. That means that your processor function will need to contain (or create) all instances of external dependencies it needs.\n"),e.k0s(),e.j41(588,"h4",46)(589,"span"),e.EFF(590,"Async configuration"),e.k0s()(),e.j41(591,"p"),e.EFF(592,"You may want to pass "),e.j41(593,"code"),e.EFF(594,"bullmq"),e.k0s(),e.EFF(595," options asynchronously instead of statically. In this case, use the "),e.j41(596,"code"),e.EFF(597,"forRootAsync()"),e.k0s(),e.EFF(598," method which provides several ways to deal with async configuration. Likewise, if you want to pass queue options asynchronously, use the "),e.j41(599,"code"),e.EFF(600,"registerQueueAsync()"),e.k0s(),e.EFF(601," method."),e.k0s(),e.j41(602,"p"),e.EFF(603,"One approach is to use a factory function:"),e.k0s(),e.j41(604,"pre")(605,"code",20),e.EFF(606,"\nBullModule.forRootAsync({\n  useFactory: () => ({\n    connection: {\n      host: 'localhost',\n      port: 6379,\n    },\n  }),\n});\n"),e.k0s()(),e.j41(607,"p"),e.EFF(608,"Our factory behaves like any other "),e.j41(609,"a",47),e.EFF(610,"asynchronous provider"),e.k0s(),e.EFF(611," (e.g., it can be "),e.j41(612,"code"),e.EFF(613,"async"),e.k0s(),e.EFF(614," and it's able to inject dependencies through "),e.j41(615,"code"),e.EFF(616,"inject"),e.k0s(),e.EFF(617,")."),e.k0s(),e.j41(618,"pre")(619,"code",20),e.EFF(620,"\nBullModule.forRootAsync({\n  imports: [ConfigModule],\n  useFactory: async (configService: ConfigService) => ({\n    connection: {\n      host: configService.get('QUEUE_HOST'),\n      port: configService.get('QUEUE_PORT'),\n    },\n  }),\n  inject: [ConfigService],\n});\n"),e.k0s()(),e.j41(621,"p"),e.EFF(622,"Alternatively, you can use the "),e.j41(623,"code"),e.EFF(624,"useClass"),e.k0s(),e.EFF(625," syntax:"),e.k0s(),e.j41(626,"pre")(627,"code",20),e.EFF(628,"\nBullModule.forRootAsync({\n  useClass: BullConfigService,\n});\n"),e.k0s()(),e.j41(629,"p"),e.EFF(630,"The construction above will instantiate "),e.j41(631,"code"),e.EFF(632,"BullConfigService"),e.k0s(),e.EFF(633," inside "),e.j41(634,"code"),e.EFF(635,"BullModule"),e.k0s(),e.EFF(636," and use it to provide an options object by calling "),e.j41(637,"code"),e.EFF(638,"createSharedConfiguration()"),e.k0s(),e.EFF(639,". Note that this means that the "),e.j41(640,"code"),e.EFF(641,"BullConfigService"),e.k0s(),e.EFF(642," has to implement the "),e.j41(643,"code"),e.EFF(644,"SharedBullConfigurationFactory"),e.k0s(),e.EFF(645," interface, as shown below:"),e.k0s(),e.j41(646,"pre")(647,"code",20),e.EFF(648,"\n@Injectable()\nclass BullConfigService implements SharedBullConfigurationFactory {\n  createSharedConfiguration(): BullModuleOptions {\n    return {\n      connection: {\n        host: 'localhost',\n        port: 6379,\n      },\n    };\n  }\n}\n"),e.k0s()(),e.j41(649,"p"),e.EFF(650,"In order to prevent the creation of "),e.j41(651,"code"),e.EFF(652,"BullConfigService"),e.k0s(),e.EFF(653," inside "),e.j41(654,"code"),e.EFF(655,"BullModule"),e.k0s(),e.EFF(656," and use a provider imported from a different module, you can use the "),e.j41(657,"code"),e.EFF(658,"useExisting"),e.k0s(),e.EFF(659," syntax."),e.k0s(),e.j41(660,"pre")(661,"code",20),e.EFF(662,"\nBullModule.forRootAsync({\n  imports: [ConfigModule],\n  useExisting: ConfigService,\n});\n"),e.k0s()(),e.j41(663,"p"),e.EFF(664,"This construction works the same as "),e.j41(665,"code"),e.EFF(666,"useClass"),e.k0s(),e.EFF(667," with one critical difference - "),e.j41(668,"code"),e.EFF(669,"BullModule"),e.k0s(),e.EFF(670," will lookup imported modules to reuse an existing "),e.j41(671,"code"),e.EFF(672,"ConfigService"),e.k0s(),e.EFF(673," instead of instantiating a new one."),e.k0s(),e.j41(674,"h4",48)(675,"span"),e.EFF(676,"Bull installation"),e.k0s()(),e.j41(677,"blockquote",35)(678,"strong"),e.EFF(679,"Note"),e.k0s(),e.EFF(680," If you decided to use BullMQ, skip this section and the following chapters.\n"),e.k0s(),e.j41(681,"p"),e.EFF(682,"To begin using Bull, we first install the required dependencies."),e.k0s(),e.j41(683,"pre")(684,"code",18),e.EFF(685,"\n$ npm install --save @nestjs/bull bull\n"),e.k0s()(),e.j41(686,"p"),e.EFF(687,"Once the installation process is complete, we can import the "),e.j41(688,"code"),e.EFF(689,"BullModule"),e.k0s(),e.EFF(690," into the root "),e.j41(691,"code"),e.EFF(692,"AppModule"),e.k0s(),e.EFF(693,"."),e.k0s(),e.j41(694,"span",19),e.EFF(695),e.nI1(696,"extension"),e.nrm(697,"app-tabs",null,3),e.k0s(),e.j41(699,"pre")(700,"code",20),e.EFF(701,"\nimport { Module } from '@nestjs/common';\nimport { BullModule } from '@nestjs/bull';\n\n@Module({\n  imports: [\n    BullModule.forRoot({\n      redis: {\n        host: 'localhost',\n        port: 6379,\n      },\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(702,"p"),e.EFF(703,"The "),e.j41(704,"code"),e.EFF(705,"forRoot()"),e.k0s(),e.EFF(706," method is used to register a "),e.j41(707,"code"),e.EFF(708,"bull"),e.k0s(),e.EFF(709," package configuration object that will be used by all queues registered in the application (unless specified otherwise). A configuration object consists of the following properties:"),e.k0s(),e.j41(710,"ul")(711,"li")(712,"code"),e.EFF(713,"limiter: RateLimiter"),e.k0s(),e.EFF(714," - Options to control the rate at which the queue's jobs are processed. See "),e.j41(715,"a",23),e.EFF(716,"RateLimiter"),e.k0s(),e.EFF(717," for more information. Optional."),e.k0s(),e.j41(718,"li")(719,"code"),e.EFF(720,"redis: RedisOpts"),e.k0s(),e.EFF(721," - Options to configure the Redis connection. See "),e.j41(722,"a",23),e.EFF(723,"RedisOpts"),e.k0s(),e.EFF(724," for more information. Optional."),e.k0s(),e.j41(725,"li")(726,"code"),e.EFF(727,"prefix: string"),e.k0s(),e.EFF(728," - Prefix for all queue keys. Optional."),e.k0s(),e.j41(729,"li")(730,"code"),e.EFF(731,"defaultJobOptions: JobOpts"),e.k0s(),e.EFF(732," - Options to control the default settings for new jobs. See "),e.j41(733,"a",22),e.EFF(734,"JobOpts"),e.k0s(),e.EFF(735," for more information. Optional."),e.k0s(),e.j41(736,"li")(737,"code"),e.EFF(738,"settings: AdvancedSettings"),e.k0s(),e.EFF(739," - Advanced Queue configuration settings. These should usually not be changed. See "),e.j41(740,"a",23),e.EFF(741,"AdvancedSettings"),e.k0s(),e.EFF(742," for more information. Optional."),e.k0s()(),e.j41(743,"p"),e.EFF(744,"All the options are optional, providing detailed control over queue behavior. These are passed directly to the Bull "),e.j41(745,"code"),e.EFF(746,"Queue"),e.k0s(),e.EFF(747," constructor. Read more about these options "),e.j41(748,"a",23),e.EFF(749,"here"),e.k0s(),e.EFF(750,"."),e.k0s(),e.j41(751,"p"),e.EFF(752,"To register a queue, import the "),e.j41(753,"code"),e.EFF(754,"BullModule.registerQueue()"),e.k0s(),e.EFF(755," dynamic module, as follows:"),e.k0s(),e.j41(756,"pre")(757,"code",20),e.EFF(758,"\nBullModule.registerQueue({\n  name: 'audio',\n});\n"),e.k0s()(),e.j41(759,"blockquote",25)(760,"strong"),e.EFF(761,"Hint"),e.k0s(),e.EFF(762," Create multiple queues by passing multiple comma-separated configuration objects to the "),e.j41(763,"code"),e.EFF(764,"registerQueue()"),e.k0s(),e.EFF(765," method.\n"),e.k0s(),e.j41(766,"p"),e.EFF(767,"The "),e.j41(768,"code"),e.EFF(769,"registerQueue()"),e.k0s(),e.EFF(770," method is used to instantiate and/or register queues. Queues are shared across modules and processes that connect to the same underlying Redis database with the same credentials. Each queue is unique by its name property. A queue name is used as both an injection token (for injecting the queue into controllers/providers), and as an argument to decorators to associate consumer classes and listeners with queues."),e.k0s(),e.j41(771,"p"),e.EFF(772,"You can also override some of the pre-configured options for a specific queue, as follows:"),e.k0s(),e.j41(773,"pre")(774,"code",20),e.EFF(775,"\nBullModule.registerQueue({\n  name: 'audio',\n  redis: {\n    port: 6380,\n  },\n});\n"),e.k0s()(),e.j41(776,"p"),e.EFF(777,"Since jobs are persisted in Redis, each time a specific named queue is instantiated (e.g., when an app is started/restarted), it attempts to process any old jobs that may exist from a previous unfinished session."),e.k0s(),e.j41(778,"p"),e.EFF(779,"Each queue can have one or many producers, consumers, and listeners. Consumers retrieve jobs from the queue in a specific order: FIFO (the default), LIFO, or according to priorities. Controlling queue processing order is discussed "),e.j41(780,"a",13),e.EFF(781,"here"),e.k0s(),e.EFF(782,"."),e.k0s(),e.j41(783,"p"),e.nrm(784,"app-banner-enterprise"),e.k0s(),e.j41(785,"h4",49)(786,"span"),e.EFF(787,"Named configurations"),e.k0s()(),e.j41(788,"p"),e.EFF(789,"If your queues connect to multiple Redis instances, you can use a technique called "),e.j41(790,"strong"),e.EFF(791,"named configurations"),e.k0s(),e.EFF(792,". This feature allows you to register several configurations under specified keys, which then you can refer to in the queue options."),e.k0s(),e.j41(793,"p"),e.EFF(794,"For example, assuming that you have an additional Redis instance (apart from the default one) used by a few queues registered in your application, you can register its configuration as follows:"),e.k0s(),e.j41(795,"pre")(796,"code",20),e.EFF(797,"\nBullModule.forRoot('alternative-config', {\n  redis: {\n    port: 6381,\n  },\n});\n"),e.k0s()(),e.j41(798,"p"),e.EFF(799,"In the example above, "),e.j41(800,"code"),e.EFF(801,"'alternative-config'"),e.k0s(),e.EFF(802," is just a configuration key (it can be any arbitrary string)."),e.k0s(),e.j41(803,"p"),e.EFF(804,"With this in place, you can now point to this configuration in the "),e.j41(805,"code"),e.EFF(806,"registerQueue()"),e.k0s(),e.EFF(807," options object:"),e.k0s(),e.j41(808,"pre")(809,"code",20),e.EFF(810,"\nBullModule.registerQueue({\n  configKey: 'alternative-config',\n  name: 'video',\n});\n"),e.k0s()(),e.j41(811,"h4",50)(812,"span"),e.EFF(813,"Producers"),e.k0s()(),e.j41(814,"p"),e.EFF(815,"Job producers add jobs to queues. Producers are typically application services (Nest "),e.j41(816,"a",29),e.EFF(817,"providers"),e.k0s(),e.EFF(818,"). To add jobs to a queue, first inject the queue into the service as follows:"),e.k0s(),e.j41(819,"pre")(820,"code",20),e.EFF(821,"\nimport { Injectable } from '@nestjs/common';\nimport { Queue } from 'bull';\nimport { InjectQueue } from '@nestjs/bull';\n\n@Injectable()\nexport class AudioService {\n  constructor(@InjectQueue('audio') private audioQueue: Queue) {}\n}\n"),e.k0s()(),e.j41(822,"blockquote",25)(823,"strong"),e.EFF(824,"Hint"),e.k0s(),e.EFF(825," The "),e.j41(826,"code"),e.EFF(827,"@InjectQueue()"),e.k0s(),e.EFF(828," decorator identifies the queue by its name, as provided in the "),e.j41(829,"code"),e.EFF(830,"registerQueue()"),e.k0s(),e.EFF(831," method call (e.g., "),e.j41(832,"code"),e.EFF(833,"'audio'"),e.k0s(),e.EFF(834,").\n"),e.k0s(),e.j41(835,"p"),e.EFF(836,"Now, add a job by calling the queue's "),e.j41(837,"code"),e.EFF(838,"add()"),e.k0s(),e.EFF(839," method, passing a user-defined job object. Jobs are represented as serializable JavaScript objects (since that is how they are stored in the Redis database). The shape of the job you pass is arbitrary; use it to represent the semantics of your job object."),e.k0s(),e.j41(840,"pre")(841,"code",20),e.EFF(842,"\nconst job = await this.audioQueue.add({\n  foo: 'bar',\n});\n"),e.k0s()(),e.j41(843,"h4",51)(844,"span"),e.EFF(845,"Named jobs"),e.k0s()(),e.j41(846,"p"),e.EFF(847,"Jobs may have unique names. This allows you to create specialized "),e.j41(848,"a",13),e.EFF(849,"consumers"),e.k0s(),e.EFF(850," that will only process jobs with a given name."),e.k0s(),e.j41(851,"pre")(852,"code",20),e.EFF(853,"\nconst job = await this.audioQueue.add('transcode', {\n  foo: 'bar',\n});\n"),e.k0s()(),e.j41(854,"blockquote",52)(855,"strong"),e.EFF(856,"Warning"),e.k0s(),e.EFF(857," When using named jobs, you must create processors for each unique name added to a queue, or the queue will complain that you are missing a processor for the given job. See "),e.j41(858,"a",13),e.EFF(859,"here"),e.k0s(),e.EFF(860," for more information on consuming named jobs.\n"),e.k0s(),e.j41(861,"h4",53)(862,"span"),e.EFF(863,"Job options"),e.k0s()(),e.j41(864,"p"),e.EFF(865,"Jobs can have additional options associated with them. Pass an options object after the "),e.j41(866,"code"),e.EFF(867,"job"),e.k0s(),e.EFF(868," argument in the "),e.j41(869,"code"),e.EFF(870,"Queue.add()"),e.k0s(),e.EFF(871," method. Job options properties are:"),e.k0s(),e.j41(872,"ul")(873,"li")(874,"code"),e.EFF(875,"priority"),e.k0s(),e.EFF(876,": "),e.j41(877,"code"),e.EFF(878,"number"),e.k0s(),e.EFF(879," - Optional priority value. Ranges from 1 (highest priority) to MAX_INT (lowest priority). Note that using priorities has a slight impact on performance, so use them with caution."),e.k0s(),e.j41(880,"li")(881,"code"),e.EFF(882,"delay"),e.k0s(),e.EFF(883,": "),e.j41(884,"code"),e.EFF(885,"number"),e.k0s(),e.EFF(886," - An amount of time (milliseconds) to wait until this job can be processed. Note that for accurate delays, both server and clients should have their clocks synchronized."),e.k0s(),e.j41(887,"li")(888,"code"),e.EFF(889,"attempts"),e.k0s(),e.EFF(890,": "),e.j41(891,"code"),e.EFF(892,"number"),e.k0s(),e.EFF(893," - The total number of attempts to try the job until it completes."),e.k0s(),e.j41(894,"li")(895,"code"),e.EFF(896,"repeat"),e.k0s(),e.EFF(897,": "),e.j41(898,"code"),e.EFF(899,"RepeatOpts"),e.k0s(),e.EFF(900," - Repeat job according to a cron specification. See "),e.j41(901,"a",22),e.EFF(902,"RepeatOpts"),e.k0s(),e.EFF(903,"."),e.k0s(),e.j41(904,"li")(905,"code"),e.EFF(906,"backoff"),e.k0s(),e.EFF(907,": "),e.j41(908,"code"),e.EFF(909,"number | BackoffOpts"),e.k0s(),e.EFF(910," - Backoff setting for automatic retries if the job fails. See "),e.j41(911,"a",22),e.EFF(912,"BackoffOpts"),e.k0s(),e.EFF(913,"."),e.k0s(),e.j41(914,"li")(915,"code"),e.EFF(916,"lifo"),e.k0s(),e.EFF(917,": "),e.j41(918,"code"),e.EFF(919,"boolean"),e.k0s(),e.EFF(920," - If true, adds the job to the right end of the queue instead of the left (default false)."),e.k0s(),e.j41(921,"li")(922,"code"),e.EFF(923,"timeout"),e.k0s(),e.EFF(924,": "),e.j41(925,"code"),e.EFF(926,"number"),e.k0s(),e.EFF(927," - The number of milliseconds after which the job should fail with a timeout error."),e.k0s(),e.j41(928,"li")(929,"code"),e.EFF(930,"jobId"),e.k0s(),e.EFF(931,": "),e.j41(932,"code"),e.EFF(933,"number"),e.k0s(),e.EFF(934," | "),e.j41(935,"code"),e.EFF(936,"string"),e.k0s(),e.EFF(937," - Override the job ID - by default, the job ID is a unique\ninteger, but you can use this setting to override it. If you use this option, it is up to you to ensure the jobId is unique. If you attempt to add a job with an id that already exists, it will not be added."),e.k0s(),e.j41(938,"li")(939,"code"),e.EFF(940,"removeOnComplete"),e.k0s(),e.EFF(941,": "),e.j41(942,"code"),e.EFF(943,"boolean | number"),e.k0s(),e.EFF(944," - If true, removes the job when it successfully completes. A number specifies the amount of jobs to keep. Default behavior is to keep the job in the completed set."),e.k0s(),e.j41(945,"li")(946,"code"),e.EFF(947,"removeOnFail"),e.k0s(),e.EFF(948,": "),e.j41(949,"code"),e.EFF(950,"boolean | number"),e.k0s(),e.EFF(951," - If true, removes the job when it fails after all attempts. A number specifies the amount of jobs to keep. Default behavior is to keep the job in the failed set."),e.k0s(),e.j41(952,"li")(953,"code"),e.EFF(954,"stackTraceLimit"),e.k0s(),e.EFF(955,": "),e.j41(956,"code"),e.EFF(957,"number"),e.k0s(),e.EFF(958," - Limits the amount of stack trace lines that will be recorded in the stacktrace."),e.k0s()(),e.j41(959,"p"),e.EFF(960,"Here are a few examples of customizing jobs with job options."),e.k0s(),e.j41(961,"p"),e.EFF(962,"To delay the start of a job, use the "),e.j41(963,"code"),e.EFF(964,"delay"),e.k0s(),e.EFF(965," configuration property."),e.k0s(),e.j41(966,"pre")(967,"code",20),e.EFF(968,"\nconst job = await this.audioQueue.add(\n  {\n    foo: 'bar',\n  },\n  { delay: 3000 }, // 3 seconds delayed\n);\n"),e.k0s()(),e.j41(969,"p"),e.EFF(970,"To add a job to the right end of the queue (process the job as "),e.j41(971,"strong"),e.EFF(972,"LIFO"),e.k0s(),e.EFF(973," (Last In First Out)), set the "),e.j41(974,"code"),e.EFF(975,"lifo"),e.k0s(),e.EFF(976," property of the configuration object to "),e.j41(977,"code"),e.EFF(978,"true"),e.k0s(),e.EFF(979,"."),e.k0s(),e.j41(980,"pre")(981,"code",20),e.EFF(982,"\nconst job = await this.audioQueue.add(\n  {\n    foo: 'bar',\n  },\n  { lifo: true },\n);\n"),e.k0s()(),e.j41(983,"p"),e.EFF(984,"To prioritize a job, use the "),e.j41(985,"code"),e.EFF(986,"priority"),e.k0s(),e.EFF(987," property."),e.k0s(),e.j41(988,"pre")(989,"code",20),e.EFF(990,"\nconst job = await this.audioQueue.add(\n  {\n    foo: 'bar',\n  },\n  { priority: 2 },\n);\n"),e.k0s()(),e.j41(991,"h4",54)(992,"span"),e.EFF(993,"Consumers"),e.k0s()(),e.j41(994,"p"),e.EFF(995,"A consumer is a "),e.j41(996,"strong"),e.EFF(997,"class"),e.k0s(),e.EFF(998," defining methods that either process jobs added into the queue, or listen for events on the queue, or both. Declare a consumer class using the "),e.j41(999,"code"),e.EFF(1e3,"@Processor()"),e.k0s(),e.EFF(1001," decorator as follows:"),e.k0s(),e.j41(1002,"pre")(1003,"code",20),e.EFF(1004,"\nimport { Processor } from '@nestjs/bull';\n\n@Processor('audio')\nexport class AudioConsumer {}\n"),e.k0s()(),e.j41(1005,"blockquote",25)(1006,"strong"),e.EFF(1007,"Hint"),e.k0s(),e.EFF(1008," Consumers must be registered as "),e.j41(1009,"code"),e.EFF(1010,"providers"),e.k0s(),e.EFF(1011," so the "),e.j41(1012,"code"),e.EFF(1013,"@nestjs/bull"),e.k0s(),e.EFF(1014," package can pick them up.\n"),e.k0s(),e.j41(1015,"p"),e.EFF(1016,"Where the decorator's string argument (e.g., "),e.j41(1017,"code"),e.EFF(1018,"'audio'"),e.k0s(),e.EFF(1019,") is the name of the queue to be associated with the class methods."),e.k0s(),e.j41(1020,"p"),e.EFF(1021,"Within a consumer class, declare job handlers by decorating handler methods with the "),e.j41(1022,"code"),e.EFF(1023,"@Process()"),e.k0s(),e.EFF(1024," decorator."),e.k0s(),e.j41(1025,"pre")(1026,"code",20),e.EFF(1027,"\nimport { Processor, Process } from '@nestjs/bull';\nimport { Job } from 'bull';\n\n@Processor('audio')\nexport class AudioConsumer {\n  @Process()\n  async transcode(job: Job<unknown>) {\n    let progress = 0;\n    for (let i = 0; i < 100; i++) {\n      await doSomething(job.data);\n      progress += 1;\n      await job.progress(progress);\n    }\n    return {};\n  }\n}\n"),e.k0s()(),e.j41(1028,"p"),e.EFF(1029,"The decorated method (e.g., "),e.j41(1030,"code"),e.EFF(1031,"transcode()"),e.k0s(),e.EFF(1032,") is called whenever the worker is idle and there are jobs to process in the queue. This handler method receives the "),e.j41(1033,"code"),e.EFF(1034,"job"),e.k0s(),e.EFF(1035," object as its only argument. The value returned by the handler method is stored in the job object and can be accessed later on, for example in a listener for the completed event."),e.k0s(),e.j41(1036,"p")(1037,"code"),e.EFF(1038,"Job"),e.k0s(),e.EFF(1039," objects have multiple methods that allow you to interact with their state. For example, the above code uses the "),e.j41(1040,"code"),e.EFF(1041,"progress()"),e.k0s(),e.EFF(1042," method to update the job's progress. See "),e.j41(1043,"a",55),e.EFF(1044,"here"),e.k0s(),e.EFF(1045," for the complete "),e.j41(1046,"code"),e.EFF(1047,"Job"),e.k0s(),e.EFF(1048," object API reference."),e.k0s(),e.j41(1049,"p"),e.EFF(1050,"You can designate that a job handler method will handle "),e.j41(1051,"strong"),e.EFF(1052,"only"),e.k0s(),e.EFF(1053," jobs of a certain type (jobs with a specific "),e.j41(1054,"code"),e.EFF(1055,"name"),e.k0s(),e.EFF(1056,") by passing that "),e.j41(1057,"code"),e.EFF(1058,"name"),e.k0s(),e.EFF(1059," to the "),e.j41(1060,"code"),e.EFF(1061,"@Process()"),e.k0s(),e.EFF(1062," decorator as shown below. You can have multiple "),e.j41(1063,"code"),e.EFF(1064,"@Process()"),e.k0s(),e.EFF(1065," handlers in a given consumer class, corresponding to each job type ("),e.j41(1066,"code"),e.EFF(1067,"name"),e.k0s(),e.EFF(1068,"). When you use named jobs, be sure to have a handler corresponding to each name."),e.k0s(),e.j41(1069,"pre")(1070,"code",20),e.EFF(1071,"\n@Process('transcode')\nasync transcode(job: Job<unknown>) { ... }\n"),e.k0s()(),e.j41(1072,"blockquote",35)(1073,"strong"),e.EFF(1074,"Warning"),e.k0s(),e.EFF(1075," When defining multiple consumers for the same queue, the "),e.j41(1076,"code"),e.EFF(1077,"concurrency"),e.k0s(),e.EFF(1078," option in "),e.j41(1079,"code"),e.EFF(1080),e.k0s(),e.EFF(1081," won't take effect. The minimum "),e.j41(1082,"code"),e.EFF(1083,"concurrency"),e.k0s(),e.EFF(1084," will match the number of consumers defined. This also applies even if "),e.j41(1085,"code"),e.EFF(1086,"@Process()"),e.k0s(),e.EFF(1087," handlers use a different "),e.j41(1088,"code"),e.EFF(1089,"name"),e.k0s(),e.EFF(1090," to handle named jobs.\n"),e.k0s(),e.j41(1091,"h4",56)(1092,"span"),e.EFF(1093,"Request-scoped consumers"),e.k0s()(),e.j41(1094,"p"),e.EFF(1095,"When a consumer is flagged as request-scoped (learn more about the injection scopes "),e.j41(1096,"a",38),e.EFF(1097,"here"),e.k0s(),e.EFF(1098,"), a new instance of the class will be created exclusively for each job. The instance will be garbage-collected after the job has completed."),e.k0s(),e.j41(1099,"pre")(1100,"code",20),e.EFF(1101,"\n@Processor({\n  name: 'audio',\n  scope: Scope.REQUEST,\n})\n"),e.k0s()(),e.j41(1102,"p"),e.EFF(1103,"Since request-scoped consumer classes are instantiated dynamically and scoped to a single job, you can inject a "),e.j41(1104,"code"),e.EFF(1105,"JOB_REF"),e.k0s(),e.EFF(1106," through the constructor using a standard approach."),e.k0s(),e.j41(1107,"pre")(1108,"code",20),e.EFF(1109,"\nconstructor(@Inject(JOB_REF) jobRef: Job) {\n  console.log(jobRef);\n}\n"),e.k0s()(),e.j41(1110,"blockquote",25)(1111,"strong"),e.EFF(1112,"Hint"),e.k0s(),e.EFF(1113," The "),e.j41(1114,"code"),e.EFF(1115,"JOB_REF"),e.k0s(),e.EFF(1116," token is imported from the "),e.j41(1117,"code"),e.EFF(1118,"@nestjs/bull"),e.k0s(),e.EFF(1119," package.\n"),e.k0s(),e.j41(1120,"h4",57)(1121,"span"),e.EFF(1122,"Event listeners"),e.k0s()(),e.j41(1123,"p"),e.EFF(1124,"Bull generates a set of useful events when queue and/or job state changes occur. Nest provides a set of decorators that allow subscribing to a core set of standard events. These are exported from the "),e.j41(1125,"code"),e.EFF(1126,"@nestjs/bull"),e.k0s(),e.EFF(1127," package."),e.k0s(),e.j41(1128,"p"),e.EFF(1129,"Event listeners must be declared within a "),e.j41(1130,"a",13),e.EFF(1131,"consumer"),e.k0s(),e.EFF(1132," class (i.e., within a class decorated with the "),e.j41(1133,"code"),e.EFF(1134,"@Processor()"),e.k0s(),e.EFF(1135," decorator). To listen for an event, use one of the decorators in the table below to declare a handler for the event. For example, to listen to the event emitted when a job enters the active state in the "),e.j41(1136,"code"),e.EFF(1137,"audio"),e.k0s(),e.EFF(1138," queue, use the following construct:"),e.k0s(),e.j41(1139,"pre")(1140,"code",20),e.EFF(1141,"\nimport { Processor, Process, OnQueueActive } from '@nestjs/bull';\nimport { Job } from 'bull';\n\n@Processor('audio')\nexport class AudioConsumer {\n\n  @OnQueueActive()\n  onActive(job: Job) {\n    console.log(\n      `Processing job ${job.id} of type ${job.name} with data ${job.data}...`,\n    );\n  }\n  ...\n"),e.k0s()(),e.j41(1142,"p"),e.EFF(1143,"Since Bull operates in a distributed (multi-node) environment, it defines the concept of event locality. This concept recognizes that events may be triggered either entirely within a single process, or on shared queues from different processes. A "),e.j41(1144,"strong"),e.EFF(1145,"local"),e.k0s(),e.EFF(1146," event is one that is produced when an action or state change is triggered on a queue in the local process. In other words, when your event producers and consumers are local to a single process, all events happening on queues are local."),e.k0s(),e.j41(1147,"p"),e.EFF(1148,"When a queue is shared across multiple processes, we encounter the possibility of "),e.j41(1149,"strong"),e.EFF(1150,"global"),e.k0s(),e.EFF(1151," events. For a listener in one process to receive an event notification triggered by another process, it must register for a global event."),e.k0s(),e.j41(1152,"p"),e.EFF(1153,"Event handlers are invoked whenever their corresponding event is emitted. The handler is called with the signature shown in the table below, providing access to information relevant to the event. We discuss one key difference between local and global event handler signatures below."),e.k0s(),e.j41(1154,"table")(1155,"tr")(1156,"th"),e.EFF(1157,"Local event listeners"),e.k0s(),e.j41(1158,"th"),e.EFF(1159,"Global event listeners"),e.k0s(),e.j41(1160,"th"),e.EFF(1161,"Handler method signature / When fired"),e.k0s()(),e.j41(1162,"tr")(1163,"td")(1164,"code"),e.EFF(1165,"@OnQueueError()"),e.k0s()(),e.j41(1166,"td")(1167,"code"),e.EFF(1168,"@OnGlobalQueueError()"),e.k0s()(),e.j41(1169,"td")(1170,"code"),e.EFF(1171,"handler(error: Error)"),e.k0s(),e.EFF(1172," - An error occurred. "),e.j41(1173,"code"),e.EFF(1174,"error"),e.k0s(),e.EFF(1175," contains the triggering error."),e.k0s()(),e.j41(1176,"tr")(1177,"td")(1178,"code"),e.EFF(1179,"@OnQueueWaiting()"),e.k0s()(),e.j41(1180,"td")(1181,"code"),e.EFF(1182,"@OnGlobalQueueWaiting()"),e.k0s()(),e.j41(1183,"td")(1184,"code"),e.EFF(1185,"handler(jobId: number | string)"),e.k0s(),e.EFF(1186," - A Job is waiting to be processed as soon as a worker is idling. "),e.j41(1187,"code"),e.EFF(1188,"jobId"),e.k0s(),e.EFF(1189," contains the id for the job that has entered this state."),e.k0s()(),e.j41(1190,"tr")(1191,"td")(1192,"code"),e.EFF(1193,"@OnQueueActive()"),e.k0s()(),e.j41(1194,"td")(1195,"code"),e.EFF(1196,"@OnGlobalQueueActive()"),e.k0s()(),e.j41(1197,"td")(1198,"code"),e.EFF(1199,"handler(job: Job)"),e.k0s(),e.EFF(1200," - Job "),e.j41(1201,"code"),e.EFF(1202,"job"),e.k0s(),e.EFF(1203,"has started. "),e.k0s()(),e.j41(1204,"tr")(1205,"td")(1206,"code"),e.EFF(1207,"@OnQueueStalled()"),e.k0s()(),e.j41(1208,"td")(1209,"code"),e.EFF(1210,"@OnGlobalQueueStalled()"),e.k0s()(),e.j41(1211,"td")(1212,"code"),e.EFF(1213,"handler(job: Job)"),e.k0s(),e.EFF(1214," - Job "),e.j41(1215,"code"),e.EFF(1216,"job"),e.k0s(),e.EFF(1217," has been marked as stalled. This is useful for debugging job workers that crash or pause the event loop."),e.k0s()(),e.j41(1218,"tr")(1219,"td")(1220,"code"),e.EFF(1221,"@OnQueueProgress()"),e.k0s()(),e.j41(1222,"td")(1223,"code"),e.EFF(1224,"@OnGlobalQueueProgress()"),e.k0s()(),e.j41(1225,"td")(1226,"code"),e.EFF(1227,"handler(job: Job, progress: number)"),e.k0s(),e.EFF(1228," - Job "),e.j41(1229,"code"),e.EFF(1230,"job"),e.k0s(),e.EFF(1231,"'s progress was updated to value "),e.j41(1232,"code"),e.EFF(1233,"progress"),e.k0s(),e.EFF(1234,"."),e.k0s()(),e.j41(1235,"tr")(1236,"td")(1237,"code"),e.EFF(1238,"@OnQueueCompleted()"),e.k0s()(),e.j41(1239,"td")(1240,"code"),e.EFF(1241,"@OnGlobalQueueCompleted()"),e.k0s()(),e.j41(1242,"td")(1243,"code"),e.EFF(1244,"handler(job: Job, result: any)"),e.k0s(),e.EFF(1245," Job "),e.j41(1246,"code"),e.EFF(1247,"job"),e.k0s(),e.EFF(1248," successfully completed with a result "),e.j41(1249,"code"),e.EFF(1250,"result"),e.k0s(),e.EFF(1251,"."),e.k0s()(),e.j41(1252,"tr")(1253,"td")(1254,"code"),e.EFF(1255,"@OnQueueFailed()"),e.k0s()(),e.j41(1256,"td")(1257,"code"),e.EFF(1258,"@OnGlobalQueueFailed()"),e.k0s()(),e.j41(1259,"td")(1260,"code"),e.EFF(1261,"handler(job: Job, err: Error)"),e.k0s(),e.EFF(1262," Job "),e.j41(1263,"code"),e.EFF(1264,"job"),e.k0s(),e.EFF(1265," failed with reason "),e.j41(1266,"code"),e.EFF(1267,"err"),e.k0s(),e.EFF(1268,"."),e.k0s()(),e.j41(1269,"tr")(1270,"td")(1271,"code"),e.EFF(1272,"@OnQueuePaused()"),e.k0s()(),e.j41(1273,"td")(1274,"code"),e.EFF(1275,"@OnGlobalQueuePaused()"),e.k0s()(),e.j41(1276,"td")(1277,"code"),e.EFF(1278,"handler()"),e.k0s(),e.EFF(1279," The queue has been paused."),e.k0s()(),e.j41(1280,"tr")(1281,"td")(1282,"code"),e.EFF(1283,"@OnQueueResumed()"),e.k0s()(),e.j41(1284,"td")(1285,"code"),e.EFF(1286,"@OnGlobalQueueResumed()"),e.k0s()(),e.j41(1287,"td")(1288,"code"),e.EFF(1289,"handler(job: Job)"),e.k0s(),e.EFF(1290," The queue has been resumed."),e.k0s()(),e.j41(1291,"tr")(1292,"td")(1293,"code"),e.EFF(1294,"@OnQueueCleaned()"),e.k0s()(),e.j41(1295,"td")(1296,"code"),e.EFF(1297,"@OnGlobalQueueCleaned()"),e.k0s()(),e.j41(1298,"td")(1299,"code"),e.EFF(1300,"handler(jobs: Job[], type: string)"),e.k0s(),e.EFF(1301," Old jobs have been cleaned from the queue. "),e.j41(1302,"code"),e.EFF(1303,"jobs"),e.k0s(),e.EFF(1304," is an array of cleaned jobs, and "),e.j41(1305,"code"),e.EFF(1306,"type"),e.k0s(),e.EFF(1307," is the type of jobs cleaned."),e.k0s()(),e.j41(1308,"tr")(1309,"td")(1310,"code"),e.EFF(1311,"@OnQueueDrained()"),e.k0s()(),e.j41(1312,"td")(1313,"code"),e.EFF(1314,"@OnGlobalQueueDrained()"),e.k0s()(),e.j41(1315,"td")(1316,"code"),e.EFF(1317,"handler()"),e.k0s(),e.EFF(1318," Emitted whenever the queue has processed all the waiting jobs (even if there can be some delayed jobs not yet processed)."),e.k0s()(),e.j41(1319,"tr")(1320,"td")(1321,"code"),e.EFF(1322,"@OnQueueRemoved()"),e.k0s()(),e.j41(1323,"td")(1324,"code"),e.EFF(1325,"@OnGlobalQueueRemoved()"),e.k0s()(),e.j41(1326,"td")(1327,"code"),e.EFF(1328,"handler(job: Job)"),e.k0s(),e.EFF(1329," Job "),e.j41(1330,"code"),e.EFF(1331,"job"),e.k0s(),e.EFF(1332," was successfully removed."),e.k0s()()(),e.j41(1333,"p"),e.EFF(1334,"When listening for global events, the method signatures can be slightly different from their local counterpart. Specifically, any method signature that receives "),e.j41(1335,"code"),e.EFF(1336,"job"),e.k0s(),e.EFF(1337," objects in the local version, instead receives a "),e.j41(1338,"code"),e.EFF(1339,"jobId"),e.k0s(),e.EFF(1340," ("),e.j41(1341,"code"),e.EFF(1342,"number"),e.k0s(),e.EFF(1343,") in the global version. To get a reference to the actual "),e.j41(1344,"code"),e.EFF(1345,"job"),e.k0s(),e.EFF(1346," object in such a case, use the "),e.j41(1347,"code"),e.EFF(1348,"Queue#getJob"),e.k0s(),e.EFF(1349," method. This call should be awaited, and therefore the handler should be declared "),e.j41(1350,"code"),e.EFF(1351,"async"),e.k0s(),e.EFF(1352,". For example:"),e.k0s(),e.j41(1353,"pre")(1354,"code",20),e.EFF(1355,"\n@OnGlobalQueueCompleted()\nasync onGlobalCompleted(jobId: number, result: any) {\n  const job = await this.immediateQueue.getJob(jobId);\n  console.log('(Global) on completed: job ', job.id, ' -> result: ', result);\n}\n"),e.k0s()(),e.j41(1356,"blockquote",25)(1357,"strong"),e.EFF(1358,"Hint"),e.k0s(),e.EFF(1359," To access the "),e.j41(1360,"code"),e.EFF(1361,"Queue"),e.k0s(),e.EFF(1362," object (to make a "),e.j41(1363,"code"),e.EFF(1364,"getJob()"),e.k0s(),e.EFF(1365," call), you must of course inject it. Also, the Queue must be registered in the module where you are injecting it.\n"),e.k0s(),e.j41(1366,"p"),e.EFF(1367,"In addition to the specific event listener decorators, you can also use the generic "),e.j41(1368,"code"),e.EFF(1369,"@OnQueueEvent()"),e.k0s(),e.EFF(1370," decorator in combination with either "),e.j41(1371,"code"),e.EFF(1372,"BullQueueEvents"),e.k0s(),e.EFF(1373," or "),e.j41(1374,"code"),e.EFF(1375,"BullQueueGlobalEvents"),e.k0s(),e.EFF(1376," enums. Read more about events "),e.j41(1377,"a",58),e.EFF(1378,"here"),e.k0s(),e.EFF(1379,"."),e.k0s(),e.j41(1380,"h4",59)(1381,"span"),e.EFF(1382,"Queue management"),e.k0s()(),e.j41(1383,"p"),e.EFF(1384,"Queue's have an API that allows you to perform management functions like pausing and resuming, retrieving the count of jobs in various states, and several more. You can find the full queue API "),e.j41(1385,"a",23),e.EFF(1386,"here"),e.k0s(),e.EFF(1387,". Invoke any of these methods directly on the "),e.j41(1388,"code"),e.EFF(1389,"Queue"),e.k0s(),e.EFF(1390," object, as shown below with the pause/resume examples."),e.k0s(),e.j41(1391,"p"),e.EFF(1392,"Pause a queue with the "),e.j41(1393,"code"),e.EFF(1394,"pause()"),e.k0s(),e.EFF(1395," method call. A paused queue will not process new jobs until resumed, but current jobs being processed will continue until they are finalized."),e.k0s(),e.j41(1396,"pre")(1397,"code",20),e.EFF(1398,"\nawait audioQueue.pause();\n"),e.k0s()(),e.j41(1399,"p"),e.EFF(1400,"To resume a paused queue, use the "),e.j41(1401,"code"),e.EFF(1402,"resume()"),e.k0s(),e.EFF(1403," method, as follows:"),e.k0s(),e.j41(1404,"pre")(1405,"code",20),e.EFF(1406,"\nawait audioQueue.resume();\n"),e.k0s()(),e.j41(1407,"h4",60)(1408,"span"),e.EFF(1409,"Separate processes"),e.k0s()(),e.j41(1410,"p"),e.EFF(1411,"Job handlers can also be run in a separate (forked) process ("),e.j41(1412,"a",61),e.EFF(1413,"source"),e.k0s(),e.EFF(1414,"). This has several advantages:"),e.k0s(),e.j41(1415,"ul")(1416,"li"),e.EFF(1417,"The process is sandboxed so if it crashes it does not affect the worker."),e.k0s(),e.j41(1418,"li"),e.EFF(1419,"You can run blocking code without affecting the queue (jobs will not stall)."),e.k0s(),e.j41(1420,"li"),e.EFF(1421,"Much better utilization of multi-core CPUs."),e.k0s(),e.j41(1422,"li"),e.EFF(1423,"Less connections to redis."),e.k0s()(),e.j41(1424,"span",19),e.EFF(1425),e.nI1(1426,"extension"),e.nrm(1427,"app-tabs",null,4),e.k0s(),e.j41(1429,"pre")(1430,"code",62),e.EFF(1431,"\nimport { Module } from '@nestjs/common';\nimport { BullModule } from '@nestjs/bull';\nimport { join } from 'path';\n\n@Module({\n  imports: [\n    BullModule.registerQueue({\n      name: 'audio',\n      processors: [join(__dirname, 'processor.js')],\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()(),e.j41(1432,"p"),e.EFF(1433,"Please note that because your function is being executed in a forked process, Dependency Injection (and IoC container) won't be available. That means that your processor function will need to contain (or create) all instances of external dependencies it needs."),e.k0s(),e.j41(1434,"span",19),e.EFF(1435),e.nI1(1436,"extension"),e.nrm(1437,"app-tabs",null,5),e.k0s(),e.j41(1439,"pre")(1440,"code",62),e.EFF(1441,"\nimport { Job, DoneCallback } from 'bull';\n\nexport default function (job: Job, cb: DoneCallback) {\n  console.log(`[${process.pid}] ${JSON.stringify(job.data)}`);\n  cb(null, 'It works');\n}\n"),e.k0s()(),e.j41(1442,"h4",63)(1443,"span"),e.EFF(1444,"Async configuration"),e.k0s()(),e.j41(1445,"p"),e.EFF(1446,"You may want to pass "),e.j41(1447,"code"),e.EFF(1448,"bull"),e.k0s(),e.EFF(1449," options asynchronously instead of statically. In this case, use the "),e.j41(1450,"code"),e.EFF(1451,"forRootAsync()"),e.k0s(),e.EFF(1452," method which provides several ways to deal with async configuration. Likewise, if you want to pass queue options asynchronously, use the "),e.j41(1453,"code"),e.EFF(1454,"registerQueueAsync()"),e.k0s(),e.EFF(1455," method."),e.k0s(),e.j41(1456,"p"),e.EFF(1457,"One approach is to use a factory function:"),e.k0s(),e.j41(1458,"pre")(1459,"code",20),e.EFF(1460,"\nBullModule.forRootAsync({\n  useFactory: () => ({\n    redis: {\n      host: 'localhost',\n      port: 6379,\n    },\n  }),\n});\n"),e.k0s()(),e.j41(1461,"p"),e.EFF(1462,"Our factory behaves like any other "),e.j41(1463,"a",47),e.EFF(1464,"asynchronous provider"),e.k0s(),e.EFF(1465," (e.g., it can be "),e.j41(1466,"code"),e.EFF(1467,"async"),e.k0s(),e.EFF(1468," and it's able to inject dependencies through "),e.j41(1469,"code"),e.EFF(1470,"inject"),e.k0s(),e.EFF(1471,")."),e.k0s(),e.j41(1472,"pre")(1473,"code",20),e.EFF(1474,"\nBullModule.forRootAsync({\n  imports: [ConfigModule],\n  useFactory: async (configService: ConfigService) => ({\n    redis: {\n      host: configService.get('QUEUE_HOST'),\n      port: configService.get('QUEUE_PORT'),\n    },\n  }),\n  inject: [ConfigService],\n});\n"),e.k0s()(),e.j41(1475,"p"),e.EFF(1476,"Alternatively, you can use the "),e.j41(1477,"code"),e.EFF(1478,"useClass"),e.k0s(),e.EFF(1479," syntax:"),e.k0s(),e.j41(1480,"pre")(1481,"code",20),e.EFF(1482,"\nBullModule.forRootAsync({\n  useClass: BullConfigService,\n});\n"),e.k0s()(),e.j41(1483,"p"),e.EFF(1484,"The construction above will instantiate "),e.j41(1485,"code"),e.EFF(1486,"BullConfigService"),e.k0s(),e.EFF(1487," inside "),e.j41(1488,"code"),e.EFF(1489,"BullModule"),e.k0s(),e.EFF(1490," and use it to provide an options object by calling "),e.j41(1491,"code"),e.EFF(1492,"createSharedConfiguration()"),e.k0s(),e.EFF(1493,". Note that this means that the "),e.j41(1494,"code"),e.EFF(1495,"BullConfigService"),e.k0s(),e.EFF(1496," has to implement the "),e.j41(1497,"code"),e.EFF(1498,"SharedBullConfigurationFactory"),e.k0s(),e.EFF(1499," interface, as shown below:"),e.k0s(),e.j41(1500,"pre")(1501,"code",20),e.EFF(1502,"\n@Injectable()\nclass BullConfigService implements SharedBullConfigurationFactory {\n  createSharedConfiguration(): BullModuleOptions {\n    return {\n      redis: {\n        host: 'localhost',\n        port: 6379,\n      },\n    };\n  }\n}\n"),e.k0s()(),e.j41(1503,"p"),e.EFF(1504,"In order to prevent the creation of "),e.j41(1505,"code"),e.EFF(1506,"BullConfigService"),e.k0s(),e.EFF(1507," inside "),e.j41(1508,"code"),e.EFF(1509,"BullModule"),e.k0s(),e.EFF(1510," and use a provider imported from a different module, you can use the "),e.j41(1511,"code"),e.EFF(1512,"useExisting"),e.k0s(),e.EFF(1513," syntax."),e.k0s(),e.j41(1514,"pre")(1515,"code",20),e.EFF(1516,"\nBullModule.forRootAsync({\n  imports: [ConfigModule],\n  useExisting: ConfigService,\n});\n"),e.k0s()(),e.j41(1517,"p"),e.EFF(1518,"This construction works the same as "),e.j41(1519,"code"),e.EFF(1520,"useClass"),e.k0s(),e.EFF(1521," with one critical difference - "),e.j41(1522,"code"),e.EFF(1523,"BullModule"),e.k0s(),e.EFF(1524," will lookup imported modules to reuse an existing "),e.j41(1525,"code"),e.EFF(1526,"ConfigService"),e.k0s(),e.EFF(1527," instead of instantiating a new one."),e.k0s(),e.j41(1528,"h4",64)(1529,"span"),e.EFF(1530,"Example"),e.k0s()(),e.j41(1531,"p"),e.EFF(1532,"A working example is available "),e.j41(1533,"a",65),e.EFF(1534,"here"),e.k0s(),e.EFF(1535,"."),e.k0s()()),2&s){const a=e.sdS(72),r=e.sdS(580),l=e.sdS(698),c=e.sdS(1428),u=e.sdS(1438);e.R7$(69),e.SpI(" ",e.i5U(70,7,"app.module",a.isJsActive),"\n"),e.R7$(508),e.SpI(" ",e.i5U(578,10,"app.module",r.isJsActive),"\n"),e.R7$(118),e.SpI(" ",e.i5U(696,13,"app.module",l.isJsActive),"\n"),e.R7$(385),e.Lme("@Process(","{"," concurrency: 1 ","}",")"),e.R7$(345),e.SpI(" ",e.i5U(1426,16,"app.module",c.isJsActive),"\n"),e.R7$(10),e.SpI(" ",e.i5U(1436,19,"processor",u.isJsActive),"\n")}},dependencies:[p.O,F.a,w.d,E.Wk,m.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Queues"}},{path:"hot-reload",redirectTo:"/recipes/hot-reload"},{path:"server-sent-events",component:(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-sse"]],features:[e.Vt3],decls:126,vars:0,consts:[["contentReference",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/server-sent-events.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","server-sent-events"],["rel","nofollow","target","_blank","href","https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events"],["appAnchor","","id","usage"],[1,"language-typescript"],[1,"info"],[1,"warning"],["rel","nofollow","target","_blank","href","https://developer.mozilla.org/en-US/docs/Web/API/EventSource"],[1,"language-javascript"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/28-sse"]],template:function(s,n){1&s&&(e.j41(0,"div",1,0)(2,"div",2)(3,"a",3),e.nrm(4,"i",4),e.k0s()(),e.j41(5,"h3",5),e.EFF(6,"Server-Sent Events"),e.k0s(),e.j41(7,"p"),e.EFF(8,"Server-Sent Events (SSE) is a server push technology enabling a client to receive automatic updates from a server via HTTP connection. Each notification is sent as a block of text terminated by a pair of newlines (learn more "),e.j41(9,"a",6),e.EFF(10,"here"),e.k0s(),e.EFF(11,")."),e.k0s(),e.j41(12,"h4",7)(13,"span"),e.EFF(14,"Usage"),e.k0s()(),e.j41(15,"p"),e.EFF(16,"To enable Server-Sent events on a route (route registered within a "),e.j41(17,"strong"),e.EFF(18,"controller class"),e.k0s(),e.EFF(19,"), annotate the method handler with the "),e.j41(20,"code"),e.EFF(21,"@Sse()"),e.k0s(),e.EFF(22," decorator."),e.k0s(),e.j41(23,"pre")(24,"code",8),e.EFF(25,"\n@Sse('sse')\nsse(): Observable<MessageEvent> {\n  return interval(1000).pipe(map((_) => ({ data: { hello: 'world' } })));\n}\n"),e.k0s()(),e.j41(26,"blockquote",9)(27,"strong"),e.EFF(28,"Hint"),e.k0s(),e.EFF(29," The "),e.j41(30,"code"),e.EFF(31,"@Sse()"),e.k0s(),e.EFF(32," decorator and "),e.j41(33,"code"),e.EFF(34,"MessageEvent"),e.k0s(),e.EFF(35," interface are imported from the "),e.j41(36,"code"),e.EFF(37,"@nestjs/common"),e.k0s(),e.EFF(38,", while "),e.j41(39,"code"),e.EFF(40,"Observable"),e.k0s(),e.EFF(41,", "),e.j41(42,"code"),e.EFF(43,"interval"),e.k0s(),e.EFF(44,", and "),e.j41(45,"code"),e.EFF(46,"map"),e.k0s(),e.EFF(47," are imported from the "),e.j41(48,"code"),e.EFF(49,"rxjs"),e.k0s(),e.EFF(50," package.\n"),e.k0s(),e.j41(51,"blockquote",10)(52,"strong"),e.EFF(53,"Warning"),e.k0s(),e.EFF(54," Server-Sent Events routes must return an "),e.j41(55,"code"),e.EFF(56,"Observable"),e.k0s(),e.EFF(57," stream.\n"),e.k0s(),e.j41(58,"p"),e.EFF(59,"In the example above, we defined a route named "),e.j41(60,"code"),e.EFF(61,"sse"),e.k0s(),e.EFF(62," that will allow us to propagate real-time updates. These events can be listened to using the "),e.j41(63,"a",11),e.EFF(64,"EventSource API"),e.k0s(),e.EFF(65,"."),e.k0s(),e.j41(66,"p"),e.EFF(67,"The "),e.j41(68,"code"),e.EFF(69,"sse"),e.k0s(),e.EFF(70," method returns an "),e.j41(71,"code"),e.EFF(72,"Observable"),e.k0s(),e.EFF(73," that emits multiple "),e.j41(74,"code"),e.EFF(75,"MessageEvent"),e.k0s(),e.EFF(76," (in this example, it emits a new "),e.j41(77,"code"),e.EFF(78,"MessageEvent"),e.k0s(),e.EFF(79," every second). The "),e.j41(80,"code"),e.EFF(81,"MessageEvent"),e.k0s(),e.EFF(82," object should respect the following interface to match the specification:"),e.k0s(),e.j41(83,"pre")(84,"code",8),e.EFF(85,"\nexport interface MessageEvent {\n  data: string | object;\n  id?: string;\n  type?: string;\n  retry?: number;\n}\n"),e.k0s()(),e.j41(86,"p"),e.EFF(87,"With this in place, we can now create an instance of the "),e.j41(88,"code"),e.EFF(89,"EventSource"),e.k0s(),e.EFF(90," class in our client-side application, passing the "),e.j41(91,"code"),e.EFF(92,"/sse"),e.k0s(),e.EFF(93," route (which matches the endpoint we have passed into the "),e.j41(94,"code"),e.EFF(95,"@Sse()"),e.k0s(),e.EFF(96," decorator above) as a constructor argument."),e.k0s(),e.j41(97,"p")(98,"code"),e.EFF(99,"EventSource"),e.k0s(),e.EFF(100," instance opens a persistent connection to an HTTP server, which sends events in "),e.j41(101,"code"),e.EFF(102,"text/event-stream"),e.k0s(),e.EFF(103," format. The connection remains open until closed by calling "),e.j41(104,"code"),e.EFF(105,"EventSource.close()"),e.k0s(),e.EFF(106,"."),e.k0s(),e.j41(107,"p"),e.EFF(108,"Once the connection is opened, incoming messages from the server are delivered to your code in the form of events. If there is an event field in the incoming message, the triggered event is the same as the event field value. If no event field is present, then a generic "),e.j41(109,"code"),e.EFF(110,"message"),e.k0s(),e.EFF(111," event is fired ("),e.j41(112,"a",11),e.EFF(113,"source"),e.k0s(),e.EFF(114,")."),e.k0s(),e.j41(115,"pre")(116,"code",12),e.EFF(117,"\nconst eventSource = new EventSource('/sse');\neventSource.onmessage = ({ data }) => {\n  console.log('New message', JSON.parse(data));\n};\n"),e.k0s()(),e.j41(118,"h4",13)(119,"span"),e.EFF(120,"Example"),e.k0s()(),e.j41(121,"p"),e.EFF(122,"A working example is available "),e.j41(123,"a",14),e.EFF(124,"here"),e.k0s(),e.EFF(125,"."),e.k0s()())},dependencies:[F.a],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Server-Sent Events"}},{path:"versioning",component:(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-versioning"]],features:[e.Vt3],decls:438,vars:56,consts:[["contentReference",""],["app1440f64617354037859f056bc234a6d47d953956",""],["app29ad2fe36bcfe842b607d731059735057f6ac5c2",""],["app9f0868f90cd1bf25f4eaa9c5a68d252efca46d28",""],["app948eda459b720ecafc31585a53307008a0416037",""],["appeaaa39053eb964297ba7de3e84e05738e9d40b5b",""],["appa67ace47ecb40ace5a357af593f9fb9769132116",""],["app874df5f7a16efd0c7da8888830dddec8907e0aa1",""],["app6b50edde1c6bedd61571539aa2834746770326b6",""],["app228fa9f83315479fb89c3c688a579cce30a6e3f5",""],["app92359381ea2667032821f29c12ec201c5b2ff400",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/versioning.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","versioning"],[1,"info"],["href","techniques/versioning#uri-versioning-type"],["href","techniques/versioning#header-versioning-type"],["href","techniques/versioning#media-type-versioning-type"],["href","techniques/versioning#custom-versioning-type"],["appAnchor","","id","uri-versioning-type"],[1,"warning"],["href","faq/global-prefix"],[1,"filename"],[1,"language-typescript"],["appAnchor","","id","header-versioning-type"],["appAnchor","","id","media-type-versioning-type"],["appAnchor","","id","custom-versioning-type"],["appAnchor","","id","usage"],["appAnchor","","id","controller-versions"],["appAnchor","","id","route-versions"],["appAnchor","","id","multiple-versions"],["appAnchor","","id","version-neutral"],["appAnchor","","id","global-default-version"],["appAnchor","","id","middleware-versioning"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/middleware"]],template:function(s,n){if(1&s&&(e.j41(0,"div",11,0)(2,"div",12)(3,"a",13),e.nrm(4,"i",14),e.k0s()(),e.j41(5,"h3",15),e.EFF(6,"Versioning"),e.k0s(),e.j41(7,"blockquote",16)(8,"strong"),e.EFF(9,"Hint"),e.k0s(),e.EFF(10," This chapter is only relevant to HTTP-based applications.\n"),e.k0s(),e.j41(11,"p"),e.EFF(12,"Versioning allows you to have "),e.j41(13,"strong"),e.EFF(14,"different versions"),e.k0s(),e.EFF(15," of your controllers or individual routes running within the same application. Applications change very often and it is not unusual that there are breaking changes that you need to make while still needing to support the previous version of the application."),e.k0s(),e.j41(16,"p"),e.EFF(17,"There are 4 types of versioning that are supported:"),e.k0s(),e.j41(18,"table")(19,"tr")(20,"td")(21,"a",17)(22,"code"),e.EFF(23,"URI Versioning"),e.k0s()()(),e.j41(24,"td"),e.EFF(25,"The version will be passed within the URI of the request (default)"),e.k0s()(),e.j41(26,"tr")(27,"td")(28,"a",18)(29,"code"),e.EFF(30,"Header Versioning"),e.k0s()()(),e.j41(31,"td"),e.EFF(32,"A custom request header will specify the version"),e.k0s()(),e.j41(33,"tr")(34,"td")(35,"a",19)(36,"code"),e.EFF(37,"Media Type Versioning"),e.k0s()()(),e.j41(38,"td"),e.EFF(39,"The "),e.j41(40,"code"),e.EFF(41,"Accept"),e.k0s(),e.EFF(42," header of the request will specify the version"),e.k0s()(),e.j41(43,"tr")(44,"td")(45,"a",20)(46,"code"),e.EFF(47,"Custom Versioning"),e.k0s()()(),e.j41(48,"td"),e.EFF(49,"Any aspect of the request may be used to specify the version(s). A custom function is provided to extract said version(s)."),e.k0s()()(),e.j41(50,"h4",21)(51,"span"),e.EFF(52,"URI Versioning Type"),e.k0s()(),e.j41(53,"p"),e.EFF(54,"URI Versioning uses the version passed within the URI of the request, such as "),e.j41(55,"code"),e.EFF(56,"https://example.com/v1/route"),e.k0s(),e.EFF(57," and "),e.j41(58,"code"),e.EFF(59,"https://example.com/v2/route"),e.k0s(),e.EFF(60,"."),e.k0s(),e.j41(61,"blockquote",22)(62,"strong"),e.EFF(63,"Notice"),e.k0s(),e.EFF(64," With URI Versioning the version will be automatically added to the URI after the "),e.j41(65,"a",23),e.EFF(66,"global path prefix"),e.k0s(),e.EFF(67," (if one exists), and before any controller or route paths.\n"),e.k0s(),e.j41(68,"p"),e.EFF(69,"To enable URI Versioning for your application, do the following:"),e.k0s(),e.j41(70,"span",24),e.EFF(71),e.nI1(72,"extension"),e.nrm(73,"app-tabs",null,1),e.k0s(),e.j41(75,"pre")(76,"code",25),e.EFF(77,'\nconst app = await NestFactory.create(AppModule);\n// or "app.enableVersioning()"\napp.enableVersioning({\n  type: VersioningType.URI,\n});\nawait app.listen(process.env.PORT ?? 3000);\n'),e.k0s()(),e.j41(78,"blockquote",22)(79,"strong"),e.EFF(80,"Notice"),e.k0s(),e.EFF(81," The version in the URI will be automatically prefixed with "),e.j41(82,"code"),e.EFF(83,"v"),e.k0s(),e.EFF(84," by default, however the prefix value can be configured by setting the "),e.j41(85,"code"),e.EFF(86,"prefix"),e.k0s(),e.EFF(87," key to your desired prefix or "),e.j41(88,"code"),e.EFF(89,"false"),e.k0s(),e.EFF(90," if you wish to disable it.\n"),e.k0s(),e.j41(91,"blockquote",16)(92,"strong"),e.EFF(93,"Hint"),e.k0s(),e.EFF(94," The "),e.j41(95,"code"),e.EFF(96,"VersioningType"),e.k0s(),e.EFF(97," enum is available to use for the "),e.j41(98,"code"),e.EFF(99,"type"),e.k0s(),e.EFF(100," property and is imported from the "),e.j41(101,"code"),e.EFF(102,"@nestjs/common"),e.k0s(),e.EFF(103," package.\n"),e.k0s(),e.j41(104,"h4",26)(105,"span"),e.EFF(106,"Header Versioning Type"),e.k0s()(),e.j41(107,"p"),e.EFF(108,"Header Versioning uses a custom, user specified, request header to specify the version where the value of the header will be the version to use for the request."),e.k0s(),e.j41(109,"p"),e.EFF(110,"Example HTTP Requests for Header Versioning:"),e.k0s(),e.j41(111,"p"),e.EFF(112,"To enable "),e.j41(113,"strong"),e.EFF(114,"Header Versioning"),e.k0s(),e.EFF(115," for your application, do the following:"),e.k0s(),e.j41(116,"span",24),e.EFF(117),e.nI1(118,"extension"),e.nrm(119,"app-tabs",null,2),e.k0s(),e.j41(121,"pre")(122,"code",25),e.EFF(123,"\nconst app = await NestFactory.create(AppModule);\napp.enableVersioning({\n  type: VersioningType.HEADER,\n  header: 'Custom-Header',\n});\nawait app.listen(process.env.PORT ?? 3000);\n"),e.k0s()(),e.j41(124,"p"),e.EFF(125,"The "),e.j41(126,"code"),e.EFF(127,"header"),e.k0s(),e.EFF(128," property should be the name of the header that will contain the version of the request."),e.k0s(),e.j41(129,"blockquote",16)(130,"strong"),e.EFF(131,"Hint"),e.k0s(),e.EFF(132," The "),e.j41(133,"code"),e.EFF(134,"VersioningType"),e.k0s(),e.EFF(135," enum is available to use for the "),e.j41(136,"code"),e.EFF(137,"type"),e.k0s(),e.EFF(138," property and is imported from the "),e.j41(139,"code"),e.EFF(140,"@nestjs/common"),e.k0s(),e.EFF(141," package.\n"),e.k0s(),e.j41(142,"h4",27)(143,"span"),e.EFF(144,"Media Type Versioning Type"),e.k0s()(),e.j41(145,"p"),e.EFF(146,"Media Type Versioning uses the "),e.j41(147,"code"),e.EFF(148,"Accept"),e.k0s(),e.EFF(149," header of the request to specify the version."),e.k0s(),e.j41(150,"p"),e.EFF(151,"Within the "),e.j41(152,"code"),e.EFF(153,"Accept"),e.k0s(),e.EFF(154," header, the version will be separated from the media type with a semi-colon, "),e.j41(155,"code"),e.EFF(156,";"),e.k0s(),e.EFF(157,". It should then contain a key-value pair that represents the version to use for the request, such as "),e.j41(158,"code"),e.EFF(159,"Accept: application/json;v=2"),e.k0s(),e.EFF(160,". They key is treated more as a prefix when determining the version will to be configured to include the key and separator."),e.k0s(),e.j41(161,"p"),e.EFF(162,"To enable "),e.j41(163,"strong"),e.EFF(164,"Media Type Versioning"),e.k0s(),e.EFF(165," for your application, do the following:"),e.k0s(),e.j41(166,"span",24),e.EFF(167),e.nI1(168,"extension"),e.nrm(169,"app-tabs",null,3),e.k0s(),e.j41(171,"pre")(172,"code",25),e.EFF(173,"\nconst app = await NestFactory.create(AppModule);\napp.enableVersioning({\n  type: VersioningType.MEDIA_TYPE,\n  key: 'v=',\n});\nawait app.listen(process.env.PORT ?? 3000);\n"),e.k0s()(),e.j41(174,"p"),e.EFF(175,"The "),e.j41(176,"code"),e.EFF(177,"key"),e.k0s(),e.EFF(178," property should be the key and separator of the key-value pair that contains the version. For the example "),e.j41(179,"code"),e.EFF(180,"Accept: application/json;v=2"),e.k0s(),e.EFF(181,", the "),e.j41(182,"code"),e.EFF(183,"key"),e.k0s(),e.EFF(184," property would be set to "),e.j41(185,"code"),e.EFF(186,"v="),e.k0s(),e.EFF(187,"."),e.k0s(),e.j41(188,"blockquote",16)(189,"strong"),e.EFF(190,"Hint"),e.k0s(),e.EFF(191," The "),e.j41(192,"code"),e.EFF(193,"VersioningType"),e.k0s(),e.EFF(194," enum is available to use for the "),e.j41(195,"code"),e.EFF(196,"type"),e.k0s(),e.EFF(197," property and is imported from the "),e.j41(198,"code"),e.EFF(199,"@nestjs/common"),e.k0s(),e.EFF(200," package.\n"),e.k0s(),e.j41(201,"h4",28)(202,"span"),e.EFF(203,"Custom Versioning Type"),e.k0s()(),e.j41(204,"p"),e.EFF(205,"Custom Versioning uses any aspect of the request to specify the version (or versions). The incoming request is analyzed\nusing an "),e.j41(206,"code"),e.EFF(207,"extractor"),e.k0s(),e.EFF(208," function that returns a string or array of strings."),e.k0s(),e.j41(209,"p"),e.EFF(210,"If multiple versions are provided by the requester, the extractor function can return an array of strings, sorted in\norder of greatest/highest version to smallest/lowest version. Versions are matched to routes in order from highest to\nlowest."),e.k0s(),e.j41(211,"p"),e.EFF(212,"If an empty string or array is returned from the "),e.j41(213,"code"),e.EFF(214,"extractor"),e.k0s(),e.EFF(215,", no routes are matched and a 404 is returned."),e.k0s(),e.j41(216,"p"),e.EFF(217,"For example, if an incoming request specifies it supports versions "),e.j41(218,"code"),e.EFF(219,"1"),e.k0s(),e.EFF(220,", "),e.j41(221,"code"),e.EFF(222,"2"),e.k0s(),e.EFF(223,", and "),e.j41(224,"code"),e.EFF(225,"3"),e.k0s(),e.EFF(226,", the "),e.j41(227,"code"),e.EFF(228,"extractor"),e.k0s(),e.j41(229,"strong"),e.EFF(230,"MUST"),e.k0s(),e.EFF(231," return "),e.j41(232,"code"),e.EFF(233,"[3, 2, 1]"),e.k0s(),e.EFF(234,". This ensures that the highest possible route version is selected first."),e.k0s(),e.j41(235,"p"),e.EFF(236,"If versions "),e.j41(237,"code"),e.EFF(238,"[3, 2, 1]"),e.k0s(),e.EFF(239," are extracted, but routes only exist for version "),e.j41(240,"code"),e.EFF(241,"2"),e.k0s(),e.EFF(242," and "),e.j41(243,"code"),e.EFF(244,"1"),e.k0s(),e.EFF(245,", the route that matches version "),e.j41(246,"code"),e.EFF(247,"2"),e.k0s(),e.EFF(248,"\nis selected (version "),e.j41(249,"code"),e.EFF(250,"3"),e.k0s(),e.EFF(251," is automatically ignored)."),e.k0s(),e.j41(252,"blockquote",22)(253,"strong"),e.EFF(254,"Notice"),e.k0s(),e.EFF(255," Selecting the highest matching version based on the array returned from "),e.j41(256,"code"),e.EFF(257,"extractor"),e.k0s(),e.EFF(258," > "),e.j41(259,"strong"),e.EFF(260,"does not reliably work"),e.k0s(),e.EFF(261," with the Express adapter due to design limitations. A single version (either a string or\narray of 1 element) works just fine in Express. Fastify correctly supports both highest matching version\nselection and single version selection.\n"),e.k0s(),e.j41(262,"p"),e.EFF(263,"To enable "),e.j41(264,"strong"),e.EFF(265,"Custom Versioning"),e.k0s(),e.EFF(266," for your application, create an "),e.j41(267,"code"),e.EFF(268,"extractor"),e.k0s(),e.EFF(269," function and pass it into your application\nlike so:"),e.k0s(),e.j41(270,"span",24),e.EFF(271),e.nI1(272,"extension"),e.nrm(273,"app-tabs",null,4),e.k0s(),e.j41(275,"pre")(276,"code",25),e.EFF(277,"\n// Example extractor that pulls out a list of versions from a custom header and turns it into a sorted array.\n// This example uses Fastify, but Express requests can be processed in a similar way.\nconst extractor = (request: FastifyRequest): string | string[] =>\n  [request.headers['custom-versioning-field'] ?? '']\n     .flatMap(v => v.split(','))\n     .filter(v => !!v)\n     .sort()\n     .reverse()\n\nconst app = await NestFactory.create(AppModule);\napp.enableVersioning({\n  type: VersioningType.CUSTOM,\n  extractor,\n});\nawait app.listen(process.env.PORT ?? 3000);\n"),e.k0s()(),e.j41(278,"h4",29)(279,"span"),e.EFF(280,"Usage"),e.k0s()(),e.j41(281,"p"),e.EFF(282,"Versioning allows you to version controllers, individual routes, and also provides a way for certain resources to opt-out of versioning. The usage of versioning is the same regardless of the Versioning Type your application uses."),e.k0s(),e.j41(283,"blockquote",22)(284,"strong"),e.EFF(285,"Notice"),e.k0s(),e.EFF(286," If versioning is enabled for the application but the controller or route does not specify the version, any requests to that controller/route will be returned a "),e.j41(287,"code"),e.EFF(288,"404"),e.k0s(),e.EFF(289," response status. Similarly, if a request is received containing a version that does not have a corresponding controller or route, it will also be returned a "),e.j41(290,"code"),e.EFF(291,"404"),e.k0s(),e.EFF(292," response status.\n"),e.k0s(),e.j41(293,"h4",30)(294,"span"),e.EFF(295,"Controller versions"),e.k0s()(),e.j41(296,"p"),e.EFF(297,"A version can be applied to a controller, setting the version for all routes within the controller."),e.k0s(),e.j41(298,"p"),e.EFF(299,"To add a version to a controller do the following:"),e.k0s(),e.j41(300,"span",24),e.EFF(301),e.nI1(302,"extension"),e.nrm(303,"app-tabs",null,5),e.k0s(),e.j41(305,"pre")(306,"code",25),e.EFF(307,"\n@Controller({\n  version: '1',\n})\nexport class CatsControllerV1 {\n  @Get('cats')\n  findAll(): string {\n    return 'This action returns all cats for version 1';\n  }\n}\n"),e.k0s()(),e.j41(308,"pre")(309,"code",25),e.EFF(310,"\n@Controller({\n  version: '1',\n})\nexport class CatsControllerV1 {\n  @Get('cats')\n  findAll() {\n    return 'This action returns all cats for version 1';\n  }\n}\n"),e.k0s()(),e.j41(311,"h4",31)(312,"span"),e.EFF(313,"Route versions"),e.k0s()(),e.j41(314,"p"),e.EFF(315,"A version can be applied to an individual route. This version will override any other version that would effect the route, such as the Controller Version."),e.k0s(),e.j41(316,"p"),e.EFF(317,"To add a version to an individual route do the following:"),e.k0s(),e.j41(318,"span",24),e.EFF(319),e.nI1(320,"extension"),e.nrm(321,"app-tabs",null,6),e.k0s(),e.j41(323,"pre")(324,"code",25),e.EFF(325,"\nimport { Controller, Get, Version } from '@nestjs/common';\n\n@Controller()\nexport class CatsController {\n  @Version('1')\n  @Get('cats')\n  findAllV1(): string {\n    return 'This action returns all cats for version 1';\n  }\n\n  @Version('2')\n  @Get('cats')\n  findAllV2(): string {\n    return 'This action returns all cats for version 2';\n  }\n}\n"),e.k0s()(),e.j41(326,"pre")(327,"code",25),e.EFF(328,"\nimport { Controller, Get, Version } from '@nestjs/common';\n\n@Controller()\nexport class CatsController {\n  @Version('1')\n  @Get('cats')\n  findAllV1() {\n    return 'This action returns all cats for version 1';\n  }\n\n  @Version('2')\n  @Get('cats')\n  findAllV2() {\n    return 'This action returns all cats for version 2';\n  }\n}\n"),e.k0s()(),e.j41(329,"h4",32)(330,"span"),e.EFF(331,"Multiple versions"),e.k0s()(),e.j41(332,"p"),e.EFF(333,"Multiple versions can be applied to a controller or route. To use multiple versions, you would set the version to be an Array."),e.k0s(),e.j41(334,"p"),e.EFF(335,"To add multiple versions do the following:"),e.k0s(),e.j41(336,"span",24),e.EFF(337),e.nI1(338,"extension"),e.nrm(339,"app-tabs",null,7),e.k0s(),e.j41(341,"pre")(342,"code",25),e.EFF(343,"\n@Controller({\n  version: ['1', '2'],\n})\nexport class CatsController {\n  @Get('cats')\n  findAll(): string {\n    return 'This action returns all cats for version 1 or 2';\n  }\n}\n"),e.k0s()(),e.j41(344,"pre")(345,"code",25),e.EFF(346,"\n@Controller({\n  version: ['1', '2'],\n})\nexport class CatsController {\n  @Get('cats')\n  findAll() {\n    return 'This action returns all cats for version 1 or 2';\n  }\n}\n"),e.k0s()(),e.j41(347,"h4",33)(348,"span"),e.EFF(349,'Version "Neutral"'),e.k0s()(),e.j41(350,"p"),e.EFF(351,"Some controllers or routes may not care about the version and would have the same functionality regardless of the version. To accommodate this, the version can be set to "),e.j41(352,"code"),e.EFF(353,"VERSION_NEUTRAL"),e.k0s(),e.EFF(354," symbol."),e.k0s(),e.j41(355,"p"),e.EFF(356,"An incoming request will be mapped to a "),e.j41(357,"code"),e.EFF(358,"VERSION_NEUTRAL"),e.k0s(),e.EFF(359," controller or route regardless of the version sent in the request in addition to if the request does not contain a version at all."),e.k0s(),e.j41(360,"blockquote",22)(361,"strong"),e.EFF(362,"Notice"),e.k0s(),e.EFF(363," For URI Versioning, a "),e.j41(364,"code"),e.EFF(365,"VERSION_NEUTRAL"),e.k0s(),e.EFF(366," resource would not have the version present in the URI.\n"),e.k0s(),e.j41(367,"p"),e.EFF(368,"To add a version neutral controller or route do the following:"),e.k0s(),e.j41(369,"span",24),e.EFF(370),e.nI1(371,"extension"),e.nrm(372,"app-tabs",null,8),e.k0s(),e.j41(374,"pre")(375,"code",25),e.EFF(376,"\nimport { Controller, Get, VERSION_NEUTRAL } from '@nestjs/common';\n\n@Controller({\n  version: VERSION_NEUTRAL,\n})\nexport class CatsController {\n  @Get('cats')\n  findAll(): string {\n    return 'This action returns all cats regardless of version';\n  }\n}\n"),e.k0s()(),e.j41(377,"pre")(378,"code",25),e.EFF(379,"\nimport { Controller, Get, VERSION_NEUTRAL } from '@nestjs/common';\n\n@Controller({\n  version: VERSION_NEUTRAL,\n})\nexport class CatsController {\n  @Get('cats')\n  findAll() {\n    return 'This action returns all cats regardless of version';\n  }\n}\n"),e.k0s()(),e.j41(380,"h4",34)(381,"span"),e.EFF(382,"Global default version"),e.k0s()(),e.j41(383,"p"),e.EFF(384,"If you do not want to provide a version for each controller/or individual routes, or if you want to have a specific version set as the default version for every controller/route that don't have the version specified, you could set the "),e.j41(385,"code"),e.EFF(386,"defaultVersion"),e.k0s(),e.EFF(387," as follows:"),e.k0s(),e.j41(388,"span",24),e.EFF(389),e.nI1(390,"extension"),e.nrm(391,"app-tabs",null,9),e.k0s(),e.j41(393,"pre")(394,"code",25),e.EFF(395,"\napp.enableVersioning({\n  // ...\n  defaultVersion: '1'\n  // or\n  defaultVersion: ['1', '2']\n  // or\n  defaultVersion: VERSION_NEUTRAL\n});\n"),e.k0s()(),e.j41(396,"h4",35)(397,"span"),e.EFF(398,"Middleware versioning"),e.k0s()(),e.j41(399,"p")(400,"a",36),e.EFF(401,"Middlewares"),e.k0s(),e.EFF(402," can also use versioning metadata to configure the middleware for a specific route's version. To do so, provide the version number as one of the parameters for the "),e.j41(403,"code"),e.EFF(404,"MiddlewareConsumer.forRoutes()"),e.k0s(),e.EFF(405," method:"),e.k0s(),e.j41(406,"span",24),e.EFF(407),e.nI1(408,"extension"),e.nrm(409,"app-tabs",null,10),e.k0s(),e.j41(411,"pre")(412,"code",25),e.EFF(413,"\nimport { Module, NestModule, MiddlewareConsumer } from '@nestjs/common';\nimport { LoggerMiddleware } from './common/middleware/logger.middleware';\nimport { CatsModule } from './cats/cats.module';\nimport { CatsController } from './cats/cats.controller';\n\n@Module({\n  imports: [CatsModule],\n})\nexport class AppModule implements NestModule {\n  configure(consumer: MiddlewareConsumer) {\n    consumer\n      .apply(LoggerMiddleware)\n      .forRoutes({ path: 'cats', method: RequestMethod.GET, version: '2' });\n  }\n}\n"),e.k0s()(),e.j41(414,"p"),e.EFF(415,"With the code above, the "),e.j41(416,"code"),e.EFF(417,"LoggerMiddleware"),e.k0s(),e.EFF(418," will only be applied to the version '2' of "),e.j41(419,"code"),e.EFF(420,"/cats"),e.k0s(),e.EFF(421," endpoint."),e.k0s(),e.j41(422,"blockquote",16)(423,"strong"),e.EFF(424,"Notice"),e.k0s(),e.EFF(425," Middlewares work with any versioning type described in the this section: "),e.j41(426,"code"),e.EFF(427,"URI"),e.k0s(),e.EFF(428,", "),e.j41(429,"code"),e.EFF(430,"Header"),e.k0s(),e.EFF(431,", "),e.j41(432,"code"),e.EFF(433,"Media Type"),e.k0s(),e.EFF(434," or "),e.j41(435,"code"),e.EFF(436,"Custom"),e.k0s(),e.EFF(437,".\n"),e.k0s()()),2&s){const a=e.sdS(74),r=e.sdS(120),l=e.sdS(170),c=e.sdS(274),u=e.sdS(304),h=e.sdS(322),k=e.sdS(340),j=e.sdS(373),g=e.sdS(392),f=e.sdS(410);e.R7$(71),e.SpI(" ",e.i5U(72,26,"main",a.isJsActive),"\n"),e.R7$(46),e.SpI(" ",e.i5U(118,29,"main",r.isJsActive),"\n"),e.R7$(50),e.SpI(" ",e.i5U(168,32,"main",l.isJsActive),"\n"),e.R7$(104),e.SpI(" ",e.i5U(272,35,"main",c.isJsActive),"\n"),e.R7$(30),e.SpI(" ",e.i5U(302,38,"cats.controller",u.isJsActive),"\n"),e.R7$(4),e.AVh("hide",u.isJsActive),e.R7$(3),e.AVh("hide",!u.isJsActive),e.R7$(11),e.SpI(" ",e.i5U(320,41,"cats.controller",h.isJsActive),"\n"),e.R7$(4),e.AVh("hide",h.isJsActive),e.R7$(3),e.AVh("hide",!h.isJsActive),e.R7$(11),e.SpI(" ",e.i5U(338,44,"cats.controller",k.isJsActive),"\n"),e.R7$(4),e.AVh("hide",k.isJsActive),e.R7$(3),e.AVh("hide",!k.isJsActive),e.R7$(26),e.SpI(" ",e.i5U(371,47,"cats.controller",j.isJsActive),"\n"),e.R7$(4),e.AVh("hide",j.isJsActive),e.R7$(3),e.AVh("hide",!j.isJsActive),e.R7$(12),e.SpI(" ",e.i5U(390,50,"main",g.isJsActive),"\n"),e.R7$(18),e.SpI(" ",e.i5U(408,53,"app.module",f.isJsActive),"\n")}},dependencies:[p.O,F.a,m.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Versioning"}},{path:"events",component:O,data:{title:"Events"}},{path:"session",component:(()=>{class t extends i.y{static \u0275fac=(()=>{let o;return function(n){return(o||(o=e.xGo(t)))(n||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-sessions"]],features:[e.Vt3],decls:193,vars:0,consts:[["contentReference",""],[1,"content"],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/techniques/sessions.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","session"],["routerLink","/techniques/mvc"],["appAnchor","","id","use-with-express-default"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/session"],[1,"language-shell"],[1,"language-typescript"],[1,"warning"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/session#saveuninitialized"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/session#options"],[1,"info"],["appAnchor","","id","use-with-fastify"],["rel","nofollow","target","_blank","href","https://github.com/fastify/fastify-secure-session"],["rel","nofollow","target","_blank","href","https://github.com/fastify/fastify-secure-session#using-keys-with-key-rotation"]],template:function(s,n){1&s&&(e.j41(0,"div",1,0)(2,"div",2)(3,"a",3),e.nrm(4,"i",4),e.k0s()(),e.j41(5,"h3",5),e.EFF(6,"Session"),e.k0s(),e.j41(7,"p")(8,"strong"),e.EFF(9,"HTTP sessions"),e.k0s(),e.EFF(10," provide a way to store information about the user across multiple requests, which is particularly useful for "),e.j41(11,"a",6),e.EFF(12,"MVC"),e.k0s(),e.EFF(13," applications."),e.k0s(),e.j41(14,"h4",7)(15,"span"),e.EFF(16,"Use with Express (default)"),e.k0s()(),e.j41(17,"p"),e.EFF(18,"First install the "),e.j41(19,"a",8),e.EFF(20,"required package"),e.k0s(),e.EFF(21," (and its types for TypeScript users):"),e.k0s(),e.j41(22,"pre")(23,"code",9),e.EFF(24,"\n$ npm i express-session\n$ npm i -D @types/express-session\n"),e.k0s()(),e.j41(25,"p"),e.EFF(26,"Once the installation is complete, apply the "),e.j41(27,"code"),e.EFF(28,"express-session"),e.k0s(),e.EFF(29," middleware as global middleware (for example, in your "),e.j41(30,"code"),e.EFF(31,"main.ts"),e.k0s(),e.EFF(32," file)."),e.k0s(),e.j41(33,"pre")(34,"code",10),e.EFF(35,"\nimport * as session from 'express-session';\n// somewhere in your initialization file\napp.use(\n  session({\n    secret: 'my-secret',\n    resave: false,\n    saveUninitialized: false,\n  }),\n);\n"),e.k0s()(),e.j41(36,"blockquote",11)(37,"strong"),e.EFF(38,"Notice"),e.k0s(),e.EFF(39," The default server-side session storage is purposely not designed for a production environment. It will leak memory under most conditions, does not scale past a single process, and is meant for debugging and developing. Read more in the "),e.j41(40,"a",8),e.EFF(41,"official repository"),e.k0s(),e.EFF(42,".\n"),e.k0s(),e.j41(43,"p"),e.EFF(44,"The "),e.j41(45,"code"),e.EFF(46,"secret"),e.k0s(),e.EFF(47," is used to sign the session ID cookie. This can be either a string for a single secret, or an array of multiple secrets. If an array of secrets is provided, only the first element will be used to sign the session ID cookie, while all the elements will be considered when verifying the signature in requests. The secret itself should be not easily parsed by a human and would best be a random set of characters."),e.k0s(),e.j41(48,"p"),e.EFF(49,"Enabling the "),e.j41(50,"code"),e.EFF(51,"resave"),e.k0s(),e.EFF(52," option forces the session to be saved back to the session store, even if the session was never modified during the request. The default value is "),e.j41(53,"code"),e.EFF(54,"true"),e.k0s(),e.EFF(55,", but using the default has been deprecated, as the default will change in the future."),e.k0s(),e.j41(56,"p"),e.EFF(57,"Likewise, enabling the "),e.j41(58,"code"),e.EFF(59,"saveUninitialized"),e.k0s(),e.EFF(60,' option Forces a session that is "uninitialized" to be saved to the store. A session is uninitialized when it is new but not modified. Choosing '),e.j41(61,"code"),e.EFF(62,"false"),e.k0s(),e.EFF(63," is useful for implementing login sessions, reducing server storage usage, or complying with laws that require permission before setting a cookie. Choosing "),e.j41(64,"code"),e.EFF(65,"false"),e.k0s(),e.EFF(66," will also help with race conditions where a client makes multiple parallel requests without a session ("),e.j41(67,"a",12),e.EFF(68,"source"),e.k0s(),e.EFF(69,")."),e.k0s(),e.j41(70,"p"),e.EFF(71,"You can pass several other options to the "),e.j41(72,"code"),e.EFF(73,"session"),e.k0s(),e.EFF(74," middleware, read more about them in the "),e.j41(75,"a",13),e.EFF(76,"API documentation"),e.k0s(),e.EFF(77,"."),e.k0s(),e.j41(78,"blockquote",14)(79,"strong"),e.EFF(80,"Hint"),e.k0s(),e.EFF(81," Please note that "),e.j41(82,"code"),e.EFF(83,"secure: true"),e.k0s(),e.EFF(84," is a recommended option. However, it requires an https-enabled website, i.e., HTTPS is necessary for secure cookies. If secure is set, and you access your site over HTTP, the cookie will not be set. If you have your node.js behind a proxy and are using "),e.j41(85,"code"),e.EFF(86,"secure: true"),e.k0s(),e.EFF(87,", you need to set "),e.j41(88,"code"),e.EFF(89,'"trust proxy"'),e.k0s(),e.EFF(90," in express.\n"),e.k0s(),e.j41(91,"p"),e.EFF(92,"With this in place, you can now set and read session values from within the route handlers, as follows:"),e.k0s(),e.j41(93,"pre")(94,"code",10),e.EFF(95,"\n@Get()\nfindAll(@Req() request: Request) {\n  request.session.visits = request.session.visits ? request.session.visits + 1 : 1;\n}\n"),e.k0s()(),e.j41(96,"blockquote",14)(97,"strong"),e.EFF(98,"Hint"),e.k0s(),e.EFF(99," The "),e.j41(100,"code"),e.EFF(101,"@Req()"),e.k0s(),e.EFF(102," decorator is imported from the "),e.j41(103,"code"),e.EFF(104,"@nestjs/common"),e.k0s(),e.EFF(105,", while "),e.j41(106,"code"),e.EFF(107,"Request"),e.k0s(),e.EFF(108," from the "),e.j41(109,"code"),e.EFF(110,"express"),e.k0s(),e.EFF(111," package.\n"),e.k0s(),e.j41(112,"p"),e.EFF(113,"Alternatively, you can use the "),e.j41(114,"code"),e.EFF(115,"@Session()"),e.k0s(),e.EFF(116," decorator to extract a session object from the request, as follows:"),e.k0s(),e.j41(117,"pre")(118,"code",10),e.EFF(119,"\n@Get()\nfindAll(@Session() session: Record<string, any>) {\n  session.visits = session.visits ? session.visits + 1 : 1;\n}\n"),e.k0s()(),e.j41(120,"blockquote",14)(121,"strong"),e.EFF(122,"Hint"),e.k0s(),e.EFF(123," The "),e.j41(124,"code"),e.EFF(125,"@Session()"),e.k0s(),e.EFF(126," decorator is imported from the "),e.j41(127,"code"),e.EFF(128,"@nestjs/common"),e.k0s(),e.EFF(129," package.\n"),e.k0s(),e.j41(130,"h4",15)(131,"span"),e.EFF(132,"Use with Fastify"),e.k0s()(),e.j41(133,"p"),e.EFF(134,"First install the required package:"),e.k0s(),e.j41(135,"pre")(136,"code",9),e.EFF(137,"\n$ npm i @fastify/secure-session\n"),e.k0s()(),e.j41(138,"p"),e.EFF(139,"Once the installation is complete, register the "),e.j41(140,"code"),e.EFF(141,"fastify-secure-session"),e.k0s(),e.EFF(142," plugin:"),e.k0s(),e.j41(143,"pre")(144,"code",10),e.EFF(145,"\nimport secureSession from '@fastify/secure-session';\n\n// somewhere in your initialization file\nconst app = await NestFactory.create<NestFastifyApplication>(\n  AppModule,\n  new FastifyAdapter(),\n);\nawait app.register(secureSession, {\n  secret: 'averylogphrasebiggerthanthirtytwochars',\n  salt: 'mq9hDxBVDbspDR6n',\n});\n"),e.k0s()(),e.j41(146,"blockquote",14)(147,"strong"),e.EFF(148,"Hint"),e.k0s(),e.EFF(149," You can also pregenerate a key ("),e.j41(150,"a",16),e.EFF(151,"see instructions"),e.k0s(),e.EFF(152,") or use "),e.j41(153,"a",17),e.EFF(154,"keys rotation"),e.k0s(),e.EFF(155,".\n"),e.k0s(),e.j41(156,"p"),e.EFF(157,"Read more about the available options in the "),e.j41(158,"a",16),e.EFF(159,"official repository"),e.k0s(),e.EFF(160,"."),e.k0s(),e.j41(161,"p"),e.EFF(162,"With this in place, you can now set and read session values from within the route handlers, as follows:"),e.k0s(),e.j41(163,"pre")(164,"code",10),e.EFF(165,"\n@Get()\nfindAll(@Req() request: FastifyRequest) {\n  const visits = request.session.get('visits');\n  request.session.set('visits', visits ? visits + 1 : 1);\n}\n"),e.k0s()(),e.j41(166,"p"),e.EFF(167,"Alternatively, you can use the "),e.j41(168,"code"),e.EFF(169,"@Session()"),e.k0s(),e.EFF(170," decorator to extract a session object from the request, as follows:"),e.k0s(),e.j41(171,"pre")(172,"code",10),e.EFF(173,"\n@Get()\nfindAll(@Session() session: secureSession.Session) {\n  const visits = session.get('visits');\n  session.set('visits', visits ? visits + 1 : 1);\n}\n"),e.k0s()(),e.j41(174,"blockquote",14)(175,"strong"),e.EFF(176,"Hint"),e.k0s(),e.EFF(177," The "),e.j41(178,"code"),e.EFF(179,"@Session()"),e.k0s(),e.EFF(180," decorator is imported from the "),e.j41(181,"code"),e.EFF(182,"@nestjs/common"),e.k0s(),e.EFF(183,", while "),e.j41(184,"code"),e.EFF(185,"secureSession.Session"),e.k0s(),e.EFF(186," from the "),e.j41(187,"code"),e.EFF(188,"@fastify/secure-session"),e.k0s(),e.EFF(189," package (import statement: "),e.j41(190,"code"),e.EFF(191,"import * as secureSession from '@fastify/secure-session'"),e.k0s(),e.EFF(192,").\n"),e.k0s()())},dependencies:[F.a,E.Wk],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Session"}}];let B=(()=>{class t{static \u0275fac=function(s){return new(s||t)};static \u0275mod=e.$C({type:t});static \u0275inj=e.G2t({imports:[x.MD,M.G,E.iI.forChild(V)]})}return t})()}}]);